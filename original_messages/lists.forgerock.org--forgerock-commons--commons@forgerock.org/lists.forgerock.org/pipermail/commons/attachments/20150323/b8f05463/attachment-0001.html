<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;XHTML&nbsp;1.1//EN&quot;<br>
&quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;&gt;<br>
&lt;html&nbsp;xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;<br>
&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;/&gt;<br>
&lt;title&gt;[3054]&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter:&nbsp;Moving&nbsp;all&nbsp;framework&nbsp;related&nbsp;classes&nbsp;to&nbsp;the&nbsp;same&nbsp;package&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&gt;<br>
<br>
&lt;style&nbsp;type=&quot;text/css&quot;&gt;&lt;!--<br>
#msg&nbsp;dl.meta&nbsp;{&nbsp;border:&nbsp;1px&nbsp;#006&nbsp;solid;&nbsp;background:&nbsp;#369;&nbsp;padding:&nbsp;6px;&nbsp;color:&nbsp;#fff;&nbsp;}<br>
#msg&nbsp;dl.meta&nbsp;dt&nbsp;{&nbsp;float:&nbsp;left;&nbsp;width:&nbsp;6em;&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>
#msg&nbsp;dt:after&nbsp;{&nbsp;content:':';}<br>
#msg&nbsp;dl,&nbsp;#msg&nbsp;dt,&nbsp;#msg&nbsp;ul,&nbsp;#msg&nbsp;li,&nbsp;#header,&nbsp;#footer,&nbsp;#logmsg&nbsp;{&nbsp;font-family:&nbsp;verdana,arial,helvetica,sans-serif;&nbsp;font-size:&nbsp;10pt;&nbsp;&nbsp;}<br>
#msg&nbsp;dl&nbsp;a&nbsp;{&nbsp;font-weight:&nbsp;bold}<br>
#msg&nbsp;dl&nbsp;a:link&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;color:#fc3;&nbsp;}<br>
#msg&nbsp;dl&nbsp;a:active&nbsp;&nbsp;{&nbsp;color:#ff0;&nbsp;}<br>
#msg&nbsp;dl&nbsp;a:visited&nbsp;{&nbsp;color:#cc6;&nbsp;}<br>
h3&nbsp;{&nbsp;font-family:&nbsp;verdana,arial,helvetica,sans-serif;&nbsp;font-size:&nbsp;10pt;&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>
#msg&nbsp;pre&nbsp;{&nbsp;overflow:&nbsp;auto;&nbsp;background:&nbsp;#ffc;&nbsp;border:&nbsp;1px&nbsp;#fa0&nbsp;solid;&nbsp;padding:&nbsp;6px;&nbsp;}<br>
#logmsg&nbsp;{&nbsp;background:&nbsp;#ffc;&nbsp;border:&nbsp;1px&nbsp;#fa0&nbsp;solid;&nbsp;padding:&nbsp;1em&nbsp;1em&nbsp;0&nbsp;1em;&nbsp;}<br>
#logmsg&nbsp;p,&nbsp;#logmsg&nbsp;pre,&nbsp;#logmsg&nbsp;blockquote&nbsp;{&nbsp;margin:&nbsp;0&nbsp;0&nbsp;1em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;p,&nbsp;#logmsg&nbsp;li,&nbsp;#logmsg&nbsp;dt,&nbsp;#logmsg&nbsp;dd&nbsp;{&nbsp;line-height:&nbsp;14pt;&nbsp;}<br>
#logmsg&nbsp;h1,&nbsp;#logmsg&nbsp;h2,&nbsp;#logmsg&nbsp;h3,&nbsp;#logmsg&nbsp;h4,&nbsp;#logmsg&nbsp;h5,&nbsp;#logmsg&nbsp;h6&nbsp;{&nbsp;margin:&nbsp;.5em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;h1:first-child,&nbsp;#logmsg&nbsp;h2:first-child,&nbsp;#logmsg&nbsp;h3:first-child,&nbsp;#logmsg&nbsp;h4:first-child,&nbsp;#logmsg&nbsp;h5:first-child,&nbsp;#logmsg&nbsp;h6:first-child&nbsp;{&nbsp;margin-top:&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;ul,&nbsp;#logmsg&nbsp;ol&nbsp;{&nbsp;padding:&nbsp;0;&nbsp;list-style-position:&nbsp;inside;&nbsp;margin:&nbsp;0&nbsp;0&nbsp;0&nbsp;1em;&nbsp;}<br>
#logmsg&nbsp;ul&nbsp;{&nbsp;text-indent:&nbsp;-1em;&nbsp;padding-left:&nbsp;1em;&nbsp;}#logmsg&nbsp;ol&nbsp;{&nbsp;text-indent:&nbsp;-1.5em;&nbsp;padding-left:&nbsp;1.5em;&nbsp;}<br>
#logmsg&nbsp;&gt;&nbsp;ul,&nbsp;#logmsg&nbsp;&gt;&nbsp;ol&nbsp;{&nbsp;margin:&nbsp;0&nbsp;0&nbsp;1em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;pre&nbsp;{&nbsp;background:&nbsp;#eee;&nbsp;padding:&nbsp;1em;&nbsp;}<br>
#logmsg&nbsp;blockquote&nbsp;{&nbsp;border:&nbsp;1px&nbsp;solid&nbsp;#fa0;&nbsp;border-left-width:&nbsp;10px;&nbsp;padding:&nbsp;1em&nbsp;1em&nbsp;0&nbsp;1em;&nbsp;background:&nbsp;white;}<br>
#logmsg&nbsp;dl&nbsp;{&nbsp;margin:&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;dt&nbsp;{&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>
#logmsg&nbsp;dd&nbsp;{&nbsp;margin:&nbsp;0;&nbsp;padding:&nbsp;0&nbsp;0&nbsp;0.5em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;dd:before&nbsp;{&nbsp;content:'\00bb';}<br>
#logmsg&nbsp;table&nbsp;{&nbsp;border-spacing:&nbsp;0px;&nbsp;border-collapse:&nbsp;collapse;&nbsp;border-top:&nbsp;4px&nbsp;solid&nbsp;#fa0;&nbsp;border-bottom:&nbsp;1px&nbsp;solid&nbsp;#fa0;&nbsp;background:&nbsp;#fff;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;th&nbsp;{&nbsp;text-align:&nbsp;left;&nbsp;font-weight:&nbsp;normal;&nbsp;padding:&nbsp;0.2em&nbsp;0.5em;&nbsp;border-top:&nbsp;1px&nbsp;dotted&nbsp;#fa0;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;td&nbsp;{&nbsp;text-align:&nbsp;right;&nbsp;border-top:&nbsp;1px&nbsp;dotted&nbsp;#fa0;&nbsp;padding:&nbsp;0.2em&nbsp;0.5em;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;thead&nbsp;th&nbsp;{&nbsp;text-align:&nbsp;center;&nbsp;border-bottom:&nbsp;1px&nbsp;solid&nbsp;#fa0;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;th.Corner&nbsp;{&nbsp;text-align:&nbsp;left;&nbsp;}<br>
#logmsg&nbsp;hr&nbsp;{&nbsp;border:&nbsp;none&nbsp;0;&nbsp;border-top:&nbsp;2px&nbsp;dashed&nbsp;#fa0;&nbsp;height:&nbsp;1px;&nbsp;}<br>
#header,&nbsp;#footer&nbsp;{&nbsp;color:&nbsp;#fff;&nbsp;background:&nbsp;#636;&nbsp;border:&nbsp;1px&nbsp;#300&nbsp;solid;&nbsp;padding:&nbsp;6px;&nbsp;}<br>
#patch&nbsp;{&nbsp;width:&nbsp;100%;&nbsp;}<br>
#patch&nbsp;h4&nbsp;{font-family:&nbsp;verdana,arial,helvetica,sans-serif;font-size:10pt;padding:8px;background:#369;color:#fff;margin:0;}<br>
#patch&nbsp;.propset&nbsp;h4,&nbsp;#patch&nbsp;.binary&nbsp;h4&nbsp;{margin:0;}<br>
#patch&nbsp;pre&nbsp;{padding:0;line-height:1.2em;margin:0;}<br>
#patch&nbsp;.diff&nbsp;{width:100%;background:#eee;padding:&nbsp;0&nbsp;0&nbsp;10px&nbsp;0;overflow:auto;}<br>
#patch&nbsp;.propset&nbsp;.diff,&nbsp;#patch&nbsp;.binary&nbsp;.diff&nbsp;&nbsp;{padding:10px&nbsp;0;}<br>
#patch&nbsp;span&nbsp;{display:block;padding:0&nbsp;10px;}<br>
#patch&nbsp;.modfile,&nbsp;#patch&nbsp;.addfile,&nbsp;#patch&nbsp;.delfile,&nbsp;#patch&nbsp;.propset,&nbsp;#patch&nbsp;.binary,&nbsp;#patch&nbsp;.copfile&nbsp;{border:1px&nbsp;solid&nbsp;#ccc;margin:10px&nbsp;0;}<br>
#patch&nbsp;ins&nbsp;{background:#dfd;text-decoration:none;display:block;padding:0&nbsp;10px;}<br>
#patch&nbsp;del&nbsp;{background:#fdd;text-decoration:none;display:block;padding:0&nbsp;10px;}<br>
#patch&nbsp;.lines,&nbsp;.info&nbsp;{color:#888;background:#fff;}<br>
--&gt;&lt;/style&gt;<br>
&lt;div&nbsp;id=&quot;msg&quot;&gt;<br>
&lt;dl&nbsp;class=&quot;meta&quot;&gt;<br>
&lt;dt&gt;Revision&lt;/dt&gt;&nbsp;&lt;dd&gt;&lt;a&nbsp;href=&quot;http://sources.forgerock.org/changelog/commons/?cs=3054&quot;&gt;3054&lt;/a&gt;&lt;/dd&gt;<br>
&lt;dt&gt;Author&lt;/dt&gt;&nbsp;&lt;dd&gt;phillcunnington&lt;/dd&gt;<br>
&lt;dt&gt;Date&lt;/dt&gt;&nbsp;&lt;dd&gt;2015-03-23&nbsp;12:21:12&nbsp;+0000&nbsp;(Mon,&nbsp;23&nbsp;Mar&nbsp;2015)&lt;/dd&gt;<br>
&lt;/dl&gt;<br>
<br>
&lt;h3&gt;Log&nbsp;Message&lt;/h3&gt;<br>
&lt;pre&gt;Moving&nbsp;all&nbsp;framework&nbsp;related&nbsp;classes&nbsp;to&nbsp;the&nbsp;same&nbsp;package&lt;/pre&gt;<br>
<br>
&lt;h3&gt;Modified&nbsp;Paths&lt;/h3&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestProtectedResourcejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingSessionAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleOnejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleTwojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesFailureAuditingAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesSessionAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeGuiceModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeTestAuditApijava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestAuditApi.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeTestContextFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainwebappWEBINFwebxml&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwaIWAModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwawdssoWDSSOjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrcmainjavaorgforgerockjaspimodulessessionjwtJwtSessionModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrctestjavaorgforgerockjaspimodulessessionjwtJwtSessionModuleTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamOpenAMSessionModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamRestletRestClientjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidOpenIdConnectModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversJWKOpenIdResolverImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversPublicKeyOpenIdResolverImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversSharedSecretOpenIdResolverImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversWellKnownOpenIdConfigurationFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceConfiguratorImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;h3&gt;Added&nbsp;Paths&lt;/h3&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuditApijava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditApi.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuditTrailjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthStatusUtilsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletCallbackHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkResourceExceptionHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuditTrailTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuditTrailTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkContextHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkHttpServletCallbackHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfoTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;h3&gt;Removed&nbsp;Paths&lt;/h3&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiJaspiRuntimeFilterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/JaspiRuntimeFilter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspicontextFallbackServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/FallbackServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspicontextpackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiexceptionspackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/exceptions/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspipackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuditApijava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditApi.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuditTrailjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditTrail.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuthStatusUtilsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuthStatusUtils.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeContextFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ContextFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeHttpServletCallbackHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeHttpServletMessageInfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletMessageInfo.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeJaspiRuntimejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/JaspiRuntime.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeResourceExceptionHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ResourceExceptionHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeRuntimeResultHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/RuntimeResultHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextContextHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/ContextHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextJaspiServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextpackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimepackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseFailureResponseHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/FailureResponseHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiHttpServletResponseWrapperjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapper.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiPrintWriterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiServletOutputStreamjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStream.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponsepackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiutilsMessageInfoUtilsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/MessageInfoUtils.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiutilspackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiJaspiRuntimeFilterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/JaspiRuntimeFilterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspicontextFallbackServerAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/context/FallbackServerAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeAuditTrailTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/AuditTrailTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeHttpServletCallbackHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeHttpServletMessageInfoTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletMessageInfoTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeJaspiRuntimeTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/JaspiRuntimeTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeRuntimeResultHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/RuntimeResultHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimecontextContextHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/ContextHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimecontextJaspiServerAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseFailureResponseHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/FailureResponseHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiHttpServletResponseWrapperTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapperTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiPrintWriterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiServletOutputStreamTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStreamTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiutilsMessageInfoUtilsTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/utils/MessageInfoUtilsTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;patch&quot;&gt;<br>
&lt;h3&gt;Diff&lt;/h3&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestProtectedResourcejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,13&nbsp;+11,13&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
-import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.servlet.ServletException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.servlet.http.HttpServlet;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-26,8&nbsp;+26,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.io.IOException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
+import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;protected&nbsp;resource&nbsp;which&nbsp;will&nbsp;set&nbsp;a&nbsp;header&nbsp;on&nbsp;the&nbsp;response&nbsp;to&nbsp;signify&nbsp;that&nbsp;it&nbsp;has&nbsp;been&nbsp;called&nbsp;and&nbsp;write&nbsp;a&nbsp;JSON<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,11&nbsp;+11,15&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_INFO_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne.AUTH_MODULE_ONE_PRINCIPAL;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-28,10&nbsp;+32,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_INFO_KEY;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne.AUTH_MODULE_ONE_PRINCIPAL;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;attempts&nbsp;to&nbsp;audit&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingSessionAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,11&nbsp;+11,15&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_INFO_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.SESSION_MODULE_PRINCIPAL;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-28,10&nbsp;+32,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.SESSION_MODULE_PRINCIPAL;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_INFO_KEY;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;audits&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleOnejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,12&nbsp;+11,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-30,7&nbsp;+30,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleTwojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,12&nbsp;+11,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-30,7&nbsp;+30,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesFailureAuditingAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,11&nbsp;+11,13&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_FAILURE_REASON_KEY;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-28,8&nbsp;+30,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Collections;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_FAILURE_REASON_KEY;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;attempts&nbsp;to&nbsp;audit&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesSessionAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,12&nbsp;+11,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-30,7&nbsp;+30,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;test&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeGuiceModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-32,13&nbsp;+32,13&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.AbstractModule;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.Injector;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.Provides;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuditApi;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.ContextFactory;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.ContextHandler;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.FallbackServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.MessageInfoUtils;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authn.test.configuration.ConfigurationResource;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.RootContext;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.context.FallbackServerAuthContext;<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditApi;<br>
-import&nbsp;org.forgerock.jaspi.runtime.ContextFactory;<br>
-import&nbsp;org.forgerock.jaspi.runtime.context.ContextHandler;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.Resource;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.ResourceException;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeTestAuditApijava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestAuditApi.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestAuditApi.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestAuditApi.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,19&nbsp;+11,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.runtime;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.List;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.Singleton;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuditApi;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.guice.core.InjectorHolder;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.AuditApi;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.List;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Test&nbsp;implementation&nbsp;of&nbsp;the&nbsp;JASPI&nbsp;runtime's&nbsp;{@code&nbsp;AuditApi}&nbsp;interface.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeTestContextFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,19&nbsp;+11,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.runtime;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;javax.inject.Singleton;<br>
+import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.Key;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.name.Names;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.ContextFactory;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.guice.core.InjectorHolder;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.ContextFactory;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.inject.Singleton;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Test&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Jaspi&nbsp;runtime's&nbsp;{@code&nbsp;ContextFactory}&nbsp;interface.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainwebappWEBINFwebxml&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-19,7&nbsp;+19,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-name&amp;gt;JaspiFilter&amp;lt;/filter-name&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-class&amp;gt;org.forgerock.jaspi.JaspiRuntimeFilter&amp;lt;/filter-class&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-class&amp;gt;org.forgerock.caf.authentication.framework.JaspiRuntimeFilter&amp;lt;/filter-class&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;init-param&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;param-name&amp;gt;context-factory-class&amp;lt;/param-name&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;param-value&amp;gt;org.forgerock.caf.authn.test.runtime.TestContextFactory&amp;lt;/param-value&amp;gt;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwaIWAModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,12&nbsp;+11,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.iwa;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.modules.iwa.wdsso.WDSSO;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-31,7&nbsp;+31,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.jaspi.modules.iwa.wdsso.WDSSO;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Authentication&nbsp;module&nbsp;that&nbsp;uses&nbsp;IWA&nbsp;for&nbsp;authentication.<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwawdssoWDSSOjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-27,16&nbsp;+27,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Portions&nbsp;Copyrighted&nbsp;2011-2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Portions&nbsp;Copyrighted&nbsp;2011-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.iwa.wdsso;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.ietf.jgss.GSSContext;<br>
-import&nbsp;org.ietf.jgss.GSSCredential;<br>
-import&nbsp;org.ietf.jgss.GSSException;<br>
-import&nbsp;org.ietf.jgss.GSSManager;<br>
-import&nbsp;org.ietf.jgss.GSSName;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.login.Configuration;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-52,7&nbsp;+48,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Set;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.ietf.jgss.GSSContext;<br>
+import&nbsp;org.ietf.jgss.GSSCredential;<br>
+import&nbsp;org.ietf.jgss.GSSException;<br>
+import&nbsp;org.ietf.jgss.GSSManager;<br>
+import&nbsp;org.ietf.jgss.GSSName;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;class&nbsp;WDSSO&nbsp;/*extends&nbsp;AMLoginModule*/&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrcmainjavaorgforgerockjaspimodulessessionjwtJwtSessionModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,9&nbsp;+16,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.jwt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.http.Cookie.*;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.Callback;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-45,8&nbsp;+45,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Set;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.UUID;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.http.Cookie;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.builders.JwtBuilderFactory;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.exceptions.JweDecryptionException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jwe.EncryptedJwt;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrctestjavaorgforgerockjaspimodulessessionjwtJwtSessionModuleTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,22&nbsp;+16,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.jwt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
-import&nbsp;org.forgerock.json.jose.builders.EncryptedJwtBuilder;<br>
-import&nbsp;org.forgerock.json.jose.builders.JweHeaderBuilder;<br>
-import&nbsp;org.forgerock.json.jose.builders.JwtBuilderFactory;<br>
-import&nbsp;org.forgerock.json.jose.builders.JwtClaimsSetBuilder;<br>
-import&nbsp;org.forgerock.json.jose.exceptions.JweDecryptionException;<br>
-import&nbsp;org.forgerock.json.jose.jwe.EncryptedJwt;<br>
-import&nbsp;org.forgerock.json.jose.jwe.EncryptionMethod;<br>
-import&nbsp;org.forgerock.json.jose.jwe.JweAlgorithm;<br>
-import&nbsp;org.forgerock.json.jose.jwt.Algorithm;<br>
-import&nbsp;org.forgerock.json.jose.jwt.Jwt;<br>
-import&nbsp;org.forgerock.json.jose.jwt.JwtClaimsSet;<br>
-import&nbsp;org.mockito.ArgumentCaptor;<br>
-import&nbsp;org.mockito.Matchers;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.Callback;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-55,11&nbsp;+44,22&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.HashMap;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
+import&nbsp;org.forgerock.json.jose.builders.EncryptedJwtBuilder;<br>
+import&nbsp;org.forgerock.json.jose.builders.JweHeaderBuilder;<br>
+import&nbsp;org.forgerock.json.jose.builders.JwtBuilderFactory;<br>
+import&nbsp;org.forgerock.json.jose.builders.JwtClaimsSetBuilder;<br>
+import&nbsp;org.forgerock.json.jose.exceptions.JweDecryptionException;<br>
+import&nbsp;org.forgerock.json.jose.jwe.EncryptedJwt;<br>
+import&nbsp;org.forgerock.json.jose.jwe.EncryptionMethod;<br>
+import&nbsp;org.forgerock.json.jose.jwe.JweAlgorithm;<br>
+import&nbsp;org.forgerock.json.jose.jwt.Algorithm;<br>
+import&nbsp;org.forgerock.json.jose.jwt.Jwt;<br>
+import&nbsp;org.forgerock.json.jose.jwt.JwtClaimsSet;<br>
+import&nbsp;org.mockito.ArgumentCaptor;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;class&nbsp;JwtSessionModuleTest&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamOpenAMSessionModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.openam;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.Callback;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamRestletRestClientjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,11&nbsp;+11,18&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.openam;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
+<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.util.Map;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.fasterxml.jackson.databind.ObjectMapper;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.ResourceException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-28,13&nbsp;+35,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.restlet.resource.ClientResource;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.restlet.util.Series;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Simple&nbsp;REST&nbsp;client&nbsp;implemented&nbsp;using&nbsp;Restlet.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidOpenIdConnectModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,21&nbsp;+11,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.OpenIdConnectVerificationException;<br>
-import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.OpenIdResolver;<br>
-import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverService;<br>
-import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverServiceConfigurator;<br>
-import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverServiceConfiguratorImpl;<br>
-import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverServiceImpl;<br>
-import&nbsp;org.forgerock.json.jose.common.JwtReconstruction;<br>
-import&nbsp;org.forgerock.json.jose.exceptions.InvalidJwtException;<br>
-import&nbsp;org.forgerock.json.jose.exceptions.JwtReconstructionException;<br>
-import&nbsp;org.forgerock.json.jose.jws.SignedJwt;<br>
-import&nbsp;org.forgerock.json.jose.jwt.JwtClaimsSet;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.Callback;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-43,7&nbsp;+34,17&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.List;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.OpenIdConnectVerificationException;<br>
+import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.OpenIdResolver;<br>
+import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverService;<br>
+import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverServiceConfigurator;<br>
+import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverServiceConfiguratorImpl;<br>
+import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service.OpenIdResolverServiceImpl;<br>
+import&nbsp;org.forgerock.json.jose.common.JwtReconstruction;<br>
+import&nbsp;org.forgerock.json.jose.exceptions.InvalidJwtException;<br>
+import&nbsp;org.forgerock.json.jose.exceptions.JwtReconstructionException;<br>
+import&nbsp;org.forgerock.json.jose.jws.SignedJwt;<br>
+import&nbsp;org.forgerock.json.jose.jwt.JwtClaimsSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;OpenID&nbsp;Connect&nbsp;module&nbsp;that&nbsp;allows&nbsp;access&nbsp;when&nbsp;a&nbsp;valid&nbsp;OpenID&nbsp;Connect&nbsp;JWT&nbsp;which<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversJWKOpenIdResolverImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,10&nbsp;+11,18&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+<br>
+import&nbsp;java.net.URL;<br>
+import&nbsp;java.security.Key;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.FailedToLoadJWKException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.InvalidSignatureException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.OpenIdConnectVerificationException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-23,13&nbsp;+31,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jws.SignedJwt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jws.SigningManager;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.net.URL;<br>
-import&nbsp;java.security.Key;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;This&nbsp;class&nbsp;exists&nbsp;to&nbsp;allow&nbsp;Open&nbsp;Id&nbsp;Providers&nbsp;to&nbsp;supply&nbsp;or&nbsp;promote&nbsp;a&nbsp;JWK&nbsp;exposure&nbsp;point&nbsp;for<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;their&nbsp;public&nbsp;keys.&nbsp;We&nbsp;convert&nbsp;the&nbsp;exposed&nbsp;keys&nbsp;they&nbsp;provide&nbsp;according&nbsp;to&nbsp;the&nbsp;algorithm<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversPublicKeyOpenIdResolverImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,20&nbsp;+11,20&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+<br>
+import&nbsp;java.security.PublicKey;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.InvalidSignatureException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.OpenIdConnectVerificationException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jws.SignedJwt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jws.SigningManager;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.security.PublicKey;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;This&nbsp;class&nbsp;exists&nbsp;to&nbsp;allow&nbsp;functionality&nbsp;for&nbsp;those&nbsp;Open&nbsp;ID&nbsp;Connect&nbsp;providers&nbsp;which<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;supply&nbsp;their&nbsp;signatures&nbsp;through&nbsp;asymmetric&nbsp;key&nbsp;algorithms&nbsp;(e.g.&nbsp;RSA).&nbsp;In&nbsp;these&nbsp;cases<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversSharedSecretOpenIdResolverImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,19&nbsp;+11,20&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+<br>
+import&nbsp;java.nio.charset.Charset;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.InvalidSignatureException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.OpenIdConnectVerificationException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jws.SignedJwt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.jws.SigningManager;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.nio.charset.Charset;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;This&nbsp;class&nbsp;exists&nbsp;to&nbsp;allow&nbsp;functionality&nbsp;for&nbsp;those&nbsp;Open&nbsp;ID&nbsp;Connect&nbsp;providers&nbsp;which<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;supply&nbsp;their&nbsp;signatures&nbsp;through&nbsp;symmetric&nbsp;key&nbsp;algorithms&nbsp;(e.g.&nbsp;HMAC).&nbsp;In&nbsp;these&nbsp;cases<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversWellKnownOpenIdConfigurationFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,21&nbsp;+11,22&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.FailedToLoadJWKException;<br>
-import&nbsp;org.forgerock.jaspi.modules.openid.helpers.SimpleHTTPClient;<br>
-import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
-import&nbsp;org.forgerock.json.jose.utils.Utils;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.io.IOException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.MalformedURLException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.URL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.jaspi.modules.openid.exceptions.FailedToLoadJWKException;<br>
+import&nbsp;org.forgerock.jaspi.modules.openid.helpers.SimpleHTTPClient;<br>
+import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
+import&nbsp;org.forgerock.json.jose.utils.Utils;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;This&nbsp;class&nbsp;creates&nbsp;JWKOpenIdResolverImpl's&nbsp;from&nbsp;a&nbsp;supplied<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceConfiguratorImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,18&nbsp;+11,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.OpenIdResolver;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.MalformedURLException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.URL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.List;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.jaspi.modules.openid.resolvers.OpenIdResolver;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Implementation&nbsp;of&nbsp;the&nbsp;{@link&nbsp;OpenIdResolverServiceConfigurator}&nbsp;interface&nbsp;which<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.URL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.PublicKey;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuditApijavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuditApijava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditApi.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditApi.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditApi.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditApi.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,87&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Audit&nbsp;API&nbsp;interface&nbsp;for&nbsp;auditing&nbsp;the&nbsp;result&nbsp;of&nbsp;an&nbsp;authentication&nbsp;request.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
+&nbsp;*/<br>
+public&nbsp;interface&nbsp;AuditApi&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Audits&nbsp;the&nbsp;authentication&nbsp;request,&nbsp;using&nbsp;the&nbsp;audit&nbsp;information&nbsp;from&nbsp;the&nbsp;given&nbsp;audit&nbsp;message.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;For&nbsp;successful&nbsp;authentications:&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;requestId&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;[<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;demo&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;],<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;context&amp;quot;:&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;sessionId&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;entries&amp;quot;:&nbsp;[<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;moduleId&amp;quot;:&nbsp;&amp;quot;Session-JwtSessionModule&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;info&amp;quot;:&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;&amp;quot;alice&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;...&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;]<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;For&nbsp;failed&nbsp;authentications:&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;FAILED&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;requestId&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;[<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;demo&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;//Multiple&nbsp;auth&nbsp;modules&nbsp;could&nbsp;identify&nbsp;different&nbsp;principals<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;],<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;context&amp;quot;:&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;entries&amp;quot;:&nbsp;[<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;moduleId&amp;quot;:&nbsp;&amp;quot;Session-JwtSessionModule&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;FAILED&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;reason&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;info&amp;quot;:&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;&amp;quot;bob&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;...&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;]<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditMessage&nbsp;The&nbsp;audit&nbsp;message.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;audit(JsonValue&nbsp;auditMessage);<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuditTrailjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuditTrailjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditTrail.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,218&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
+<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+import&nbsp;java.util.UUID;<br>
+<br>
+import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Is&nbsp;responsible&nbsp;for&nbsp;tracking&nbsp;the&nbsp;auditing&nbsp;of&nbsp;an&nbsp;authentication&nbsp;attempt&nbsp;including&nbsp;auditing&nbsp;each&nbsp;of&nbsp;the&nbsp;modules&nbsp;that<br>
+&nbsp;*&nbsp;are&nbsp;executed&nbsp;and&nbsp;the&nbsp;overall&nbsp;result&nbsp;of&nbsp;the&nbsp;authentication.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;audit&nbsp;record&nbsp;will&nbsp;include&nbsp;a&nbsp;unique&nbsp;request&nbsp;id,&nbsp;the&nbsp;principal&nbsp;(if&nbsp;authentication&nbsp;was&nbsp;successful)&nbsp;and&nbsp;a&nbsp;session<br>
+&nbsp;*&nbsp;id&nbsp;(if&nbsp;a&nbsp;session&nbsp;was&nbsp;created).&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;AuditTrail&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;retrieving&nbsp;the&nbsp;audit&nbsp;trail&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_TRAIL_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;additional&nbsp;audit&nbsp;information&nbsp;from&nbsp;a&nbsp;module.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_INFO_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.info&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;principal&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;has&nbsp;identified&nbsp;that&nbsp;will&nbsp;be&nbsp;set&nbsp;in&nbsp;the&nbsp;audit<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;log&nbsp;entry.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_PRINCIPAL_KEY&nbsp;=&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;session&nbsp;id&nbsp;for&nbsp;the&nbsp;authentication&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_SESSION_ID_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.session.id&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;reason&nbsp;for&nbsp;the&nbsp;module&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_FAILURE_REASON_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.failure.reason&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;MODULE_ID_KEY&nbsp;=&nbsp;&amp;quot;moduleId&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;RESULT_KEY&nbsp;=&nbsp;&amp;quot;result&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;PRINCIPAL_KEY&nbsp;=&nbsp;&amp;quot;principal&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;CONTEXT_KEY&nbsp;=&nbsp;&amp;quot;context&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;SESSION_ID_KEY&nbsp;=&nbsp;&amp;quot;sessionId&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;REQUEST_ID_KEY&nbsp;=&nbsp;&amp;quot;requestId&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;ENTRIES_KEY&nbsp;=&nbsp;&amp;quot;entries&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;REASON_KEY&nbsp;=&nbsp;&amp;quot;reason&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INFO_KEY&nbsp;=&nbsp;&amp;quot;info&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;SUCCESSFUL_RESULT&nbsp;=&nbsp;&amp;quot;SUCCESSFUL&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;FAILED_RESULT&nbsp;=&nbsp;&amp;quot;FAILED&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuditApi&nbsp;api;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;entries&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;json(object(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(REQUEST_ID_KEY,&nbsp;UUID.randomUUID().toString()),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(ENTRIES_KEY,&nbsp;entries)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;AuditTrail&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;api&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditApi}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuditTrail(AuditApi&nbsp;api,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.api&nbsp;=&nbsp;api;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(CONTEXT_KEY,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Audits&nbsp;a&nbsp;module&nbsp;as&nbsp;having&nbsp;completed&nbsp;successfully.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;id&nbsp;of&nbsp;the&nbsp;module.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;info&nbsp;The&nbsp;module&nbsp;audit&nbsp;info&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditSuccess(String&nbsp;moduleId,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;info)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries.add(json(object(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(MODULE_ID_KEY,&nbsp;moduleId),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(RESULT_KEY,&nbsp;SUCCESSFUL_RESULT),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(INFO_KEY,&nbsp;info))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).asMap());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Audits&nbsp;a&nbsp;module&nbsp;as&nbsp;having&nbsp;completed&nbsp;as&nbsp;a&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;id&nbsp;of&nbsp;the&nbsp;module.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;reason&nbsp;The&nbsp;reason&nbsp;the&nbsp;module&nbsp;is&nbsp;reporting&nbsp;a&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;info&nbsp;The&nbsp;module&nbsp;audit&nbsp;info&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditFailure(String&nbsp;moduleId,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;reason,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;info)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries.add(json(object(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(MODULE_ID_KEY,&nbsp;moduleId),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(RESULT_KEY,&nbsp;FAILED_RESULT),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(REASON_KEY,&nbsp;reason),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(INFO_KEY,&nbsp;info))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).asMap());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Completes&nbsp;the&nbsp;entire&nbsp;audit&nbsp;record&nbsp;as&nbsp;successful.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;principal&nbsp;The&nbsp;principal.&nbsp;Must&nbsp;have&nbsp;been&nbsp;set&nbsp;by&nbsp;the&nbsp;successful&nbsp;module.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;completeAuditAsSuccessful(String&nbsp;principal)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(RESULT_KEY,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;).put(PRINCIPAL_KEY,&nbsp;array(principal));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Completes&nbsp;the&nbsp;entire&nbsp;audit&nbsp;record&nbsp;as&nbsp;a&nbsp;failure.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;No&nbsp;auth&nbsp;module&nbsp;successfully&nbsp;completed&nbsp;so&nbsp;will&nbsp;check&nbsp;each&nbsp;auth&nbsp;module&nbsp;entry's&nbsp;audit&nbsp;info&nbsp;map&nbsp;for&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#AUDIT_PRINCIPAL_KEY}&nbsp;key&nbsp;and&nbsp;will&nbsp;created&nbsp;an&nbsp;ordered&nbsp;list&nbsp;of&nbsp;all&nbsp;non-null&nbsp;principal&nbsp;values.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;completeAuditAsFailure()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;principals&nbsp;=&nbsp;array();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;entry&nbsp;:&nbsp;entries)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entry.get(INFO_KEY);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditInfo&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;auditInfo.get(AUDIT_PRINCIPAL_KEY);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principals.add(principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(RESULT_KEY,&nbsp;&amp;quot;FAILED&amp;quot;).put(PRINCIPAL_KEY,&nbsp;principals);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Performs&nbsp;the&nbsp;actual&nbsp;audit&nbsp;by&nbsp;calling&nbsp;the&nbsp;{@link&nbsp;AuditApi#audit(JsonValue)}&nbsp;with&nbsp;the&nbsp;audit&nbsp;record.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;audit()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;api.audit(auditMessage);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;session&nbsp;id&nbsp;on&nbsp;the&nbsp;audit&nbsp;record,&nbsp;if&nbsp;a&nbsp;session&nbsp;has&nbsp;been&nbsp;created.&nbsp;Will&nbsp;not&nbsp;set&nbsp;the&nbsp;session&nbsp;id&nbsp;on&nbsp;the&nbsp;audit<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;record&nbsp;if&nbsp;it&nbsp;is&nbsp;{@code&nbsp;null}&nbsp;or&nbsp;an&nbsp;empty&nbsp;{@code&nbsp;String}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionId&nbsp;The&nbsp;session&nbsp;id.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setSessionId(String&nbsp;sessionId)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionId&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!sessionId.isEmpty())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(SESSION_ID_KEY,&nbsp;sessionId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;request&nbsp;id.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;request&nbsp;id.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;getRequestId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;auditMessage.get(REQUEST_ID_KEY).asString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;list&nbsp;of&nbsp;failure&nbsp;reasons&nbsp;from&nbsp;each&nbsp;of&nbsp;the&nbsp;module&nbsp;entries.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;failure&nbsp;reasons&nbsp;as&nbsp;{@code&nbsp;Map}s&nbsp;of&nbsp;{@code&nbsp;String}&nbsp;to&nbsp;{@code&nbsp;Object}s.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;getFailureReasons()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasons&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;entry&nbsp;:&nbsp;entries)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entry.get(REASON_KEY);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;==&nbsp;null&nbsp;||&nbsp;failureReason.isEmpty())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReasons.add(failureReason);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;failureReasons;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;auditMessage.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthStatusUtilsjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuthStatusUtilsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuthStatusUtils.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,107&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.*;<br>
+<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Utility&nbsp;class&nbsp;providing&nbsp;utility&nbsp;methods&nbsp;for&nbsp;determining&nbsp;the&nbsp;meaning&nbsp;behind&nbsp;each&nbsp;of&nbsp;the&nbsp;different&nbsp;{@link&nbsp;AuthStatus}<br>
+&nbsp;*&nbsp;values.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
+&nbsp;*/<br>
+public&nbsp;final&nbsp;class&nbsp;AuthStatusUtils&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Private&nbsp;utility&nbsp;constructor.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthStatusUtils()&nbsp;{&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Converts&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;into&nbsp;its&nbsp;{@code&nbsp;String}&nbsp;representation.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;String.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;String&nbsp;asString(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SUCCESS&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;FAILURE&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendContinue(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SEND_CONTINUE&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SEND_FAILURE&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SEND_SUCCESS&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;null&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SUCCESS}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SUCCESS}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SUCCESS.equals(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSendSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_SUCCESS.equals(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_CONTINUE}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_CONTINUE}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;boolean&nbsp;isSendContinue(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_CONTINUE.equals(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSendFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_FAILURE.equals(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#FAILURE}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#FAILURE}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FAILURE.equals(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextFactoryjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeContextFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ContextFactory.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,36&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;A&nbsp;factory&nbsp;which&nbsp;is&nbsp;responsible&nbsp;for&nbsp;creating&nbsp;{@code&nbsp;ServerAuthContext}s&nbsp;for&nbsp;authenticating&nbsp;requests.<br>
+&nbsp;*/<br>
+public&nbsp;interface&nbsp;ContextFactory&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Returns&nbsp;the&nbsp;context&nbsp;which&nbsp;should&nbsp;be&nbsp;used&nbsp;to&nbsp;authenticate&nbsp;requests.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;method&nbsp;is&nbsp;called&nbsp;for&nbsp;each&nbsp;request.&nbsp;This&nbsp;means&nbsp;that&nbsp;the&nbsp;{@code&nbsp;ServerAuthContext}&nbsp;instance&nbsp;can&nbsp;be<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;changed/updated&nbsp;with&nbsp;new&nbsp;ServerAuthModules&nbsp;and&nbsp;any&nbsp;changes&nbsp;will&nbsp;be&nbsp;picked&nbsp;up&nbsp;by&nbsp;the&nbsp;runtime&nbsp;for&nbsp;subsequent<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;requests.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;context&nbsp;which&nbsp;should&nbsp;be&nbsp;used&nbsp;for&nbsp;authenticating&nbsp;requests.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;getContext();<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextHandlerjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextContextHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/ContextHandler.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,157&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.security.Principal;<br>
+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;A&nbsp;handler&nbsp;for&nbsp;ServerAuthContext,&nbsp;which&nbsp;exposes&nbsp;helper&nbsp;methods&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;at&nbsp;the&nbsp;varying&nbsp;end&nbsp;states<br>
+&nbsp;*&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;processing.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;ContextHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constant&nbsp;for&nbsp;the&nbsp;list&nbsp;of&nbsp;auth&nbsp;module&nbsp;failure&nbsp;reasons.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;FAILURE_REASONS&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ContextHandler(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Validates&nbsp;that&nbsp;each&nbsp;given&nbsp;ServerAuthModule&nbsp;conforms&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile&nbsp;by&nbsp;calling&nbsp;each<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;modules&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;and&nbsp;ensuring&nbsp;it&nbsp;contains&nbsp;both&nbsp;the&nbsp;HttpServletRequest&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;HttpServletResponse&nbsp;classes.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;List&nbsp;of&nbsp;ServerAuthModules&nbsp;to&nbsp;check.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;ServerAuthModules&nbsp;does&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;HttpServlet&nbsp;Profile.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModuleConformToHttpServletProfile(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkAuthModuleSupportsHttpServletProfile(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Validates&nbsp;that&nbsp;the&nbsp;given&nbsp;ServerAuthModule&nbsp;conforms&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile&nbsp;by&nbsp;calling&nbsp;the&nbsp;module's<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;and&nbsp;ensuring&nbsp;it&nbsp;contains&nbsp;both&nbsp;the&nbsp;HttpServletRequest&nbsp;and&nbsp;HttpServletResponse<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;classes.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;ServerAuthModule&nbsp;to&nbsp;check.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;the&nbsp;ServerAuthModule&nbsp;does&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;HttpServlet&nbsp;Profile.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;checkAuthModuleSupportsHttpServletProfile(final&nbsp;ServerAuthModule&nbsp;authModule)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;gt;&nbsp;supportedTypes&nbsp;=&nbsp;Arrays.asList(authModule.getSupportedMessageTypes());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(supportedTypes.contains(HttpServletRequest.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;amp;&amp;amp;&nbsp;supportedTypes.contains(HttpServletResponse.class)))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;ServerAuthModule&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;HttpServlet&nbsp;profile,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModule.getClass().getName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;ServerAuthModule&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;HttpServlet&nbsp;profile,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModule.getClass().getName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;completion&nbsp;of&nbsp;an&nbsp;authentication&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Checks&nbsp;if&nbsp;the&nbsp;authentication&nbsp;resulted&nbsp;in&nbsp;a&nbsp;valid&nbsp;AuthStatus&nbsp;and&nbsp;if&nbsp;not&nbsp;will&nbsp;write&nbsp;a&nbsp;401&nbsp;Unauthorized&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;the&nbsp;HttpServletResponse&nbsp;stored&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;object.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Otherwise&nbsp;will&nbsp;set&nbsp;the&nbsp;authentication&nbsp;attributes,&nbsp;principal&nbsp;name&nbsp;and&nbsp;authentication&nbsp;context&nbsp;map,&nbsp;in&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;HttpServletRequest.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;object.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;Client&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;AuthStatus&nbsp;of&nbsp;the&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;problem&nbsp;writing&nbsp;to&nbsp;the&nbsp;response.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleCompletion(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;authStatus)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Authentication&nbsp;has&nbsp;failed.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(UNAUTHORIZED_HTTP_ERROR_CODE,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNAUTHORIZED_ERROR_MESSAGE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(jre);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setAuthenticationRequestAttributes(messageInfo,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;authentication&nbsp;id&nbsp;and&nbsp;context&nbsp;map&nbsp;into&nbsp;the&nbsp;HttpServletRequest,&nbsp;as&nbsp;attributes,&nbsp;for&nbsp;use&nbsp;by&nbsp;other<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;filters&nbsp;and&nbsp;resources.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Will&nbsp;take&nbsp;the&nbsp;first&nbsp;Principal&nbsp;it&nbsp;finds&nbsp;in&nbsp;the&nbsp;client&nbsp;Subject&nbsp;and&nbsp;add&nbsp;the&nbsp;Principal's&nbsp;name&nbsp;to&nbsp;the&nbsp;authentication<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;context.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;object.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;Client&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;setAuthenticationRequestAttributes(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principalName&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principalName&nbsp;=&nbsp;principal.getName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Setting&nbsp;principal&nbsp;name,&nbsp;{},&nbsp;and&nbsp;{}&nbsp;context&nbsp;values&nbsp;on&nbsp;to&nbsp;the&nbsp;request.&amp;quot;,&nbsp;principalName,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.size());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;principalName);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;context);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseFailureResponseHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/FailureResponseHandler.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,148&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.math.BigDecimal;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.Comparator;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.SortedSet;<br>
+import&nbsp;java.util.TreeSet;<br>
+import&nbsp;java.util.regex.Matcher;<br>
+import&nbsp;java.util.regex.Pattern;<br>
+<br>
+import&nbsp;com.fasterxml.jackson.databind.ObjectMapper;<br>
+import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;A&nbsp;handler&nbsp;class&nbsp;for&nbsp;rendering&nbsp;failures&nbsp;in&nbsp;the&nbsp;most&nbsp;acceptable&nbsp;supported&nbsp;content&nbsp;type.<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;FailureResponseHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;ObjectMapper&nbsp;OBJECT_MAPPER&nbsp;=&nbsp;new&nbsp;ObjectMapper();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;Pattern&nbsp;ACCEPT_HEADER&nbsp;=&nbsp;Pattern.compile(&amp;quot;(?:(?:[^\&amp;quot;,]*|(?:.*[^\\\\]\&amp;quot;.*[^\\\\]\&amp;quot;.*)))(&nbsp;*,&nbsp;*)&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;MediaType&nbsp;WILDCARD&nbsp;=&nbsp;MediaType.parse(&amp;quot;*/*&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;QUALITY_PARAMETER&nbsp;=&nbsp;&amp;quot;q&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;Comparator&amp;lt;MediaType&amp;gt;&nbsp;ACCEPT_QUALITY_COMPARATOR&nbsp;=&nbsp;new&nbsp;Comparator&amp;lt;MediaType&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;compare(MediaType&nbsp;o1,&nbsp;MediaType&nbsp;o2)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;comparison&nbsp;=&nbsp;getQuality(o2).compareTo(getQuality(o1));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(comparison&nbsp;==&nbsp;0)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Wildcards&nbsp;should&nbsp;come&nbsp;after&nbsp;non-wildcards<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comparison&nbsp;=&nbsp;o2.toString().compareTo(o1.toString());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;comparison;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;BigDecimal&nbsp;getQuality(MediaType&nbsp;type)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;String&amp;gt;&nbsp;quality&nbsp;=&nbsp;type.parameters().get(QUALITY_PARAMETER);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;quality.isEmpty()&nbsp;?&nbsp;BigDecimal.ONE&nbsp;:&nbsp;new&nbsp;BigDecimal(quality.get(0));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;ResourceExceptionHandler&amp;gt;&nbsp;handlers&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ResourceExceptionHandler&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;JsonResourceExceptionHandler&nbsp;defaultHandler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FailureResponseHandler()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultHandler&nbsp;=&nbsp;new&nbsp;JsonResourceExceptionHandler();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handlers.add(defaultHandler);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;error.&nbsp;The&nbsp;message's&nbsp;request&nbsp;{@code&nbsp;Accept}&nbsp;header&nbsp;preference&nbsp;is&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;most&nbsp;suitable<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;handler&nbsp;is&nbsp;selected.&nbsp;If&nbsp;no&nbsp;specific&nbsp;handler&nbsp;is&nbsp;found,&nbsp;or&nbsp;if&nbsp;the&nbsp;highest&nbsp;quality&nbsp;accepted&nbsp;content&nbsp;type&nbsp;is<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;\*\/\*},&nbsp;then&nbsp;the&nbsp;{@code&nbsp;JsonResourceExceptionHandler}&nbsp;is&nbsp;used.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;jre<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handle(ResourceException&nbsp;jre,&nbsp;MessageInfo&nbsp;messageInfo)&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(jre.getCode());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;acceptHeader&nbsp;=&nbsp;request.getHeader(&amp;quot;Accept&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(acceptHeader&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SortedSet&amp;lt;MediaType&amp;gt;&nbsp;acceptedTypes&nbsp;=&nbsp;new&nbsp;TreeSet&amp;lt;MediaType&amp;gt;(ACCEPT_QUALITY_COMPARATOR);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matcher&nbsp;m&nbsp;=&nbsp;ACCEPT_HEADER.matcher(acceptHeader);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;lastGroup&nbsp;=&nbsp;0;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(m.find())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptedTypes.add(MediaType.parse(acceptHeader.substring(m.start(),&nbsp;m.start(1))));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastGroup&nbsp;=&nbsp;m.end(1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptedTypes.add(MediaType.parse(acceptHeader.substring(lastGroup)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(MediaType&nbsp;type&nbsp;:&nbsp;acceptedTypes)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType&nbsp;forComparison&nbsp;=&nbsp;type.withoutParameters();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ResourceExceptionHandler&nbsp;handler&nbsp;:&nbsp;handlers)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(MediaType&nbsp;handled&nbsp;:&nbsp;handler.handles())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(handled.is(forComparison))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.write(jre,&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(type.withoutParameters().is(WILDCARD))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultHandler.write(jre,&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;class&nbsp;to&nbsp;handle&nbsp;{@code&nbsp;ResourceException}s.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;handlerClass&nbsp;The&nbsp;implementation&nbsp;class.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;registerExceptionHandler(Class&amp;lt;?&nbsp;extends&nbsp;ResourceExceptionHandler&amp;gt;&nbsp;handlerClass)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handlers.add(handlerClass.newInstance());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(InstantiationException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalArgumentException(&amp;quot;Cannot&nbsp;instantiate&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClass.getName(),&nbsp;e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IllegalAccessException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalArgumentException(&amp;quot;Cannot&nbsp;access&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClass.getName(),&nbsp;e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;default&nbsp;implementation&nbsp;of&nbsp;{@code&nbsp;ResourceExceptionHandler}&nbsp;that&nbsp;renders&nbsp;the&nbsp;exception&nbsp;to&nbsp;JSON.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;class&nbsp;JsonResourceExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;MEDIA_TYPES&nbsp;=&nbsp;Arrays.asList(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType.JSON_UTF_8,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType.JSON_UTF_8.withoutParameters());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;handles()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MEDIA_TYPES;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;jre,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setContentType(&amp;quot;application/json&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setCharacterEncoding(&amp;quot;UTF-8&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_MAPPER.writeValue(response.getWriter(),&nbsp;jre.includeCauseInJsonValue().toJsonValue().asMap());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspicontextFallbackServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/FallbackServerAuthContext.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,203&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.*;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.asString;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;java.util.Collections;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Encapsulates&nbsp;ServerAuthModules&nbsp;that&nbsp;are&nbsp;used&nbsp;to&nbsp;validate&nbsp;service&nbsp;requests&nbsp;received&nbsp;from&nbsp;clients,&nbsp;and&nbsp;to&nbsp;secure&nbsp;any<br>
+&nbsp;*&nbsp;response&nbsp;returned&nbsp;for&nbsp;those&nbsp;requests.<br>
+&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;*&nbsp;This&nbsp;FallbackServerAuthContext&nbsp;can&nbsp;be&nbsp;configured&nbsp;to&nbsp;use&nbsp;a&nbsp;single&nbsp;Session&nbsp;ServerAuthModule,&nbsp;to&nbsp;provide&nbsp;session<br>
+&nbsp;*&nbsp;capabilities&nbsp;(i.e.&nbsp;on&nbsp;secureResponse&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;which&nbsp;is&nbsp;validated&nbsp;on&nbsp;subsequent&nbsp;request&nbsp;to&nbsp;skip&nbsp;re-authenticating<br>
+&nbsp;*&nbsp;for&nbsp;each&nbsp;request),&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;ServerAuthModule&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;in&nbsp;order&nbsp;until&nbsp;one&nbsp;returns&nbsp;a&nbsp;non-failure<br>
+&nbsp;*&nbsp;AuthStatus,&nbsp;or&nbsp;the&nbsp;list&nbsp;is&nbsp;exhausted.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;FallbackServerAuthContext&nbsp;extends&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;String&nbsp;AUTHENTICATING_AUTH_MODULE_KEY&nbsp;=&nbsp;&amp;quot;authenticatingAuthModule&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;FallbackServerAuthContext&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;The&nbsp;configured&nbsp;Session&nbsp;AuthModule.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configure&nbsp;ServerAuthModules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;do&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FallbackServerAuthContext(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule,&nbsp;final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,&nbsp;authModules);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;logic&nbsp;used&nbsp;to&nbsp;determine&nbsp;which&nbsp;of&nbsp;the&nbsp;list&nbsp;of&nbsp;ServerAuthModules&nbsp;are&nbsp;called&nbsp;is&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ol&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Modules&nbsp;are&nbsp;called&nbsp;in&nbsp;insertion&nbsp;order&nbsp;in&nbsp;the&nbsp;list.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SUCCESS&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_SUCCESS&nbsp;the&nbsp;module&nbsp;has&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;and&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_CONTINUE&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;the&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;context&nbsp;will&nbsp;call&nbsp;the&nbsp;next&nbsp;subsequent&nbsp;module.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;modules&nbsp;in&nbsp;the&nbsp;configured&nbsp;list&nbsp;the&nbsp;last&nbsp;AuthStatus&nbsp;is&nbsp;returned&nbsp;and&nbsp;processing<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stops..&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ol&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;index&nbsp;=&nbsp;0;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;&amp;quot;AuthModule-&amp;quot;&nbsp;+&nbsp;authModule.getClass().getSimpleName()&nbsp;+&nbsp;&amp;quot;-&amp;quot;&nbsp;+&nbsp;index++;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;doValidateRequest(authModule,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject,&nbsp;moduleId,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Record&nbsp;the&nbsp;AuthModules&nbsp;AuthStatus&nbsp;to&nbsp;decided&nbsp;later&nbsp;whether&nbsp;to&nbsp;call&nbsp;secureResponse&nbsp;on&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;AuthModule.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authenticatingAuthModule&nbsp;=&nbsp;authModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;put&nbsp;authStatus&nbsp;and&nbsp;authenticatingAuthModule&nbsp;in&nbsp;MessageInfo&nbsp;so&nbsp;can&nbsp;accessed&nbsp;by&nbsp;secureResponse&nbsp;in&nbsp;a<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;stateless&nbsp;way<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Adding&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;to&nbsp;private&nbsp;context&nbsp;map,&nbsp;{}&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authenticatingAuthModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authContextMap&nbsp;=&nbsp;getMessageInfoUtils().getMap(messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIVATE_CONTEXT_MAP_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContextMap.put(AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authenticatingAuthModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;emptyMap(),&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;--&nbsp;In&nbsp;our&nbsp;implementation&nbsp;we&nbsp;will&nbsp;let&nbsp;subsequent&nbsp;modules&nbsp;try&nbsp;before&nbsp;sending&nbsp;the&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticated&nbsp;the&nbsp;client,&nbsp;passing&nbsp;to&nbsp;Auth&nbsp;Modules&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(message);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(message);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;In&nbsp;this&nbsp;implementation&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;we&nbsp;are&nbsp;allowing&nbsp;a&nbsp;single&nbsp;&amp;quot;session&amp;quot;&nbsp;auth&nbsp;module&nbsp;to<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;run&nbsp;and&nbsp;possible&nbsp;succeed&nbsp;and&nbsp;if&nbsp;so&nbsp;will&nbsp;stop&nbsp;processing,&nbsp;otherwise&nbsp;we&nbsp;allow&nbsp;a&nbsp;list&nbsp;of&nbsp;&amp;quot;normal&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;modules&nbsp;to&nbsp;try&nbsp;and&nbsp;authenticate&nbsp;the&nbsp;request.&nbsp;Hence&nbsp;why&nbsp;here&nbsp;a&nbsp;SEND_FAILURE&nbsp;will&nbsp;carry&nbsp;on<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;processing,&nbsp;where&nbsp;as&nbsp;SEND_CONTINUE&nbsp;and&nbsp;SEND_SUCCESS&nbsp;will&nbsp;cause&nbsp;processing&nbsp;to&nbsp;end.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;SEND_CONTINUE&nbsp;implies&nbsp;that&nbsp;there&nbsp;is&nbsp;to&nbsp;be&nbsp;more&nbsp;communication&nbsp;between&nbsp;server&nbsp;and&nbsp;client&nbsp;before<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;can&nbsp;be&nbsp;deemed&nbsp;successful&nbsp;or&nbsp;failed.&nbsp;So&nbsp;processing&nbsp;needs&nbsp;to&nbsp;stop&nbsp;and&nbsp;a&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Only&nbsp;the&nbsp;ServerAuthModule&nbsp;which&nbsp;returned&nbsp;AuthStatus.SUCCESS&nbsp;for&nbsp;its&nbsp;#validateRequest&nbsp;method&nbsp;will&nbsp;have&nbsp;its<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;secureResponse&nbsp;method&nbsp;call&nbsp;and&nbsp;if&nbsp;no&nbsp;ServerAuthModule&nbsp;successfully&nbsp;validated&nbsp;the&nbsp;request&nbsp;then&nbsp;this&nbsp;method<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;return&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authContextMap&nbsp;=&nbsp;getMessageInfoUtils().getMap(messageInfo,&nbsp;PRIVATE_CONTEXT_MAP_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;authenticatingAuthModule&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServerAuthModule)&nbsp;authContextMap.remove(AUTHENTICATING_AUTH_MODULE_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;authenticationAuthModule&nbsp;has&nbsp;been&nbsp;set,&nbsp;ie&nbsp;a&nbsp;normal&nbsp;ServerAuthModule&nbsp;successfully&nbsp;validated&nbsp;the&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authenticatingAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Using&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;from&nbsp;private&nbsp;context&nbsp;map,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authenticatingAuthModule.getClass().getSimpleName()&nbsp;+&nbsp;&amp;quot;,&nbsp;to&nbsp;secure&nbsp;the&nbsp;response&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authenticatingAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletCallbackHandlerjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeHttpServletCallbackHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandler.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,137&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.callback.Callback;<br>
+import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
+import&nbsp;javax.security.auth.callback.UnsupportedCallbackException;<br>
+import&nbsp;javax.security.auth.message.callback.CallerPrincipalCallback;<br>
+import&nbsp;javax.security.auth.message.callback.CertStoreCallback;<br>
+import&nbsp;javax.security.auth.message.callback.GroupPrincipalCallback;<br>
+import&nbsp;javax.security.auth.message.callback.PasswordValidationCallback;<br>
+import&nbsp;javax.security.auth.message.callback.PrivateKeyCallback;<br>
+import&nbsp;javax.security.auth.message.callback.SecretKeyCallback;<br>
+import&nbsp;javax.security.auth.message.callback.TrustStoreCallback;<br>
+import&nbsp;java.security.Principal;<br>
+import&nbsp;java.util.Set;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Callback&nbsp;handler&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.0.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;HttpServletCallbackHandler&nbsp;implements&nbsp;CallbackHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Called&nbsp;by&nbsp;Authentication&nbsp;modules&nbsp;to&nbsp;request&nbsp;more&nbsp;information&nbsp;about&nbsp;the&nbsp;request&nbsp;and&nbsp;response&nbsp;message.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Callbacks&nbsp;currently&nbsp;supported&nbsp;are&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;CallerPrincipalCallback&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;GroupPrincipalCallback&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;method&nbsp;will&nbsp;handle&nbsp;a&nbsp;CallerPrincipalCallback&nbsp;by&nbsp;creating&nbsp;a&nbsp;Principal&nbsp;from&nbsp;the&nbsp;name&nbsp;stored&nbsp;in&nbsp;the&nbsp;Callback<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;adding&nbsp;it&nbsp;to&nbsp;the&nbsp;Subject&nbsp;from&nbsp;the&nbsp;Callback.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;not&nbsp;populated&nbsp;then&nbsp;the&nbsp;Principal&nbsp;stored&nbsp;in&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Callback&nbsp;will&nbsp;be&nbsp;added&nbsp;to&nbsp;the&nbsp;Subject&nbsp;instead.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;method&nbsp;will&nbsp;handle&nbsp;a&nbsp;GroupPrincipalCallback&nbsp;by&nbsp;create&nbsp;a&nbsp;Principal&nbsp;for&nbsp;each&nbsp;group&nbsp;stored&nbsp;in&nbsp;the&nbsp;Callback<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;adding&nbsp;them&nbsp;to&nbsp;the&nbsp;Subject&nbsp;from&nbsp;the&nbsp;Callback.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbacks&nbsp;An&nbsp;array&nbsp;of&nbsp;Callback&nbsp;objects&nbsp;provided&nbsp;by&nbsp;the&nbsp;Authentication&nbsp;modules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;UnsupportedCallbackException&nbsp;If&nbsp;a&nbsp;callback&nbsp;is&nbsp;passed&nbsp;which&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;this&nbsp;CallbackHandler.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handle(final&nbsp;Callback[]&nbsp;callbacks)&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Callback&nbsp;callback&nbsp;:&nbsp;callbacks)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(CallerPrincipalCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callerPrincipalCallback&nbsp;=&nbsp;(CallerPrincipalCallback)&nbsp;callback;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;callerPrincipalCallback.getSubject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;name&nbsp;=&nbsp;callerPrincipalCallback.getName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;callerPrincipalCallback.getPrincipal();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;principal.getName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.getPrincipals().add(principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(name&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;name);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.getPrincipals().add(new&nbsp;Principal()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getName()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;name;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Both&nbsp;name&nbsp;and&nbsp;principal&nbsp;are&nbsp;null&nbsp;so&nbsp;not&nbsp;adding&nbsp;either.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Not&nbsp;adding&nbsp;principal&nbsp;as&nbsp;no&nbsp;name&nbsp;or&nbsp;principal&nbsp;set&nbsp;on&nbsp;callback&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(GroupPrincipalCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GroupPrincipalCallback&nbsp;groupPrincipalCallback&nbsp;=&nbsp;(GroupPrincipalCallback)&nbsp;callback;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;groupPrincipalCallback.getSubject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[]&nbsp;groups&nbsp;=&nbsp;groupPrincipalCallback.getGroups();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(groups&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&amp;lt;Principal&amp;gt;&nbsp;principals&nbsp;=&nbsp;subject.getPrincipals();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(final&nbsp;String&nbsp;group&nbsp;:&nbsp;groups)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;group);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principals.add(new&nbsp;Principal()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getName()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;group;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(PasswordValidationCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;JSR-196&nbsp;Spec&nbsp;states&nbsp;this&nbsp;MUST&nbsp;be&nbsp;implemented&nbsp;but&nbsp;as&nbsp;this&nbsp;is&nbsp;not&nbsp;actually&nbsp;a&nbsp;&amp;quot;real&amp;quot;&nbsp;container<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;we&nbsp;don't&nbsp;need&nbsp;to&nbsp;do&nbsp;this&nbsp;here.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;PasswordValidationCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(CertStoreCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;CertStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(PrivateKeyCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;PrivateKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SecretKeyCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;SecretKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(TrustStoreCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;TrustStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
+//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(HttpCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
+//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
+//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfojavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeHttpServletMessageInfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletMessageInfo.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,112&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletRequestWrapper;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Provides&nbsp;an&nbsp;implementation&nbsp;of&nbsp;a&nbsp;MessageInfo&nbsp;for&nbsp;the&nbsp;HttpServlet&nbsp;profile.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;HttpServletMessageInfo&nbsp;implements&nbsp;MessageInfo&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletRequestWrapper&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletResponseWrapper&nbsp;response;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;properties;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;HttpServletMessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HtwtpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletMessageInfo(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this(request,&nbsp;response,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;HttpServletMessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;properties&nbsp;A&nbsp;Map&nbsp;of&nbsp;properties.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletMessageInfo(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;properties)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setRequestMessage(request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResponseMessage(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.properties&nbsp;=&nbsp;properties;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;request&nbsp;message&nbsp;object&nbsp;from&nbsp;this&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;request&nbsp;message,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;request&nbsp;message&nbsp;is&nbsp;set&nbsp;within&nbsp;the&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletRequest&nbsp;getRequestMessage()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;response&nbsp;message&nbsp;object&nbsp;from&nbsp;this&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;response&nbsp;message,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;response&nbsp;message&nbsp;is&nbsp;set&nbsp;within&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletResponse&nbsp;getResponseMessage()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;response;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;request&nbsp;message&nbsp;object&nbsp;in&nbsp;this&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;request&nbsp;message.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setRequestMessage(final&nbsp;Object&nbsp;request)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.request&nbsp;=&nbsp;new&nbsp;HttpServletRequestWrapper((HttpServletRequest)&nbsp;request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;response&nbsp;message&nbsp;object&nbsp;in&nbsp;this&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;response&nbsp;message.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setResponseMessage(final&nbsp;Object&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.response&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper((HttpServletResponse)&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;(a&nbsp;reference&nbsp;to)&nbsp;the&nbsp;Map&nbsp;object&nbsp;of&nbsp;this&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;Map&nbsp;object&nbsp;of&nbsp;this&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;properties;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiHttpServletResponseWrapperjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapper.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,72&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.servlet.ServletOutputStream;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.io.PrintWriter;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Response&nbsp;Wrapper&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;response&nbsp;before&nbsp;the&nbsp;JASPI&nbsp;filter&nbsp;has&nbsp;run<br>
+&nbsp;*&nbsp;secureResponse.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;JaspiHttpServletResponseWrapper&nbsp;extends&nbsp;HttpServletResponseWrapper&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;PrintWriter&nbsp;writer;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ServletOutputStream&nbsp;out;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiHttpServletResponseWrapper.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;underlying&nbsp;HttpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiHttpServletResponseWrapper(final&nbsp;HttpServletResponse&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Lazily&nbsp;initialises&nbsp;the&nbsp;wrapped&nbsp;underlying&nbsp;response&nbsp;output&nbsp;stream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ServletOutputStream&nbsp;getOutputStream()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(out&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out&nbsp;=&nbsp;new&nbsp;JaspiServletOutputStream(getResponse().getOutputStream());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;out;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Lasily&nbsp;initialises&nbsp;the&nbsp;wrapped&nbsp;underlying&nbsp;response&nbsp;writer.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;PrintWriter&nbsp;getWriter()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(writer&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer&nbsp;=&nbsp;new&nbsp;JaspiPrintWriter(getResponse().getWriter());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;writer;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiPrintWriterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriter.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,37&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;java.io.PrintWriter;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Wrapper&nbsp;around&nbsp;a&nbsp;HttpServletResponse's&nbsp;writer&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;writer&nbsp;before&nbsp;the&nbsp;JASPI<br>
+&nbsp;*&nbsp;filter&nbsp;has&nbsp;run&nbsp;secureResponse.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;JaspiPrintWriter&nbsp;extends&nbsp;PrintWriter&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiPrintWriter.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;printWriter&nbsp;The&nbsp;underlying&nbsp;PrintWriter.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiPrintWriter(final&nbsp;PrintWriter&nbsp;printWriter)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(printWriter);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimejavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeJaspiRuntimejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/JaspiRuntime.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,209&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_TRAIL_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.isSendContinue;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
+import&nbsp;javax.servlet.FilterChain;<br>
+import&nbsp;javax.servlet.ServletException;<br>
+import&nbsp;javax.servlet.ServletRequest;<br>
+import&nbsp;javax.servlet.ServletResponse;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;class&nbsp;is&nbsp;the&nbsp;entry&nbsp;point&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Provides&nbsp;a&nbsp;single&nbsp;method&nbsp;#processMessage&nbsp;that&nbsp;takes&nbsp;a&nbsp;HttpServletRequest,&nbsp;HttpServletResponse&nbsp;and&nbsp;the&nbsp;FilterChain<br>
+&nbsp;*&nbsp;and&nbsp;will&nbsp;run&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;request&nbsp;is&nbsp;allowed&nbsp;to&nbsp;be&nbsp;passed&nbsp;down<br>
+&nbsp;*&nbsp;the&nbsp;filter&nbsp;chain.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;Note:&amp;lt;/strong&amp;gt;&nbsp;if&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;is&nbsp;not&nbsp;configured&nbsp;properly&nbsp;with&nbsp;a&nbsp;non-null&nbsp;ServerAuthContext<br>
+&nbsp;*&nbsp;each&nbsp;request&nbsp;will&nbsp;be&nbsp;passed&nbsp;straight&nbsp;to&nbsp;the&nbsp;filter&nbsp;chain&nbsp;with&nbsp;no&nbsp;further&nbsp;processing.&nbsp;So&nbsp;it&nbsp;is&nbsp;VERY&nbsp;important<br>
+&nbsp;*&nbsp;to&nbsp;ensure&nbsp;the&nbsp;runtime&nbsp;is&nbsp;configured&nbsp;correctly.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;JaspiRuntime&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Runtime&nbsp;slf4j&nbsp;debug&nbsp;logger.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;Logger&nbsp;LOG&nbsp;=&nbsp;LoggerFactory.getLogger(JaspiRuntime.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Indicates&nbsp;that&nbsp;the&nbsp;request&nbsp;could&nbsp;not&nbsp;be&nbsp;authenticated&nbsp;either&nbsp;because&nbsp;no&nbsp;credentials&nbsp;were&nbsp;provided&nbsp;or<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;credentials&nbsp;provided&nbsp;did&nbsp;not&nbsp;pass&nbsp;authentication.&nbsp;Equivalent&nbsp;to&nbsp;HTTP&nbsp;status:&nbsp;401&nbsp;Unauthorized.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;int&nbsp;UNAUTHORIZED_HTTP_ERROR_CODE&nbsp;=&nbsp;401;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;exception&nbsp;message&nbsp;for&nbsp;a&nbsp;401&nbsp;ResourceException.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;UNAUTHORIZED_ERROR_MESSAGE&nbsp;=&nbsp;&amp;quot;Access&nbsp;Denied&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;application/json&nbsp;HTTP&nbsp;Media&nbsp;Type.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;JSON_HTTP_MEDIA_TYPE&nbsp;=&nbsp;&amp;quot;application/json&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;principal&nbsp;name&nbsp;of&nbsp;the&nbsp;user/client&nbsp;making&nbsp;the&nbsp;request<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;set.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_PRINCIPAL&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.principal&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;any&nbsp;additional&nbsp;authentication&nbsp;context&nbsp;information<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;set.&nbsp;It&nbsp;MUST&nbsp;contain&nbsp;a&nbsp;{@code&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;if&nbsp;present.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_CONTEXT&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.context&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;unique&nbsp;id&nbsp;of&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;set.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_REQUEST_ID&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.request.id&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ContextFactory&nbsp;contextFactory;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;RuntimeResultHandler&nbsp;resultHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuditApi&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;FailureResponseHandler&nbsp;failureResponseHandler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiRuntime.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextFactory&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;ContextFactory}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;resultHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;RuntimeResultHandler}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditApi}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;failureResponseHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;FailureResponseHandler}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntime(ContextFactory&nbsp;contextFactory,&nbsp;RuntimeResultHandler&nbsp;resultHandler,&nbsp;AuditApi&nbsp;auditApi,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;contextFactory;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.resultHandler&nbsp;=&nbsp;resultHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.failureResponseHandler&nbsp;=&nbsp;failureResponseHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Processes&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Guaranteed&nbsp;to&nbsp;call&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;validateRequest&nbsp;method&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;request&nbsp;is<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;allowed&nbsp;through&nbsp;and&nbsp;if&nbsp;validation&nbsp;was&nbsp;successful,&nbsp;to&nbsp;call&nbsp;secureResponse&nbsp;after&nbsp;the&nbsp;service&nbsp;call&nbsp;has&nbsp;completed.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Any&nbsp;authentication&nbsp;exceptions&nbsp;that&nbsp;occur&nbsp;during&nbsp;this&nbsp;process&nbsp;will&nbsp;be&nbsp;caught&nbsp;and&nbsp;converted&nbsp;into&nbsp;a&nbsp;Json&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;that&nbsp;matches&nbsp;a&nbsp;HTTP&nbsp;500&nbsp;status&nbsp;code.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;no&nbsp;ServerAuthContext&nbsp;is&nbsp;configured&nbsp;for&nbsp;the&nbsp;HttpServlet&nbsp;layer&nbsp;and&nbsp;the&nbsp;requests&nbsp;application&nbsp;context,&nbsp;then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;allowed&nbsp;through.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;filterChain&nbsp;The&nbsp;filter&nbsp;chain.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error&nbsp;processing&nbsp;the&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;processMessage(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;FilterChain&nbsp;filterChain)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Must&nbsp;create&nbsp;new&nbsp;client&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Can&nbsp;be&nbsp;null&nbsp;if&nbsp;no&nbsp;details&nbsp;required&nbsp;for&nbsp;service&nbsp;subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;new&nbsp;AuditTrail(auditApi,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;requestAuthStatus&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;contextFactory.getContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Could&nbsp;be&nbsp;null&nbsp;if&nbsp;no&nbsp;modules&nbsp;found<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(serverAuthContext&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;No&nbsp;ServerAuthContext&nbsp;configured!&nbsp;Jaspi&nbsp;Runtime&nbsp;not&nbsp;configured&nbsp;properly!&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&amp;quot;Proceeding&nbsp;with&nbsp;filter&nbsp;chain&nbsp;call.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter(request,&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;This&nbsp;is&nbsp;where&nbsp;the&nbsp;modules&nbsp;are&nbsp;called<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestAuthStatus&nbsp;=&nbsp;serverAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!resultHandler.handleValidateRequestResult(requestAuthStatus,&nbsp;messageInfo,&nbsp;auditTrail,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject,&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage()))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;e;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_REQUEST_ID,&nbsp;auditTrail.getRequestId());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter((ServletRequest)&nbsp;messageInfo.getRequestMessage(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServletResponse)&nbsp;messageInfo.getResponseMessage());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;responseAuthStatus&nbsp;=&nbsp;serverAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(responseAuthStatus,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Give&nbsp;the&nbsp;AuthModule&nbsp;a&nbsp;chance&nbsp;to&nbsp;clear&nbsp;out&nbsp;any&nbsp;authentication&nbsp;data&nbsp;from&nbsp;the&nbsp;subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverAuthContext.cleanSubject(messageInfo,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e.getCause()&nbsp;instanceof&nbsp;ResourceException)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(e.getMessage(),&nbsp;e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;(ResourceException)&nbsp;e.getCause();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(e.getMessage(),&nbsp;e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.INTERNAL_ERROR,&nbsp;e.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;auditTrail.getFailureReasons();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReasonList&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!failureReasonList.isEmpty())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;failureReasons&amp;quot;,&nbsp;failureReasonList))));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler.handle(jre,&nbsp;messageInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IOException&nbsp;ioe)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(e.getMessage(),&nbsp;ioe);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(ioe.getMessage(),&nbsp;ioe);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isSendContinue(requestAuthStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiJaspiRuntimeFilterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/JaspiRuntimeFilter.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,194&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+<br>
+import&nbsp;javax.servlet.Filter;<br>
+import&nbsp;javax.servlet.FilterChain;<br>
+import&nbsp;javax.servlet.FilterConfig;<br>
+import&nbsp;javax.servlet.ServletException;<br>
+import&nbsp;javax.servlet.ServletRequest;<br>
+import&nbsp;javax.servlet.ServletResponse;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.lang.reflect.Method;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;Servlet&nbsp;Filter&nbsp;class&nbsp;provides&nbsp;a&nbsp;method&nbsp;of&nbsp;integrating&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;into&nbsp;a&nbsp;Servlet&nbsp;Container,&nbsp;such&nbsp;that<br>
+&nbsp;*&nbsp;requests&nbsp;made&nbsp;to&nbsp;the&nbsp;url&nbsp;this&nbsp;filter&nbsp;is&nbsp;registered&nbsp;at&nbsp;will&nbsp;cause&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;to&nbsp;validate&nbsp;and&nbsp;secure&nbsp;the<br>
+&nbsp;*&nbsp;request&nbsp;and&nbsp;response&nbsp;using&nbsp;it&nbsp;configured&nbsp;{@code&nbsp;ServerAuthModule}s.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;To&nbsp;configure&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;the&nbsp;Servlet&nbsp;Filter&nbsp;registration&nbsp;must&nbsp;contain&nbsp;the&nbsp;configuration&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;{@link&nbsp;ContextFactory}&nbsp;and&nbsp;the&nbsp;{@link&nbsp;AuditApi}.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;JaspiRuntimeFilter&nbsp;implements&nbsp;Filter&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_CLASS&nbsp;=&nbsp;&amp;quot;context-factory-class&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD&nbsp;=&nbsp;&amp;quot;context-factory-method&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD_DEFAULT&nbsp;=&nbsp;&amp;quot;getContextFactory&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Filter&nbsp;config&nbsp;can&nbsp;register&nbsp;different&nbsp;{@code&nbsp;ResourceException}&nbsp;handlers.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.forgerock.caf.authentication.framework.ResourceExceptionHandler<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_EXCEPTION_HANDLERS&nbsp;=&nbsp;&amp;quot;resource-exception-handlers&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_CLASS&nbsp;=&nbsp;&amp;quot;audit-api-factory-class&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_METHOD&nbsp;=&nbsp;&amp;quot;audit-api-factory-method&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_METHOD_DEFAULT&nbsp;=&nbsp;&amp;quot;getAuditApi&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextFactory&nbsp;contextFactory;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiRuntime&nbsp;runtime;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Default&nbsp;constructor&nbsp;called&nbsp;during&nbsp;normal&nbsp;Filter&nbsp;initialization.&nbsp;Implementations&nbsp;MUST&nbsp;override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#getContextFactory(FilterConfig)}&nbsp;and&nbsp;{@link&nbsp;#getAuditApi(FilterConfig)}&nbsp;in&nbsp;order&nbsp;for&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;to<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;function.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntimeFilter()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Creates&nbsp;a&nbsp;new&nbsp;Jaspi&nbsp;HTTP&nbsp;Filter&nbsp;with&nbsp;the&nbsp;provided&nbsp;context&nbsp;factory&nbsp;and&nbsp;audit&nbsp;api.&nbsp;This&nbsp;constructor&nbsp;is&nbsp;provided<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;as&nbsp;a&nbsp;convenience&nbsp;for&nbsp;cases&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;Filter&nbsp;is&nbsp;instantiated&nbsp;programmatically.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;HTTP&nbsp;Filter&nbsp;is&nbsp;created&nbsp;using&nbsp;this&nbsp;constructor&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;need&nbsp;to&nbsp;override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#getContextFactory(FilterConfig)}&nbsp;or&nbsp;{@link&nbsp;#getAuditApi(FilterConfig)}.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextFactory&nbsp;The&nbsp;context&nbsp;factory.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;The&nbsp;audit&nbsp;api.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntimeFilter(ContextFactory&nbsp;contextFactory,&nbsp;AuditApi&nbsp;auditApi)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;contextFactory;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Initialises&nbsp;the&nbsp;filter&nbsp;with&nbsp;the&nbsp;provided&nbsp;filter&nbsp;configuration.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;The&nbsp;filter&nbsp;config.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;either&nbsp;the&nbsp;{@code&nbsp;ContextFactory}&nbsp;or&nbsp;{@code&nbsp;AuditApi}&nbsp;instance&nbsp;could&nbsp;not&nbsp;be&nbsp;created.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;init(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(contextFactory&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextFactory&nbsp;=&nbsp;getContextFactory(config);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditApi&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;getAuditApi(config);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;exceptionHandlers&nbsp;=&nbsp;config.getInitParameter(JaspiRuntimeFilter.INIT_PARAM_EXCEPTION_HANDLERS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(exceptionHandlers&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(String&nbsp;handlerClassName&nbsp;:&nbsp;exceptionHandlers.split(&amp;quot;,&amp;quot;))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;ResourceExceptionHandler&amp;gt;&nbsp;handlerClass&nbsp;=&nbsp;Class.forName(handlerClassName.trim())<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.asSubclass(ResourceExceptionHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler.registerExceptionHandler(handlerClass);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(ClassNotFoundException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&amp;quot;Class&nbsp;is&nbsp;not&nbsp;available:&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClassName,&nbsp;e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.runtime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;new&nbsp;RuntimeResultHandler(),&nbsp;auditApi,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;On&nbsp;receipt&nbsp;of&nbsp;a&nbsp;request&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;is&nbsp;invoked&nbsp;to&nbsp;validate&nbsp;the&nbsp;request&nbsp;and&nbsp;secure&nbsp;the&nbsp;response,&nbsp;(providing<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;validation&nbsp;was&nbsp;successful).<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;ServletRequest.&nbsp;MUST&nbsp;be&nbsp;of&nbsp;type&nbsp;HttpServletRequest.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;ServletResponse.&nbsp;MUST&nbsp;be&nbsp;of&nbsp;type&nbsp;HttpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;chain&nbsp;The&nbsp;filter&nbsp;chain.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;exception&nbsp;thrown&nbsp;from&nbsp;the&nbsp;Jaspi&nbsp;runtime.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;doFilter(ServletRequest&nbsp;request,&nbsp;ServletResponse&nbsp;response,&nbsp;FilterChain&nbsp;chain)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(request&nbsp;instanceof&nbsp;HttpServletRequest&nbsp;&amp;amp;&amp;amp;&nbsp;response&nbsp;instanceof&nbsp;HttpServletResponse))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Non&nbsp;HTTP&nbsp;request&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.processMessage((HttpServletRequest)&nbsp;request,&nbsp;(HttpServletResponse)&nbsp;response,&nbsp;chain);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextFactory&nbsp;getContextFactory(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(config&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;for&nbsp;configured&nbsp;connection&nbsp;factory&nbsp;class&nbsp;first.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;className&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_CONTEXT_FACTORY_CLASS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(className&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Class&amp;lt;?&amp;gt;&nbsp;cls&nbsp;=&nbsp;Class.forName(className);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;tmp&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_CONTEXT_FACTORY_METHOD);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;methodName&nbsp;=&nbsp;tmp&nbsp;!=&nbsp;null&nbsp;?&nbsp;tmp&nbsp;:&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD_DEFAULT;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ContextFactory)&nbsp;factoryMethod.invoke(null,&nbsp;config);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;IllegalArgumentException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;no-arg&nbsp;method.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ContextFactory)&nbsp;factoryMethod.invoke(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;Exception&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIXME:&nbsp;i18n<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Unable&nbsp;to&nbsp;initialize&nbsp;ContextFactory&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;getAuditApi(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(config&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;for&nbsp;configured&nbsp;connection&nbsp;factory&nbsp;class&nbsp;first.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;className&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_AUDIT_API_CLASS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(className&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Class&amp;lt;?&amp;gt;&nbsp;cls&nbsp;=&nbsp;Class.forName(className);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;tmp&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_AUDIT_API_METHOD);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;methodName&nbsp;=&nbsp;tmp&nbsp;!=&nbsp;null&nbsp;?&nbsp;tmp&nbsp;:&nbsp;INIT_PARAM_AUDIT_API_METHOD_DEFAULT;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AuditApi)&nbsp;factoryMethod.invoke(null,&nbsp;config);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;IllegalArgumentException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;no-arg&nbsp;method.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AuditApi)&nbsp;factoryMethod.invoke(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;Exception&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIXME:&nbsp;i18n<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Unable&nbsp;to&nbsp;initialize&nbsp;AuditApi&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;destroy()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;what&nbsp;if&nbsp;context&nbsp;is&nbsp;still&nbsp;processing&nbsp;something?...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextJaspiServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContext.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,442&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.*;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.asString;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.Collections;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Encapsulates&nbsp;ServerAuthModules&nbsp;that&nbsp;are&nbsp;used&nbsp;to&nbsp;validate&nbsp;service&nbsp;requests&nbsp;received&nbsp;from&nbsp;clients,&nbsp;and&nbsp;to&nbsp;secure&nbsp;any<br>
+&nbsp;*&nbsp;response&nbsp;returned&nbsp;for&nbsp;those&nbsp;requests.<br>
+&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;*&nbsp;This&nbsp;abstract&nbsp;implementation&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;interface&nbsp;allows&nbsp;a&nbsp;single&nbsp;Session&nbsp;ServerAuthModule,&nbsp;to<br>
+&nbsp;*&nbsp;provide&nbsp;session&nbsp;capabilities&nbsp;(i.e.&nbsp;on&nbsp;secureResponse,&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;which&nbsp;is&nbsp;validate&nbsp;on&nbsp;each&nbsp;subsequent&nbsp;request&nbsp;to<br>
+&nbsp;*&nbsp;skip&nbsp;re-authenticating&nbsp;each&nbsp;request),&nbsp;and&nbsp;then&nbsp;defers&nbsp;to&nbsp;the&nbsp;concrete&nbsp;implementation&nbsp;to&nbsp;co-ordinate&nbsp;calling<br>
+&nbsp;*&nbsp;any&nbsp;other&nbsp;ServerAuthModules.<br>
+&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;*&nbsp;This&nbsp;class&nbsp;or&nbsp;concrete&nbsp;implementations&nbsp;of&nbsp;it&nbsp;MUST&nbsp;not&nbsp;store&nbsp;any&nbsp;request&nbsp;specific&nbsp;state&nbsp;in&nbsp;it.&nbsp;This&nbsp;is&nbsp;because<br>
+&nbsp;*&nbsp;many&nbsp;different&nbsp;requests&nbsp;will&nbsp;use&nbsp;this&nbsp;class,&nbsp;possibly&nbsp;concurrently.&nbsp;If&nbsp;the&nbsp;request-specific&nbsp;state&nbsp;needs&nbsp;to&nbsp;be<br>
+&nbsp;*&nbsp;maintained&nbsp;then&nbsp;use&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;provided.&nbsp;This&nbsp;is&nbsp;created&nbsp;and&nbsp;used&nbsp;only&nbsp;by&nbsp;this&nbsp;specific&nbsp;request&nbsp;-&nbsp;it&nbsp;will<br>
+&nbsp;*&nbsp;be&nbsp;available&nbsp;for&nbsp;the&nbsp;entire&nbsp;time&nbsp;the&nbsp;request&nbsp;is&nbsp;being&nbsp;processed..<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@param&nbsp;&amp;lt;T&amp;gt;&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;ServerAuthModule&nbsp;configured&nbsp;in&nbsp;the&nbsp;runtime.<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;abstract&nbsp;class&nbsp;JaspiServerAuthContext&amp;lt;T&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;implements&nbsp;ServerAuthContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Key&nbsp;to&nbsp;the&nbsp;private&nbsp;context&nbsp;map,&nbsp;shared&nbsp;between&nbsp;ServerAuthContext&nbsp;implementations.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;static&nbsp;final&nbsp;String&nbsp;PRIVATE_CONTEXT_MAP_KEY&nbsp;=&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiServerAuthContext.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Each&nbsp;configured&nbsp;ServerAuthModule&nbsp;has&nbsp;its&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;called&nbsp;to&nbsp;ensure&nbsp;that&nbsp;each&nbsp;module<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;does&nbsp;support&nbsp;and&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;A&nbsp;Session&nbsp;AuthModule.&nbsp;Can&nbsp;be&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;A&nbsp;List&nbsp;of&nbsp;ServerAuthModules.&nbsp;MUST&nbsp;not&nbsp;be&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;do&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiServerAuthContext(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule,&nbsp;final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;allAuthModules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;(authModules);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules.add(0,&nbsp;sessionAuthModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(allAuthModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextHandler&nbsp;=&nbsp;contextHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.sessionAuthModule&nbsp;=&nbsp;sessionAuthModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModules&nbsp;=&nbsp;authModules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;MessageInfoUtils.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;MessageInfoUtils.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;MessageInfoUtils&nbsp;getMessageInfoUtils()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;messageInfoUtils;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Authenticate&nbsp;a&nbsp;received&nbsp;service&nbsp;request&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured&nbsp;ServerAuthModules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;logic&nbsp;used&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;called&nbsp;is&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ol&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;configured,&nbsp;it&nbsp;is&nbsp;called&nbsp;first.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;configured&nbsp;and&nbsp;returns&nbsp;AuthStatus.SUCCESS,&nbsp;AuthStatus.SEND_SUCCESS&nbsp;or<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus.SEND_CONTINUE&nbsp;processing&nbsp;stops&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;returned.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;it&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;then&nbsp;the&nbsp;list<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;ServerAuthModules&nbsp;are&nbsp;called.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ol&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE,&nbsp;then&nbsp;the&nbsp;concrete&nbsp;sub-types<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#validateRequest(List,&nbsp;MessageInfo,&nbsp;Subject,&nbsp;Subject)&nbsp;will&nbsp;be&nbsp;called&nbsp;for&nbsp;the&nbsp;ServerAuthModules<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)&nbsp;to&nbsp;be&nbsp;called.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;configured&nbsp;AuditLogger&nbsp;will&nbsp;be&nbsp;called&nbsp;to&nbsp;audit&nbsp;the&nbsp;request&nbsp;&amp;lt;strong&amp;gt;if&amp;lt;/strong&amp;gt;&nbsp;the&nbsp;Session&nbsp;AuthModule<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;as&nbsp;if&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;passes&nbsp;the&nbsp;Jaspi&nbsp;Runtime<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;takes&nbsp;this&nbsp;as&nbsp;an&nbsp;existing&nbsp;session&nbsp;continuing.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;request&nbsp;message&nbsp;was&nbsp;successfully&nbsp;validated.&nbsp;The&nbsp;validated&nbsp;request<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getRequestMessage&nbsp;on&nbsp;messageInfo.&amp;lt;li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;to&nbsp;indicate&nbsp;that&nbsp;validation/processing&nbsp;of&nbsp;the&nbsp;request&nbsp;message&nbsp;successfully&nbsp;produced<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;secured&nbsp;application&nbsp;response&nbsp;message&nbsp;(in&nbsp;messageInfo).&nbsp;The&nbsp;secured&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;is&nbsp;incomplete,&nbsp;and&nbsp;that&nbsp;a&nbsp;preliminary&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;was&nbsp;returned&nbsp;as&nbsp;the&nbsp;response&nbsp;message&nbsp;in&nbsp;messageInfo.&nbsp;When&nbsp;this&nbsp;status&nbsp;value&nbsp;is&nbsp;returned&nbsp;to&nbsp;challenge&nbsp;an<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;application&nbsp;request&nbsp;message,&nbsp;the&nbsp;challenged&nbsp;request&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;request&nbsp;returned&nbsp;for&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;challenge.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;failed&nbsp;and&nbsp;that&nbsp;an&nbsp;appropriate&nbsp;failure&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;validate&nbsp;session&nbsp;module<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;&amp;quot;Session-&amp;quot;&nbsp;+&nbsp;sessionAuthModule.getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;doValidateRequest(sessionAuthModule,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject,&nbsp;moduleId,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;emptyMap(),&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;--&nbsp;In&nbsp;our&nbsp;implementation&nbsp;we&nbsp;will&nbsp;let&nbsp;subsequent&nbsp;modules&nbsp;try&nbsp;before&nbsp;sending&nbsp;the&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticated&nbsp;the&nbsp;client,&nbsp;passing&nbsp;to&nbsp;Auth&nbsp;Modules&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;&nbsp;+&nbsp;asString(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(message);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(message);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().remove(AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;exceptionAuthStatus&nbsp;=&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Setting&nbsp;authStatus&nbsp;to&nbsp;null&nbsp;so&nbsp;auditing&nbsp;does&nbsp;not&nbsp;happen.&nbsp;As&nbsp;this&nbsp;exception&nbsp;is&nbsp;a&nbsp;configuration&nbsp;issue.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;,&nbsp;asString(exceptionAuthStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(exceptionAuthStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Performs&nbsp;the&nbsp;actual&nbsp;{@code&nbsp;#validateRequest}&nbsp;call&nbsp;on&nbsp;the&nbsp;auth&nbsp;module&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;principal&nbsp;set&nbsp;by&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;module&nbsp;is&nbsp;set&nbsp;in&nbsp;the&nbsp;audit&nbsp;trail&nbsp;and&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;an&nbsp;exception&nbsp;that&nbsp;the&nbsp;failure&nbsp;reason&nbsp;is&nbsp;captured.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;auth&nbsp;module&nbsp;to&nbsp;call&nbsp;{@code&nbsp;#validateRequest}&nbsp;on.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;module&nbsp;identifier.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;audit&nbsp;trail.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;from&nbsp;the&nbsp;{@code&nbsp;#validateRequest}&nbsp;call.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;the&nbsp;{@code&nbsp;#validateRequest}&nbsp;call&nbsp;fails.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;doValidateRequest(ServerAuthModule&nbsp;authModule,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject,&nbsp;String&nbsp;moduleId,&nbsp;AuditTrail&nbsp;auditTrail)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().get(AUDIT_PRINCIPAL_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!principal.isEmpty())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(AUDIT_PRINCIPAL_KEY,&nbsp;principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Auditing&nbsp;authentication&nbsp;result&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason.put(&amp;quot;exception&amp;quot;,&nbsp;e.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason&nbsp;=&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;exception&amp;quot;,&nbsp;e.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;e;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Co-ordinates&nbsp;calling&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;#validateRequest&nbsp;method,&nbsp;when&nbsp;either&nbsp;the&nbsp;Session<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;has&nbsp;returned&nbsp;AuthStatus.SEND_FAILURE.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SUCCESS,&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configured&nbsp;ServerAuthModules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;request&nbsp;message&nbsp;was&nbsp;successfully&nbsp;validated.&nbsp;The&nbsp;validated&nbsp;request<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getRequestMessage&nbsp;on&nbsp;messageInfo.&amp;lt;li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;to&nbsp;indicate&nbsp;that&nbsp;validation/processing&nbsp;of&nbsp;the&nbsp;request&nbsp;message&nbsp;successfully&nbsp;produced<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;secured&nbsp;application&nbsp;response&nbsp;message&nbsp;(in&nbsp;messageInfo).&nbsp;The&nbsp;secured&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;is&nbsp;incomplete,&nbsp;and&nbsp;that&nbsp;a&nbsp;preliminary&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;was&nbsp;returned&nbsp;as&nbsp;the&nbsp;response&nbsp;message&nbsp;in&nbsp;messageInfo.&nbsp;When&nbsp;this&nbsp;status&nbsp;value&nbsp;is&nbsp;returned&nbsp;to&nbsp;challenge&nbsp;an<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;application&nbsp;request&nbsp;message,&nbsp;the&nbsp;challenged&nbsp;request&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;request&nbsp;returned&nbsp;for&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;challenge.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;failed&nbsp;and&nbsp;that&nbsp;an&nbsp;appropriate&nbsp;failure&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;abstract&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Secures&nbsp;a&nbsp;service&nbsp;response&nbsp;before&nbsp;sending&nbsp;it&nbsp;to&nbsp;the&nbsp;client&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;ServerAuthModules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Firstly&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;#secureResponse(List,&nbsp;MessageInfo,&nbsp;Subject)&nbsp;will&nbsp;be&nbsp;called&nbsp;for&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;ServerAuthModules&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)&nbsp;to&nbsp;be&nbsp;called.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;only&nbsp;called&nbsp;if:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;it&nbsp;is&nbsp;configured&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;the&nbsp;call&nbsp;to&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;secureResponse&nbsp;returns&nbsp;AuthStatus.SEND_SUCCESS&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Any&nbsp;other&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;secureResponse&nbsp;method&nbsp;will&nbsp;result&nbsp;in&nbsp;the&nbsp;end&nbsp;of<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;processing&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;to&nbsp;be&nbsp;returned.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Note:&nbsp;secureResponse&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;if&nbsp;the&nbsp;call&nbsp;to&nbsp;validateRequest&nbsp;returned&nbsp;AuthStatus.SUCCESS.&nbsp;Any&nbsp;other<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;should&nbsp;cause&nbsp;the&nbsp;runtime&nbsp;to&nbsp;finish&nbsp;processing&nbsp;the&nbsp;request&nbsp;and&nbsp;return&nbsp;a&nbsp;response&nbsp;to&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;was&nbsp;successfully&nbsp;secured.&nbsp;The&nbsp;secured<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;message&nbsp;may&nbsp;be&nbsp;obtained&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;(within&nbsp;messageInfo)&nbsp;was&nbsp;replaced<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;with&nbsp;a&nbsp;security&nbsp;message&nbsp;that&nbsp;should&nbsp;elicit&nbsp;a&nbsp;security-specific&nbsp;response&nbsp;(in&nbsp;the&nbsp;form&nbsp;of&nbsp;a&nbsp;request)&nbsp;from&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peer.&nbsp;This&nbsp;status&nbsp;value&nbsp;serves&nbsp;to&nbsp;inform&nbsp;the&nbsp;calling&nbsp;runtime&nbsp;that&nbsp;(to&nbsp;successfully&nbsp;complete&nbsp;the&nbsp;message<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exchange)&nbsp;it&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;capable&nbsp;of&nbsp;continuing&nbsp;the&nbsp;message&nbsp;dialog&nbsp;by&nbsp;processing&nbsp;at&nbsp;least&nbsp;one&nbsp;additional<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;exchange&nbsp;(after&nbsp;having&nbsp;sent&nbsp;the&nbsp;response&nbsp;message&nbsp;returned&nbsp;in&nbsp;messageInfo).&nbsp;When&nbsp;this&nbsp;status<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;is&nbsp;returned,&nbsp;the&nbsp;application&nbsp;response&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can&nbsp;be<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;elicited&nbsp;response.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;a&nbsp;failure&nbsp;occurred&nbsp;while&nbsp;securing&nbsp;the&nbsp;response&nbsp;message&nbsp;and&nbsp;that&nbsp;an<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;appropriate&nbsp;failure&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus)&nbsp;||&nbsp;AuthStatus.FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;SessionModule&nbsp;is&nbsp;configured&nbsp;and&nbsp;either&nbsp;the&nbsp;AuthModule&nbsp;secureResponse&nbsp;has&nbsp;been&nbsp;called&nbsp;and&nbsp;returned<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus.SUCCESS&nbsp;or&nbsp;the&nbsp;AuthModule&nbsp;secureResponse&nbsp;has&nbsp;not&nbsp;been&nbsp;called&nbsp;and&nbsp;hence&nbsp;the&nbsp;authStatus&nbsp;is&nbsp;null.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.SEND_SUCCESS.equals(authStatus)))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().remove(AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;As&nbsp;this&nbsp;method&nbsp;can&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;validateRequest&nbsp;returns&nbsp;a&nbsp;AuthStatus.SUCCESS,&nbsp;which&nbsp;means&nbsp;either&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;SessionModule&nbsp;is&nbsp;configured&nbsp;or&nbsp;the&nbsp;authenticatingAuthModule&nbsp;will&nbsp;be&nbsp;set,&nbsp;so&nbsp;authStatus&nbsp;cannot&nbsp;be&nbsp;null&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MUST&nbsp;be&nbsp;set&nbsp;to&nbsp;a&nbsp;valid&nbsp;AuthStatus&nbsp;value&nbsp;for&nbsp;secureResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Co-ordinates&nbsp;calling&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;#secureResponse&nbsp;method,&nbsp;before&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;called&nbsp;(if&nbsp;it&nbsp;is&nbsp;configured).<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Any&nbsp;other&nbsp;AuthStatus&nbsp;that&nbsp;AuthStatus.SEND_SUCCESS&nbsp;returned&nbsp;from&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;secureResponse<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;method&nbsp;will&nbsp;result&nbsp;in&nbsp;the&nbsp;end&nbsp;of&nbsp;processing&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;to&nbsp;be&nbsp;returned.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configured&nbsp;ServerAuthModules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;was&nbsp;successfully&nbsp;secured.&nbsp;The&nbsp;secured<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;message&nbsp;may&nbsp;be&nbsp;obtained&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;(within&nbsp;messageInfo)&nbsp;was&nbsp;replaced<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;with&nbsp;a&nbsp;security&nbsp;message&nbsp;that&nbsp;should&nbsp;elicit&nbsp;a&nbsp;security-specific&nbsp;response&nbsp;(in&nbsp;the&nbsp;form&nbsp;of&nbsp;a&nbsp;request)&nbsp;from&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peer.&nbsp;This&nbsp;status&nbsp;value&nbsp;serves&nbsp;to&nbsp;inform&nbsp;the&nbsp;calling&nbsp;runtime&nbsp;that&nbsp;(to&nbsp;successfully&nbsp;complete&nbsp;the&nbsp;message<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exchange)&nbsp;it&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;capable&nbsp;of&nbsp;continuing&nbsp;the&nbsp;message&nbsp;dialog&nbsp;by&nbsp;processing&nbsp;at&nbsp;least&nbsp;one&nbsp;additional<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;exchange&nbsp;(after&nbsp;having&nbsp;sent&nbsp;the&nbsp;response&nbsp;message&nbsp;returned&nbsp;in&nbsp;messageInfo).&nbsp;When&nbsp;this&nbsp;status<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;is&nbsp;returned,&nbsp;the&nbsp;application&nbsp;response&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can&nbsp;be<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;elicited&nbsp;response.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;a&nbsp;failure&nbsp;occurred&nbsp;while&nbsp;securing&nbsp;the&nbsp;response&nbsp;message&nbsp;and&nbsp;that&nbsp;an<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;appropriate&nbsp;failure&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;abstract&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Remove&nbsp;method&nbsp;specific&nbsp;principals&nbsp;and&nbsp;credentials&nbsp;from&nbsp;the&nbsp;subject&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;Session<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthModule&nbsp;and&nbsp;the&nbsp;List&nbsp;of&nbsp;ServerAuthModules.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;subject&nbsp;The&nbsp;Subject&nbsp;instance&nbsp;from&nbsp;which&nbsp;the&nbsp;Principals&nbsp;and&nbsp;credentials&nbsp;are&nbsp;to&nbsp;be&nbsp;removed.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;Subject&nbsp;processing.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;void&nbsp;cleanSubject(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;subject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;serverAuthModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverAuthModule.cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiServletOutputStreamjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStream.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,87&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.servlet.ServletOutputStream;<br>
+import&nbsp;java.io.IOException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Wrapper&nbsp;around&nbsp;a&nbsp;HttpServletResponse's&nbsp;output&nbsp;stream&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;stream&nbsp;before&nbsp;the<br>
+&nbsp;*&nbsp;JASPI&nbsp;filter&nbsp;has&nbsp;run&nbsp;secureResponse.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;JaspiServletOutputStream&nbsp;extends&nbsp;ServletOutputStream&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ServletOutputStream&nbsp;servletOutputStream;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiServletOutputStream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;servletOutputStream&nbsp;The&nbsp;underlying&nbsp;ServletOutputStream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiServletOutputStream(final&nbsp;ServletOutputStream&nbsp;servletOutputStream)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.servletOutputStream&nbsp;=&nbsp;servletOutputStream;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(int)&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;i&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(final&nbsp;int&nbsp;i)&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(i);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(byte[])&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;b&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(byte[]&nbsp;b)&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(byte[],&nbsp;int,&nbsp;int)&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;b&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;off&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;len&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(byte[]&nbsp;b,&nbsp;int&nbsp;off,&nbsp;int&nbsp;len)&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b,&nbsp;off,&nbsp;len);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;close()&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;close()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.close();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiutilsMessageInfoUtilsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/MessageInfoUtils.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,89&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Provides&nbsp;methods&nbsp;that&nbsp;allow&nbsp;working&nbsp;with&nbsp;MessageInfo&nbsp;maps&nbsp;to&nbsp;be&nbsp;simplified.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;MessageInfoUtils&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Removes&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;of&nbsp;the&nbsp;MessageInfo,&nbsp;then&nbsp;{@code&nbsp;null}&nbsp;will&nbsp;be&nbsp;returned.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;remove&nbsp;the&nbsp;map&nbsp;from.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;or&nbsp;{@code&nbsp;null}&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;exist.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;removeMap(MessageInfo&nbsp;messageInfo,&nbsp;String&nbsp;mapKey)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().remove(mapKey);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;of&nbsp;the&nbsp;MessageInfo,&nbsp;the&nbsp;a&nbsp;new&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;will<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;created&nbsp;an&nbsp;inserted&nbsp;into&nbsp;it,&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;get&nbsp;the&nbsp;map&nbsp;from.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;String&nbsp;mapKey)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getMap(messageInfo.getMap(),&nbsp;mapKey);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;given&nbsp;containing&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist,&nbsp;a&nbsp;new&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;will&nbsp;be&nbsp;created&nbsp;and&nbsp;inserted&nbsp;into&nbsp;the&nbsp;given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;containing&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;containingMap&nbsp;The&nbsp;map&nbsp;that&nbsp;will&nbsp;contain&nbsp;the&nbsp;map&nbsp;at&nbsp;the&nbsp;given&nbsp;key.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;given&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;containingMap,&nbsp;final&nbsp;String&nbsp;mapKey)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;containingMap.get(mapKey);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containingMap.put(mapKey,&nbsp;map);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;map;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Adds&nbsp;a&nbsp;new&nbsp;empty&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;add&nbsp;the&nbsp;map&nbsp;to.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;key&nbsp;The&nbsp;key&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;new&nbsp;map.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;addMap(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;String&nbsp;key)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getMap(messageInfo,&nbsp;key);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkResourceExceptionHandlerjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeResourceExceptionHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ResourceExceptionHandler.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,45&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.util.Collection;<br>
+<br>
+import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Handle&nbsp;ResourceException&nbsp;responses&nbsp;for&nbsp;different&nbsp;media&nbsp;types.&nbsp;Implementations&nbsp;should&nbsp;be&nbsp;thread-safe.<br>
+&nbsp;*/<br>
+public&nbsp;interface&nbsp;ResourceExceptionHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Which&nbsp;media&nbsp;types&nbsp;can&nbsp;this&nbsp;handler&nbsp;handle<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;list&nbsp;of&nbsp;media&nbsp;types.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;MediaType&amp;gt;&nbsp;handles();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;the&nbsp;details&nbsp;of&nbsp;the&nbsp;exception&nbsp;out,&nbsp;and&nbsp;set&nbsp;the&nbsp;content&nbsp;type&nbsp;of&nbsp;the&nbsp;response.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;exception&nbsp;The&nbsp;exception&nbsp;to&nbsp;be&nbsp;written.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;response&nbsp;to&nbsp;write&nbsp;the&nbsp;details&nbsp;to.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;writing&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException;<br>
+<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeRuntimeResultHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/RuntimeResultHandler.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,116&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.security.Principal;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;Handler&nbsp;which&nbsp;handles&nbsp;the&nbsp;result&nbsp;of&nbsp;calls&nbsp;to&nbsp;a&nbsp;ServerAuthContexts&nbsp;validateRequest&nbsp;and&nbsp;secureResponse&nbsp;methods.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;RuntimeResultHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Handles&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;ServerAuthContext&nbsp;validateRequest&nbsp;method.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Only&nbsp;an&nbsp;AuthStatus&nbsp;of&nbsp;SUCCESS&nbsp;will&nbsp;return&nbsp;true&nbsp;and&nbsp;an&nbsp;AuthStatus&nbsp;of&nbsp;SEND_FAILURE&nbsp;will&nbsp;set&nbsp;the&nbsp;response&nbsp;status<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;401.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;returned&nbsp;AuthStatus&nbsp;from&nbsp;the&nbsp;validateRequest&nbsp;method&nbsp;call.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditTrail}&nbsp;for&nbsp;this&nbsp;authentication&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;client's&nbsp;subject.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;&amp;lt;code&amp;gt;true&amp;lt;/code&amp;gt;&nbsp;if&nbsp;the&nbsp;processing&nbsp;of&nbsp;the&nbsp;request&nbsp;should&nbsp;proceed,&nbsp;&amp;lt;code&amp;gt;false&amp;lt;/code&amp;gt;&nbsp;otherwise.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;If&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;not&nbsp;valid&nbsp;for&nbsp;a&nbsp;call&nbsp;to&nbsp;validateRequest.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;boolean&nbsp;handleValidateRequestResult(AuthStatus&nbsp;authStatus,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;AuditTrail&nbsp;auditTrail,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request,&nbsp;with&nbsp;response&nbsp;message&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Failed&nbsp;to&nbsp;validate&nbsp;request,&nbsp;included&nbsp;response&nbsp;message.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(401);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;validating&nbsp;request.&nbsp;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;AuthStatusUtils.asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;validateRequest:&nbsp;&amp;quot;&nbsp;+&nbsp;AuthStatusUtils.asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;getPrincipal(Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;principal.getName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;ServerAuthContext&nbsp;secureResponse&nbsp;method.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;An&nbsp;AuthStatus&nbsp;of&nbsp;SEND_CONTINUE&nbsp;will&nbsp;set&nbsp;the&nbsp;response&nbsp;status&nbsp;to&nbsp;100.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;returned&nbsp;AuthStatus&nbsp;from&nbsp;the&nbsp;secureResponse&nbsp;method&nbsp;call.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;If&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;not&nbsp;valid&nbsp;for&nbsp;a&nbsp;call&nbsp;to&nbsp;secureResponse.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleSecureResponseResult(final&nbsp;AuthStatus&nbsp;authStatus,&nbsp;final&nbsp;HttpServletResponse&nbsp;response)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Successfully&nbsp;secured&nbsp;response.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_FAILURE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Failed&nbsp;to&nbsp;secured&nbsp;response,&nbsp;included&nbsp;response&nbsp;message&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(500);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;securing&nbsp;response.&nbsp;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;AuthStatusUtils.asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;secureResponse:&nbsp;&amp;quot;&nbsp;+&nbsp;AuthStatusUtils.asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiJaspiRuntimeFilterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/JaspiRuntimeFilter.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/JaspiRuntimeFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/JaspiRuntimeFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,201&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditApi;<br>
-import&nbsp;org.forgerock.jaspi.runtime.ContextFactory;<br>
-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
-import&nbsp;org.forgerock.jaspi.runtime.ResourceExceptionHandler;<br>
-import&nbsp;org.forgerock.jaspi.runtime.RuntimeResultHandler;<br>
-import&nbsp;org.forgerock.jaspi.runtime.response.FailureResponseHandler;<br>
-<br>
-import&nbsp;javax.servlet.Filter;<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.FilterConfig;<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.ServletRequest;<br>
-import&nbsp;javax.servlet.ServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.lang.reflect.Method;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;Servlet&nbsp;Filter&nbsp;class&nbsp;provides&nbsp;a&nbsp;method&nbsp;of&nbsp;integrating&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;into&nbsp;a&nbsp;Servlet&nbsp;Container,&nbsp;such&nbsp;that<br>
-&nbsp;*&nbsp;requests&nbsp;made&nbsp;to&nbsp;the&nbsp;url&nbsp;this&nbsp;filter&nbsp;is&nbsp;registered&nbsp;at&nbsp;will&nbsp;cause&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;to&nbsp;validate&nbsp;and&nbsp;secure&nbsp;the<br>
-&nbsp;*&nbsp;request&nbsp;and&nbsp;response&nbsp;using&nbsp;it&nbsp;configured&nbsp;{@code&nbsp;ServerAuthModule}s.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;To&nbsp;configure&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;the&nbsp;Servlet&nbsp;Filter&nbsp;registration&nbsp;must&nbsp;contain&nbsp;the&nbsp;configuration&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;{@link&nbsp;ContextFactory}&nbsp;and&nbsp;the&nbsp;{@link&nbsp;AuditApi}.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiRuntimeFilter&nbsp;implements&nbsp;Filter&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_CLASS&nbsp;=&nbsp;&amp;quot;context-factory-class&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD&nbsp;=&nbsp;&amp;quot;context-factory-method&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD_DEFAULT&nbsp;=&nbsp;&amp;quot;getContextFactory&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Filter&nbsp;config&nbsp;can&nbsp;register&nbsp;different&nbsp;{@code&nbsp;ResourceException}&nbsp;handlers.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.forgerock.jaspi.runtime.ResourceExceptionHandler<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_EXCEPTION_HANDLERS&nbsp;=&nbsp;&amp;quot;resource-exception-handlers&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_CLASS&nbsp;=&nbsp;&amp;quot;audit-api-factory-class&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_METHOD&nbsp;=&nbsp;&amp;quot;audit-api-factory-method&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_METHOD_DEFAULT&nbsp;=&nbsp;&amp;quot;getAuditApi&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextFactory&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiRuntime&nbsp;runtime;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Default&nbsp;constructor&nbsp;called&nbsp;during&nbsp;normal&nbsp;Filter&nbsp;initialization.&nbsp;Implementations&nbsp;MUST&nbsp;override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#getContextFactory(FilterConfig)}&nbsp;and&nbsp;{@link&nbsp;#getAuditApi(FilterConfig)}&nbsp;in&nbsp;order&nbsp;for&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;to<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;function.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntimeFilter()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Creates&nbsp;a&nbsp;new&nbsp;Jaspi&nbsp;HTTP&nbsp;Filter&nbsp;with&nbsp;the&nbsp;provided&nbsp;context&nbsp;factory&nbsp;and&nbsp;audit&nbsp;api.&nbsp;This&nbsp;constructor&nbsp;is&nbsp;provided<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;as&nbsp;a&nbsp;convenience&nbsp;for&nbsp;cases&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;Filter&nbsp;is&nbsp;instantiated&nbsp;programmatically.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;HTTP&nbsp;Filter&nbsp;is&nbsp;created&nbsp;using&nbsp;this&nbsp;constructor&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;need&nbsp;to&nbsp;override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#getContextFactory(FilterConfig)}&nbsp;or&nbsp;{@link&nbsp;#getAuditApi(FilterConfig)}.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextFactory&nbsp;The&nbsp;context&nbsp;factory.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;The&nbsp;audit&nbsp;api.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntimeFilter(ContextFactory&nbsp;contextFactory,&nbsp;AuditApi&nbsp;auditApi)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Initialises&nbsp;the&nbsp;filter&nbsp;with&nbsp;the&nbsp;provided&nbsp;filter&nbsp;configuration.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;The&nbsp;filter&nbsp;config.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;either&nbsp;the&nbsp;{@code&nbsp;ContextFactory}&nbsp;or&nbsp;{@code&nbsp;AuditApi}&nbsp;instance&nbsp;could&nbsp;not&nbsp;be&nbsp;created.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;init(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(contextFactory&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextFactory&nbsp;=&nbsp;getContextFactory(config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditApi&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;getAuditApi(config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;exceptionHandlers&nbsp;=&nbsp;config.getInitParameter(JaspiRuntimeFilter.INIT_PARAM_EXCEPTION_HANDLERS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(exceptionHandlers&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(String&nbsp;handlerClassName&nbsp;:&nbsp;exceptionHandlers.split(&amp;quot;,&amp;quot;))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;ResourceExceptionHandler&amp;gt;&nbsp;handlerClass&nbsp;=&nbsp;Class.forName(handlerClassName.trim())<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.asSubclass(ResourceExceptionHandler.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler.registerExceptionHandler(handlerClass);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(ClassNotFoundException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&amp;quot;Class&nbsp;is&nbsp;not&nbsp;available:&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClassName,&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.runtime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;new&nbsp;RuntimeResultHandler(),&nbsp;auditApi,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;On&nbsp;receipt&nbsp;of&nbsp;a&nbsp;request&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;is&nbsp;invoked&nbsp;to&nbsp;validate&nbsp;the&nbsp;request&nbsp;and&nbsp;secure&nbsp;the&nbsp;response,&nbsp;(providing<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;validation&nbsp;was&nbsp;successful).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;ServletRequest.&nbsp;MUST&nbsp;be&nbsp;of&nbsp;type&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;ServletResponse.&nbsp;MUST&nbsp;be&nbsp;of&nbsp;type&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;chain&nbsp;The&nbsp;filter&nbsp;chain.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;exception&nbsp;thrown&nbsp;from&nbsp;the&nbsp;Jaspi&nbsp;runtime.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;doFilter(ServletRequest&nbsp;request,&nbsp;ServletResponse&nbsp;response,&nbsp;FilterChain&nbsp;chain)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(request&nbsp;instanceof&nbsp;HttpServletRequest&nbsp;&amp;amp;&amp;amp;&nbsp;response&nbsp;instanceof&nbsp;HttpServletResponse))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Non&nbsp;HTTP&nbsp;request&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.processMessage((HttpServletRequest)&nbsp;request,&nbsp;(HttpServletResponse)&nbsp;response,&nbsp;chain);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextFactory&nbsp;getContextFactory(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(config&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;for&nbsp;configured&nbsp;connection&nbsp;factory&nbsp;class&nbsp;first.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;className&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_CONTEXT_FACTORY_CLASS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(className&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Class&amp;lt;?&amp;gt;&nbsp;cls&nbsp;=&nbsp;Class.forName(className);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;tmp&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_CONTEXT_FACTORY_METHOD);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;methodName&nbsp;=&nbsp;tmp&nbsp;!=&nbsp;null&nbsp;?&nbsp;tmp&nbsp;:&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD_DEFAULT;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ContextFactory)&nbsp;factoryMethod.invoke(null,&nbsp;config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;IllegalArgumentException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;no-arg&nbsp;method.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ContextFactory)&nbsp;factoryMethod.invoke(null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;Exception&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIXME:&nbsp;i18n<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Unable&nbsp;to&nbsp;initialize&nbsp;ContextFactory&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;getAuditApi(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(config&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;for&nbsp;configured&nbsp;connection&nbsp;factory&nbsp;class&nbsp;first.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;className&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_AUDIT_API_CLASS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(className&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Class&amp;lt;?&amp;gt;&nbsp;cls&nbsp;=&nbsp;Class.forName(className);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;tmp&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_AUDIT_API_METHOD);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;methodName&nbsp;=&nbsp;tmp&nbsp;!=&nbsp;null&nbsp;?&nbsp;tmp&nbsp;:&nbsp;INIT_PARAM_AUDIT_API_METHOD_DEFAULT;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AuditApi)&nbsp;factoryMethod.invoke(null,&nbsp;config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;IllegalArgumentException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;no-arg&nbsp;method.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AuditApi)&nbsp;factoryMethod.invoke(null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;Exception&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIXME:&nbsp;i18n<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Unable&nbsp;to&nbsp;initialize&nbsp;AuditApi&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;destroy()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;what&nbsp;if&nbsp;context&nbsp;is&nbsp;still&nbsp;processing&nbsp;something?...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspicontextFallbackServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/FallbackServerAuthContext.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/FallbackServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/FallbackServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,207&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.context;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.*;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuthStatusUtils.asString;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.Collections;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditTrail;<br>
-import&nbsp;org.forgerock.jaspi.runtime.context.ContextHandler;<br>
-import&nbsp;org.forgerock.jaspi.runtime.context.JaspiServerAuthContext;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Encapsulates&nbsp;ServerAuthModules&nbsp;that&nbsp;are&nbsp;used&nbsp;to&nbsp;validate&nbsp;service&nbsp;requests&nbsp;received&nbsp;from&nbsp;clients,&nbsp;and&nbsp;to&nbsp;secure&nbsp;any<br>
-&nbsp;*&nbsp;response&nbsp;returned&nbsp;for&nbsp;those&nbsp;requests.<br>
-&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;*&nbsp;This&nbsp;FallbackServerAuthContext&nbsp;can&nbsp;be&nbsp;configured&nbsp;to&nbsp;use&nbsp;a&nbsp;single&nbsp;Session&nbsp;ServerAuthModule,&nbsp;to&nbsp;provide&nbsp;session<br>
-&nbsp;*&nbsp;capabilities&nbsp;(i.e.&nbsp;on&nbsp;secureResponse&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;which&nbsp;is&nbsp;validated&nbsp;on&nbsp;subsequent&nbsp;request&nbsp;to&nbsp;skip&nbsp;re-authenticating<br>
-&nbsp;*&nbsp;for&nbsp;each&nbsp;request),&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;ServerAuthModule&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;in&nbsp;order&nbsp;until&nbsp;one&nbsp;returns&nbsp;a&nbsp;non-failure<br>
-&nbsp;*&nbsp;AuthStatus,&nbsp;or&nbsp;the&nbsp;list&nbsp;is&nbsp;exhausted.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;FallbackServerAuthContext&nbsp;extends&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;String&nbsp;AUTHENTICATING_AUTH_MODULE_KEY&nbsp;=&nbsp;&amp;quot;authenticatingAuthModule&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;FallbackServerAuthContext&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;The&nbsp;configured&nbsp;Session&nbsp;AuthModule.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configure&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;do&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FallbackServerAuthContext(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule,&nbsp;final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,&nbsp;authModules);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;logic&nbsp;used&nbsp;to&nbsp;determine&nbsp;which&nbsp;of&nbsp;the&nbsp;list&nbsp;of&nbsp;ServerAuthModules&nbsp;are&nbsp;called&nbsp;is&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Modules&nbsp;are&nbsp;called&nbsp;in&nbsp;insertion&nbsp;order&nbsp;in&nbsp;the&nbsp;list.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SUCCESS&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_SUCCESS&nbsp;the&nbsp;module&nbsp;has&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;and&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_CONTINUE&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;the&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client&nbsp;and<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;context&nbsp;will&nbsp;call&nbsp;the&nbsp;next&nbsp;subsequent&nbsp;module.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;modules&nbsp;in&nbsp;the&nbsp;configured&nbsp;list&nbsp;the&nbsp;last&nbsp;AuthStatus&nbsp;is&nbsp;returned&nbsp;and&nbsp;processing<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stops..&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;index&nbsp;=&nbsp;0;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;&amp;quot;AuthModule-&amp;quot;&nbsp;+&nbsp;authModule.getClass().getSimpleName()&nbsp;+&nbsp;&amp;quot;-&amp;quot;&nbsp;+&nbsp;index++;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;doValidateRequest(authModule,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject,&nbsp;moduleId,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Record&nbsp;the&nbsp;AuthModules&nbsp;AuthStatus&nbsp;to&nbsp;decided&nbsp;later&nbsp;whether&nbsp;to&nbsp;call&nbsp;secureResponse&nbsp;on&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;AuthModule.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authenticatingAuthModule&nbsp;=&nbsp;authModule;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;put&nbsp;authStatus&nbsp;and&nbsp;authenticatingAuthModule&nbsp;in&nbsp;MessageInfo&nbsp;so&nbsp;can&nbsp;accessed&nbsp;by&nbsp;secureResponse&nbsp;in&nbsp;a<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;stateless&nbsp;way<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Adding&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;to&nbsp;private&nbsp;context&nbsp;map,&nbsp;{}&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authenticatingAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authContextMap&nbsp;=&nbsp;getMessageInfoUtils().getMap(messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIVATE_CONTEXT_MAP_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContextMap.put(AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authenticatingAuthModule);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;emptyMap(),&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;--&nbsp;In&nbsp;our&nbsp;implementation&nbsp;we&nbsp;will&nbsp;let&nbsp;subsequent&nbsp;modules&nbsp;try&nbsp;before&nbsp;sending&nbsp;the&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticated&nbsp;the&nbsp;client,&nbsp;passing&nbsp;to&nbsp;Auth&nbsp;Modules&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;In&nbsp;this&nbsp;implementation&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;we&nbsp;are&nbsp;allowing&nbsp;a&nbsp;single&nbsp;&amp;quot;session&amp;quot;&nbsp;auth&nbsp;module&nbsp;to<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;run&nbsp;and&nbsp;possible&nbsp;succeed&nbsp;and&nbsp;if&nbsp;so&nbsp;will&nbsp;stop&nbsp;processing,&nbsp;otherwise&nbsp;we&nbsp;allow&nbsp;a&nbsp;list&nbsp;of&nbsp;&amp;quot;normal&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;modules&nbsp;to&nbsp;try&nbsp;and&nbsp;authenticate&nbsp;the&nbsp;request.&nbsp;Hence&nbsp;why&nbsp;here&nbsp;a&nbsp;SEND_FAILURE&nbsp;will&nbsp;carry&nbsp;on<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;processing,&nbsp;where&nbsp;as&nbsp;SEND_CONTINUE&nbsp;and&nbsp;SEND_SUCCESS&nbsp;will&nbsp;cause&nbsp;processing&nbsp;to&nbsp;end.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;SEND_CONTINUE&nbsp;implies&nbsp;that&nbsp;there&nbsp;is&nbsp;to&nbsp;be&nbsp;more&nbsp;communication&nbsp;between&nbsp;server&nbsp;and&nbsp;client&nbsp;before<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;can&nbsp;be&nbsp;deemed&nbsp;successful&nbsp;or&nbsp;failed.&nbsp;So&nbsp;processing&nbsp;needs&nbsp;to&nbsp;stop&nbsp;and&nbsp;a&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Only&nbsp;the&nbsp;ServerAuthModule&nbsp;which&nbsp;returned&nbsp;AuthStatus.SUCCESS&nbsp;for&nbsp;its&nbsp;#validateRequest&nbsp;method&nbsp;will&nbsp;have&nbsp;its<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;secureResponse&nbsp;method&nbsp;call&nbsp;and&nbsp;if&nbsp;no&nbsp;ServerAuthModule&nbsp;successfully&nbsp;validated&nbsp;the&nbsp;request&nbsp;then&nbsp;this&nbsp;method<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;return&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authContextMap&nbsp;=&nbsp;getMessageInfoUtils().getMap(messageInfo,&nbsp;PRIVATE_CONTEXT_MAP_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;authenticatingAuthModule&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServerAuthModule)&nbsp;authContextMap.remove(AUTHENTICATING_AUTH_MODULE_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;authenticationAuthModule&nbsp;has&nbsp;been&nbsp;set,&nbsp;ie&nbsp;a&nbsp;normal&nbsp;ServerAuthModule&nbsp;successfully&nbsp;validated&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authenticatingAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Using&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;from&nbsp;private&nbsp;context&nbsp;map,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authenticatingAuthModule.getClass().getSimpleName()&nbsp;+&nbsp;&amp;quot;,&nbsp;to&nbsp;secure&nbsp;the&nbsp;response&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authenticatingAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspicontextpackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/context/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,21&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;a&nbsp;set&nbsp;of&nbsp;concrete&nbsp;implementations&nbsp;for&nbsp;creating&nbsp;and&nbsp;retrieving&nbsp;an&nbsp;instance&nbsp;of&nbsp;a<br>
-&nbsp;*&nbsp;FallbackServerAuthContext&nbsp;to&nbsp;co-ordinate&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;instances.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi.context;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiexceptionspackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/exceptions/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/exceptions/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/exceptions/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,20&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;extensions&nbsp;to&nbsp;the&nbsp;AuthException&nbsp;from&nbsp;the&nbsp;Jaspi&nbsp;specification.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi.exceptions;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspipackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,20&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;contains&nbsp;the&nbsp;classes&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuditApijava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditApi.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditApi.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditApi.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,87&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Audit&nbsp;API&nbsp;interface&nbsp;for&nbsp;auditing&nbsp;the&nbsp;result&nbsp;of&nbsp;an&nbsp;authentication&nbsp;request.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
-&nbsp;*/<br>
-public&nbsp;interface&nbsp;AuditApi&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Audits&nbsp;the&nbsp;authentication&nbsp;request,&nbsp;using&nbsp;the&nbsp;audit&nbsp;information&nbsp;from&nbsp;the&nbsp;given&nbsp;audit&nbsp;message.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;For&nbsp;successful&nbsp;authentications:&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;requestId&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;[<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;demo&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;],<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;context&amp;quot;:&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;sessionId&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;entries&amp;quot;:&nbsp;[<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;moduleId&amp;quot;:&nbsp;&amp;quot;Session-JwtSessionModule&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;info&amp;quot;:&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;&amp;quot;alice&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;...&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;]<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;For&nbsp;failed&nbsp;authentications:&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;FAILED&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;requestId&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;[<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;demo&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;//Multiple&nbsp;auth&nbsp;modules&nbsp;could&nbsp;identify&nbsp;different&nbsp;principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;],<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;context&amp;quot;:&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&amp;quot;entries&amp;quot;:&nbsp;[<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;moduleId&amp;quot;:&nbsp;&amp;quot;Session-JwtSessionModule&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;result&amp;quot;:&nbsp;&amp;quot;FAILED&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;reason&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;info&amp;quot;:&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;principal&amp;quot;:&nbsp;&amp;quot;bob&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;...&amp;quot;:&nbsp;&amp;quot;...&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;]<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditMessage&nbsp;The&nbsp;audit&nbsp;message.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;audit(JsonValue&nbsp;auditMessage);<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuditTrailjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditTrail.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditTrail.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuditTrail.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,218&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
-<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-import&nbsp;java.util.UUID;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;Is&nbsp;responsible&nbsp;for&nbsp;tracking&nbsp;the&nbsp;auditing&nbsp;of&nbsp;an&nbsp;authentication&nbsp;attempt&nbsp;including&nbsp;auditing&nbsp;each&nbsp;of&nbsp;the&nbsp;modules&nbsp;that<br>
-&nbsp;*&nbsp;are&nbsp;executed&nbsp;and&nbsp;the&nbsp;overall&nbsp;result&nbsp;of&nbsp;the&nbsp;authentication.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;audit&nbsp;record&nbsp;will&nbsp;include&nbsp;a&nbsp;unique&nbsp;request&nbsp;id,&nbsp;the&nbsp;principal&nbsp;(if&nbsp;authentication&nbsp;was&nbsp;successful)&nbsp;and&nbsp;a&nbsp;session<br>
-&nbsp;*&nbsp;id&nbsp;(if&nbsp;a&nbsp;session&nbsp;was&nbsp;created).&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;AuditTrail&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;retrieving&nbsp;the&nbsp;audit&nbsp;trail&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_TRAIL_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;additional&nbsp;audit&nbsp;information&nbsp;from&nbsp;a&nbsp;module.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_INFO_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.info&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;principal&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;has&nbsp;identified&nbsp;that&nbsp;will&nbsp;be&nbsp;set&nbsp;in&nbsp;the&nbsp;audit<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;log&nbsp;entry.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_PRINCIPAL_KEY&nbsp;=&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;session&nbsp;id&nbsp;for&nbsp;the&nbsp;authentication&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_SESSION_ID_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.session.id&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;reason&nbsp;for&nbsp;the&nbsp;module&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_FAILURE_REASON_KEY&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.audit.failure.reason&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;MODULE_ID_KEY&nbsp;=&nbsp;&amp;quot;moduleId&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;RESULT_KEY&nbsp;=&nbsp;&amp;quot;result&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;PRINCIPAL_KEY&nbsp;=&nbsp;&amp;quot;principal&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;CONTEXT_KEY&nbsp;=&nbsp;&amp;quot;context&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;SESSION_ID_KEY&nbsp;=&nbsp;&amp;quot;sessionId&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;REQUEST_ID_KEY&nbsp;=&nbsp;&amp;quot;requestId&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;ENTRIES_KEY&nbsp;=&nbsp;&amp;quot;entries&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;REASON_KEY&nbsp;=&nbsp;&amp;quot;reason&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INFO_KEY&nbsp;=&nbsp;&amp;quot;info&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;SUCCESSFUL_RESULT&nbsp;=&nbsp;&amp;quot;SUCCESSFUL&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;FAILED_RESULT&nbsp;=&nbsp;&amp;quot;FAILED&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuditApi&nbsp;api;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;entries&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;json(object(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(REQUEST_ID_KEY,&nbsp;UUID.randomUUID().toString()),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(ENTRIES_KEY,&nbsp;entries)));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;AuditTrail&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;api&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditApi}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuditTrail(AuditApi&nbsp;api,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.api&nbsp;=&nbsp;api;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(CONTEXT_KEY,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Audits&nbsp;a&nbsp;module&nbsp;as&nbsp;having&nbsp;completed&nbsp;successfully.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;id&nbsp;of&nbsp;the&nbsp;module.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;info&nbsp;The&nbsp;module&nbsp;audit&nbsp;info&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditSuccess(String&nbsp;moduleId,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;info)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries.add(json(object(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(MODULE_ID_KEY,&nbsp;moduleId),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(RESULT_KEY,&nbsp;SUCCESSFUL_RESULT),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(INFO_KEY,&nbsp;info))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).asMap());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Audits&nbsp;a&nbsp;module&nbsp;as&nbsp;having&nbsp;completed&nbsp;as&nbsp;a&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;id&nbsp;of&nbsp;the&nbsp;module.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;reason&nbsp;The&nbsp;reason&nbsp;the&nbsp;module&nbsp;is&nbsp;reporting&nbsp;a&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;info&nbsp;The&nbsp;module&nbsp;audit&nbsp;info&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditFailure(String&nbsp;moduleId,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;reason,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;info)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries.add(json(object(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(MODULE_ID_KEY,&nbsp;moduleId),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(RESULT_KEY,&nbsp;FAILED_RESULT),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(REASON_KEY,&nbsp;reason),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(INFO_KEY,&nbsp;info))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).asMap());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Completes&nbsp;the&nbsp;entire&nbsp;audit&nbsp;record&nbsp;as&nbsp;successful.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;principal&nbsp;The&nbsp;principal.&nbsp;Must&nbsp;have&nbsp;been&nbsp;set&nbsp;by&nbsp;the&nbsp;successful&nbsp;module.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;completeAuditAsSuccessful(String&nbsp;principal)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(RESULT_KEY,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;).put(PRINCIPAL_KEY,&nbsp;array(principal));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Completes&nbsp;the&nbsp;entire&nbsp;audit&nbsp;record&nbsp;as&nbsp;a&nbsp;failure.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;No&nbsp;auth&nbsp;module&nbsp;successfully&nbsp;completed&nbsp;so&nbsp;will&nbsp;check&nbsp;each&nbsp;auth&nbsp;module&nbsp;entry's&nbsp;audit&nbsp;info&nbsp;map&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#AUDIT_PRINCIPAL_KEY}&nbsp;key&nbsp;and&nbsp;will&nbsp;created&nbsp;an&nbsp;ordered&nbsp;list&nbsp;of&nbsp;all&nbsp;non-null&nbsp;principal&nbsp;values.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;completeAuditAsFailure()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;principals&nbsp;=&nbsp;array();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;entry&nbsp;:&nbsp;entries)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entry.get(INFO_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditInfo&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;auditInfo.get(AUDIT_PRINCIPAL_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principals.add(principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(RESULT_KEY,&nbsp;&amp;quot;FAILED&amp;quot;).put(PRINCIPAL_KEY,&nbsp;principals);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Performs&nbsp;the&nbsp;actual&nbsp;audit&nbsp;by&nbsp;calling&nbsp;the&nbsp;{@link&nbsp;AuditApi#audit(JsonValue)}&nbsp;with&nbsp;the&nbsp;audit&nbsp;record.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;audit()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;api.audit(auditMessage);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;session&nbsp;id&nbsp;on&nbsp;the&nbsp;audit&nbsp;record,&nbsp;if&nbsp;a&nbsp;session&nbsp;has&nbsp;been&nbsp;created.&nbsp;Will&nbsp;not&nbsp;set&nbsp;the&nbsp;session&nbsp;id&nbsp;on&nbsp;the&nbsp;audit<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;record&nbsp;if&nbsp;it&nbsp;is&nbsp;{@code&nbsp;null}&nbsp;or&nbsp;an&nbsp;empty&nbsp;{@code&nbsp;String}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionId&nbsp;The&nbsp;session&nbsp;id.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setSessionId(String&nbsp;sessionId)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionId&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!sessionId.isEmpty())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(SESSION_ID_KEY,&nbsp;sessionId);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;request&nbsp;id.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;request&nbsp;id.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;getRequestId()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;auditMessage.get(REQUEST_ID_KEY).asString();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;list&nbsp;of&nbsp;failure&nbsp;reasons&nbsp;from&nbsp;each&nbsp;of&nbsp;the&nbsp;module&nbsp;entries.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;failure&nbsp;reasons&nbsp;as&nbsp;{@code&nbsp;Map}s&nbsp;of&nbsp;{@code&nbsp;String}&nbsp;to&nbsp;{@code&nbsp;Object}s.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;getFailureReasons()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasons&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;entry&nbsp;:&nbsp;entries)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entry.get(REASON_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;==&nbsp;null&nbsp;||&nbsp;failureReason.isEmpty())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReasons.add(failureReason);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;failureReasons;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;auditMessage.toString();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeAuthStatusUtilsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuthStatusUtils.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuthStatusUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/AuthStatusUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,111&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.FAILURE;<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.SEND_CONTINUE;<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.SEND_FAILURE;<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.SEND_SUCCESS;<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.SUCCESS;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Utility&nbsp;class&nbsp;providing&nbsp;utility&nbsp;methods&nbsp;for&nbsp;determining&nbsp;the&nbsp;meaning&nbsp;behind&nbsp;each&nbsp;of&nbsp;the&nbsp;different&nbsp;{@link&nbsp;AuthStatus}<br>
-&nbsp;*&nbsp;values.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
-&nbsp;*/<br>
-public&nbsp;final&nbsp;class&nbsp;AuthStatusUtils&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Private&nbsp;utility&nbsp;constructor.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthStatusUtils()&nbsp;{&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Converts&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;into&nbsp;its&nbsp;{@code&nbsp;String}&nbsp;representation.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;String.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;String&nbsp;asString(AuthStatus&nbsp;authStatus)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SUCCESS&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isFailure(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;FAILURE&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendContinue(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SEND_CONTINUE&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SEND_FAILURE&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;SEND_SUCCESS&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;null&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SUCCESS}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SUCCESS}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SUCCESS.equals(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSendSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_SUCCESS.equals(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_CONTINUE}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_CONTINUE}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;boolean&nbsp;isSendContinue(AuthStatus&nbsp;authStatus)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_CONTINUE.equals(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSendFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_FAILURE.equals(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#FAILURE}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#FAILURE}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FAILURE.equals(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeContextFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ContextFactory.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,36&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;A&nbsp;factory&nbsp;which&nbsp;is&nbsp;responsible&nbsp;for&nbsp;creating&nbsp;{@code&nbsp;ServerAuthContext}s&nbsp;for&nbsp;authenticating&nbsp;requests.<br>
-&nbsp;*/<br>
-public&nbsp;interface&nbsp;ContextFactory&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Returns&nbsp;the&nbsp;context&nbsp;which&nbsp;should&nbsp;be&nbsp;used&nbsp;to&nbsp;authenticate&nbsp;requests.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;method&nbsp;is&nbsp;called&nbsp;for&nbsp;each&nbsp;request.&nbsp;This&nbsp;means&nbsp;that&nbsp;the&nbsp;{@code&nbsp;ServerAuthContext}&nbsp;instance&nbsp;can&nbsp;be<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;changed/updated&nbsp;with&nbsp;new&nbsp;ServerAuthModules&nbsp;and&nbsp;any&nbsp;changes&nbsp;will&nbsp;be&nbsp;picked&nbsp;up&nbsp;by&nbsp;the&nbsp;runtime&nbsp;for&nbsp;subsequent<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;requests.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;context&nbsp;which&nbsp;should&nbsp;be&nbsp;used&nbsp;for&nbsp;authenticating&nbsp;requests.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;getContext();<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeHttpServletCallbackHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandler.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,139&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.callback.Callback;<br>
-import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
-import&nbsp;javax.security.auth.callback.UnsupportedCallbackException;<br>
-import&nbsp;javax.security.auth.message.callback.CallerPrincipalCallback;<br>
-import&nbsp;javax.security.auth.message.callback.CertStoreCallback;<br>
-import&nbsp;javax.security.auth.message.callback.GroupPrincipalCallback;<br>
-import&nbsp;javax.security.auth.message.callback.PasswordValidationCallback;<br>
-import&nbsp;javax.security.auth.message.callback.PrivateKeyCallback;<br>
-import&nbsp;javax.security.auth.message.callback.SecretKeyCallback;<br>
-import&nbsp;javax.security.auth.message.callback.TrustStoreCallback;<br>
-import&nbsp;java.security.Principal;<br>
-import&nbsp;java.util.Set;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Callback&nbsp;handler&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;HttpServletCallbackHandler&nbsp;implements&nbsp;CallbackHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Called&nbsp;by&nbsp;Authentication&nbsp;modules&nbsp;to&nbsp;request&nbsp;more&nbsp;information&nbsp;about&nbsp;the&nbsp;request&nbsp;and&nbsp;response&nbsp;message.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Callbacks&nbsp;currently&nbsp;supported&nbsp;are&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;CallerPrincipalCallback&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;GroupPrincipalCallback&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;method&nbsp;will&nbsp;handle&nbsp;a&nbsp;CallerPrincipalCallback&nbsp;by&nbsp;creating&nbsp;a&nbsp;Principal&nbsp;from&nbsp;the&nbsp;name&nbsp;stored&nbsp;in&nbsp;the&nbsp;Callback<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;adding&nbsp;it&nbsp;to&nbsp;the&nbsp;Subject&nbsp;from&nbsp;the&nbsp;Callback.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;not&nbsp;populated&nbsp;then&nbsp;the&nbsp;Principal&nbsp;stored&nbsp;in&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Callback&nbsp;will&nbsp;be&nbsp;added&nbsp;to&nbsp;the&nbsp;Subject&nbsp;instead.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;method&nbsp;will&nbsp;handle&nbsp;a&nbsp;GroupPrincipalCallback&nbsp;by&nbsp;create&nbsp;a&nbsp;Principal&nbsp;for&nbsp;each&nbsp;group&nbsp;stored&nbsp;in&nbsp;the&nbsp;Callback<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;adding&nbsp;them&nbsp;to&nbsp;the&nbsp;Subject&nbsp;from&nbsp;the&nbsp;Callback.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbacks&nbsp;An&nbsp;array&nbsp;of&nbsp;Callback&nbsp;objects&nbsp;provided&nbsp;by&nbsp;the&nbsp;Authentication&nbsp;modules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;UnsupportedCallbackException&nbsp;If&nbsp;a&nbsp;callback&nbsp;is&nbsp;passed&nbsp;which&nbsp;is&nbsp;not&nbsp;supported&nbsp;by&nbsp;this&nbsp;CallbackHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handle(final&nbsp;Callback[]&nbsp;callbacks)&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Callback&nbsp;callback&nbsp;:&nbsp;callbacks)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(CallerPrincipalCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callerPrincipalCallback&nbsp;=&nbsp;(CallerPrincipalCallback)&nbsp;callback;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;callerPrincipalCallback.getSubject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;name&nbsp;=&nbsp;callerPrincipalCallback.getName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;callerPrincipalCallback.getPrincipal();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;principal.getName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.getPrincipals().add(principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(name&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;name);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.getPrincipals().add(new&nbsp;Principal()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getName()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;name;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Both&nbsp;name&nbsp;and&nbsp;principal&nbsp;are&nbsp;null&nbsp;so&nbsp;not&nbsp;adding&nbsp;either.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Not&nbsp;adding&nbsp;principal&nbsp;as&nbsp;no&nbsp;name&nbsp;or&nbsp;principal&nbsp;set&nbsp;on&nbsp;callback&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(GroupPrincipalCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GroupPrincipalCallback&nbsp;groupPrincipalCallback&nbsp;=&nbsp;(GroupPrincipalCallback)&nbsp;callback;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;groupPrincipalCallback.getSubject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[]&nbsp;groups&nbsp;=&nbsp;groupPrincipalCallback.getGroups();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(groups&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&amp;lt;Principal&amp;gt;&nbsp;principals&nbsp;=&nbsp;subject.getPrincipals();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(final&nbsp;String&nbsp;group&nbsp;:&nbsp;groups)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;group);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principals.add(new&nbsp;Principal()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getName()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;group;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(PasswordValidationCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;JSR-196&nbsp;Spec&nbsp;states&nbsp;this&nbsp;MUST&nbsp;be&nbsp;implemented&nbsp;but&nbsp;as&nbsp;this&nbsp;is&nbsp;not&nbsp;actually&nbsp;a&nbsp;&amp;quot;real&amp;quot;&nbsp;container<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;we&nbsp;don't&nbsp;need&nbsp;to&nbsp;do&nbsp;this&nbsp;here.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;PasswordValidationCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(CertStoreCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;CertStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(PrivateKeyCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;PrivateKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SecretKeyCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;SecretKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(TrustStoreCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;TrustStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
-//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(HttpCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
-//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
-//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeHttpServletMessageInfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletMessageInfo.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletMessageInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/HttpServletMessageInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,114&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.forgerock.jaspi.runtime.response.JaspiHttpServletResponseWrapper;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletRequestWrapper;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Provides&nbsp;an&nbsp;implementation&nbsp;of&nbsp;a&nbsp;MessageInfo&nbsp;for&nbsp;the&nbsp;HttpServlet&nbsp;profile.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;HttpServletMessageInfo&nbsp;implements&nbsp;MessageInfo&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletRequestWrapper&nbsp;request;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletResponseWrapper&nbsp;response;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;properties;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;HttpServletMessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HtwtpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletMessageInfo(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this(request,&nbsp;response,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;HttpServletMessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;properties&nbsp;A&nbsp;Map&nbsp;of&nbsp;properties.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletMessageInfo(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;properties)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setRequestMessage(request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResponseMessage(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.properties&nbsp;=&nbsp;properties;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;request&nbsp;message&nbsp;object&nbsp;from&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;request&nbsp;message,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;request&nbsp;message&nbsp;is&nbsp;set&nbsp;within&nbsp;the&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletRequest&nbsp;getRequestMessage()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;request;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;response&nbsp;message&nbsp;object&nbsp;from&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;response&nbsp;message,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;response&nbsp;message&nbsp;is&nbsp;set&nbsp;within&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletResponse&nbsp;getResponseMessage()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;response;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;request&nbsp;message&nbsp;object&nbsp;in&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;request&nbsp;message.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setRequestMessage(final&nbsp;Object&nbsp;request)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.request&nbsp;=&nbsp;new&nbsp;HttpServletRequestWrapper((HttpServletRequest)&nbsp;request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;response&nbsp;message&nbsp;object&nbsp;in&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;response&nbsp;message.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setResponseMessage(final&nbsp;Object&nbsp;response)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.response&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper((HttpServletResponse)&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;(a&nbsp;reference&nbsp;to)&nbsp;the&nbsp;Map&nbsp;object&nbsp;of&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;Map&nbsp;object&nbsp;of&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;properties;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeJaspiRuntimejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/JaspiRuntime.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/JaspiRuntime.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/JaspiRuntime.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,213&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.AUDIT_TRAIL_KEY;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuthStatusUtils.isSendContinue;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.field;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
-<br>
-import&nbsp;org.forgerock.auth.common.DebugLogger;<br>
-import&nbsp;org.forgerock.jaspi.runtime.response.FailureResponseHandler;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.ServletRequest;<br>
-import&nbsp;javax.servlet.ServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;class&nbsp;is&nbsp;the&nbsp;entry&nbsp;point&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;Provides&nbsp;a&nbsp;single&nbsp;method&nbsp;#processMessage&nbsp;that&nbsp;takes&nbsp;a&nbsp;HttpServletRequest,&nbsp;HttpServletResponse&nbsp;and&nbsp;the&nbsp;FilterChain<br>
-&nbsp;*&nbsp;and&nbsp;will&nbsp;run&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;request&nbsp;is&nbsp;allowed&nbsp;to&nbsp;be&nbsp;passed&nbsp;down<br>
-&nbsp;*&nbsp;the&nbsp;filter&nbsp;chain.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;Note:&amp;lt;/strong&amp;gt;&nbsp;if&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;is&nbsp;not&nbsp;configured&nbsp;properly&nbsp;with&nbsp;a&nbsp;non-null&nbsp;ServerAuthContext<br>
-&nbsp;*&nbsp;each&nbsp;request&nbsp;will&nbsp;be&nbsp;passed&nbsp;straight&nbsp;to&nbsp;the&nbsp;filter&nbsp;chain&nbsp;with&nbsp;no&nbsp;further&nbsp;processing.&nbsp;So&nbsp;it&nbsp;is&nbsp;VERY&nbsp;important<br>
-&nbsp;*&nbsp;to&nbsp;ensure&nbsp;the&nbsp;runtime&nbsp;is&nbsp;configured&nbsp;correctly.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiRuntime&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Runtime&nbsp;slf4j&nbsp;debug&nbsp;logger.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;Logger&nbsp;LOG&nbsp;=&nbsp;LoggerFactory.getLogger(JaspiRuntime.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Indicates&nbsp;that&nbsp;the&nbsp;request&nbsp;could&nbsp;not&nbsp;be&nbsp;authenticated&nbsp;either&nbsp;because&nbsp;no&nbsp;credentials&nbsp;were&nbsp;provided&nbsp;or<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;credentials&nbsp;provided&nbsp;did&nbsp;not&nbsp;pass&nbsp;authentication.&nbsp;Equivalent&nbsp;to&nbsp;HTTP&nbsp;status:&nbsp;401&nbsp;Unauthorized.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;int&nbsp;UNAUTHORIZED_HTTP_ERROR_CODE&nbsp;=&nbsp;401;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;exception&nbsp;message&nbsp;for&nbsp;a&nbsp;401&nbsp;ResourceException.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;UNAUTHORIZED_ERROR_MESSAGE&nbsp;=&nbsp;&amp;quot;Access&nbsp;Denied&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;application/json&nbsp;HTTP&nbsp;Media&nbsp;Type.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;JSON_HTTP_MEDIA_TYPE&nbsp;=&nbsp;&amp;quot;application/json&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;principal&nbsp;name&nbsp;of&nbsp;the&nbsp;user/client&nbsp;making&nbsp;the&nbsp;request<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;set.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_PRINCIPAL&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.principal&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;any&nbsp;additional&nbsp;authentication&nbsp;context&nbsp;information<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;set.&nbsp;It&nbsp;MUST&nbsp;contain&nbsp;a&nbsp;{@code&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;if&nbsp;present.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_CONTEXT&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.context&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;unique&nbsp;id&nbsp;of&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;set.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_REQUEST_ID&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.request.id&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ContextFactory&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;RuntimeResultHandler&nbsp;resultHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuditApi&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;FailureResponseHandler&nbsp;failureResponseHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiRuntime.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextFactory&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;ContextFactory}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;resultHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;RuntimeResultHandler}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditApi}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;failureResponseHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;FailureResponseHandler}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntime(ContextFactory&nbsp;contextFactory,&nbsp;RuntimeResultHandler&nbsp;resultHandler,&nbsp;AuditApi&nbsp;auditApi,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.resultHandler&nbsp;=&nbsp;resultHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.failureResponseHandler&nbsp;=&nbsp;failureResponseHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Processes&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Guaranteed&nbsp;to&nbsp;call&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;validateRequest&nbsp;method&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;request&nbsp;is<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;allowed&nbsp;through&nbsp;and&nbsp;if&nbsp;validation&nbsp;was&nbsp;successful,&nbsp;to&nbsp;call&nbsp;secureResponse&nbsp;after&nbsp;the&nbsp;service&nbsp;call&nbsp;has&nbsp;completed.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Any&nbsp;authentication&nbsp;exceptions&nbsp;that&nbsp;occur&nbsp;during&nbsp;this&nbsp;process&nbsp;will&nbsp;be&nbsp;caught&nbsp;and&nbsp;converted&nbsp;into&nbsp;a&nbsp;Json&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;that&nbsp;matches&nbsp;a&nbsp;HTTP&nbsp;500&nbsp;status&nbsp;code.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;no&nbsp;ServerAuthContext&nbsp;is&nbsp;configured&nbsp;for&nbsp;the&nbsp;HttpServlet&nbsp;layer&nbsp;and&nbsp;the&nbsp;requests&nbsp;application&nbsp;context,&nbsp;then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;allowed&nbsp;through.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;filterChain&nbsp;The&nbsp;filter&nbsp;chain.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error&nbsp;processing&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;processMessage(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;FilterChain&nbsp;filterChain)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Must&nbsp;create&nbsp;new&nbsp;client&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Can&nbsp;be&nbsp;null&nbsp;if&nbsp;no&nbsp;details&nbsp;required&nbsp;for&nbsp;service&nbsp;subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;new&nbsp;AuditTrail(auditApi,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;requestAuthStatus&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;contextFactory.getContext();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Could&nbsp;be&nbsp;null&nbsp;if&nbsp;no&nbsp;modules&nbsp;found<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(serverAuthContext&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;No&nbsp;ServerAuthContext&nbsp;configured!&nbsp;Jaspi&nbsp;Runtime&nbsp;not&nbsp;configured&nbsp;properly!&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&amp;quot;Proceeding&nbsp;with&nbsp;filter&nbsp;chain&nbsp;call.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter(request,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;This&nbsp;is&nbsp;where&nbsp;the&nbsp;modules&nbsp;are&nbsp;called<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestAuthStatus&nbsp;=&nbsp;serverAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!resultHandler.handleValidateRequestResult(requestAuthStatus,&nbsp;messageInfo,&nbsp;auditTrail,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject,&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;e;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_REQUEST_ID,&nbsp;auditTrail.getRequestId());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter((ServletRequest)&nbsp;messageInfo.getRequestMessage(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServletResponse)&nbsp;messageInfo.getResponseMessage());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;responseAuthStatus&nbsp;=&nbsp;serverAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(responseAuthStatus,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Give&nbsp;the&nbsp;AuthModule&nbsp;a&nbsp;chance&nbsp;to&nbsp;clear&nbsp;out&nbsp;any&nbsp;authentication&nbsp;data&nbsp;from&nbsp;the&nbsp;subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverAuthContext.cleanSubject(messageInfo,&nbsp;clientSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e.getCause()&nbsp;instanceof&nbsp;ResourceException)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(e.getMessage(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;(ResourceException)&nbsp;e.getCause();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(e.getMessage(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.INTERNAL_ERROR,&nbsp;e.getMessage());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;auditTrail.getFailureReasons();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReasonList&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!failureReasonList.isEmpty())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;failureReasons&amp;quot;,&nbsp;failureReasonList))));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler.handle(jre,&nbsp;messageInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IOException&nbsp;ioe)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(e.getMessage(),&nbsp;ioe);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(ioe.getMessage(),&nbsp;ioe);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isSendContinue(requestAuthStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeResourceExceptionHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ResourceExceptionHandler.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ResourceExceptionHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/ResourceExceptionHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,47&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.Writer;<br>
-import&nbsp;java.util.Collection;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Handle&nbsp;ResourceException&nbsp;responses&nbsp;for&nbsp;different&nbsp;media&nbsp;types.&nbsp;Implementations&nbsp;should&nbsp;be&nbsp;thread-safe.<br>
-&nbsp;*/<br>
-public&nbsp;interface&nbsp;ResourceExceptionHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Which&nbsp;media&nbsp;types&nbsp;can&nbsp;this&nbsp;handler&nbsp;handle<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;list&nbsp;of&nbsp;media&nbsp;types.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;MediaType&amp;gt;&nbsp;handles();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;the&nbsp;details&nbsp;of&nbsp;the&nbsp;exception&nbsp;out,&nbsp;and&nbsp;set&nbsp;the&nbsp;content&nbsp;type&nbsp;of&nbsp;the&nbsp;response.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;exception&nbsp;The&nbsp;exception&nbsp;to&nbsp;be&nbsp;written.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;response&nbsp;to&nbsp;write&nbsp;the&nbsp;details&nbsp;to.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;writing&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException;<br>
-<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeRuntimeResultHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/RuntimeResultHandler.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/RuntimeResultHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/RuntimeResultHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,118&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.security.Principal;<br>
-<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.*;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuthStatusUtils.asString;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Handler&nbsp;which&nbsp;handles&nbsp;the&nbsp;result&nbsp;of&nbsp;calls&nbsp;to&nbsp;a&nbsp;ServerAuthContexts&nbsp;validateRequest&nbsp;and&nbsp;secureResponse&nbsp;methods.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;RuntimeResultHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Handles&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;ServerAuthContext&nbsp;validateRequest&nbsp;method.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Only&nbsp;an&nbsp;AuthStatus&nbsp;of&nbsp;SUCCESS&nbsp;will&nbsp;return&nbsp;true&nbsp;and&nbsp;an&nbsp;AuthStatus&nbsp;of&nbsp;SEND_FAILURE&nbsp;will&nbsp;set&nbsp;the&nbsp;response&nbsp;status<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;401.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;returned&nbsp;AuthStatus&nbsp;from&nbsp;the&nbsp;validateRequest&nbsp;method&nbsp;call.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditTrail}&nbsp;for&nbsp;this&nbsp;authentication&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;client's&nbsp;subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;&amp;lt;code&amp;gt;true&amp;lt;/code&amp;gt;&nbsp;if&nbsp;the&nbsp;processing&nbsp;of&nbsp;the&nbsp;request&nbsp;should&nbsp;proceed,&nbsp;&amp;lt;code&amp;gt;false&amp;lt;/code&amp;gt;&nbsp;otherwise.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;If&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;not&nbsp;valid&nbsp;for&nbsp;a&nbsp;call&nbsp;to&nbsp;validateRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;boolean&nbsp;handleValidateRequestResult(AuthStatus&nbsp;authStatus,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;AuditTrail&nbsp;auditTrail,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request,&nbsp;with&nbsp;response&nbsp;message&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Failed&nbsp;to&nbsp;validate&nbsp;request,&nbsp;included&nbsp;response&nbsp;message.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(401);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;validating&nbsp;request.&nbsp;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;validateRequest:&nbsp;&amp;quot;&nbsp;+&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;getPrincipal(Subject&nbsp;clientSubject)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;principal.getName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;ServerAuthContext&nbsp;secureResponse&nbsp;method.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;An&nbsp;AuthStatus&nbsp;of&nbsp;SEND_CONTINUE&nbsp;will&nbsp;set&nbsp;the&nbsp;response&nbsp;status&nbsp;to&nbsp;100.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;returned&nbsp;AuthStatus&nbsp;from&nbsp;the&nbsp;secureResponse&nbsp;method&nbsp;call.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;If&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;not&nbsp;valid&nbsp;for&nbsp;a&nbsp;call&nbsp;to&nbsp;secureResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleSecureResponseResult(final&nbsp;AuthStatus&nbsp;authStatus,&nbsp;final&nbsp;HttpServletResponse&nbsp;response)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Successfully&nbsp;secured&nbsp;response.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Failed&nbsp;to&nbsp;secured&nbsp;response,&nbsp;included&nbsp;response&nbsp;message&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(500);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;securing&nbsp;response.&nbsp;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;secureResponse:&nbsp;&amp;quot;&nbsp;+&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextContextHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/ContextHandler.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/ContextHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/ContextHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,159&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.context;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.security.Principal;<br>
-import&nbsp;java.util.Arrays;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;A&nbsp;handler&nbsp;for&nbsp;ServerAuthContext,&nbsp;which&nbsp;exposes&nbsp;helper&nbsp;methods&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;at&nbsp;the&nbsp;varying&nbsp;end&nbsp;states<br>
-&nbsp;*&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;processing.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;ContextHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constant&nbsp;for&nbsp;the&nbsp;list&nbsp;of&nbsp;auth&nbsp;module&nbsp;failure&nbsp;reasons.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;FAILURE_REASONS&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ContextHandler(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Validates&nbsp;that&nbsp;each&nbsp;given&nbsp;ServerAuthModule&nbsp;conforms&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile&nbsp;by&nbsp;calling&nbsp;each<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;modules&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;and&nbsp;ensuring&nbsp;it&nbsp;contains&nbsp;both&nbsp;the&nbsp;HttpServletRequest&nbsp;and<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;HttpServletResponse&nbsp;classes.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;List&nbsp;of&nbsp;ServerAuthModules&nbsp;to&nbsp;check.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;ServerAuthModules&nbsp;does&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModuleConformToHttpServletProfile(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkAuthModuleSupportsHttpServletProfile(authModule);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Validates&nbsp;that&nbsp;the&nbsp;given&nbsp;ServerAuthModule&nbsp;conforms&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile&nbsp;by&nbsp;calling&nbsp;the&nbsp;module's<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;and&nbsp;ensuring&nbsp;it&nbsp;contains&nbsp;both&nbsp;the&nbsp;HttpServletRequest&nbsp;and&nbsp;HttpServletResponse<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;classes.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;ServerAuthModule&nbsp;to&nbsp;check.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;the&nbsp;ServerAuthModule&nbsp;does&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;checkAuthModuleSupportsHttpServletProfile(final&nbsp;ServerAuthModule&nbsp;authModule)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;gt;&nbsp;supportedTypes&nbsp;=&nbsp;Arrays.asList(authModule.getSupportedMessageTypes());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(supportedTypes.contains(HttpServletRequest.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;amp;&amp;amp;&nbsp;supportedTypes.contains(HttpServletResponse.class)))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;ServerAuthModule&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;HttpServlet&nbsp;profile,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModule.getClass().getName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;ServerAuthModule&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;HttpServlet&nbsp;profile,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModule.getClass().getName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;completion&nbsp;of&nbsp;an&nbsp;authentication&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Checks&nbsp;if&nbsp;the&nbsp;authentication&nbsp;resulted&nbsp;in&nbsp;a&nbsp;valid&nbsp;AuthStatus&nbsp;and&nbsp;if&nbsp;not&nbsp;will&nbsp;write&nbsp;a&nbsp;401&nbsp;Unauthorized&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;the&nbsp;HttpServletResponse&nbsp;stored&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;object.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Otherwise&nbsp;will&nbsp;set&nbsp;the&nbsp;authentication&nbsp;attributes,&nbsp;principal&nbsp;name&nbsp;and&nbsp;authentication&nbsp;context&nbsp;map,&nbsp;in&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;object.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;Client&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;AuthStatus&nbsp;of&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;problem&nbsp;writing&nbsp;to&nbsp;the&nbsp;response.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleCompletion(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;authStatus)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Authentication&nbsp;has&nbsp;failed.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(UNAUTHORIZED_HTTP_ERROR_CODE,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNAUTHORIZED_ERROR_MESSAGE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(jre);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setAuthenticationRequestAttributes(messageInfo,&nbsp;clientSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;authentication&nbsp;id&nbsp;and&nbsp;context&nbsp;map&nbsp;into&nbsp;the&nbsp;HttpServletRequest,&nbsp;as&nbsp;attributes,&nbsp;for&nbsp;use&nbsp;by&nbsp;other<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;filters&nbsp;and&nbsp;resources.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Will&nbsp;take&nbsp;the&nbsp;first&nbsp;Principal&nbsp;it&nbsp;finds&nbsp;in&nbsp;the&nbsp;client&nbsp;Subject&nbsp;and&nbsp;add&nbsp;the&nbsp;Principal's&nbsp;name&nbsp;to&nbsp;the&nbsp;authentication<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;context.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;object.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;Client&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;setAuthenticationRequestAttributes(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principalName&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principalName&nbsp;=&nbsp;principal.getName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Setting&nbsp;principal&nbsp;name,&nbsp;{},&nbsp;and&nbsp;{}&nbsp;context&nbsp;values&nbsp;on&nbsp;to&nbsp;the&nbsp;request.&amp;quot;,&nbsp;principalName,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.size());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;principalName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;context);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextJaspiServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContext.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,444&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.context;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuditTrail.*;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.AuthStatusUtils.asString;<br>
-import&nbsp;static&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime.LOG;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.Collections;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditTrail;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Encapsulates&nbsp;ServerAuthModules&nbsp;that&nbsp;are&nbsp;used&nbsp;to&nbsp;validate&nbsp;service&nbsp;requests&nbsp;received&nbsp;from&nbsp;clients,&nbsp;and&nbsp;to&nbsp;secure&nbsp;any<br>
-&nbsp;*&nbsp;response&nbsp;returned&nbsp;for&nbsp;those&nbsp;requests.<br>
-&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;*&nbsp;This&nbsp;abstract&nbsp;implementation&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;interface&nbsp;allows&nbsp;a&nbsp;single&nbsp;Session&nbsp;ServerAuthModule,&nbsp;to<br>
-&nbsp;*&nbsp;provide&nbsp;session&nbsp;capabilities&nbsp;(i.e.&nbsp;on&nbsp;secureResponse,&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;which&nbsp;is&nbsp;validate&nbsp;on&nbsp;each&nbsp;subsequent&nbsp;request&nbsp;to<br>
-&nbsp;*&nbsp;skip&nbsp;re-authenticating&nbsp;each&nbsp;request),&nbsp;and&nbsp;then&nbsp;defers&nbsp;to&nbsp;the&nbsp;concrete&nbsp;implementation&nbsp;to&nbsp;co-ordinate&nbsp;calling<br>
-&nbsp;*&nbsp;any&nbsp;other&nbsp;ServerAuthModules.<br>
-&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;*&nbsp;This&nbsp;class&nbsp;or&nbsp;concrete&nbsp;implementations&nbsp;of&nbsp;it&nbsp;MUST&nbsp;not&nbsp;store&nbsp;any&nbsp;request&nbsp;specific&nbsp;state&nbsp;in&nbsp;it.&nbsp;This&nbsp;is&nbsp;because<br>
-&nbsp;*&nbsp;many&nbsp;different&nbsp;requests&nbsp;will&nbsp;use&nbsp;this&nbsp;class,&nbsp;possibly&nbsp;concurrently.&nbsp;If&nbsp;the&nbsp;request-specific&nbsp;state&nbsp;needs&nbsp;to&nbsp;be<br>
-&nbsp;*&nbsp;maintained&nbsp;then&nbsp;use&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;provided.&nbsp;This&nbsp;is&nbsp;created&nbsp;and&nbsp;used&nbsp;only&nbsp;by&nbsp;this&nbsp;specific&nbsp;request&nbsp;-&nbsp;it&nbsp;will<br>
-&nbsp;*&nbsp;be&nbsp;available&nbsp;for&nbsp;the&nbsp;entire&nbsp;time&nbsp;the&nbsp;request&nbsp;is&nbsp;being&nbsp;processed..<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@param&nbsp;&amp;lt;T&amp;gt;&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;ServerAuthModule&nbsp;configured&nbsp;in&nbsp;the&nbsp;runtime.<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;abstract&nbsp;class&nbsp;JaspiServerAuthContext&amp;lt;T&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;implements&nbsp;ServerAuthContext&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Key&nbsp;to&nbsp;the&nbsp;private&nbsp;context&nbsp;map,&nbsp;shared&nbsp;between&nbsp;ServerAuthContext&nbsp;implementations.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;static&nbsp;final&nbsp;String&nbsp;PRIVATE_CONTEXT_MAP_KEY&nbsp;=&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiServerAuthContext.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Each&nbsp;configured&nbsp;ServerAuthModule&nbsp;has&nbsp;its&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;called&nbsp;to&nbsp;ensure&nbsp;that&nbsp;each&nbsp;module<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;does&nbsp;support&nbsp;and&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;A&nbsp;Session&nbsp;AuthModule.&nbsp;Can&nbsp;be&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;A&nbsp;List&nbsp;of&nbsp;ServerAuthModules.&nbsp;MUST&nbsp;not&nbsp;be&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;do&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiServerAuthContext(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule,&nbsp;final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;allAuthModules;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;(authModules);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules.add(0,&nbsp;sessionAuthModule);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(allAuthModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextHandler&nbsp;=&nbsp;contextHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.sessionAuthModule&nbsp;=&nbsp;sessionAuthModule;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModules&nbsp;=&nbsp;authModules;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;MessageInfoUtils&nbsp;getMessageInfoUtils()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Authenticate&nbsp;a&nbsp;received&nbsp;service&nbsp;request&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;logic&nbsp;used&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;called&nbsp;is&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;configured,&nbsp;it&nbsp;is&nbsp;called&nbsp;first.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;configured&nbsp;and&nbsp;returns&nbsp;AuthStatus.SUCCESS,&nbsp;AuthStatus.SEND_SUCCESS&nbsp;or<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus.SEND_CONTINUE&nbsp;processing&nbsp;stops&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;returned.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;it&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;then&nbsp;the&nbsp;list<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;ServerAuthModules&nbsp;are&nbsp;called.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE,&nbsp;then&nbsp;the&nbsp;concrete&nbsp;sub-types<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#validateRequest(List,&nbsp;MessageInfo,&nbsp;Subject,&nbsp;Subject)&nbsp;will&nbsp;be&nbsp;called&nbsp;for&nbsp;the&nbsp;ServerAuthModules<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)&nbsp;to&nbsp;be&nbsp;called.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;configured&nbsp;AuditLogger&nbsp;will&nbsp;be&nbsp;called&nbsp;to&nbsp;audit&nbsp;the&nbsp;request&nbsp;&amp;lt;strong&amp;gt;if&amp;lt;/strong&amp;gt;&nbsp;the&nbsp;Session&nbsp;AuthModule<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;as&nbsp;if&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;passes&nbsp;the&nbsp;Jaspi&nbsp;Runtime<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;takes&nbsp;this&nbsp;as&nbsp;an&nbsp;existing&nbsp;session&nbsp;continuing.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;request&nbsp;message&nbsp;was&nbsp;successfully&nbsp;validated.&nbsp;The&nbsp;validated&nbsp;request<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getRequestMessage&nbsp;on&nbsp;messageInfo.&amp;lt;li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;to&nbsp;indicate&nbsp;that&nbsp;validation/processing&nbsp;of&nbsp;the&nbsp;request&nbsp;message&nbsp;successfully&nbsp;produced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;secured&nbsp;application&nbsp;response&nbsp;message&nbsp;(in&nbsp;messageInfo).&nbsp;The&nbsp;secured&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;is&nbsp;incomplete,&nbsp;and&nbsp;that&nbsp;a&nbsp;preliminary&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;was&nbsp;returned&nbsp;as&nbsp;the&nbsp;response&nbsp;message&nbsp;in&nbsp;messageInfo.&nbsp;When&nbsp;this&nbsp;status&nbsp;value&nbsp;is&nbsp;returned&nbsp;to&nbsp;challenge&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;application&nbsp;request&nbsp;message,&nbsp;the&nbsp;challenged&nbsp;request&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;request&nbsp;returned&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;challenge.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;failed&nbsp;and&nbsp;that&nbsp;an&nbsp;appropriate&nbsp;failure&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;validate&nbsp;session&nbsp;module<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;&amp;quot;Session-&amp;quot;&nbsp;+&nbsp;sessionAuthModule.getClass().getSimpleName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;doValidateRequest(sessionAuthModule,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject,&nbsp;moduleId,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;emptyMap(),&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;--&nbsp;In&nbsp;our&nbsp;implementation&nbsp;we&nbsp;will&nbsp;let&nbsp;subsequent&nbsp;modules&nbsp;try&nbsp;before&nbsp;sending&nbsp;the&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticated&nbsp;the&nbsp;client,&nbsp;passing&nbsp;to&nbsp;Auth&nbsp;Modules&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;&nbsp;+&nbsp;asString(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().remove(AUDIT_SESSION_ID_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;exceptionAuthStatus&nbsp;=&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Setting&nbsp;authStatus&nbsp;to&nbsp;null&nbsp;so&nbsp;auditing&nbsp;does&nbsp;not&nbsp;happen.&nbsp;As&nbsp;this&nbsp;exception&nbsp;is&nbsp;a&nbsp;configuration&nbsp;issue.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;,&nbsp;asString(exceptionAuthStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(exceptionAuthStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Performs&nbsp;the&nbsp;actual&nbsp;{@code&nbsp;#validateRequest}&nbsp;call&nbsp;on&nbsp;the&nbsp;auth&nbsp;module&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;principal&nbsp;set&nbsp;by&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;module&nbsp;is&nbsp;set&nbsp;in&nbsp;the&nbsp;audit&nbsp;trail&nbsp;and&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;an&nbsp;exception&nbsp;that&nbsp;the&nbsp;failure&nbsp;reason&nbsp;is&nbsp;captured.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;auth&nbsp;module&nbsp;to&nbsp;call&nbsp;{@code&nbsp;#validateRequest}&nbsp;on.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;module&nbsp;identifier.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;audit&nbsp;trail.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;from&nbsp;the&nbsp;{@code&nbsp;#validateRequest}&nbsp;call.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;the&nbsp;{@code&nbsp;#validateRequest}&nbsp;call&nbsp;fails.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;doValidateRequest(ServerAuthModule&nbsp;authModule,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject,&nbsp;String&nbsp;moduleId,&nbsp;AuditTrail&nbsp;auditTrail)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().get(AUDIT_PRINCIPAL_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!principal.isEmpty())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(AUDIT_PRINCIPAL_KEY,&nbsp;principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Auditing&nbsp;authentication&nbsp;result&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason.put(&amp;quot;exception&amp;quot;,&nbsp;e.getMessage());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason&nbsp;=&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;exception&amp;quot;,&nbsp;e.getMessage());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;e;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Co-ordinates&nbsp;calling&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;#validateRequest&nbsp;method,&nbsp;when&nbsp;either&nbsp;the&nbsp;Session<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;has&nbsp;returned&nbsp;AuthStatus.SEND_FAILURE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SUCCESS,&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configured&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;request&nbsp;message&nbsp;was&nbsp;successfully&nbsp;validated.&nbsp;The&nbsp;validated&nbsp;request<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getRequestMessage&nbsp;on&nbsp;messageInfo.&amp;lt;li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;to&nbsp;indicate&nbsp;that&nbsp;validation/processing&nbsp;of&nbsp;the&nbsp;request&nbsp;message&nbsp;successfully&nbsp;produced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;secured&nbsp;application&nbsp;response&nbsp;message&nbsp;(in&nbsp;messageInfo).&nbsp;The&nbsp;secured&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;is&nbsp;incomplete,&nbsp;and&nbsp;that&nbsp;a&nbsp;preliminary&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;was&nbsp;returned&nbsp;as&nbsp;the&nbsp;response&nbsp;message&nbsp;in&nbsp;messageInfo.&nbsp;When&nbsp;this&nbsp;status&nbsp;value&nbsp;is&nbsp;returned&nbsp;to&nbsp;challenge&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;application&nbsp;request&nbsp;message,&nbsp;the&nbsp;challenged&nbsp;request&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;request&nbsp;returned&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;challenge.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;failed&nbsp;and&nbsp;that&nbsp;an&nbsp;appropriate&nbsp;failure&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;abstract&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Secures&nbsp;a&nbsp;service&nbsp;response&nbsp;before&nbsp;sending&nbsp;it&nbsp;to&nbsp;the&nbsp;client&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Firstly&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;#secureResponse(List,&nbsp;MessageInfo,&nbsp;Subject)&nbsp;will&nbsp;be&nbsp;called&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;ServerAuthModules&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)&nbsp;to&nbsp;be&nbsp;called.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;only&nbsp;called&nbsp;if:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;it&nbsp;is&nbsp;configured&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;the&nbsp;call&nbsp;to&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;secureResponse&nbsp;returns&nbsp;AuthStatus.SEND_SUCCESS&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Any&nbsp;other&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;secureResponse&nbsp;method&nbsp;will&nbsp;result&nbsp;in&nbsp;the&nbsp;end&nbsp;of<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;processing&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;to&nbsp;be&nbsp;returned.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Note:&nbsp;secureResponse&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;if&nbsp;the&nbsp;call&nbsp;to&nbsp;validateRequest&nbsp;returned&nbsp;AuthStatus.SUCCESS.&nbsp;Any&nbsp;other<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;should&nbsp;cause&nbsp;the&nbsp;runtime&nbsp;to&nbsp;finish&nbsp;processing&nbsp;the&nbsp;request&nbsp;and&nbsp;return&nbsp;a&nbsp;response&nbsp;to&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;was&nbsp;successfully&nbsp;secured.&nbsp;The&nbsp;secured<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;message&nbsp;may&nbsp;be&nbsp;obtained&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;(within&nbsp;messageInfo)&nbsp;was&nbsp;replaced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;with&nbsp;a&nbsp;security&nbsp;message&nbsp;that&nbsp;should&nbsp;elicit&nbsp;a&nbsp;security-specific&nbsp;response&nbsp;(in&nbsp;the&nbsp;form&nbsp;of&nbsp;a&nbsp;request)&nbsp;from&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peer.&nbsp;This&nbsp;status&nbsp;value&nbsp;serves&nbsp;to&nbsp;inform&nbsp;the&nbsp;calling&nbsp;runtime&nbsp;that&nbsp;(to&nbsp;successfully&nbsp;complete&nbsp;the&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exchange)&nbsp;it&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;capable&nbsp;of&nbsp;continuing&nbsp;the&nbsp;message&nbsp;dialog&nbsp;by&nbsp;processing&nbsp;at&nbsp;least&nbsp;one&nbsp;additional<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;exchange&nbsp;(after&nbsp;having&nbsp;sent&nbsp;the&nbsp;response&nbsp;message&nbsp;returned&nbsp;in&nbsp;messageInfo).&nbsp;When&nbsp;this&nbsp;status<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;is&nbsp;returned,&nbsp;the&nbsp;application&nbsp;response&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can&nbsp;be<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;elicited&nbsp;response.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;a&nbsp;failure&nbsp;occurred&nbsp;while&nbsp;securing&nbsp;the&nbsp;response&nbsp;message&nbsp;and&nbsp;that&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;appropriate&nbsp;failure&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus)&nbsp;||&nbsp;AuthStatus.FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;SessionModule&nbsp;is&nbsp;configured&nbsp;and&nbsp;either&nbsp;the&nbsp;AuthModule&nbsp;secureResponse&nbsp;has&nbsp;been&nbsp;called&nbsp;and&nbsp;returned<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus.SUCCESS&nbsp;or&nbsp;the&nbsp;AuthModule&nbsp;secureResponse&nbsp;has&nbsp;not&nbsp;been&nbsp;called&nbsp;and&nbsp;hence&nbsp;the&nbsp;authStatus&nbsp;is&nbsp;null.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.SEND_SUCCESS.equals(authStatus)))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().remove(AUDIT_SESSION_ID_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;As&nbsp;this&nbsp;method&nbsp;can&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;validateRequest&nbsp;returns&nbsp;a&nbsp;AuthStatus.SUCCESS,&nbsp;which&nbsp;means&nbsp;either&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;SessionModule&nbsp;is&nbsp;configured&nbsp;or&nbsp;the&nbsp;authenticatingAuthModule&nbsp;will&nbsp;be&nbsp;set,&nbsp;so&nbsp;authStatus&nbsp;cannot&nbsp;be&nbsp;null&nbsp;and<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MUST&nbsp;be&nbsp;set&nbsp;to&nbsp;a&nbsp;valid&nbsp;AuthStatus&nbsp;value&nbsp;for&nbsp;secureResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Co-ordinates&nbsp;calling&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;#secureResponse&nbsp;method,&nbsp;before&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;called&nbsp;(if&nbsp;it&nbsp;is&nbsp;configured).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Any&nbsp;other&nbsp;AuthStatus&nbsp;that&nbsp;AuthStatus.SEND_SUCCESS&nbsp;returned&nbsp;from&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;secureResponse<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;method&nbsp;will&nbsp;result&nbsp;in&nbsp;the&nbsp;end&nbsp;of&nbsp;processing&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;to&nbsp;be&nbsp;returned.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configured&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;was&nbsp;successfully&nbsp;secured.&nbsp;The&nbsp;secured<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;message&nbsp;may&nbsp;be&nbsp;obtained&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;(within&nbsp;messageInfo)&nbsp;was&nbsp;replaced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;with&nbsp;a&nbsp;security&nbsp;message&nbsp;that&nbsp;should&nbsp;elicit&nbsp;a&nbsp;security-specific&nbsp;response&nbsp;(in&nbsp;the&nbsp;form&nbsp;of&nbsp;a&nbsp;request)&nbsp;from&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peer.&nbsp;This&nbsp;status&nbsp;value&nbsp;serves&nbsp;to&nbsp;inform&nbsp;the&nbsp;calling&nbsp;runtime&nbsp;that&nbsp;(to&nbsp;successfully&nbsp;complete&nbsp;the&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exchange)&nbsp;it&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;capable&nbsp;of&nbsp;continuing&nbsp;the&nbsp;message&nbsp;dialog&nbsp;by&nbsp;processing&nbsp;at&nbsp;least&nbsp;one&nbsp;additional<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;exchange&nbsp;(after&nbsp;having&nbsp;sent&nbsp;the&nbsp;response&nbsp;message&nbsp;returned&nbsp;in&nbsp;messageInfo).&nbsp;When&nbsp;this&nbsp;status<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;is&nbsp;returned,&nbsp;the&nbsp;application&nbsp;response&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can&nbsp;be<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;elicited&nbsp;response.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;a&nbsp;failure&nbsp;occurred&nbsp;while&nbsp;securing&nbsp;the&nbsp;response&nbsp;message&nbsp;and&nbsp;that&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;appropriate&nbsp;failure&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;abstract&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Remove&nbsp;method&nbsp;specific&nbsp;principals&nbsp;and&nbsp;credentials&nbsp;from&nbsp;the&nbsp;subject&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;Session<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthModule&nbsp;and&nbsp;the&nbsp;List&nbsp;of&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;subject&nbsp;The&nbsp;Subject&nbsp;instance&nbsp;from&nbsp;which&nbsp;the&nbsp;Principals&nbsp;and&nbsp;credentials&nbsp;are&nbsp;to&nbsp;be&nbsp;removed.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;Subject&nbsp;processing.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;void&nbsp;cleanSubject(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;subject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;serverAuthModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverAuthModule.cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimecontextpackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/context/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,21&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;a&nbsp;set&nbsp;of&nbsp;classes&nbsp;that&nbsp;implement&nbsp;the&nbsp;JASPI&nbsp;context&nbsp;object&nbsp;that&nbsp;provide&nbsp;methods&nbsp;to&nbsp;co-ordinate<br>
-&nbsp;*&nbsp;calls&nbsp;to&nbsp;configured&nbsp;ServerAuthModules&nbsp;instances.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi.runtime.context;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimepackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,20&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;the&nbsp;set&nbsp;of&nbsp;classes&nbsp;that&nbsp;constitute&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseFailureResponseHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/FailureResponseHandler.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/FailureResponseHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/FailureResponseHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,149&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;com.fasterxml.jackson.databind.ObjectMapper;<br>
-import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
-import&nbsp;org.forgerock.jaspi.runtime.ResourceExceptionHandler;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.math.BigDecimal;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.Arrays;<br>
-import&nbsp;java.util.Comparator;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.SortedSet;<br>
-import&nbsp;java.util.TreeSet;<br>
-import&nbsp;java.util.regex.Matcher;<br>
-import&nbsp;java.util.regex.Pattern;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;A&nbsp;handler&nbsp;class&nbsp;for&nbsp;rendering&nbsp;failures&nbsp;in&nbsp;the&nbsp;most&nbsp;acceptable&nbsp;supported&nbsp;content&nbsp;type.<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;FailureResponseHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;ObjectMapper&nbsp;OBJECT_MAPPER&nbsp;=&nbsp;new&nbsp;ObjectMapper();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;Pattern&nbsp;ACCEPT_HEADER&nbsp;=&nbsp;Pattern.compile(&amp;quot;(?:(?:[^\&amp;quot;,]*|(?:.*[^\\\\]\&amp;quot;.*[^\\\\]\&amp;quot;.*)))(&nbsp;*,&nbsp;*)&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;MediaType&nbsp;WILDCARD&nbsp;=&nbsp;MediaType.parse(&amp;quot;*/*&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;QUALITY_PARAMETER&nbsp;=&nbsp;&amp;quot;q&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;Comparator&amp;lt;MediaType&amp;gt;&nbsp;ACCEPT_QUALITY_COMPARATOR&nbsp;=&nbsp;new&nbsp;Comparator&amp;lt;MediaType&amp;gt;()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;compare(MediaType&nbsp;o1,&nbsp;MediaType&nbsp;o2)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;comparison&nbsp;=&nbsp;getQuality(o2).compareTo(getQuality(o1));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(comparison&nbsp;==&nbsp;0)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Wildcards&nbsp;should&nbsp;come&nbsp;after&nbsp;non-wildcards<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comparison&nbsp;=&nbsp;o2.toString().compareTo(o1.toString());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;comparison;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;BigDecimal&nbsp;getQuality(MediaType&nbsp;type)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;String&amp;gt;&nbsp;quality&nbsp;=&nbsp;type.parameters().get(QUALITY_PARAMETER);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;quality.isEmpty()&nbsp;?&nbsp;BigDecimal.ONE&nbsp;:&nbsp;new&nbsp;BigDecimal(quality.get(0));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;ResourceExceptionHandler&amp;gt;&nbsp;handlers&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ResourceExceptionHandler&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;JsonResourceExceptionHandler&nbsp;defaultHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FailureResponseHandler()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultHandler&nbsp;=&nbsp;new&nbsp;JsonResourceExceptionHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handlers.add(defaultHandler);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;error.&nbsp;The&nbsp;message's&nbsp;request&nbsp;{@code&nbsp;Accept}&nbsp;header&nbsp;preference&nbsp;is&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;most&nbsp;suitable<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;handler&nbsp;is&nbsp;selected.&nbsp;If&nbsp;no&nbsp;specific&nbsp;handler&nbsp;is&nbsp;found,&nbsp;or&nbsp;if&nbsp;the&nbsp;highest&nbsp;quality&nbsp;accepted&nbsp;content&nbsp;type&nbsp;is<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;\*\/\*},&nbsp;then&nbsp;the&nbsp;{@code&nbsp;JsonResourceExceptionHandler}&nbsp;is&nbsp;used.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;jre<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handle(ResourceException&nbsp;jre,&nbsp;MessageInfo&nbsp;messageInfo)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(jre.getCode());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;acceptHeader&nbsp;=&nbsp;request.getHeader(&amp;quot;Accept&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(acceptHeader&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SortedSet&amp;lt;MediaType&amp;gt;&nbsp;acceptedTypes&nbsp;=&nbsp;new&nbsp;TreeSet&amp;lt;MediaType&amp;gt;(ACCEPT_QUALITY_COMPARATOR);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matcher&nbsp;m&nbsp;=&nbsp;ACCEPT_HEADER.matcher(acceptHeader);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;lastGroup&nbsp;=&nbsp;0;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(m.find())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptedTypes.add(MediaType.parse(acceptHeader.substring(m.start(),&nbsp;m.start(1))));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastGroup&nbsp;=&nbsp;m.end(1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptedTypes.add(MediaType.parse(acceptHeader.substring(lastGroup)));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(MediaType&nbsp;type&nbsp;:&nbsp;acceptedTypes)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType&nbsp;forComparison&nbsp;=&nbsp;type.withoutParameters();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ResourceExceptionHandler&nbsp;handler&nbsp;:&nbsp;handlers)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(MediaType&nbsp;handled&nbsp;:&nbsp;handler.handles())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(handled.is(forComparison))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.write(jre,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(type.withoutParameters().is(WILDCARD))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultHandler.write(jre,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;class&nbsp;to&nbsp;handle&nbsp;{@code&nbsp;ResourceException}s.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;handlerClass&nbsp;The&nbsp;implementation&nbsp;class.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;registerExceptionHandler(Class&amp;lt;?&nbsp;extends&nbsp;ResourceExceptionHandler&amp;gt;&nbsp;handlerClass)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handlers.add(handlerClass.newInstance());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(InstantiationException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalArgumentException(&amp;quot;Cannot&nbsp;instantiate&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClass.getName(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IllegalAccessException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalArgumentException(&amp;quot;Cannot&nbsp;access&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClass.getName(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;default&nbsp;implementation&nbsp;of&nbsp;{@code&nbsp;ResourceExceptionHandler}&nbsp;that&nbsp;renders&nbsp;the&nbsp;exception&nbsp;to&nbsp;JSON.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;class&nbsp;JsonResourceExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;MEDIA_TYPES&nbsp;=&nbsp;Arrays.asList(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType.JSON_UTF_8,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType.JSON_UTF_8.withoutParameters());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;handles()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MEDIA_TYPES;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;jre,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setContentType(&amp;quot;application/json&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setCharacterEncoding(&amp;quot;UTF-8&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_MAPPER.writeValue(response.getWriter(),&nbsp;jre.includeCauseInJsonValue().toJsonValue().asMap());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiHttpServletResponseWrapperjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapper.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapper.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapper.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,72&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Response&nbsp;Wrapper&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;response&nbsp;before&nbsp;the&nbsp;JASPI&nbsp;filter&nbsp;has&nbsp;run<br>
-&nbsp;*&nbsp;secureResponse.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiHttpServletResponseWrapper&nbsp;extends&nbsp;HttpServletResponseWrapper&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;PrintWriter&nbsp;writer;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ServletOutputStream&nbsp;out;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiHttpServletResponseWrapper.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;underlying&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiHttpServletResponseWrapper(final&nbsp;HttpServletResponse&nbsp;response)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Lazily&nbsp;initialises&nbsp;the&nbsp;wrapped&nbsp;underlying&nbsp;response&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ServletOutputStream&nbsp;getOutputStream()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(out&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out&nbsp;=&nbsp;new&nbsp;JaspiServletOutputStream(getResponse().getOutputStream());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;out;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Lasily&nbsp;initialises&nbsp;the&nbsp;wrapped&nbsp;underlying&nbsp;response&nbsp;writer.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;PrintWriter&nbsp;getWriter()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(writer&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer&nbsp;=&nbsp;new&nbsp;JaspiPrintWriter(getResponse().getWriter());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;writer;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiPrintWriterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriter.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,37&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Wrapper&nbsp;around&nbsp;a&nbsp;HttpServletResponse's&nbsp;writer&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;writer&nbsp;before&nbsp;the&nbsp;JASPI<br>
-&nbsp;*&nbsp;filter&nbsp;has&nbsp;run&nbsp;secureResponse.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiPrintWriter&nbsp;extends&nbsp;PrintWriter&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiPrintWriter.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;printWriter&nbsp;The&nbsp;underlying&nbsp;PrintWriter.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiPrintWriter(final&nbsp;PrintWriter&nbsp;printWriter)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(printWriter);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponseJaspiServletOutputStreamjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStream.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStream.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStream.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,87&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Wrapper&nbsp;around&nbsp;a&nbsp;HttpServletResponse's&nbsp;output&nbsp;stream&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;stream&nbsp;before&nbsp;the<br>
-&nbsp;*&nbsp;JASPI&nbsp;filter&nbsp;has&nbsp;run&nbsp;secureResponse.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiServletOutputStream&nbsp;extends&nbsp;ServletOutputStream&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ServletOutputStream&nbsp;servletOutputStream;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiServletOutputStream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;servletOutputStream&nbsp;The&nbsp;underlying&nbsp;ServletOutputStream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiServletOutputStream(final&nbsp;ServletOutputStream&nbsp;servletOutputStream)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.servletOutputStream&nbsp;=&nbsp;servletOutputStream;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(int)&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;i&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(final&nbsp;int&nbsp;i)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(i);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(byte[])&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;b&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(byte[]&nbsp;b)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(byte[],&nbsp;int,&nbsp;int)&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;b&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;off&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;len&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(byte[]&nbsp;b,&nbsp;int&nbsp;off,&nbsp;int&nbsp;len)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b,&nbsp;off,&nbsp;len);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;close()&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;close()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.close();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiruntimeresponsepackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/runtime/response/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,21&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;a&nbsp;set&nbsp;of&nbsp;classes&nbsp;that&nbsp;prevent&nbsp;the&nbsp;HttpServletResponse&nbsp;from&nbsp;being&nbsp;closed&nbsp;before&nbsp;the&nbsp;JASPI&nbsp;runtime<br>
-&nbsp;*&nbsp;has&nbsp;the&nbsp;chance&nbsp;to&nbsp;secure&nbsp;the&nbsp;response.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiutilsMessageInfoUtilsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/MessageInfoUtils.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/MessageInfoUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/MessageInfoUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,89&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.utils;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Provides&nbsp;methods&nbsp;that&nbsp;allow&nbsp;working&nbsp;with&nbsp;MessageInfo&nbsp;maps&nbsp;to&nbsp;be&nbsp;simplified.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;MessageInfoUtils&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Removes&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;of&nbsp;the&nbsp;MessageInfo,&nbsp;then&nbsp;{@code&nbsp;null}&nbsp;will&nbsp;be&nbsp;returned.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;remove&nbsp;the&nbsp;map&nbsp;from.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;or&nbsp;{@code&nbsp;null}&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;exist.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;removeMap(MessageInfo&nbsp;messageInfo,&nbsp;String&nbsp;mapKey)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().remove(mapKey);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;of&nbsp;the&nbsp;MessageInfo,&nbsp;the&nbsp;a&nbsp;new&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;will<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;created&nbsp;an&nbsp;inserted&nbsp;into&nbsp;it,&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;get&nbsp;the&nbsp;map&nbsp;from.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;String&nbsp;mapKey)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getMap(messageInfo.getMap(),&nbsp;mapKey);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;given&nbsp;containing&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist,&nbsp;a&nbsp;new&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;will&nbsp;be&nbsp;created&nbsp;and&nbsp;inserted&nbsp;into&nbsp;the&nbsp;given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;containing&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;containingMap&nbsp;The&nbsp;map&nbsp;that&nbsp;will&nbsp;contain&nbsp;the&nbsp;map&nbsp;at&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;given&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;containingMap,&nbsp;final&nbsp;String&nbsp;mapKey)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;containingMap.get(mapKey);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containingMap.put(mapKey,&nbsp;map);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;map;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Adds&nbsp;a&nbsp;new&nbsp;empty&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;add&nbsp;the&nbsp;map&nbsp;to.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;key&nbsp;The&nbsp;key&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;new&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;addMap(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;String&nbsp;key)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getMap(messageInfo,&nbsp;key);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockjaspiutilspackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/package-info.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/jaspi/utils/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,20&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;a&nbsp;set&nbsp;of&nbsp;classes&nbsp;that&nbsp;offer&nbsp;utilities&nbsp;functions&nbsp;to&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
-&nbsp;*/<br>
-package&nbsp;org.forgerock.jaspi.utils;<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuditTrailTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeAuditTrailTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuditTrailTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/AuditTrailTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuditTrailTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuditTrailTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,167&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.entry;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
+<br>
+import&nbsp;java.util.Collections;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
+import&nbsp;org.mockito.ArgumentCaptor;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AuditTrailTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditTrail&nbsp;auditTrail;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail&nbsp;=&nbsp;new&nbsp;AuditTrail(auditApi,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldAuditEmptyAuditMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;JsonValue&amp;gt;&nbsp;auditMessageCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(JsonValue.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditApi).audit(auditMessageCaptor.capture());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;auditMessageCaptor.getValue();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.asMap()).hasSize(3);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;requestId&amp;quot;).getObject()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;context&amp;quot;).required().size()).isEqualTo(0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;entries&amp;quot;).required().size()).isEqualTo(0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldAuditFullSuccessfulAuditMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_ONE_ID&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_TWO_ID&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(&amp;quot;MODULE_THREE_ID&amp;quot;,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;MODULE_THREE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(&amp;quot;PRINCIPAL&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(&amp;quot;SESSION_ID&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;JsonValue&amp;gt;&nbsp;auditMessageCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(JsonValue.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditApi).audit(auditMessageCaptor.capture());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;auditMessageCaptor.getValue();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.asMap()).hasSize(6);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;requestId&amp;quot;).getObject()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;SUCCESSFUL&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;principal&amp;quot;).asList(String.class)).containsExactly(&amp;quot;PRINCIPAL&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;context&amp;quot;).required().size()).isEqualTo(0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;sessionId&amp;quot;).asString()).isEqualTo(&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;entries&amp;quot;).required().size()).isEqualTo(3);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleOneEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleTwoEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleThreeEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(2);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.asMap()).hasSize(4);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_ONE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.asMap()).hasSize(4);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_TWO_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.asMap()).hasSize(3);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_THREE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;SUCCESSFUL&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_THREE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldAuditFullFailedAuditMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleOneAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleOneAuditInfo.put(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleOneAuditInfo.put(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;admin&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_ONE_ID&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;),&nbsp;moduleOneAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleTwoAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleTwoAuditInfo.put(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleTwoAuditInfo.put(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;demo&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_TWO_ID&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;),&nbsp;moduleTwoAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;JsonValue&amp;gt;&nbsp;auditMessageCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(JsonValue.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditApi).audit(auditMessageCaptor.capture());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;auditMessageCaptor.getValue();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.asMap()).hasSize(5);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;requestId&amp;quot;).getObject()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;principal&amp;quot;).asList(String.class)).containsExactly(&amp;quot;admin&amp;quot;,&nbsp;&amp;quot;demo&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;context&amp;quot;).required().size()).isEqualTo(0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;entries&amp;quot;).required().size()).isEqualTo(2);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleOneEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleTwoEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(1);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.asMap()).hasSize(4);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_ONE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;admin&amp;quot;));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.asMap()).hasSize(4);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_TWO_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;demo&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkContextHandlerTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimecontextContextHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/ContextHandlerTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,220&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.security.Principal;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;ContextHandlerTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextHandler&nbsp;contextHandler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler&nbsp;=&nbsp;new&nbsp;ContextHandler(messageInfoUtils);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModulesWhenAuthModulesNull()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenDoesNotSupportEither()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[0]);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenOnlySupportsHttpServletRequest()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{HttpServletRequest.class});<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenOnlySupportsHttpServletResponse()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{HttpServletResponse.class});<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes())<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class});<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModulesWhenAuthModuleListContainsNullAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNull()&nbsp;throws&nbsp;AuthException,&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail(&amp;quot;Expect&nbsp;exception&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(e.getCause()&nbsp;instanceof&nbsp;ResourceException);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((ResourceException)&nbsp;e.getCause()).getCode(),&nbsp;401);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNotNullAndPrincipalNameNotSet()&nbsp;throws&nbsp;AuthException,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT)).willReturn(contextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(messageInfo,&nbsp;never()).setRequestMessage(anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNotNull()&nbsp;throws&nbsp;AuthException,&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principalOne&nbsp;=&nbsp;mock(Principal.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT)).willReturn(contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().add(principalOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(principalOne.getName()).willReturn(&amp;quot;PRN_ONE&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;&amp;quot;PRN_ONE&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseFailureResponseHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/FailureResponseHandlerTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,125&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
+<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.io.PrintWriter;<br>
+import&nbsp;java.io.StringWriter;<br>
+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.List;<br>
+<br>
+import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;FailureResponseHandlerTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_XML&nbsp;=&nbsp;&amp;quot;application/xml&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_JSON&nbsp;=&nbsp;&amp;quot;application/json&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TEXT_XML&nbsp;=&nbsp;&amp;quot;text/xml&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TEXT_PLAIN&nbsp;=&nbsp;&amp;quot;text/plain&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FailureResponseHandler&nbsp;handler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setup()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;jsonHandlerShouldRenderException()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StringWriter();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(new&nbsp;PrintWriter(sw)).when(response).getWriter();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.BAD_REQUEST,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;))));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;FailureResponseHandler.JsonResourceExceptionHandler().write(jre,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;responseText&nbsp;=&nbsp;sw.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;400&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;BAD_REQUEST&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;DETAIL_KEY&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;DETAIL_VALUE&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setContentType(&amp;quot;application/json&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;content-types&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;Object[][]&nbsp;contentTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;APPLICATION_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/svg+xml&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_PLAIN,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.8,&nbsp;application/xml&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.9,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=1.0&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;null,&nbsp;APPLICATION_JSON&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;content-types&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldUseExceptionHandlerIfAvailable(String&nbsp;accept,&nbsp;String&nbsp;expected)&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StringWriter();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(new&nbsp;PrintWriter(sw)).when(response).getWriter();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(accept).when(request).getHeader(&amp;quot;Accept&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.registerExceptionHandler(TestExceptionHandler.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.BAD_REQUEST,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;))));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.handle(jre,&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(400);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setContentType(expected);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;class&nbsp;TestExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;handles()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Arrays.asList(MediaType.parse(APPLICATION_XML),&nbsp;MediaType.parse(TEXT_XML));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setContentType(APPLICATION_XML);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.getWriter().write(&amp;quot;Hello&nbsp;&amp;quot;+exception.getCode());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspicontextFallbackServerAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/context/FallbackServerAuthContextTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,389&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;FallbackServerAuthContextTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackServerAuthContext&nbsp;fallbackServerAuthContext;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextHandler&nbsp;contextHandler&nbsp;=&nbsp;mock(ContextHandler.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext&nbsp;=&nbsp;new&nbsp;FallbackServerAuthContext(messageInfoUtils,&nbsp;contextHandler,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSuccessWhenFirstAuthModuleValidateRequestReturnsSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsKey(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsValue(authModuleOne));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendSuccessWhenFirstAuthModuleValidateRequestReturnsSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendContinueWhenFirstAuthModuleValidateRequestReturnsSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSuccessWhenAuthModulesValidateRequestReturnSendFailureSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsKey(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsValue(authModuleTwo));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendFailureWhenSingleAuthModuleValidateRequestReturnsSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowAuthExceptionWhenAuthModuleValidateRequestThrowsAuthException()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(authModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldReturnSendFailureWithNoAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnNullWhenNoAuthModuleValidateRequestSuccessfullyAuthenticated()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNull(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendSuccessWhenAuthModuleReturnsSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendContinueWhenAuthModuleReturnsSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendFailureWhenAuthModuleReturnsSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowAuthExceptionWhenAuthModuleSecureResponseThrowsAuthException()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(authModule).secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkHttpServletCallbackHandlerTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeHttpServletCallbackHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandlerTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandlerTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,242&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.callback.Callback;<br>
+import&nbsp;javax.security.auth.callback.UnsupportedCallbackException;<br>
+import&nbsp;javax.security.auth.message.callback.CallerPrincipalCallback;<br>
+import&nbsp;javax.security.auth.message.callback.CertStoreCallback;<br>
+import&nbsp;javax.security.auth.message.callback.GroupPrincipalCallback;<br>
+import&nbsp;javax.security.auth.message.callback.PasswordValidationCallback;<br>
+import&nbsp;javax.security.auth.message.callback.PrivateKeyCallback;<br>
+import&nbsp;javax.security.auth.message.callback.SecretKeyCallback;<br>
+import&nbsp;javax.security.auth.message.callback.TrustStoreCallback;<br>
+import&nbsp;java.security.Principal;<br>
+<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;HttpServletCallbackHandlerTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletCallbackHandler&nbsp;callbackHandler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler&nbsp;=&nbsp;new&nbsp;HttpServletCallbackHandler();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithCallbackName()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(&amp;quot;PRN_NAME&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(principal);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0].getName(),&nbsp;&amp;quot;PRN_NAME&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0],&nbsp;principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithCallbackNameButNonNullPrincipal()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;mock(Principal.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(&amp;quot;PRN_NAME&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(principal);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNull(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0].getName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0],&nbsp;principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithCallbackPrincipal()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;mock(Principal.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(principal);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0],&nbsp;principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithNoCallbackNameOrPrincipal()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleGroupPrincipalCallbackWithNoGroups()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GroupPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(GroupPrincipalCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getGroups()).willReturn(null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleGroupPrincipalCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GroupPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(GroupPrincipalCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;groupOne&nbsp;=&nbsp;&amp;quot;GROUP_ONE&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;groupTwo&nbsp;=&nbsp;&amp;quot;GROUP_TWO&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[]&nbsp;groups&nbsp;=&nbsp;new&nbsp;String[]{groupOne,&nbsp;groupTwo};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getGroups()).willReturn(groups);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;2);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0].getName(),&nbsp;&amp;quot;GROUP_ONE&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[1].getName(),&nbsp;&amp;quot;GROUP_TWO&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandlePasswordValidationCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PasswordValidationCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(PasswordValidationCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCertStoreCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CertStoreCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CertStoreCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandlePrivateKeyCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrivateKeyCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(PrivateKeyCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecretKeyCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SecretKeyCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(SecretKeyCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleTrustStoreCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TrustStoreCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(TrustStoreCallback.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfoTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeHttpServletMessageInfoTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletMessageInfoTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,130&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
+<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;HttpServletMessageInfoTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetRequestMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;returnedRequest&nbsp;=&nbsp;messageInfo.getRequestMessage();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedRequest);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedRequest,&nbsp;request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetResponseMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;returnedResponse&nbsp;=&nbsp;messageInfo.getResponseMessage();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedResponse);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedResponse,&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMapWithNoMapGivenInConstructor()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;returnedMap&nbsp;=&nbsp;messageInfo.getMap();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(returnedMap.size(),&nbsp;0);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSetRequestMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request2&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.setRequestMessage(request2);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;returnedRequest&nbsp;=&nbsp;messageInfo.getRequestMessage();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedRequest);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedRequest,&nbsp;request2);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSetResponseMessage()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response2&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.setResponseMessage(response2);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;returnedResponse&nbsp;=&nbsp;messageInfo.getResponseMessage();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedResponse);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedResponse,&nbsp;response2);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMapWithMapGivenInConstructor()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response,&nbsp;map);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;returnedMap&nbsp;=&nbsp;messageInfo.getMap();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(returnedMap,&nbsp;map);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiHttpServletResponseWrapperTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapperTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,62&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
+<br>
+import&nbsp;javax.servlet.ServletOutputStream;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+import&nbsp;java.io.PrintWriter;<br>
+<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;JaspiHttpServletResponseWrapperTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetOutputStream()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiHttpServletResponseWrapper&nbsp;responseWrapper&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper(response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletOutputStream&nbsp;outputStream&nbsp;=&nbsp;responseWrapper.getOutputStream();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(JaspiServletOutputStream.class.isAssignableFrom(outputStream.getClass()));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetWriter()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiHttpServletResponseWrapper&nbsp;responseWrapper&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;printWriter&nbsp;=&nbsp;mock(PrintWriter.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(response.getWriter()).willReturn(printWriter);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;writer&nbsp;=&nbsp;responseWrapper.getWriter();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(JaspiPrintWriter.class.isAssignableFrom(writer.getClass()));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiPrintWriterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriterTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,40&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
+<br>
+import&nbsp;java.io.PrintWriter;<br>
+<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;JaspiPrintWriterTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiPrintWriter()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;printWriter&nbsp;=&nbsp;mock(PrintWriter.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiPrintWriter&nbsp;jaspiPrintWriter&nbsp;=&nbsp;new&nbsp;JaspiPrintWriter(printWriter);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiPrintWriter);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiJaspiRuntimeFilterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/JaspiRuntimeFilterTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,103&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
+import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
+<br>
+import&nbsp;javax.servlet.FilterChain;<br>
+import&nbsp;javax.servlet.FilterConfig;<br>
+import&nbsp;javax.servlet.ServletException;<br>
+import&nbsp;javax.servlet.ServletRequest;<br>
+import&nbsp;javax.servlet.ServletResponse;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.IOException;<br>
+<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;JaspiRuntimeFilterTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiRuntimeFilter&nbsp;jaspiRuntimeFilter;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;throws&nbsp;ServletException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter&nbsp;=&nbsp;new&nbsp;JaspiRuntimeFilter(contextFactory,&nbsp;auditApi);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterConfig&nbsp;filterConfig&nbsp;=&nbsp;mock(FilterConfig.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.init(filterConfig);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiRuntimeFilterWithDefaultConstructor()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntimeFilter&nbsp;runtimeFilter&nbsp;=&nbsp;new&nbsp;JaspiRuntimeFilter();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(runtimeFilter);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;ServletException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowServletExceptionWhenNotHttpServletRequest()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletRequest&nbsp;request&nbsp;=&nbsp;mock(ServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.doFilter(request,&nbsp;response,&nbsp;filterChain);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;ServletException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowServletExceptionWhenNotHttpServletResponse()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletResponse&nbsp;response&nbsp;=&nbsp;mock(ServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.doFilter(request,&nbsp;response,&nbsp;filterChain);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldDestroyFilter()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.destroy();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeJaspiRuntimeTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/JaspiRuntimeTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,161&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+*&nbsp;License.<br>
+*<br>
+*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+*<br>
+*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+*<br>
+*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
+import&nbsp;javax.servlet.FilterChain;<br>
+import&nbsp;javax.servlet.http.HttpServletRequest;<br>
+import&nbsp;javax.servlet.http.HttpServletRequestWrapper;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
+<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+import&nbsp;org.mockito.ArgumentCaptor;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;JaspiRuntimeTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;RuntimeResultHandler&nbsp;runtimeResultHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtimeResultHandler&nbsp;=&nbsp;mock(RuntimeResultHandler.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessageAndPassStraightToChainWhenServerAuthContextNotConfigured()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain).doFilter(request,&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(runtimeResultHandler);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessageAndNotCallChainIfValidateRequestIsNotSUCCESS()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(runtimeResultHandler.handleValidateRequestResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;AuditTrail&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject())).willReturn(false);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain,&nbsp;never()).doFilter(request,&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(runtimeResultHandler,&nbsp;never()).handleSecureResponseResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessage()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(runtimeResultHandler.handleValidateRequestResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;AuditTrail&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject())).willReturn(true);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;HttpServletRequest&amp;gt;&nbsp;requestCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;HttpServletResponse&amp;gt;&nbsp;responseCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain).doFilter(requestCaptor.capture(),&nbsp;responseCaptor.capture());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(runtimeResultHandler).handleSecureResponseResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(serverAuthContext).cleanSubject(Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((HttpServletRequestWrapper)&nbsp;requestCaptor.getValue()).getRequest(),&nbsp;request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((HttpServletResponseWrapper)&nbsp;responseCaptor.getValue()).getResponse(),&nbsp;response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldConvertAuthExceptionToCrestResponseWhenDoFilterFails()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler&nbsp;=&nbsp;mock(FailureResponseHandler.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(serverAuthContext).validateRequest(Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;ResourceException&amp;gt;&nbsp;resourceExceptionCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(ResourceException.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(failureResponseHandler).handle(resourceExceptionCaptor.capture(),&nbsp;any(MessageInfo.class));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(resourceExceptionCaptor.getValue().getCode(),&nbsp;500);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimecontextJaspiServerAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContextTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,789&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.never;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.anyListOf;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;JaspiServerAuthContextTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextHandler&nbsp;contextHandler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler&nbsp;=&nbsp;mock(ContextHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;createJaspiServerAuthContext(ServerAuthModule&nbsp;sessionAuthModule,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;AuthStatus&nbsp;validateRequestAuthStatus,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;secureResponseAuthStatus)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;validateRequest(List&nbsp;authModules,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;validateRequestAuthStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;secureResponse(List&nbsp;authModules,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;secureResponseAuthStatus;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContextWithNoSessionAuthModuleAndEmptyListOfAuthModules()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContextWithNoSessionAuthModuleAndNullListOfAuthModules()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContext()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowJaspiAuthExceptionWhenAuthModuleDoesNotConformToHttpServletProfile()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(contextHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateServerAuthModuleConformToHttpServletProfile(anyListOf(ServerAuthModule.class));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createJaspiServerAuthContext(sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMessageInfoUtils()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfoUtils&nbsp;actualMessageInfoUtils&nbsp;=&nbsp;jaspiServerAuthContext.getMessageInfoUtils();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(actualMessageInfoUtils,&nbsp;messageInfoUtils);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithNoAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_SUCCESS);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler,&nbsp;never()).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_CONTINUE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler,&nbsp;never()).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenSessionModuleReturnsInvalidAuthStatus()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_FAILURE,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiServerAuthContext.PRIVATE_CONTEXT_MAP_KEY))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(contextMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenAuthModulesReturnNull()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenAuthModulesReturnFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.FAILURE,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldNotAuditWhenAuthModulesReturnSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_CONTINUE,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_SUCCESS,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_FAILURE,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithNoSessionModuleAndWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldThrowJaspiAuthExceptionWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldThrowJaspiAuthExceptionWhenAuthModulesReturnFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnSendSuccessWithNoSessionAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnNullWithSessionAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_SUCCESS);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnSendSuccessAndSessionModuleReturnsSendFailure()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_FAILURE);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithNoSessionAuthModuleAndNullAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithOnlySessionAuthModuleConfigured()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithOnlyAuthModulesConfigured()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubject()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(messageInfo,&nbsp;subject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiServletOutputStreamTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStreamTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,91&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
+<br>
+import&nbsp;javax.servlet.ServletOutputStream;<br>
+import&nbsp;java.io.IOException;<br>
+<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;JaspiServletOutputStreamTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiServletOutputStream&nbsp;servletOutputStream;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ServletOutputStream&nbsp;outputStream;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outputStream&nbsp;=&nbsp;mock(ServletOutputStream.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream&nbsp;=&nbsp;new&nbsp;JaspiServletOutputStream(outputStream);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWrite()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(1);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWriteByte()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;b&nbsp;=&nbsp;new&nbsp;byte[0];<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(b);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWriteByteWithLength()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;b&nbsp;=&nbsp;new&nbsp;byte[0];<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b,&nbsp;0,&nbsp;1);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(b,&nbsp;0,&nbsp;1);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldClose()&nbsp;throws&nbsp;IOException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.close();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).close();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiutilsMessageInfoUtilsTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/utils/MessageInfoUtilsTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,92&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
+import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
+<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;MessageInfoUtilsTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;new&nbsp;MessageInfoUtils();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetNewMap()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;mapKey);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(map);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetExistingMap()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;expectedMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(mapKey,&nbsp;expectedMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;mapKey);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(map,&nbsp;expectedMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;should()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.addMap(messageInfo,&nbsp;mapKey);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerTestjavafromrev3053forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeRuntimeResultHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&nbsp;(from&nbsp;rev&nbsp;3053,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/RuntimeResultHandlerTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,212&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthException;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessageInfo;<br>
+import&nbsp;javax.servlet.http.HttpServletResponse;<br>
+import&nbsp;java.io.PrintWriter;<br>
+<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;RuntimeResultHandlerTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;RuntimeResultHandler&nbsp;resultHandler;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler&nbsp;=&nbsp;new&nbsp;RuntimeResultHandler();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(result);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_SUCCESS;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendFailureAuthStatus()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;writer&nbsp;=&nbsp;mock(PrintWriter.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(response.getWriter()).willReturn(writer);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(401);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendContinueAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_CONTINUE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response,&nbsp;never()).setStatus(100);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleValidateRequestShouldThrowAuthExceptionWithFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.FAILURE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_SUCCESS;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(500);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendContinueAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_CONTINUE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response,&nbsp;never()).setStatus(100);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.FAILURE;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiJaspiRuntimeFilterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/JaspiRuntimeFilterTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/JaspiRuntimeFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/JaspiRuntimeFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,105&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
-<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditApi;<br>
-import&nbsp;org.forgerock.jaspi.runtime.ContextFactory;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.FilterConfig;<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.ServletRequest;<br>
-import&nbsp;javax.servlet.ServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-public&nbsp;class&nbsp;JaspiRuntimeFilterTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiRuntimeFilter&nbsp;jaspiRuntimeFilter;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter&nbsp;=&nbsp;new&nbsp;JaspiRuntimeFilter(contextFactory,&nbsp;auditApi);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterConfig&nbsp;filterConfig&nbsp;=&nbsp;mock(FilterConfig.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.init(filterConfig);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiRuntimeFilterWithDefaultConstructor()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntimeFilter&nbsp;runtimeFilter&nbsp;=&nbsp;new&nbsp;JaspiRuntimeFilter();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(runtimeFilter);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;ServletException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowServletExceptionWhenNotHttpServletRequest()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletRequest&nbsp;request&nbsp;=&nbsp;mock(ServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.doFilter(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;ServletException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowServletExceptionWhenNotHttpServletResponse()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletResponse&nbsp;response&nbsp;=&nbsp;mock(ServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.doFilter(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldDestroyFilter()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.destroy();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspicontextFallbackServerAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/context/FallbackServerAuthContextTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/context/FallbackServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/context/FallbackServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,397&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.context;<br>
-<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditTrail;<br>
-import&nbsp;org.forgerock.jaspi.runtime.context.ContextHandler;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.doThrow;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.verifyZeroInteractions;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNull;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
-import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
-<br>
-public&nbsp;class&nbsp;FallbackServerAuthContextTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackServerAuthContext&nbsp;fallbackServerAuthContext;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextHandler&nbsp;contextHandler&nbsp;=&nbsp;mock(ContextHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext&nbsp;=&nbsp;new&nbsp;FallbackServerAuthContext(messageInfoUtils,&nbsp;contextHandler,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSuccessWhenFirstAuthModuleValidateRequestReturnsSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsKey(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsValue(authModuleOne));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendSuccessWhenFirstAuthModuleValidateRequestReturnsSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendContinueWhenFirstAuthModuleValidateRequestReturnsSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSuccessWhenAuthModulesValidateRequestReturnSendFailureSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsKey(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsValue(authModuleTwo));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendFailureWhenSingleAuthModuleValidateRequestReturnsSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowAuthExceptionWhenAuthModuleValidateRequestThrowsAuthException()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(authModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldReturnSendFailureWithNoAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnNullWhenNoAuthModuleValidateRequestSuccessfullyAuthenticated()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNull(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendSuccessWhenAuthModuleReturnsSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendContinueWhenAuthModuleReturnsSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendFailureWhenAuthModuleReturnsSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowAuthExceptionWhenAuthModuleSecureResponseThrowsAuthException()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(authModule).secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeAuditTrailTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/AuditTrailTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/AuditTrailTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/AuditTrailTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,167&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
-import&nbsp;org.mockito.ArgumentCaptor;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.util.Collections;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
-import&nbsp;static&nbsp;org.assertj.core.api.Assertions.entry;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
-<br>
-public&nbsp;class&nbsp;AuditTrailTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditTrail&nbsp;auditTrail;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail&nbsp;=&nbsp;new&nbsp;AuditTrail(auditApi,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldAuditEmptyAuditMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;JsonValue&amp;gt;&nbsp;auditMessageCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(JsonValue.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditApi).audit(auditMessageCaptor.capture());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;auditMessageCaptor.getValue();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.asMap()).hasSize(3);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;requestId&amp;quot;).getObject()).isNotNull();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;context&amp;quot;).required().size()).isEqualTo(0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;entries&amp;quot;).required().size()).isEqualTo(0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldAuditFullSuccessfulAuditMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_ONE_ID&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_TWO_ID&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(&amp;quot;MODULE_THREE_ID&amp;quot;,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;MODULE_THREE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(&amp;quot;PRINCIPAL&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(&amp;quot;SESSION_ID&amp;quot;);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;JsonValue&amp;gt;&nbsp;auditMessageCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(JsonValue.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditApi).audit(auditMessageCaptor.capture());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;auditMessageCaptor.getValue();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.asMap()).hasSize(6);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;requestId&amp;quot;).getObject()).isNotNull();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;SUCCESSFUL&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;principal&amp;quot;).asList(String.class)).containsExactly(&amp;quot;PRINCIPAL&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;context&amp;quot;).required().size()).isEqualTo(0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;sessionId&amp;quot;).asString()).isEqualTo(&amp;quot;SESSION_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;entries&amp;quot;).required().size()).isEqualTo(3);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleOneEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleTwoEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleThreeEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(2);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.asMap()).hasSize(4);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_ONE_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.asMap()).hasSize(4);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_TWO_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.asMap()).hasSize(3);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_THREE_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;SUCCESSFUL&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleThreeEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_THREE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldAuditFullFailedAuditMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleOneAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleOneAuditInfo.put(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleOneAuditInfo.put(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;admin&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_ONE_ID&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;),&nbsp;moduleOneAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleTwoAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleTwoAuditInfo.put(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleTwoAuditInfo.put(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;demo&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(&amp;quot;MODULE_TWO_ID&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;),&nbsp;moduleTwoAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;JsonValue&amp;gt;&nbsp;auditMessageCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(JsonValue.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditApi).audit(auditMessageCaptor.capture());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;auditMessage&nbsp;=&nbsp;auditMessageCaptor.getValue();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.asMap()).hasSize(5);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;requestId&amp;quot;).getObject()).isNotNull();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;principal&amp;quot;).asList(String.class)).containsExactly(&amp;quot;admin&amp;quot;,&nbsp;&amp;quot;demo&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;context&amp;quot;).required().size()).isEqualTo(0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditMessage.get(&amp;quot;entries&amp;quot;).required().size()).isEqualTo(2);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleOneEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;moduleTwoEntry&nbsp;=&nbsp;auditMessage.get(&amp;quot;entries&amp;quot;).get(1);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.asMap()).hasSize(4);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_ONE_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_ONE_REASON&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleOneEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_ONE&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;admin&amp;quot;));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.asMap()).hasSize(4);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;moduleId&amp;quot;).asString()).isEqualTo(&amp;quot;MODULE_TWO_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;result&amp;quot;).asString()).isEqualTo(&amp;quot;FAILED&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;reason&amp;quot;).asMap()).containsOnly(entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;MODULE_TWO_REASON&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(moduleTwoEntry.get(&amp;quot;info&amp;quot;).asMap()).containsOnly(entry(&amp;quot;MODULE_TWO&amp;quot;,&nbsp;&amp;quot;INFO&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;demo&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeHttpServletCallbackHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandlerTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletCallbackHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,242&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.callback.Callback;<br>
-import&nbsp;javax.security.auth.callback.UnsupportedCallbackException;<br>
-import&nbsp;javax.security.auth.message.callback.CallerPrincipalCallback;<br>
-import&nbsp;javax.security.auth.message.callback.CertStoreCallback;<br>
-import&nbsp;javax.security.auth.message.callback.GroupPrincipalCallback;<br>
-import&nbsp;javax.security.auth.message.callback.PasswordValidationCallback;<br>
-import&nbsp;javax.security.auth.message.callback.PrivateKeyCallback;<br>
-import&nbsp;javax.security.auth.message.callback.SecretKeyCallback;<br>
-import&nbsp;javax.security.auth.message.callback.TrustStoreCallback;<br>
-import&nbsp;java.security.Principal;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-public&nbsp;class&nbsp;HttpServletCallbackHandlerTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletCallbackHandler&nbsp;callbackHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler&nbsp;=&nbsp;new&nbsp;HttpServletCallbackHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithCallbackName()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(&amp;quot;PRN_NAME&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(principal);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0].getName(),&nbsp;&amp;quot;PRN_NAME&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0],&nbsp;principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithCallbackNameButNonNullPrincipal()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;mock(Principal.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(&amp;quot;PRN_NAME&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(principal);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNull(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0].getName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0],&nbsp;principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithCallbackPrincipal()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;mock(Principal.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(principal);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0],&nbsp;principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCallerPrincipalCallbackWithNoCallbackNameOrPrincipal()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallerPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CallerPrincipalCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getName()).willReturn(null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getPrincipal()).willReturn(null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleGroupPrincipalCallbackWithNoGroups()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GroupPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(GroupPrincipalCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getGroups()).willReturn(null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleGroupPrincipalCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GroupPrincipalCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(GroupPrincipalCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;groupOne&nbsp;=&nbsp;&amp;quot;GROUP_ONE&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;groupTwo&nbsp;=&nbsp;&amp;quot;GROUP_TWO&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[]&nbsp;groups&nbsp;=&nbsp;new&nbsp;String[]{groupOne,&nbsp;groupTwo};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getSubject()).willReturn(subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(callbackOne.getGroups()).willReturn(groups);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().size(),&nbsp;2);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[0].getName(),&nbsp;&amp;quot;GROUP_ONE&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(subject.getPrincipals().toArray(new&nbsp;Principal[0])[1].getName(),&nbsp;&amp;quot;GROUP_TWO&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandlePasswordValidationCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PasswordValidationCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(PasswordValidationCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCertStoreCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CertStoreCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(CertStoreCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandlePrivateKeyCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrivateKeyCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(PrivateKeyCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecretKeyCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SecretKeyCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(SecretKeyCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;UnsupportedCallbackException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleTrustStoreCallback()&nbsp;throws&nbsp;UnsupportedCallbackException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TrustStoreCallback&nbsp;callbackOne&nbsp;=&nbsp;mock(TrustStoreCallback.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Callback[]&nbsp;callbacks&nbsp;=&nbsp;new&nbsp;Callback[]{callbackOne};<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackHandler.handle(callbacks);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeHttpServletMessageInfoTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletMessageInfoTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletMessageInfoTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/HttpServletMessageInfoTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,132&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotEquals;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-<br>
-public&nbsp;class&nbsp;HttpServletMessageInfoTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetRequestMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;returnedRequest&nbsp;=&nbsp;messageInfo.getRequestMessage();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedRequest);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedRequest,&nbsp;request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetResponseMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;returnedResponse&nbsp;=&nbsp;messageInfo.getResponseMessage();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedResponse);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedResponse,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMapWithNoMapGivenInConstructor()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;returnedMap&nbsp;=&nbsp;messageInfo.getMap();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(returnedMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSetRequestMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request2&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.setRequestMessage(request2);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;returnedRequest&nbsp;=&nbsp;messageInfo.getRequestMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedRequest);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedRequest,&nbsp;request2);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSetResponseMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response2&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.setResponseMessage(response2);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;returnedResponse&nbsp;=&nbsp;messageInfo.getResponseMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedResponse);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedResponse,&nbsp;response2);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMapWithMapGivenInConstructor()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response,&nbsp;map);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;returnedMap&nbsp;=&nbsp;messageInfo.getMap();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(returnedMap,&nbsp;map);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeJaspiRuntimeTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/JaspiRuntimeTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/JaspiRuntimeTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/JaspiRuntimeTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,162&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-*&nbsp;License.<br>
-*<br>
-*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-*<br>
-*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-*<br>
-*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
-<br>
-import&nbsp;org.forgerock.jaspi.runtime.response.FailureResponseHandler;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.mockito.ArgumentCaptor;<br>
-import&nbsp;org.mockito.Matchers;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletRequestWrapper;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
-<br>
-public&nbsp;class&nbsp;JaspiRuntimeTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;RuntimeResultHandler&nbsp;runtimeResultHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtimeResultHandler&nbsp;=&nbsp;mock(RuntimeResultHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessageAndPassStraightToChainWhenServerAuthContextNotConfigured()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain).doFilter(request,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(runtimeResultHandler);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessageAndNotCallChainIfValidateRequestIsNotSUCCESS()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(runtimeResultHandler.handleValidateRequestResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;AuditTrail&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject())).willReturn(false);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain,&nbsp;never()).doFilter(request,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(runtimeResultHandler,&nbsp;never()).handleSecureResponseResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessage()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(runtimeResultHandler.handleValidateRequestResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;AuditTrail&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject())).willReturn(true);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;HttpServletRequest&amp;gt;&nbsp;requestCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;HttpServletResponse&amp;gt;&nbsp;responseCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain).doFilter(requestCaptor.capture(),&nbsp;responseCaptor.capture());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(runtimeResultHandler).handleSecureResponseResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(serverAuthContext).cleanSubject(Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((HttpServletRequestWrapper)&nbsp;requestCaptor.getValue()).getRequest(),&nbsp;request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((HttpServletResponseWrapper)&nbsp;responseCaptor.getValue()).getResponse(),&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldConvertAuthExceptionToCrestResponseWhenDoFilterFails()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler&nbsp;=&nbsp;mock(FailureResponseHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(serverAuthContext).validateRequest(Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;ResourceException&amp;gt;&nbsp;resourceExceptionCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(ResourceException.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(failureResponseHandler).handle(resourceExceptionCaptor.capture(),&nbsp;any(MessageInfo.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(resourceExceptionCaptor.getValue().getCode(),&nbsp;500);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeRuntimeResultHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/RuntimeResultHandlerTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/RuntimeResultHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/RuntimeResultHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,218&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.never;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.verifyZeroInteractions;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertFalse;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
-import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
-<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-public&nbsp;class&nbsp;RuntimeResultHandlerTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;RuntimeResultHandler&nbsp;resultHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler&nbsp;=&nbsp;new&nbsp;RuntimeResultHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendFailureAuthStatus()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;writer&nbsp;=&nbsp;mock(PrintWriter.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(response.getWriter()).willReturn(writer);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(401);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendContinueAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_CONTINUE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response,&nbsp;never()).setStatus(100);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleValidateRequestShouldThrowAuthExceptionWithFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(500);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendContinueAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_CONTINUE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response,&nbsp;never()).setStatus(100);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimecontextContextHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/ContextHandlerTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/ContextHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/ContextHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,222&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.context;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.security.Principal;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.jaspi.runtime.JaspiRuntime;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;ContextHandlerTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextHandler&nbsp;contextHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler&nbsp;=&nbsp;new&nbsp;ContextHandler(messageInfoUtils);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModulesWhenAuthModulesNull()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenDoesNotSupportEither()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[0]);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenOnlySupportsHttpServletRequest()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{HttpServletRequest.class});<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenOnlySupportsHttpServletResponse()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{HttpServletResponse.class});<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes())<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class});<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModulesWhenAuthModuleListContainsNullAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNull()&nbsp;throws&nbsp;AuthException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail(&amp;quot;Expect&nbsp;exception&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(e.getCause()&nbsp;instanceof&nbsp;ResourceException);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((ResourceException)&nbsp;e.getCause()).getCode(),&nbsp;401);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNotNullAndPrincipalNameNotSet()&nbsp;throws&nbsp;AuthException,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT)).willReturn(contextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(messageInfo,&nbsp;never()).setRequestMessage(anyObject());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNotNull()&nbsp;throws&nbsp;AuthException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principalOne&nbsp;=&nbsp;mock(Principal.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT)).willReturn(contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().add(principalOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(principalOne.getName()).willReturn(&amp;quot;PRN_ONE&amp;quot;);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;&amp;quot;PRN_ONE&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimecontextJaspiServerAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContextTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/context/JaspiServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,791&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.context;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.never;<br>
-import&nbsp;static&nbsp;org.mockito.Matchers.anyListOf;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.jaspi.runtime.AuditTrail;<br>
-import&nbsp;org.forgerock.jaspi.utils.MessageInfoUtils;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiServerAuthContextTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextHandler&nbsp;contextHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler&nbsp;=&nbsp;mock(ContextHandler.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;createJaspiServerAuthContext(ServerAuthModule&nbsp;sessionAuthModule,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;AuthStatus&nbsp;validateRequestAuthStatus,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;secureResponseAuthStatus)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;validateRequest(List&nbsp;authModules,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;validateRequestAuthStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;secureResponse(List&nbsp;authModules,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;secureResponseAuthStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContextWithNoSessionAuthModuleAndEmptyListOfAuthModules()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContextWithNoSessionAuthModuleAndNullListOfAuthModules()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContext()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowJaspiAuthExceptionWhenAuthModuleDoesNotConformToHttpServletProfile()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(contextHandler)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateServerAuthModuleConformToHttpServletProfile(anyListOf(ServerAuthModule.class));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createJaspiServerAuthContext(sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMessageInfoUtils()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfoUtils&nbsp;actualMessageInfoUtils&nbsp;=&nbsp;jaspiServerAuthContext.getMessageInfoUtils();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(actualMessageInfoUtils,&nbsp;messageInfoUtils);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithNoAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler,&nbsp;never()).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_CONTINUE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler,&nbsp;never()).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenSessionModuleReturnsInvalidAuthStatus()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_FAILURE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiServerAuthContext.PRIVATE_CONTEXT_MAP_KEY))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(contextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenAuthModulesReturnNull()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenAuthModulesReturnFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.FAILURE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldNotAuditWhenAuthModulesReturnSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_CONTINUE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_FAILURE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithNoSessionModuleAndWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldThrowJaspiAuthExceptionWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldThrowJaspiAuthExceptionWhenAuthModulesReturnFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnSendSuccessWithNoSessionAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnNullWithSessionAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnSendSuccessAndSessionModuleReturnsSendFailure()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithNoSessionAuthModuleAndNullAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithOnlySessionAuthModuleConfigured()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithOnlyAuthModulesConfigured()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubject()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseFailureResponseHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/FailureResponseHandlerTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/FailureResponseHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/FailureResponseHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,127&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
-<br>
-import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
-import&nbsp;org.forgerock.jaspi.runtime.HttpServletMessageInfo;<br>
-import&nbsp;org.forgerock.jaspi.runtime.ResourceExceptionHandler;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.DataProvider;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.PrintWriter;<br>
-import&nbsp;java.io.StringWriter;<br>
-import&nbsp;java.util.Arrays;<br>
-import&nbsp;java.util.List;<br>
-<br>
-public&nbsp;class&nbsp;FailureResponseHandlerTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_XML&nbsp;=&nbsp;&amp;quot;application/xml&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_JSON&nbsp;=&nbsp;&amp;quot;application/json&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TEXT_XML&nbsp;=&nbsp;&amp;quot;text/xml&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TEXT_PLAIN&nbsp;=&nbsp;&amp;quot;text/plain&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FailureResponseHandler&nbsp;handler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setup()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;jsonHandlerShouldRenderException()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StringWriter();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(new&nbsp;PrintWriter(sw)).when(response).getWriter();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.BAD_REQUEST,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;))));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;FailureResponseHandler.JsonResourceExceptionHandler().write(jre,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;responseText&nbsp;=&nbsp;sw.toString();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;400&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;BAD_REQUEST&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;DETAIL_KEY&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;DETAIL_VALUE&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setContentType(&amp;quot;application/json&amp;quot;);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;content-types&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;Object[][]&nbsp;contentTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;APPLICATION_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/svg+xml&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_PLAIN,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.8,&nbsp;application/xml&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.9,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=1.0&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;null,&nbsp;APPLICATION_JSON&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;content-types&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldUseExceptionHandlerIfAvailable(String&nbsp;accept,&nbsp;String&nbsp;expected)&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StringWriter();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(new&nbsp;PrintWriter(sw)).when(response).getWriter();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(accept).when(request).getHeader(&amp;quot;Accept&amp;quot;);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.registerExceptionHandler(TestExceptionHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.BAD_REQUEST,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;))));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.handle(jre,&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(400);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setContentType(expected);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;class&nbsp;TestExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;handles()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Arrays.asList(MediaType.parse(APPLICATION_XML),&nbsp;MediaType.parse(TEXT_XML));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setContentType(APPLICATION_XML);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.getWriter().write(&amp;quot;Hello&nbsp;&amp;quot;+exception.getCode());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiHttpServletResponseWrapperTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapperTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapperTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiHttpServletResponseWrapperTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,62&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
-<br>
-public&nbsp;class&nbsp;JaspiHttpServletResponseWrapperTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetOutputStream()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiHttpServletResponseWrapper&nbsp;responseWrapper&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper(response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletOutputStream&nbsp;outputStream&nbsp;=&nbsp;responseWrapper.getOutputStream();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(JaspiServletOutputStream.class.isAssignableFrom(outputStream.getClass()));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetWriter()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiHttpServletResponseWrapper&nbsp;responseWrapper&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;printWriter&nbsp;=&nbsp;mock(PrintWriter.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(response.getWriter()).willReturn(printWriter);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;writer&nbsp;=&nbsp;responseWrapper.getWriter();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(JaspiPrintWriter.class.isAssignableFrom(writer.getClass()));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiPrintWriterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriterTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiPrintWriterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,40&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-<br>
-public&nbsp;class&nbsp;JaspiPrintWriterTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiPrintWriter()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;printWriter&nbsp;=&nbsp;mock(PrintWriter.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiPrintWriter&nbsp;jaspiPrintWriter&nbsp;=&nbsp;new&nbsp;JaspiPrintWriter(printWriter);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiPrintWriter);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiruntimeresponseJaspiServletOutputStreamTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStreamTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStreamTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/runtime/response/JaspiServletOutputStreamTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,91&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.runtime.response;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
-<br>
-public&nbsp;class&nbsp;JaspiServletOutputStreamTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiServletOutputStream&nbsp;servletOutputStream;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ServletOutputStream&nbsp;outputStream;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outputStream&nbsp;=&nbsp;mock(ServletOutputStream.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream&nbsp;=&nbsp;new&nbsp;JaspiServletOutputStream(outputStream);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWrite()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(1);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWriteByte()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;b&nbsp;=&nbsp;new&nbsp;byte[0];<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(b);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWriteByteWithLength()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;b&nbsp;=&nbsp;new&nbsp;byte[0];<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b,&nbsp;0,&nbsp;1);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(b,&nbsp;0,&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldClose()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.close();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).close();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockjaspiutilsMessageInfoUtilsTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/utils/MessageInfoUtilsTest.java&nbsp;(3053&nbsp;=&gt;&nbsp;3054)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/utils/MessageInfoUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:20:02&nbsp;UTC&nbsp;(rev&nbsp;3053)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/jaspi/utils/MessageInfoUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-03-23&nbsp;12:21:12&nbsp;UTC&nbsp;(rev&nbsp;3054)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,93&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2014&nbsp;ForgeRock&nbsp;AS.<br>
-&amp;lt;!--<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.jaspi.utils;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-<br>
-public&nbsp;class&nbsp;MessageInfoUtilsTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;new&nbsp;MessageInfoUtils();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetNewMap()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;mapKey);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(map);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetExistingMap()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;expectedMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(mapKey,&nbsp;expectedMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;mapKey);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(map,&nbsp;expectedMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;should()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.addMap(messageInfo,&nbsp;mapKey);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;footer&quot;&gt;Copyright&nbsp;(c)&nbsp;by&nbsp;ForgeRock.&nbsp;All&nbsp;rights&nbsp;reserved.&lt;/div&gt;<br>
<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
