<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;XHTML&nbsp;1.1//EN&quot;<br>
&quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;&gt;<br>
&lt;html&nbsp;xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;<br>
&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;/&gt;<br>
&lt;title&gt;[3261]&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter:&nbsp;CAF-109&nbsp;CMN-89&nbsp;Refactor&nbsp;authentication&nbsp;framework&nbsp;to&nbsp;be&nbsp;based&nbsp;on&nbsp;CHF&nbsp;and&nbsp;promises&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&gt;<br>
<br>
&lt;style&nbsp;type=&quot;text/css&quot;&gt;&lt;!--<br>
#msg&nbsp;dl.meta&nbsp;{&nbsp;border:&nbsp;1px&nbsp;#006&nbsp;solid;&nbsp;background:&nbsp;#369;&nbsp;padding:&nbsp;6px;&nbsp;color:&nbsp;#fff;&nbsp;}<br>
#msg&nbsp;dl.meta&nbsp;dt&nbsp;{&nbsp;float:&nbsp;left;&nbsp;width:&nbsp;6em;&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>
#msg&nbsp;dt:after&nbsp;{&nbsp;content:':';}<br>
#msg&nbsp;dl,&nbsp;#msg&nbsp;dt,&nbsp;#msg&nbsp;ul,&nbsp;#msg&nbsp;li,&nbsp;#header,&nbsp;#footer,&nbsp;#logmsg&nbsp;{&nbsp;font-family:&nbsp;verdana,arial,helvetica,sans-serif;&nbsp;font-size:&nbsp;10pt;&nbsp;&nbsp;}<br>
#msg&nbsp;dl&nbsp;a&nbsp;{&nbsp;font-weight:&nbsp;bold}<br>
#msg&nbsp;dl&nbsp;a:link&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;color:#fc3;&nbsp;}<br>
#msg&nbsp;dl&nbsp;a:active&nbsp;&nbsp;{&nbsp;color:#ff0;&nbsp;}<br>
#msg&nbsp;dl&nbsp;a:visited&nbsp;{&nbsp;color:#cc6;&nbsp;}<br>
h3&nbsp;{&nbsp;font-family:&nbsp;verdana,arial,helvetica,sans-serif;&nbsp;font-size:&nbsp;10pt;&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>
#msg&nbsp;pre&nbsp;{&nbsp;overflow:&nbsp;auto;&nbsp;background:&nbsp;#ffc;&nbsp;border:&nbsp;1px&nbsp;#fa0&nbsp;solid;&nbsp;padding:&nbsp;6px;&nbsp;}<br>
#logmsg&nbsp;{&nbsp;background:&nbsp;#ffc;&nbsp;border:&nbsp;1px&nbsp;#fa0&nbsp;solid;&nbsp;padding:&nbsp;1em&nbsp;1em&nbsp;0&nbsp;1em;&nbsp;}<br>
#logmsg&nbsp;p,&nbsp;#logmsg&nbsp;pre,&nbsp;#logmsg&nbsp;blockquote&nbsp;{&nbsp;margin:&nbsp;0&nbsp;0&nbsp;1em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;p,&nbsp;#logmsg&nbsp;li,&nbsp;#logmsg&nbsp;dt,&nbsp;#logmsg&nbsp;dd&nbsp;{&nbsp;line-height:&nbsp;14pt;&nbsp;}<br>
#logmsg&nbsp;h1,&nbsp;#logmsg&nbsp;h2,&nbsp;#logmsg&nbsp;h3,&nbsp;#logmsg&nbsp;h4,&nbsp;#logmsg&nbsp;h5,&nbsp;#logmsg&nbsp;h6&nbsp;{&nbsp;margin:&nbsp;.5em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;h1:first-child,&nbsp;#logmsg&nbsp;h2:first-child,&nbsp;#logmsg&nbsp;h3:first-child,&nbsp;#logmsg&nbsp;h4:first-child,&nbsp;#logmsg&nbsp;h5:first-child,&nbsp;#logmsg&nbsp;h6:first-child&nbsp;{&nbsp;margin-top:&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;ul,&nbsp;#logmsg&nbsp;ol&nbsp;{&nbsp;padding:&nbsp;0;&nbsp;list-style-position:&nbsp;inside;&nbsp;margin:&nbsp;0&nbsp;0&nbsp;0&nbsp;1em;&nbsp;}<br>
#logmsg&nbsp;ul&nbsp;{&nbsp;text-indent:&nbsp;-1em;&nbsp;padding-left:&nbsp;1em;&nbsp;}#logmsg&nbsp;ol&nbsp;{&nbsp;text-indent:&nbsp;-1.5em;&nbsp;padding-left:&nbsp;1.5em;&nbsp;}<br>
#logmsg&nbsp;&gt;&nbsp;ul,&nbsp;#logmsg&nbsp;&gt;&nbsp;ol&nbsp;{&nbsp;margin:&nbsp;0&nbsp;0&nbsp;1em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;pre&nbsp;{&nbsp;background:&nbsp;#eee;&nbsp;padding:&nbsp;1em;&nbsp;}<br>
#logmsg&nbsp;blockquote&nbsp;{&nbsp;border:&nbsp;1px&nbsp;solid&nbsp;#fa0;&nbsp;border-left-width:&nbsp;10px;&nbsp;padding:&nbsp;1em&nbsp;1em&nbsp;0&nbsp;1em;&nbsp;background:&nbsp;white;}<br>
#logmsg&nbsp;dl&nbsp;{&nbsp;margin:&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;dt&nbsp;{&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>
#logmsg&nbsp;dd&nbsp;{&nbsp;margin:&nbsp;0;&nbsp;padding:&nbsp;0&nbsp;0&nbsp;0.5em&nbsp;0;&nbsp;}<br>
#logmsg&nbsp;dd:before&nbsp;{&nbsp;content:'\00bb';}<br>
#logmsg&nbsp;table&nbsp;{&nbsp;border-spacing:&nbsp;0px;&nbsp;border-collapse:&nbsp;collapse;&nbsp;border-top:&nbsp;4px&nbsp;solid&nbsp;#fa0;&nbsp;border-bottom:&nbsp;1px&nbsp;solid&nbsp;#fa0;&nbsp;background:&nbsp;#fff;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;th&nbsp;{&nbsp;text-align:&nbsp;left;&nbsp;font-weight:&nbsp;normal;&nbsp;padding:&nbsp;0.2em&nbsp;0.5em;&nbsp;border-top:&nbsp;1px&nbsp;dotted&nbsp;#fa0;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;td&nbsp;{&nbsp;text-align:&nbsp;right;&nbsp;border-top:&nbsp;1px&nbsp;dotted&nbsp;#fa0;&nbsp;padding:&nbsp;0.2em&nbsp;0.5em;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;thead&nbsp;th&nbsp;{&nbsp;text-align:&nbsp;center;&nbsp;border-bottom:&nbsp;1px&nbsp;solid&nbsp;#fa0;&nbsp;}<br>
#logmsg&nbsp;table&nbsp;th.Corner&nbsp;{&nbsp;text-align:&nbsp;left;&nbsp;}<br>
#logmsg&nbsp;hr&nbsp;{&nbsp;border:&nbsp;none&nbsp;0;&nbsp;border-top:&nbsp;2px&nbsp;dashed&nbsp;#fa0;&nbsp;height:&nbsp;1px;&nbsp;}<br>
#header,&nbsp;#footer&nbsp;{&nbsp;color:&nbsp;#fff;&nbsp;background:&nbsp;#636;&nbsp;border:&nbsp;1px&nbsp;#300&nbsp;solid;&nbsp;padding:&nbsp;6px;&nbsp;}<br>
#patch&nbsp;{&nbsp;width:&nbsp;100%;&nbsp;}<br>
#patch&nbsp;h4&nbsp;{font-family:&nbsp;verdana,arial,helvetica,sans-serif;font-size:10pt;padding:8px;background:#369;color:#fff;margin:0;}<br>
#patch&nbsp;.propset&nbsp;h4,&nbsp;#patch&nbsp;.binary&nbsp;h4&nbsp;{margin:0;}<br>
#patch&nbsp;pre&nbsp;{padding:0;line-height:1.2em;margin:0;}<br>
#patch&nbsp;.diff&nbsp;{width:100%;background:#eee;padding:&nbsp;0&nbsp;0&nbsp;10px&nbsp;0;overflow:auto;}<br>
#patch&nbsp;.propset&nbsp;.diff,&nbsp;#patch&nbsp;.binary&nbsp;.diff&nbsp;&nbsp;{padding:10px&nbsp;0;}<br>
#patch&nbsp;span&nbsp;{display:block;padding:0&nbsp;10px;}<br>
#patch&nbsp;.modfile,&nbsp;#patch&nbsp;.addfile,&nbsp;#patch&nbsp;.delfile,&nbsp;#patch&nbsp;.propset,&nbsp;#patch&nbsp;.binary,&nbsp;#patch&nbsp;.copfile&nbsp;{border:1px&nbsp;solid&nbsp;#ccc;margin:10px&nbsp;0;}<br>
#patch&nbsp;ins&nbsp;{background:#dfd;text-decoration:none;display:block;padding:0&nbsp;10px;}<br>
#patch&nbsp;del&nbsp;{background:#fdd;text-decoration:none;display:block;padding:0&nbsp;10px;}<br>
#patch&nbsp;.lines,&nbsp;.info&nbsp;{color:#888;background:#fff;}<br>
--&gt;&lt;/style&gt;<br>
&lt;div&nbsp;id=&quot;msg&quot;&gt;<br>
&lt;dl&nbsp;class=&quot;meta&quot;&gt;<br>
&lt;dt&gt;Revision&lt;/dt&gt;&nbsp;&lt;dd&gt;&lt;a&nbsp;href=&quot;http://sources.forgerock.org/changelog/commons/?cs=3261&quot;&gt;3261&lt;/a&gt;&lt;/dd&gt;<br>
&lt;dt&gt;Author&lt;/dt&gt;&nbsp;&lt;dd&gt;phillcunnington&lt;/dd&gt;<br>
&lt;dt&gt;Date&lt;/dt&gt;&nbsp;&lt;dd&gt;2015-05-01&nbsp;08:29:16&nbsp;+0100&nbsp;(Fri,&nbsp;01&nbsp;May&nbsp;2015)&lt;/dd&gt;<br>
&lt;/dl&gt;<br>
<br>
&lt;h3&gt;Log&nbsp;Message&lt;/h3&gt;<br>
&lt;pre&gt;CAF-109&nbsp;CMN-89&nbsp;Refactor&nbsp;authentication&nbsp;framework&nbsp;to&nbsp;be&nbsp;based&nbsp;on&nbsp;CHF&nbsp;and&nbsp;promises&lt;/pre&gt;<br>
<br>
&lt;h3&gt;Modified&nbsp;Paths&lt;/h3&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterREADMEmd&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/README.md&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestJaspiHttpApplicationjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/JaspiHttpApplication.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestProtectedResourcejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingSessionAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleOnejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleTwojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleUnsupportedMessageTypesjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleUnsupportedMessageTypes.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesFailureAuditingAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesSessionAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeGuiceModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainwebappWEBINFwebxml&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnAuthModuleParametersjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/AuthModuleParameters.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnCommittedResponseITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/CommittedResponseIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnModuleAuditingITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/ModuleAuditingIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSendContinueSupportITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SendContinueSupportIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSessionAndAuthModulesITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionAndAuthModulesIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSessionModuleOnlyITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionModuleOnlyIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSingleAuthModuleOnlyITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SingleAuthModuleOnlyIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnTestFrameworkjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/TestFramework.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnUnsupportedMessageTypesITjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/UnsupportedMessageTypesIT.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwaIWAModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwawdssoWDSSOjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrcmainjavaorgforgerockjaspimodulessessionjwtJwtSessionModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrctestjavaorgforgerockjaspimodulessessionjwtJwtSessionModuleTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamOpenAMSessionModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamRestletRestClientjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidOpenIdConnectModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversJWKOpenIdResolverImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversPublicKeyOpenIdResolverImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversSharedSecretOpenIdResolverImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversWellKnownOpenIdConfigurationFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceConfiguratorImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimepomxml&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/pom.xml&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAsyncServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAsyncServerAuthModulejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthModule.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthenticationExceptionjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationException.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiMessageContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiMessageContextInfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContextInfo.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapipackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuditTrailjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthStatusUtilsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletCallbackHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiAdaptersjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiAdapters.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkResourceExceptionHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkpackageinfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/package-info.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationapiAuthenticationExceptionTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/api/AuthenticationExceptionTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiAdaptersTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiAdaptersTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;h3&gt;Added&nbsp;Paths&lt;/h3&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthContextWithStatejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthContextWithState.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthenticationStatejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationState.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthenticationStateExceptionjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationStateException.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAggregateAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AggregateAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthContextsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthContexts.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthModulesjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthModules.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthenticationFilterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFilter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthenticationFrameworkjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFramework.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFallbackAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkMessageContextImpljava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageContextImpl.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkSessionAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/SessionAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAggregateAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AggregateAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthContextsTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthContextsTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthModulesTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthModulesTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthStatusUtilsTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthStatusUtilsTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthenticationFilterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFilterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthenticationFrameworkTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFrameworkTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFallbackAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkMessageContextImplTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageContextImplTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkSessionAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/SessionAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;h3&gt;Removed&nbsp;Paths&lt;/h3&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestProtectedResponseCommittingResourcejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResponseCommittingResource.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeTestContextFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextFactoryjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfojava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimejava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkContextHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfoTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;li&gt;&lt;a&nbsp;href=&quot;#forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerTestjava&quot;&gt;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&lt;/a&gt;&lt;/li&gt;<br>
&lt;/ul&gt;<br>
<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;patch&quot;&gt;<br>
&lt;h3&gt;Diff&lt;/h3&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterREADMEmd&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/README.md&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/README.md&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/README.md&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-155,23&nbsp;+155,102&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;###&nbsp;Example&nbsp;of&nbsp;adapting&nbsp;a&nbsp;JASPI&nbsp;**ServerAuthContext**&nbsp;to&nbsp;a&nbsp;**AsyncServerAuthContext**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```java<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;ServerAuthContext&nbsp;authContext&nbsp;=&nbsp;...;<br>
&lt;/span&gt;&lt;del&gt;-AsyncServerAuthContext&nbsp;asyncAuthContext&nbsp;=&nbsp;JaspiAdapter.adapt(authContext);<br>
&lt;/del&gt;&lt;ins&gt;+AsyncServerAuthContext&nbsp;asyncAuthContext&nbsp;=&nbsp;JaspiAdapters.adapt(authContext);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;###&nbsp;Example&nbsp;of&nbsp;adapting&nbsp;a&nbsp;JASPI&nbsp;**ServerAuthModule**&nbsp;to&nbsp;a&nbsp;**AsyncServerAuthModule**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```java<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;...;<br>
&lt;/span&gt;&lt;del&gt;-AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapter.adapt(authModule);<br>
&lt;/del&gt;&lt;ins&gt;+AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;###&nbsp;Example&nbsp;of&nbsp;adapting&nbsp;a&nbsp;JASPI&nbsp;**AuthException**&nbsp;to&nbsp;a&nbsp;**AuthenticationException**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```java<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;AuthException&nbsp;authException&nbsp;=&nbsp;...;<br>
&lt;/span&gt;&lt;del&gt;-AuthenticationException&nbsp;authenticationException&nbsp;=&nbsp;JaspiAdapter.adapt(authException);<br>
&lt;/del&gt;&lt;ins&gt;+AuthenticationException&nbsp;authenticationException&nbsp;=&nbsp;JaspiAdapters.adapt(authException);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;###&nbsp;Example&nbsp;of&nbsp;adapting&nbsp;a&nbsp;**MessageContextInfo**&nbsp;to&nbsp;a&nbsp;JASPI&nbsp;**MessageInfo**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;```java<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;MessageContextInfo&nbsp;messageContextInfo&nbsp;=&nbsp;...;<br>
&lt;/span&gt;&lt;del&gt;-MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;JaspiAdapter.adapt(messageContextInfo);<br>
-```<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;ins&gt;+MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;JaspiAdapters.adapt(messageContextInfo);<br>
+```<br>
+<br>
+---<br>
+---<br>
+<br>
+##&nbsp;Authentication&nbsp;Framework&nbsp;Configuration<br>
+<br>
+The&nbsp;**AuthenticationFilter**&nbsp;class&nbsp;is&nbsp;the&nbsp;entry&nbsp;point&nbsp;into&nbsp;both&nbsp;configuring&nbsp;the&nbsp;Authentication&nbsp;<br>
+Framework&nbsp;and&nbsp;for&nbsp;protecting&nbsp;resources.&nbsp;<br>
+<br>
+```java<br>
+AuthenticationFilter&nbsp;authenticationFilter&nbsp;=&nbsp;AuthenticationFilter.builder()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.logger(logger)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.serviceSubject(serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responseHandler(responseHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.sessionModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(sessionAuthModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(sessionAuthModuleRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(sessionAuthModuleResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(sessionAuthModuleHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(sessionAuthModuleSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authModules(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModuleOne)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleOneRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleOneResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleOneHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleOneSettings),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModuleTwo)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleTwoRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleTwoResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleTwoHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleTwoSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
+authenticationFilter.filter(context,&nbsp;request,&nbsp;handler);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
+```<br>
+<br>
+---<br>
+<br>
+The&nbsp;Authentication&nbsp;Framework&nbsp;can&nbsp;be&nbsp;configured&nbsp;with&nbsp;zero&nbsp;<br>
+or&nbsp;one&nbsp;&amp;quot;session&amp;quot;&nbsp;authentication&nbsp;modules&nbsp;and&nbsp;list&nbsp;of&nbsp;zero&nbsp;or&nbsp;more&nbsp;authentication&nbsp;modules.&nbsp;<br>
+<br>
+A&nbsp;&amp;quot;session&amp;quot;&nbsp;authentication&nbsp;module&nbsp;differs&nbsp;from&nbsp;a&nbsp;normal&nbsp;authentication&nbsp;module&nbsp;only&nbsp;in&nbsp;intent,&nbsp;<br>
+meaning&nbsp;a&nbsp;&amp;quot;session&amp;quot;&nbsp;authentication&nbsp;module,&nbsp;if&nbsp;configured,&nbsp;always&nbsp;validates&nbsp;the&nbsp;request&nbsp;first&nbsp;and&nbsp;<br>
+will&nbsp;always&nbsp;secure&nbsp;the&nbsp;response&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;successfully&nbsp;authenticated.<br>
+<br>
+The&nbsp;framework&nbsp;processes&nbsp;request&nbsp;by&nbsp;first&nbsp;invoking&nbsp;the&nbsp;&amp;quot;session&amp;quot;&nbsp;authentication&nbsp;module&nbsp;and&nbsp;only&nbsp;<br>
+proceeding&nbsp;to&nbsp;the&nbsp;authentication&nbsp;module&nbsp;list&nbsp;if&nbsp;the&nbsp;&amp;quot;session&amp;quot;&nbsp;module&nbsp;fails.&nbsp;Similarly&nbsp;each&nbsp;module&nbsp;<br>
+from&nbsp;the&nbsp;list&nbsp;of&nbsp;authentication&nbsp;modules&nbsp;is&nbsp;invoked&nbsp;in&nbsp;order&nbsp;and&nbsp;the&nbsp;next&nbsp;module&nbsp;is&nbsp;only&nbsp;invoked&nbsp;if&nbsp;<br>
+the&nbsp;previous&nbsp;module&nbsp;failed.&nbsp;If&nbsp;no&nbsp;modules&nbsp;succeed&nbsp;in&nbsp;authenticating&nbsp;the&nbsp;request&nbsp;then&nbsp;<br>
+authentication&nbsp;fails&nbsp;and&nbsp;an&nbsp;unauthenticated&nbsp;response&nbsp;is&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.<br>
+<br>
+If&nbsp;the&nbsp;&amp;quot;session&amp;quot;&nbsp;module&nbsp;or&nbsp;any&nbsp;of&nbsp;the&nbsp;authentication&nbsp;modules&nbsp;succeed&nbsp;in&nbsp;authenticating&nbsp;the&nbsp;request&nbsp;<br>
+then&nbsp;the&nbsp;downstream&nbsp;resource&nbsp;is&nbsp;called.<br>
+<br>
+Once&nbsp;the&nbsp;downstream&nbsp;resource&nbsp;has&nbsp;handled&nbsp;the&nbsp;request&nbsp;and&nbsp;returned&nbsp;a&nbsp;response,&nbsp;the&nbsp;response&nbsp;is&nbsp;then&nbsp;<br>
+handed&nbsp;to&nbsp;the&nbsp;authentication&nbsp;module&nbsp;that&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;request,&nbsp;then&nbsp;the&nbsp;&amp;quot;session&amp;quot;&nbsp;<br>
+module&nbsp;gets&nbsp;the&nbsp;chance&nbsp;to&nbsp;add&nbsp;any&nbsp;session&nbsp;information&nbsp;to&nbsp;the&nbsp;response,&nbsp;which&nbsp;can&nbsp;then&nbsp;be&nbsp;used&nbsp;on&nbsp;<br>
+subsequent&nbsp;requests&nbsp;to&nbsp;avoid&nbsp;having&nbsp;to&nbsp;go&nbsp;through&nbsp;the&nbsp;whole&nbsp;authentication&nbsp;process&nbsp;which&nbsp;may&nbsp;have&nbsp;<br>
+to&nbsp;include&nbsp;credentials&nbsp;to&nbsp;be&nbsp;sent&nbsp;on&nbsp;the&nbsp;request&nbsp;as&nbsp;well.<br>
+<br>
+**Note:**&nbsp;Only&nbsp;the&nbsp;module&nbsp;that&nbsp;successfully&nbsp;authenticates&nbsp;the&nbsp;request&nbsp;(and&nbsp;the&nbsp;&amp;quot;session&amp;quot;&nbsp;module)&nbsp;<br>
+gets&nbsp;to&nbsp;secure&nbsp;the&nbsp;response,&nbsp;not&nbsp;the&nbsp;entire&nbsp;list&nbsp;of&nbsp;authentication&nbsp;modules.&nbsp;<br>
+<br>
+---<br>
+<br>
+The&nbsp;Authentication&nbsp;Filter&nbsp;also&nbsp;performs&nbsp;audit&nbsp;logging&nbsp;on&nbsp;each&nbsp;request&nbsp;detailing&nbsp;which&nbsp;modules&nbsp;<br>
+attempted&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;request&nbsp;and&nbsp;which&nbsp;succeed&nbsp;or&nbsp;failed.&nbsp;In&nbsp;addition&nbsp;each&nbsp;successfully&nbsp;<br>
+authenticated&nbsp;request&nbsp;gets&nbsp;a&nbsp;unique&nbsp;ID&nbsp;which&nbsp;is&nbsp;logged&nbsp;with&nbsp;the&nbsp;audit&nbsp;record.<br>
+<br>
+If&nbsp;a&nbsp;&amp;quot;session&amp;quot;&nbsp;module&nbsp;has&nbsp;been&nbsp;configured&nbsp;then&nbsp;the&nbsp;module&nbsp;has&nbsp;the&nbsp;opportunity&nbsp;to&nbsp;set&nbsp;a&nbsp;unique&nbsp;<br>
+session&nbsp;id&nbsp;on&nbsp;the&nbsp;audit&nbsp;record,&nbsp;when&nbsp;it&nbsp;secures&nbsp;a&nbsp;response.&nbsp;Then&nbsp;each&nbsp;subsequent&nbsp;request&nbsp;that<br>
+the&nbsp;&amp;quot;session&amp;quot;&nbsp;module&nbsp;successfully&nbsp;authenticates&nbsp;it&nbsp;can&nbsp;set&nbsp;the&nbsp;same&nbsp;session&nbsp;id&nbsp;onto&nbsp;the&nbsp;audit<br>
+record&nbsp;and&nbsp;then&nbsp;a&nbsp;set&nbsp;of&nbsp;requests&nbsp;can&nbsp;be&nbsp;tied&nbsp;together&nbsp;and&nbsp;back&nbsp;to&nbsp;the&nbsp;request&nbsp;that&nbsp;first&nbsp;resulted<br>
+in&nbsp;the&nbsp;session&nbsp;being&nbsp;started.<br>
+<br>
+Each&nbsp;authentication&nbsp;module&nbsp;(&amp;quot;session&amp;quot;&nbsp;or&nbsp;otherwise)&nbsp;always&nbsp;has&nbsp;the&nbsp;chance&nbsp;to&nbsp;add&nbsp;additional&nbsp;audit&nbsp;<br>
+information&nbsp;to&nbsp;the&nbsp;audit&nbsp;record&nbsp;and&nbsp;also,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;an&nbsp;module&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;authenticate&nbsp;<br>
+the&nbsp;request,&nbsp;the&nbsp;module&nbsp;can&nbsp;set&nbsp;detail&nbsp;about&nbsp;the&nbsp;cause/reason&nbsp;of&nbsp;the&nbsp;failure&nbsp;on&nbsp;the&nbsp;audit&nbsp;record.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestJaspiHttpApplicationjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/JaspiHttpApplication.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/JaspiHttpApplication.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/JaspiHttpApplication.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,13&nbsp;+16,23&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFilter;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authn.test.configuration.ConfigurationConnectionFactory;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.guice.core.InjectorHolder;<br>
+import&nbsp;org.forgerock.http.Context;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.Handler;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.Http;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.HttpApplication;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.HttpApplicationException;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.RoutingMode;<br>
+import&nbsp;org.forgerock.http.UriRouter;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.io.Buffer;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.http.CrestHttp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.http.protocol.ResponseException;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.util.Factory;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.util.promise.Promise;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;HTTP&nbsp;Application&nbsp;for&nbsp;JASPI&nbsp;authentication&nbsp;framework&nbsp;functional&nbsp;tests.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-33,9&nbsp;+43,25&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Handler&nbsp;start()&nbsp;throws&nbsp;HttpApplicationException&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;CrestHttp.newHttpHandler(ConfigurationConnectionFactory.getConnectionFactory());<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UriRouter&nbsp;router&nbsp;=&nbsp;new&nbsp;UriRouter();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;router.addRoute(RoutingMode.EQUALS,&nbsp;&amp;quot;/protected/resource&amp;quot;,&nbsp;new&nbsp;ConfigurableAuthenticationFilterHandler());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;router.setDefaultRoute(CrestHttp.newHttpHandler(ConfigurationConnectionFactory.getConnectionFactory()));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;router;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;ConfigurableAuthenticationFilterHandler&nbsp;implements&nbsp;Handler&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;handle(Context&nbsp;context,&nbsp;Request&nbsp;request)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProtectedResource&nbsp;protectedResource&nbsp;=&nbsp;InjectorHolder.getInstance(ProtectedResource.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilter&nbsp;authenticationFilter&nbsp;=&nbsp;InjectorHolder.getInstance(AuthenticationFilter.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Http.chainOf(protectedResource,&nbsp;authenticationFilter).handle(context,&nbsp;request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Factory&amp;lt;Buffer&amp;gt;&nbsp;getBufferFactory()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestProtectedResourcejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResource.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-20,14&nbsp;+20,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.servlet.ServletException;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.servlet.http.HttpServlet;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.io.IOException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework;<br>
+import&nbsp;org.forgerock.http.Context;<br>
+import&nbsp;org.forgerock.http.Handler;<br>
+import&nbsp;org.forgerock.http.HttpContext;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.http.protocol.ResponseException;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;protected&nbsp;resource&nbsp;which&nbsp;will&nbsp;set&nbsp;a&nbsp;header&nbsp;on&nbsp;the&nbsp;response&nbsp;to&nbsp;signify&nbsp;that&nbsp;it&nbsp;has&nbsp;been&nbsp;called&nbsp;and&nbsp;write&nbsp;a&nbsp;JSON<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-35,7&nbsp;+40,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;ProtectedResource&nbsp;extends&nbsp;HttpServlet&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;ProtectedResource&nbsp;implements&nbsp;Handler&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;long&nbsp;serialVersionUID&nbsp;=&nbsp;1L;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-53,23&nbsp;+58,25&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;doGet(HttpServletRequest&nbsp;req,&nbsp;HttpServletResponse&nbsp;resp)&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp.setHeader(RESOURCE_CALLED_HEADER,&nbsp;&amp;quot;true&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;handle(Context&nbsp;context,&nbsp;Request&nbsp;request)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;req.getAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;req.getAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;response&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(200);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.getHeaders().putSingle(RESOURCE_CALLED_HEADER,&nbsp;&amp;quot;true&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;context.asContext(HttpContext.class).getAttributes().get(AuthenticationFramework.ATTRIBUTE_AUTH_PRINCIPAL);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;context.asContext(HttpContext.class).getAttributes().get(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;json&nbsp;=&nbsp;json(object());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json.put(&amp;quot;data&amp;quot;,&nbsp;&amp;quot;RESOURCE_DATA&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json.add(&amp;quot;principal&amp;quot;,&nbsp;principal);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(context&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json.add(&amp;quot;context&amp;quot;,&nbsp;context);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(requestContextMap&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json.add(&amp;quot;context&amp;quot;,&nbsp;requestContextMap);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;del&gt;-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp.getWriter().write(json.toString());<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setEntity(json.getObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(response);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestProtectedResponseCommittingResourcejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResponseCommittingResource.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResponseCommittingResource.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/ProtectedResponseCommittingResource.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,48&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authn.test;<br>
-<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;A&nbsp;sub-type&nbsp;of&nbsp;the&nbsp;{@code&nbsp;ProtectedResource}&nbsp;which&nbsp;performs&nbsp;the&nbsp;same&nbsp;operations&nbsp;but&nbsp;in&nbsp;addition&nbsp;also&nbsp;sets&nbsp;the<br>
-&nbsp;*&nbsp;response&nbsp;status&nbsp;to&nbsp;201&nbsp;and&nbsp;causes&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;committed.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;ProtectedResponseCommittingResource&nbsp;extends&nbsp;ProtectedResource&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;long&nbsp;serialVersionUID&nbsp;=&nbsp;1L;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;{@code&nbsp;super},&nbsp;then&nbsp;sets&nbsp;the&nbsp;response&nbsp;status&nbsp;to&nbsp;201,&nbsp;and&nbsp;causes&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;committed.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;req&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;resp&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;doGet(HttpServletRequest&nbsp;req,&nbsp;HttpServletResponse&nbsp;resp)&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super.doGet(req,&nbsp;resp);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp.setStatus(201);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp.flushBuffer();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-22,36&nbsp;+22,52&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
-&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;attempts&nbsp;to&nbsp;audit&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
+&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;attempts&nbsp;to&nbsp;audit&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;AuditingAuthModule&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;AuditingAuthModule&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-61,8&nbsp;+77,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-72,14&nbsp;+91,13&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(AUDIT_INFO_KEY);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AUDIT_INFO_KEY);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(&amp;quot;AUDITING_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().clear();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-90,7&nbsp;+108,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-100,19&nbsp;+118,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(AUDIT_INFO_KEY);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AUDIT_INFO_KEY);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditInfo&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(&amp;quot;MORE_AUDITING_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;AUDITING_AUTH_MODULE_SESSION_ID&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getRequestContextMap().put(AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;AUDITING_AUTH_MODULE_SESSION_ID&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-122,6&nbsp;+140,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuditingSessionAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuditingSessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-22,36&nbsp;+22,52&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
-&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;audits&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
+&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;audits&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;AuditingSessionAuthModule&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;AuditingSessionAuthModule&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-61,8&nbsp;+77,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-72,14&nbsp;+91,13&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(AUDIT_INFO_KEY);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AUDIT_INFO_KEY);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(&amp;quot;AUDITING_SESSION_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().clear();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-90,7&nbsp;+108,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-99,19&nbsp;+117,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(AUDIT_INFO_KEY);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AUDIT_INFO_KEY);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditInfo&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(&amp;quot;MORE_AUDITING_SESSION_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;AUDITING_SESSION_AUTH_MODULE_SESSION_ID&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getRequestContextMap().put(AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;AUDITING_SESSION_AUTH_MODULE_SESSION_ID&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-121,6&nbsp;+139,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleOnejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleOne.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-20,35&nbsp;+20,41&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.servlet.http.HttpServletRequest;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework;<br>
+import&nbsp;org.forgerock.http.HttpContext;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
-&nbsp;*&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided&nbsp;based&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request<br>
-&nbsp;*&nbsp;headers.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}<br>
+&nbsp;*&nbsp;and&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided<br>
+&nbsp;*&nbsp;based&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request&nbsp;headers.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;AuthModuleOne&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;AuthModuleOne&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;AUTH_MODULE_ONE_VALIDATE_REQUEST_HEADER_NAME&nbsp;=<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;X-JASPI-AUTH-MODULE-ONE-VALIDATE-REQUEST&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;AUTH_MODULE_ONE_SECURE_RESPONSE_HEADER_NAME&nbsp;=&nbsp;&amp;quot;X-JASPI-AUTH-MODULE-ONE-SECURE-RESPONSE&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-63,17&nbsp;+69,28&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY&nbsp;=&nbsp;&amp;quot;AUTH_MODULE_ONE_CONTEXT_ENTRY&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-83,8&nbsp;+100,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-95,19&nbsp;+115,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;httpContext&nbsp;=&nbsp;messageInfo.asContext(HttpContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;httpContext.getAttributes().get(HttpServletRequest.class.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;header&nbsp;=&nbsp;request.getHeader(AUTH_MODULE_ONE_VALIDATE_REQUEST_HEADER_NAME.toLowerCase());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.put(AUTH_MODULE_ONE_CONTEXT_ENTRY,&nbsp;true);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-118,7&nbsp;+138,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AUTH_MODULE_ONE_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-129,27&nbsp;+149,27&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AUTH_MODULE_ONE_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_CONTINUE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_CONTINUE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_CONTINUE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(NULL_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(AUTH_MODULE_ONE_VALIDATE_REQUEST_HEADER_NAME<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(AUTH_MODULE_ONE_VALIDATE_REQUEST_HEADER_NAME<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-159,41&nbsp;+179,42&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;httpContext&nbsp;=&nbsp;messageInfo.asContext(HttpContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;httpContext.getAttributes().get(HttpServletRequest.class.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;header&nbsp;=&nbsp;request.getHeader(AUTH_MODULE_ONE_SECURE_RESPONSE_HEADER_NAME.toLowerCase());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_CONTINUE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_CONTINUE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_CONTINUE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(NULL_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(AUTH_MODULE_ONE_SECURE_RESPONSE_HEADER_NAME<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(AUTH_MODULE_ONE_SECURE_RESPONSE_HEADER_NAME<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-203,6&nbsp;+224,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleTwojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleTwo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-20,35&nbsp;+20,41&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.servlet.http.HttpServletRequest;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework;<br>
+import&nbsp;org.forgerock.http.HttpContext;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
-&nbsp;*&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided&nbsp;based&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request<br>
-&nbsp;*&nbsp;headers.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}<br>
+&nbsp;*&nbsp;and&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided<br>
+&nbsp;*&nbsp;based&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request&nbsp;headers.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;AuthModuleTwo&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;AuthModuleTwo&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;AUTH_MODULE_TWO_VALIDATE_REQUEST_HEADER_NAME&nbsp;=<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;X-JASPI-AUTH-MODULE-TWO-VALIDATE-REQUEST&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;AUTH_MODULE_TWO_SECURE_RESPONSE_HEADER_NAME&nbsp;=&nbsp;&amp;quot;X-JASPI-AUTH-MODULE-TWO-SECURE-RESPONSE&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-63,17&nbsp;+69,28&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;AUTH_MODULE_TWO_CONTEXT_ENTRY&nbsp;=&nbsp;&amp;quot;AUTH_MODULE_TWO_CONTEXT_ENTRY&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-83,8&nbsp;+100,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-95,19&nbsp;+115,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;httpContext&nbsp;=&nbsp;messageInfo.asContext(HttpContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;httpContext.getAttributes().get(HttpServletRequest.class.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;header&nbsp;=&nbsp;request.getHeader(AUTH_MODULE_TWO_VALIDATE_REQUEST_HEADER_NAME.toLowerCase());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.put(AUTH_MODULE_TWO_CONTEXT_ENTRY,&nbsp;true);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-118,7&nbsp;+138,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AUTH_MODULE_TWO_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-129,27&nbsp;+149,27&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AUTH_MODULE_TWO_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_CONTINUE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_CONTINUE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_CONTINUE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(NULL_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(AUTH_MODULE_TWO_VALIDATE_REQUEST_HEADER_NAME<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(AUTH_MODULE_TWO_VALIDATE_REQUEST_HEADER_NAME<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-159,41&nbsp;+179,42&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;httpContext&nbsp;=&nbsp;messageInfo.asContext(HttpContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;httpContext.getAttributes().get(HttpServletRequest.class.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;header&nbsp;=&nbsp;request.getHeader(AUTH_MODULE_TWO_SECURE_RESPONSE_HEADER_NAME.toLowerCase());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_CONTINUE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_CONTINUE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_CONTINUE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(NULL_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(AUTH_MODULE_TWO_SECURE_RESPONSE_HEADER_NAME<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(AUTH_MODULE_TWO_SECURE_RESPONSE_HEADER_NAME<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-203,6&nbsp;+224,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesAuthModuleUnsupportedMessageTypesjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleUnsupportedMessageTypes.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleUnsupportedMessageTypes.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/AuthModuleUnsupportedMessageTypes.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,7&nbsp;+11,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.modules;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-19,43&nbsp;+19,65&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
-&nbsp;*&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided&nbsp;based&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request<br>
-&nbsp;*&nbsp;headers.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
+&nbsp;*&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided&nbsp;based&nbsp;on&nbsp;the<br>
+&nbsp;*&nbsp;value&nbsp;of&nbsp;two&nbsp;request&nbsp;headers.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;AuthModuleUnsupportedMessageTypes&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;AuthModuleUnsupportedMessageTypes&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;{@code&nbsp;String}&nbsp;and&nbsp;{@code&nbsp;Integer}&nbsp;classes,&nbsp;to&nbsp;force&nbsp;an&nbsp;unsupported&nbsp;message&nbsp;types&nbsp;scenario.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;{@code&nbsp;HttpServletRequest}&nbsp;and&nbsp;{@code&nbsp;HttpServletResponse}&nbsp;classes.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{String.class,&nbsp;Integer.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(String.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-67,8&nbsp;+89,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-79,8&nbsp;+102,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-90,6&nbsp;+114,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesFailureAuditingAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/FailureAuditingAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-20,36&nbsp;+20,52&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Collections;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
-&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;attempts&nbsp;to&nbsp;audit&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;adds&nbsp;additional&nbsp;audit<br>
+&nbsp;*&nbsp;information&nbsp;and&nbsp;the&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;attempts&nbsp;to&nbsp;audit&nbsp;a&nbsp;session&nbsp;id.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;FailureAuditingAuthModule&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;FailureAuditingAuthModule&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-59,8&nbsp;+75,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-70,16&nbsp;+89,15&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_FAILURE_REASON_KEY,&nbsp;Collections.singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;FAILURE_REASON&amp;quot;));<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getRequestContextMap().put(AUDIT_FAILURE_REASON_KEY,&nbsp;Collections.singletonMap(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;FAILURE_REASON&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-89,11&nbsp;+107,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-103,6&nbsp;+121,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestmodulesSessionAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/modules/SessionAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-20,34&nbsp;+20,41&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.AuthException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.AuthStatus;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.message.MessagePolicy;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.servlet.http.HttpServletRequest;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Principal;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashSet;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework;<br>
+import&nbsp;org.forgerock.http.HttpContext;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;A&nbsp;test&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
-&nbsp;*&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided&nbsp;based&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request<br>
-&nbsp;*&nbsp;headers.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;A&nbsp;test&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module&nbsp;in&nbsp;which&nbsp;the<br>
+&nbsp;*&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
+&nbsp;*&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;methods&nbsp;return&nbsp;values&nbsp;can&nbsp;be&nbsp;decided&nbsp;based<br>
+&nbsp;*&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;two&nbsp;request&nbsp;headers.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;SessionAuthModule&nbsp;implements&nbsp;ServerAuthModule&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;class&nbsp;SessionAuthModule&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)}.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;SESSION_VALIDATE_REQUEST_HEADER_NAME&nbsp;=&nbsp;&amp;quot;X-JASPI-SESSION-VALIDATE-REQUEST&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)}.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;request&nbsp;header&nbsp;for&nbsp;deciding&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;{@link&nbsp;#secureResponse(MessageContextInfo,&nbsp;Subject)}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;SESSION_SECURE_RESPONSE_HEADER_NAME&nbsp;=&nbsp;&amp;quot;X-JASPI-SESSION-SECURE-RESPONSE&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-92,17&nbsp;+99,28&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;static&nbsp;String&nbsp;SESSION_MODULE_CONTEXT_ENTRY&nbsp;=&nbsp;&amp;quot;SESSION_CONTEXT_ENTRY&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;class's&nbsp;short&nbsp;name.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getClass().getSimpleName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Does&nbsp;nothing.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestMessagePolicy&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseMessagePolicy&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;{@inheritDoc}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;callbackHandler&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;initialize(MessagePolicy&nbsp;requestMessagePolicy,&nbsp;MessagePolicy&nbsp;responseMessagePolicy,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,&nbsp;MessagePolicy&nbsp;responsePolicy,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;callbackHandler,&nbsp;Map&nbsp;config)&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-112,8&nbsp;+130,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Class[]&nbsp;getSupportedMessageTypes()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class};<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;supportedMessageTypes;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-123,19&nbsp;+144,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;validateRequest(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;httpContext&nbsp;=&nbsp;messageInfo.asContext(HttpContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;httpContext.getAttributes().get(HttpServletRequest.class.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;header&nbsp;=&nbsp;request.getHeader(SESSION_VALIDATE_REQUEST_HEADER_NAME.toLowerCase());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getRequestContextMap().get(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.put(SESSION_MODULE_CONTEXT_ENTRY,&nbsp;true);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-146,7&nbsp;+167,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SESSION_MODULE_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-157,26&nbsp;+178,27&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SESSION_MODULE_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_CONTINUE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_CONTINUE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_CONTINUE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(NULL_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(SESSION_VALIDATE_REQUEST_HEADER_NAME&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(SESSION_VALIDATE_REQUEST_HEADER_NAME<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-185,41&nbsp;+207,43&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthStatus&nbsp;secureResponse(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;httpContext&nbsp;=&nbsp;messageInfo.asContext(HttpContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;httpContext.getAttributes().get(HttpServletRequest.class.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;header&nbsp;=&nbsp;request.getHeader(SESSION_SECURE_RESPONSE_HEADER_NAME.toLowerCase());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;SESSION_ID&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_SUCCESS;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getRequestContextMap().put(AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_CONTINUE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.SEND_CONTINUE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_CONTINUE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FAILURE_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthStatus.FAILURE;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.FAILURE);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(NULL_AUTH_STATUS.equalsIgnoreCase(header))&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(SESSION_SECURE_RESPONSE_HEADER_NAME&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(SESSION_SECURE_RESPONSE_HEADER_NAME<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-229,6&nbsp;+253,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubject(MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeGuiceModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/GuiceModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,32&nbsp;+16,30&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn.test.runtime;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFilter.AuthenticationModuleBuilder.configureModule;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFilter.AuthenticationModuleBuilder;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.resource.Requests.newReadRequest;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.resource.Resources.newInternalConnection;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.resource.Resources.newSingleton;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.inject.Inject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.inject.Named;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.inject.Singleton;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.ArrayList;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.List;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.AbstractModule;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.Injector;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.google.inject.Provides;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authentication.framework.AuditApi;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.ContextFactory;<br>
-import&nbsp;org.forgerock.caf.authentication.framework.ContextHandler;<br>
-import&nbsp;org.forgerock.caf.authentication.framework.FallbackServerAuthContext;<br>
-import&nbsp;org.forgerock.caf.authentication.framework.MessageInfoUtils;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFilter;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authn.test.configuration.ConfigurationResource;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.RootContext;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.Resource;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.ResourceException;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Guice&nbsp;module&nbsp;for&nbsp;wiring&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-56,42&nbsp;+54,28&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;configure()&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bind(MessageInfoUtils.class).in(Singleton.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bind(ContextFactory.class).to(TestContextFactory.class);<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bind(AuditApi.class).to(TestAuditApi.class);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Provider&nbsp;for&nbsp;the&nbsp;{@code&nbsp;ContextHandler}&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;MessageInfoUtils}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;{@code&nbsp;ContextHandler}&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Provides<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@Inject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Singleton<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ContextHandler&nbsp;getContextHandler(MessageInfoUtils&nbsp;messageInfoUtils)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;ContextHandler(messageInfoUtils);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;getLogger()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;LoggerFactory.getLogger(&amp;quot;AuthenticationFramework&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Provider&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime's&nbsp;{@code&nbsp;ServerAuthContext}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;MessageInfoUtils}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;ContextHandler}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;The&nbsp;configured&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;configured&nbsp;auth&nbsp;modules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;ServerAuthContext}&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;{@code&nbsp;ServerAuthModule}&nbsp;instance&nbsp;do&nbsp;not&nbsp;support&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;message&nbsp;type.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Provides<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;ServerAuthContext&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Inject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ServerAuthContext&nbsp;getServerAuthContext(MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;ContextHandler&nbsp;contextHandler,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;SessionAuthModule&amp;quot;)&nbsp;ServerAuthModule&nbsp;sessionAuthModule,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;AuthModules&amp;quot;)&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;FallbackServerAuthContext(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,&nbsp;authModules);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilter&nbsp;getAuthenticationFilter(Logger&nbsp;logger,&nbsp;AuditApi&nbsp;auditApi,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;SessionAuthModule&amp;quot;)&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;AuthModules&amp;quot;)&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AuthenticationModuleBuilder&amp;gt;&nbsp;authModuleBuilders&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;AuthenticationModuleBuilder&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AsyncServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleBuilders.add(configureModule(authModule));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;AuthenticationFilter.builder()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.logger(logger)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.sessionModule(configureModule(sessionAuthModule))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authModules(authModuleBuilders)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-106,14&nbsp;+90,14&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Provides<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;SessionAuthModule&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Inject<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ServerAuthModule&nbsp;getSessionAuthModule(ConfigurationResource&nbsp;configurationResource,&nbsp;Injector&nbsp;injector)<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AsyncServerAuthModule&nbsp;getSessionAuthModule(ConfigurationResource&nbsp;configurationResource,&nbsp;Injector&nbsp;injector)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;ResourceException,&nbsp;ClassNotFoundException&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Resource&nbsp;configuration&nbsp;=&nbsp;newInternalConnection(newSingleton(configurationResource))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.read(new&nbsp;RootContext(),&nbsp;newReadRequest(&amp;quot;configuration&amp;quot;));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;sessionModuleConfig&nbsp;=&nbsp;configuration.getContent().get(&amp;quot;serverAuthContext&amp;quot;).get(&amp;quot;sessionModule&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!sessionModuleConfig.isNull())&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ServerAuthModule)&nbsp;injector.getInstance(<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AsyncServerAuthModule)&nbsp;injector.getInstance(<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class.forName(sessionModuleConfig.get(&amp;quot;className&amp;quot;).asString()));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-132,16&nbsp;+116,16&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Provides<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Named(&amp;quot;AuthModules&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Inject<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;getAuthModules(ConfigurationResource&nbsp;configurationResource,&nbsp;Injector&nbsp;injector)<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;getAuthModules(ConfigurationResource&nbsp;configurationResource,&nbsp;Injector&nbsp;injector)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;ResourceException,&nbsp;ClassNotFoundException&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;AsyncServerAuthModule&amp;gt;();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Resource&nbsp;configuration&nbsp;=&nbsp;newInternalConnection(newSingleton(configurationResource))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.read(new&nbsp;RootContext(),&nbsp;newReadRequest(&amp;quot;configuration&amp;quot;));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;authModulesConfig&nbsp;=&nbsp;configuration.getContent().get(&amp;quot;serverAuthContext&amp;quot;).get(&amp;quot;authModules&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(JsonValue&nbsp;authModuleConfig&nbsp;:&nbsp;authModulesConfig)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add((ServerAuthModule)&nbsp;injector.getInstance(<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add((AsyncServerAuthModule)&nbsp;injector.getInstance(<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class.forName(authModuleConfig.get(&amp;quot;className&amp;quot;).asString())));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainjavaorgforgerockcafauthntestruntimeTestContextFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/java/org/forgerock/caf/authn/test/runtime/TestContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,56&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authn.test.runtime;<br>
-<br>
-import&nbsp;javax.inject.Singleton;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-<br>
-import&nbsp;com.google.inject.Key;<br>
-import&nbsp;com.google.inject.name.Names;<br>
-import&nbsp;org.forgerock.caf.authentication.framework.ContextFactory;<br>
-import&nbsp;org.forgerock.guice.core.InjectorHolder;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;Test&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Jaspi&nbsp;runtime's&nbsp;{@code&nbsp;ContextFactory}&nbsp;interface.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;Each&nbsp;time&nbsp;the&nbsp;{@link&nbsp;#getContext()}&nbsp;method&nbsp;is&nbsp;called&nbsp;it&nbsp;asks&nbsp;Guice&nbsp;for&nbsp;an&nbsp;instance,&nbsp;so&nbsp;that&nbsp;changes&nbsp;made&nbsp;to&nbsp;the<br>
-&nbsp;*&nbsp;auth&nbsp;module&nbsp;configuration&nbsp;are&nbsp;picked&nbsp;up&nbsp;for&nbsp;the&nbsp;next&nbsp;authentication&nbsp;request.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
-&nbsp;*/<br>
-@Singleton<br>
-public&nbsp;class&nbsp;TestContextFactory&nbsp;implements&nbsp;ContextFactory&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Factory&nbsp;method&nbsp;called&nbsp;by&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;to&nbsp;get&nbsp;the&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;ContextFactory}&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;get&nbsp;the&nbsp;{@link&nbsp;javax.security.auth.message.config.ServerAuthContext}&nbsp;instance&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;authenticate<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;requests.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;TestContextFactory}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;ContextFactory&nbsp;getContextFactory()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;InjectorHolder.getInstance(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ServerAuthContext&nbsp;getContext()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;InjectorHolder.getInstance(Key.get(ServerAuthContext.class,&nbsp;Names.named(&amp;quot;ServerAuthContext&amp;quot;)));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrcmainwebappWEBINFwebxml&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/main/webapp/WEB-INF/web.xml&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-17,24&nbsp;+17,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xsi:schemaLocation=&amp;quot;http://java.sun.com/xml/ns/javaee&nbsp;http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&amp;quot;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version=&amp;quot;3.0&amp;quot;&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-name&amp;gt;JaspiFilter&amp;lt;/filter-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-class&amp;gt;org.forgerock.caf.authentication.framework.JaspiRuntimeFilter&amp;lt;/filter-class&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;init-param&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;param-name&amp;gt;context-factory-class&amp;lt;/param-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;param-value&amp;gt;org.forgerock.caf.authn.test.runtime.TestContextFactory&amp;lt;/param-value&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/init-param&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;init-param&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;param-name&amp;gt;audit-api-factory-class&amp;lt;/param-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;param-value&amp;gt;org.forgerock.caf.authn.test.runtime.TestAuditApi&amp;lt;/param-value&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/init-param&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/filter&amp;gt;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-mapping&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;filter-name&amp;gt;JaspiFilter&amp;lt;/filter-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;url-pattern&amp;gt;/protected/*&amp;lt;/url-pattern&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/filter-mapping&amp;gt;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-name&amp;gt;Jaspi&nbsp;HTTP&amp;lt;/servlet-name&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-class&amp;gt;org.forgerock.http.servlet.HttpFrameworkServlet&amp;lt;/servlet-class&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-43,25&nbsp;+25,4&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-name&amp;gt;Jaspi&nbsp;HTTP&amp;lt;/servlet-name&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;url-pattern&amp;gt;/*&amp;lt;/url-pattern&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/servlet-mapping&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-name&amp;gt;ProtectedResource&amp;lt;/servlet-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-class&amp;gt;org.forgerock.caf.authn.test.ProtectedResource&amp;lt;/servlet-class&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/servlet&amp;gt;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-mapping&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-name&amp;gt;ProtectedResource&amp;lt;/servlet-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;url-pattern&amp;gt;/protected/resource&amp;lt;/url-pattern&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/servlet-mapping&amp;gt;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-name&amp;gt;ProtectedResponseCommittingResource&amp;lt;/servlet-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-class&amp;gt;org.forgerock.caf.authn.test.ProtectedResponseCommittingResource&amp;lt;/servlet-class&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/servlet&amp;gt;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-mapping&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;servlet-name&amp;gt;ProtectedResponseCommittingResource&amp;lt;/servlet-name&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;url-pattern&amp;gt;/protected/resource/committing&amp;lt;/url-pattern&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/servlet-mapping&amp;gt;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&amp;lt;/web-app&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnAuthModuleParametersjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/AuthModuleParameters.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/AuthModuleParameters.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/AuthModuleParameters.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,15&nbsp;+11,16&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Arrays;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.List;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Object&nbsp;containing&nbsp;auth&nbsp;module&nbsp;configuration&nbsp;parameters.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-27,12&nbsp;+28,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;final&nbsp;class&nbsp;AuthModuleParameters&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;moduleClass;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;moduleClass;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;String&nbsp;moduleName;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;String&nbsp;validateRequestReturnValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;String&nbsp;secureResponseReturnValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthModuleParameters(Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;moduleClass,&nbsp;String&nbsp;moduleName,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthModuleParameters(Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;moduleClass,&nbsp;String&nbsp;moduleName,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;validateRequestReturnValue,&nbsp;String&nbsp;secureResponseReturnValue)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.moduleClass&nbsp;=&nbsp;moduleClass;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.moduleName&nbsp;=&nbsp;moduleName;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-59,12&nbsp;+60,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;secureResponseReturnValue&nbsp;The&nbsp;requested&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;#secureResponse&nbsp;method.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;AuthModuleParameters}&nbsp;object.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AuthModuleParameters&nbsp;moduleParams(Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;moduleClass,&nbsp;String&nbsp;moduleName,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AuthModuleParameters&nbsp;moduleParams(Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;moduleClass,&nbsp;String&nbsp;moduleName,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;validateRequestReturnValue,&nbsp;String&nbsp;secureResponseReturnValue)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuthModuleParameters(moduleClass,&nbsp;moduleName,&nbsp;validateRequestReturnValue,&nbsp;secureResponseReturnValue);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;getModuleClass()&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;getModuleClass()&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;moduleClass;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnCommittedResponseITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/CommittedResponseIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/CommittedResponseIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/CommittedResponseIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,23&nbsp;+11,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
-import&nbsp;org.hamcrest.Matcher;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-import&nbsp;org.testng.annotations.BeforeClass;<br>
-import&nbsp;org.testng.annotations.DataProvider;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.Entry.entry;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-39,6&nbsp;+27,18&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne.AUTH_MODULE_ONE_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
+import&nbsp;org.hamcrest.Matcher;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+import&nbsp;org.testng.annotations.BeforeClass;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime&nbsp;when&nbsp;the&nbsp;protected&nbsp;resource&nbsp;causes&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;committed.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-84,7&nbsp;+84,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;SEND_SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;201,&nbsp;true,&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SEND_FAILURE<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-115,7&nbsp;+115,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;201,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-146,7&nbsp;+146,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;201,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-184,7&nbsp;+184,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;201,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SEND_FAILURE<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-217,7&nbsp;+217,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;201,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-248,7&nbsp;+248,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;null)),&nbsp;201,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-284,7&nbsp;+284,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;null,&nbsp;null)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;201,&nbsp;true,&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;single&nbsp;Auth&nbsp;Module&nbsp;-&nbsp;SEND_FAILURE:SEND_SUCCESS&nbsp;&amp;amp;&nbsp;SUCCESS:SEND_SUCCESS<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-317,12&nbsp;+317,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_SUCCESS_AUTH_STATUS)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),&nbsp;201,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;true,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))},<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;true,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))},<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(dataProvider&nbsp;=&nbsp;&amp;quot;sessionModuleOnlyData&amp;quot;)<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(enabled&nbsp;=&nbsp;false,&nbsp;dataProvider&nbsp;=&nbsp;&amp;quot;sessionModuleOnlyData&amp;quot;)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;sessionModuleOnlyWithResourceCommittingResponse(String&nbsp;dataName,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthModuleParameters&nbsp;sessionModuleParams,&nbsp;List&amp;lt;AuthModuleParameters&amp;gt;&nbsp;authModuleParametersList,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;expectedResponseStatus,&nbsp;boolean&nbsp;expectResourceToBeCalled,&nbsp;Map&amp;lt;String,&nbsp;Matcher&amp;lt;?&amp;gt;&amp;gt;&nbsp;expectedBody,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-332,7&nbsp;+332,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expectedResponseStatus,&nbsp;expectResourceToBeCalled,&nbsp;expectedBody,&nbsp;auditParams);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(dataProvider&nbsp;=&nbsp;&amp;quot;authModuleOnlyData&amp;quot;)<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(enabled&nbsp;=&nbsp;false,&nbsp;dataProvider&nbsp;=&nbsp;&amp;quot;authModuleOnlyData&amp;quot;)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;authModuleOnlyWithResourceCommittingResponse(String&nbsp;dataName,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthModuleParameters&nbsp;sessionModuleParams,&nbsp;List&amp;lt;AuthModuleParameters&amp;gt;&nbsp;authModuleParametersList,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;expectedResponseStatus,&nbsp;boolean&nbsp;expectResourceToBeCalled,&nbsp;Map&amp;lt;String,&nbsp;Matcher&amp;lt;?&amp;gt;&amp;gt;&nbsp;expectedBody,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-342,7&nbsp;+342,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expectedResponseStatus,&nbsp;expectResourceToBeCalled,&nbsp;expectedBody,&nbsp;auditParams);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(dataProvider&nbsp;=&nbsp;&amp;quot;sessionModuleAndAuthModuleData&amp;quot;)<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(enabled&nbsp;=&nbsp;false,&nbsp;dataProvider&nbsp;=&nbsp;&amp;quot;sessionModuleAndAuthModuleData&amp;quot;)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;sessionModuleAndAuthModuleWithResourceCommittingResponse(String&nbsp;dataName,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthModuleParameters&nbsp;sessionModuleParams,&nbsp;List&amp;lt;AuthModuleParameters&amp;gt;&nbsp;authModuleParametersList,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;expectedResponseStatus,&nbsp;boolean&nbsp;expectResourceToBeCalled,&nbsp;Map&amp;lt;String,&nbsp;Matcher&amp;lt;?&amp;gt;&amp;gt;&nbsp;expectedBody,<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnModuleAuditingITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/ModuleAuditingIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/ModuleAuditingIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/ModuleAuditingIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,11&nbsp;+11,22&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+import&nbsp;static&nbsp;org.assertj.core.data.MapEntry.entry;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleParams;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.*;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
+import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
+<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.jayway.restassured.specification.RequestSpecification;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.assertj.core.api.Assertions;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.assertj.core.data.MapEntry;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-23,29&nbsp;+34,12&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authn.test.modules.AuditingSessionAuthModule;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authn.test.modules.FailureAuditingAuthModule;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.hamcrest.Matcher;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.slf4j.Logger;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.slf4j.LoggerFactory;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.BeforeClass;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.DataProvider;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.Test;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.util.Collections;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
-import&nbsp;static&nbsp;org.assertj.core.data.MapEntry.entry;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleParams;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.*;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.SEND_FAILURE_AUTH_STATUS;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.SEND_SUCCESS_AUTH_STATUS;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.SUCCESS_AUTH_STATUS;<br>
-import&nbsp;static&nbsp;org.hamcrest.Matchers.equalTo;<br>
-import&nbsp;static&nbsp;org.hamcrest.Matchers.nullValue;<br>
-import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;auditing&nbsp;in&nbsp;the&nbsp;JASPI&nbsp;runtime.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-84,8&nbsp;+78,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuditingSessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;200,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;true,&nbsp;&amp;quot;Session-AuditingSessionAuthModule&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.singletonMap(&amp;quot;AUDITING_SESSION_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;),&nbsp;new&nbsp;MapEntry[0]<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;200,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;true,&nbsp;&amp;quot;AuditingSessionAuthModule&amp;quot;,&nbsp;new&nbsp;MapEntry[]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AUDITING_SESSION_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;)},&nbsp;new&nbsp;MapEntry[0]<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Auditing&nbsp;Auth&nbsp;Module<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-107,8&nbsp;+101,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Single&nbsp;Auth&nbsp;Module&nbsp;Only&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(moduleParams(AuditingAuthModule.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUCCESS_AUTH_STATUS,&nbsp;SEND_SUCCESS_AUTH_STATUS)),&nbsp;200,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;AuthModule-AuditingAuthModule-0&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.singletonMap(&amp;quot;AUDITING_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;),&nbsp;new&nbsp;MapEntry[0]<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;AuditingAuthModule&amp;quot;,&nbsp;new&nbsp;MapEntry[]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AUDITING_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;MORE_AUDITING_AUTH_MODULE_AUDIT_INFO&amp;quot;,&nbsp;&amp;quot;AUDIT_INFO&amp;quot;)},&nbsp;new&nbsp;MapEntry[0],<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Failing&nbsp;Auditing&nbsp;Session&nbsp;Auth&nbsp;Module<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-127,7&nbsp;+122,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Failing&nbsp;Session&nbsp;Module&nbsp;Only&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(FailureAuditingAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null),&nbsp;moduleArray(),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;401,&nbsp;&amp;quot;FAILED&amp;quot;,&nbsp;false,&nbsp;&amp;quot;Session-FailureAuditingAuthModule&amp;quot;,&nbsp;Collections.emptyMap(),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;401,&nbsp;&amp;quot;FAILED&amp;quot;,&nbsp;false,&nbsp;&amp;quot;FailureAuditingAuthModule&amp;quot;,&nbsp;new&nbsp;MapEntry[0],<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;MapEntry[]{entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;FAILURE_REASON&amp;quot;)}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-147,8&nbsp;+142,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Single&nbsp;Failing&nbsp;Auth&nbsp;Module&nbsp;Only&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(moduleParams(FailureAuditingAuthModule.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null)),&nbsp;401,&nbsp;&amp;quot;FAILED&amp;quot;,&nbsp;false,&nbsp;&amp;quot;AuthModule-FailureAuditingAuthModule-0&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.emptyMap(),&nbsp;new&nbsp;MapEntry[]{entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;FAILURE_REASON&amp;quot;)}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null)),&nbsp;401,&nbsp;&amp;quot;FAILED&amp;quot;,&nbsp;false,&nbsp;&amp;quot;FailureAuditingAuthModule&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;MapEntry[0],&nbsp;new&nbsp;MapEntry[]{entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;FAILURE_REASON&amp;quot;)}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-156,7&nbsp;+151,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(dataProvider&nbsp;=&nbsp;&amp;quot;auditing&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditing(String&nbsp;dataName,&nbsp;AuthModuleParameters&nbsp;sessionModuleParams,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AuthModuleParameters&amp;gt;&nbsp;authModuleParametersList,&nbsp;int&nbsp;expectedResponseStatus,&nbsp;String&nbsp;auditResult,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;sessionPresent,&nbsp;String&nbsp;moduleId,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;sessionPresent,&nbsp;String&nbsp;moduleId,&nbsp;MapEntry[]&nbsp;moduleAuditInfo,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry[]&nbsp;auditReasonMatchers)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.info(&amp;quot;Running&nbsp;ModuleAuditing&nbsp;test&nbsp;with&nbsp;data&nbsp;set:&nbsp;&amp;quot;&nbsp;+&nbsp;dataName);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-184,8&nbsp;+179,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;entries&nbsp;=&nbsp;auditRecords.get(0).get(&amp;quot;entries&amp;quot;).get(0).asMap();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(entries)<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.contains(Assertions.entry(&amp;quot;moduleId&amp;quot;,&nbsp;moduleId),&nbsp;Assertions.entry(&amp;quot;result&amp;quot;,&nbsp;auditResult),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.entry(&amp;quot;info&amp;quot;,&nbsp;moduleAuditInfo));<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.contains(Assertions.entry(&amp;quot;moduleId&amp;quot;,&nbsp;moduleId),&nbsp;Assertions.entry(&amp;quot;result&amp;quot;,&nbsp;auditResult));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(((Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entries.get(&amp;quot;info&amp;quot;))).contains(moduleAuditInfo);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;reason&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entries.get(&amp;quot;reason&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(reason&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(reason).containsOnly(auditReasonMatchers);<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSendContinueSupportITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SendContinueSupportIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SendContinueSupportIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SendContinueSupportIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,25&nbsp;+11,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
-import&nbsp;org.hamcrest.Matcher;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-import&nbsp;org.testng.annotations.BeforeClass;<br>
-import&nbsp;org.testng.annotations.DataProvider;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.util.Arrays;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.Entry.entry;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-41,6&nbsp;+27,20&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo.AUTH_MODULE_TWO_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
+import&nbsp;org.hamcrest.Matcher;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+import&nbsp;org.testng.annotations.BeforeClass;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime&nbsp;to&nbsp;test&nbsp;that&nbsp;SEND_CONTINUE&nbsp;(multi-stage&nbsp;module)&nbsp;support&nbsp;works.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-93,7&nbsp;+93,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request(moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SEND_SUCCESS_AUTH_STATUS,&nbsp;null),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SEND_CONTINUE-&amp;gt;SEND_SUCCESS:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-131,7&nbsp;+131,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SEND_SUCCESS_AUTH_STATUS,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_CONTINUE-&amp;gt;SEND_SUCCESS:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-178,7&nbsp;+178,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;null,&nbsp;null)),&nbsp;200,&nbsp;false,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-226,8&nbsp;+226,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;null,&nbsp;null)),&nbsp;200,&nbsp;false,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-276,8&nbsp;+276,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;SEND_SUCCESS_AUTH_STATUS,&nbsp;null)),&nbsp;200,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_TWO_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleTwo-1&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleTwo&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSessionAndAuthModulesITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionAndAuthModulesIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionAndAuthModulesIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionAndAuthModulesIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,30&nbsp;+11,16&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
-import&nbsp;org.hamcrest.Matcher;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-import&nbsp;org.testng.annotations.BeforeClass;<br>
-import&nbsp;org.testng.annotations.DataProvider;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.Entry.entry;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleParams;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authn.BodyMatcher.exceptionMatcher;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.BodyMatcher.noData;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.BodyMatcher.resourceMatcher;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authn.BodyMatcher.*;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.runTest;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.setUpConnection;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne.AUTH_MODULE_ONE_CONTEXT_ENTRY;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-42,8&nbsp;+28,20&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo.AUTH_MODULE_TWO_CONTEXT_ENTRY;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo.AUTH_MODULE_TWO_PRINCIPAL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.Entry.entry;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleTwo;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
+import&nbsp;org.hamcrest.Matcher;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+import&nbsp;org.testng.annotations.BeforeClass;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime&nbsp;when&nbsp;configured&nbsp;with&nbsp;a&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module&nbsp;and&nbsp;two&nbsp;auth&nbsp;modules.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-94,7&nbsp;+92,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;null,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SUCCESS:SEND_SUCCESS&nbsp;&amp;amp;&nbsp;AuthException:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-129,7&nbsp;+127,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;null,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_CONTINUE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-193,7&nbsp;+191,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;null,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;&nbsp;SEND_CONTINUE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-259,8&nbsp;+257,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;null,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;true,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;true,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-296,8&nbsp;+294,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;SEND_SUCCESS_AUTH_STATUS,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_TWO_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleTwo-1&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleTwo&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-361,8&nbsp;+359,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleTwo.class,&nbsp;&amp;quot;AUTH-MODULE-TWO&amp;quot;,&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;401,&nbsp;false,&nbsp;exceptionMatcher(401),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModule-AuthModuleTwo-1&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModuleTwo&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-400,8&nbsp;+398,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_TWO_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUTH_MODULE_TWO_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_TWO_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleTwo-1&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleTwo&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:SEND_FAILURE&nbsp;&amp;amp;&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-440,8&nbsp;+438,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_TWO_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUTH_MODULE_TWO_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_TWO_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleTwo-1&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleTwo&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;and&nbsp;Two&nbsp;Auth&nbsp;Modules&nbsp;-&nbsp;SEND_FAILURE:SEND_SUCCESS&nbsp;&amp;amp;&nbsp;SEND_FAILURE:AuthException&nbsp;&amp;amp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-479,9&nbsp;+477,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_SUCCESS_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_TWO_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUTH_MODULE_TWO_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_TWO_PRINCIPAL,&nbsp;true,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleTwo-1&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_TWO_PRINCIPAL,&nbsp;true,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleTwo&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSessionModuleOnlyITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionModuleOnlyIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionModuleOnlyIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SessionModuleOnlyIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,23&nbsp;+11,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.assertj.core.data.MapEntry;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
-import&nbsp;org.hamcrest.Matcher;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-import&nbsp;org.testng.annotations.BeforeClass;<br>
-import&nbsp;org.testng.annotations.DataProvider;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.Entry.entry;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-37,8&nbsp;+25,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.setUpConnection;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.hamcrest.Matchers.containsString;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.hamcrest.Matchers.equalTo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.assertj.core.data.MapEntry;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule;<br>
+import&nbsp;org.hamcrest.Matcher;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+import&nbsp;org.testng.annotations.BeforeClass;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime&nbsp;when&nbsp;configured&nbsp;with&nbsp;just&nbsp;a&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-100,7&nbsp;+99,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SEND_SUCCESS_AUTH_STATUS,&nbsp;null),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SEND_FAILURE:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-125,7&nbsp;+124,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SEND_FAILURE:AuthException&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;401,&nbsp;false,&nbsp;exceptionMatcher(401),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SEND_CONTINUE:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-172,7&nbsp;+171,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;AuthException:SEND_SUCCESS&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;null,&nbsp;SEND_SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;false,&nbsp;exceptionMatcher(500),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry.entry(&amp;quot;exception&amp;quot;,&nbsp;SESSION_VALIDATE_REQUEST_HEADER_NAME<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;)))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-202,7&nbsp;+201,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;SEND_SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SEND_FAILURE<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-231,7&nbsp;+230,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-246,7&nbsp;+245,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Session&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-258,9&nbsp;+257,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:AuthException&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;null),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;X-JASPI-SESSION-SECURE-RESPONSE&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-293,7&nbsp;+292,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;FAILURE_AUTH_STATUS,&nbsp;SEND_SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;false,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;FAILURE&amp;quot;)),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry.entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;FAILURE&amp;quot;)))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-321,7&nbsp;+320,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;NULL_AUTH_STATUS,&nbsp;SEND_SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;false,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;null&amp;quot;)),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry.entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;null&amp;quot;)))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-350,7&nbsp;+349,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;SEND_CONTINUE_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SUCCESS<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-365,7&nbsp;+364,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Session&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-377,9&nbsp;+376,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SUCCESS&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;SUCCESS_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;SUCCESS&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:FAILURE<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-393,7&nbsp;+392,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Session&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-405,9&nbsp;+404,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:FAILURE&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;FAILURE_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;FAILURE&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:null<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-422,7&nbsp;+421,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Session&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-434,9&nbsp;+433,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Session&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:null&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(SessionAuthModule.class,&nbsp;&amp;quot;SESSION&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;NULL_AUTH_STATUS),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleArray(),&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(SESSION_MODULE_PRINCIPAL,&nbsp;SESSION_MODULE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;null&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;SESSION_MODULE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;Session-SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;SessionAuthModule&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnSingleAuthModuleOnlyITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SingleAuthModuleOnlyIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SingleAuthModuleOnlyIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/SingleAuthModuleOnlyIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,23&nbsp;+11,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.assertj.core.data.MapEntry;<br>
-import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
-import&nbsp;org.hamcrest.Matcher;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-import&nbsp;org.testng.annotations.BeforeClass;<br>
-import&nbsp;org.testng.annotations.DataProvider;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.Entry.entry;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-38,8&nbsp;+26,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne.*;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authn.test.modules.SessionAuthModule.*;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.hamcrest.Matchers.containsString;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.hamcrest.Matchers.equalTo;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.assertj.core.data.MapEntry;<br>
+import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleOne;<br>
+import&nbsp;org.hamcrest.Matcher;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+import&nbsp;org.testng.annotations.BeforeClass;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime&nbsp;when&nbsp;configured&nbsp;with&nbsp;just&nbsp;a&nbsp;single&nbsp;auth&nbsp;module.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-83,7&nbsp;+82,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SEND_SUCCESS_AUTH_STATUS,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;false,&nbsp;noData(),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SEND_FAILURE:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-109,7&nbsp;+108,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SEND_FAILURE_AUTH_STATUS,&nbsp;null)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;401,&nbsp;false,&nbsp;exceptionMatcher(401),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SEND_CONTINUE:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-159,7&nbsp;+158,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;null,&nbsp;SEND_SUCCESS_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;false,&nbsp;exceptionMatcher(500),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry.entry(&amp;quot;exception&amp;quot;,&nbsp;AUTH_MODULE_ONE_VALIDATE_REQUEST_HEADER_NAME<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;)))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-191,7&nbsp;+190,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_SUCCESS_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SEND_FAILURE<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-222,7&nbsp;+221,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:AuthException<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-237,7&nbsp;+236,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Auth&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-249,9&nbsp;+248,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&amp;quot;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:AuthException&amp;quot;,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;null)),&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;X-JASPI-AUTH-MODULE-ONE-SECURE-RESPONSE&nbsp;header&nbsp;not&nbsp;set,&nbsp;so&nbsp;throwing&nbsp;AuthException.&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-285,7&nbsp;+284,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;FAILURE_AUTH_STATUS,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_SUCCESS_AUTH_STATUS)),&nbsp;500,&nbsp;false,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;FAILURE&amp;quot;)),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry.entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;FAILURE&amp;quot;)))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-314,7&nbsp;+313,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;NULL_AUTH_STATUS,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_SUCCESS_AUTH_STATUS)),&nbsp;500,&nbsp;false,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;null&amp;quot;)),<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;FAILED&amp;quot;,&nbsp;&amp;quot;&amp;quot;,&nbsp;false,&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;FAILED&amp;quot;,<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MapEntry.entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;null&amp;quot;)))<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-346,7&nbsp;+345,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEND_CONTINUE_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200,&nbsp;true,&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:SUCCESS<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-361,7&nbsp;+360,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Auth&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-374,9&nbsp;+373,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;SUCCESS_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;SUCCESS&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:FAILURE<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-390,7&nbsp;+389,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Auth&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-403,9&nbsp;+402,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;FAILURE_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;FAILURE&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Single&nbsp;Auth&nbsp;Module&nbsp;Only&nbsp;-&nbsp;SUCCESS:null<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-420,7&nbsp;+419,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Expected&nbsp;Result:<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;500&nbsp;status<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;resource<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;HTTP&nbsp;response&nbsp;detailing&nbsp;the&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;Auth&nbsp;Module&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;overall&nbsp;result&nbsp;as&nbsp;success<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;*&nbsp;Audit&nbsp;record&nbsp;contains&nbsp;principal<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-433,9&nbsp;+432,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;moduleArray(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleParams(AuthModuleOne.class,&nbsp;&amp;quot;AUTH-MODULE-ONE&amp;quot;,&nbsp;SUCCESS_AUTH_STATUS,&nbsp;NULL_AUTH_STATUS)),<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;500,&nbsp;true,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resourceMatcher(AUTH_MODULE_ONE_PRINCIPAL,&nbsp;AUTH_MODULE_ONE_CONTEXT_ENTRY),<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptionMatcher(500,&nbsp;containsString(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;null&amp;quot;)),<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditParams(&amp;quot;SUCCESSFUL&amp;quot;,&nbsp;AUTH_MODULE_ONE_PRINCIPAL,&nbsp;false,<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModule-AuthModuleOne-0&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;AuthModuleOne&amp;quot;,&nbsp;&amp;quot;SUCCESSFUL&amp;quot;))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnTestFrameworkjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/TestFramework.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/TestFramework.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/TestFramework.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-24,7&nbsp;+24,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.hamcrest.Matchers.nullValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.io.IOException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.ArrayList;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.List;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-38,6&nbsp;+37,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.jayway.restassured.parsing.Parser;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.jayway.restassured.specification.RequestSpecification;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;com.jayway.restassured.specification.ResponseSpecification;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.hamcrest.Matcher;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-57,7&nbsp;+57,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.port&nbsp;=&nbsp;Integer.parseInt(System.getProperty(&amp;quot;HTTP_PORT&amp;quot;));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.baseURI&nbsp;=&nbsp;&amp;quot;http://&amp;quot;&nbsp;+&nbsp;System.getProperty(&amp;quot;HOSTNAME&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.basePath&nbsp;=&nbsp;System.getProperty(&amp;quot;CONTEXT_URI&amp;quot;);<br>
&lt;/span&gt;&lt;del&gt;-//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.port&nbsp;=&nbsp;8080;<br>
&lt;/del&gt;&lt;ins&gt;+//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.port&nbsp;=&nbsp;8081;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.baseURI&nbsp;=&nbsp;&amp;quot;http://localhost&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RestAssured.basePath&nbsp;=&nbsp;&amp;quot;jaspi&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-74,8&nbsp;+74,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionModule&nbsp;The&nbsp;&amp;quot;Session&amp;quot;&nbsp;auth&nbsp;module&nbsp;class.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;An&nbsp;array&nbsp;of&nbsp;auth&nbsp;module&nbsp;classes.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;configureRuntime(Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;sessionModule,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&amp;gt;&nbsp;authModules)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;configureRuntime(Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;sessionModule,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&amp;gt;&nbsp;authModules)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;config&nbsp;=&nbsp;json(object());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonValue&nbsp;configuration&nbsp;=&nbsp;json(object(field(&amp;quot;serverAuthContext&amp;quot;,&nbsp;config)));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-86,7&nbsp;+86,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.put(&amp;quot;authModules&amp;quot;,&nbsp;array());<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.get(&amp;quot;authModules&amp;quot;).add(object(field(&amp;quot;className&amp;quot;,&nbsp;authModule.getName())));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-137,8&nbsp;+137,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;RequestSpecification&nbsp;given(AuthModuleParameters&nbsp;sessionModuleParams,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AuthModuleParameters&amp;gt;&nbsp;authModuleParametersList)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;sessionModuleClass&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&amp;gt;&nbsp;authModuleClasses&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&amp;gt;();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&nbsp;sessionModuleClass&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&amp;gt;&nbsp;authModuleClasses&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthModule&amp;gt;&amp;gt;();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RequestSpecification&nbsp;given&nbsp;=&nbsp;com.jayway.restassured.RestAssured.given();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionModuleParams&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspifunctionaltestssrctestjavaorgforgerockcafauthnUnsupportedMessageTypesITjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/UnsupportedMessageTypesIT.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/UnsupportedMessageTypesIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-functional-tests/src/test/java/org/forgerock/caf/authn/UnsupportedMessageTypesIT.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-11,11&nbsp;+11,21&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;Copyright&nbsp;2014&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authn;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleParams;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.BodyMatcher.exceptionMatcher;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.runTest;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.setUpConnection;<br>
+<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.authn.test.modules.AuthModuleUnsupportedMessageTypes;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.hamcrest.Matcher;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.slf4j.Logger;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-24,16&nbsp;+34,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.DataProvider;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.Test;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.AuditParameters.auditParams;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleArray;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.AuthModuleParameters.moduleParams;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.BodyMatcher.exceptionMatcher;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.runTest;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authn.TestFramework.setUpConnection;<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;Functional&nbsp;tests&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime&nbsp;when&nbsp;the&nbsp;configured&nbsp;auth&nbsp;modules&nbsp;do&nbsp;not&nbsp;support&nbsp;the&nbsp;required&nbsp;message&nbsp;types.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-109,7&nbsp;+109,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(dataProvider&nbsp;=&nbsp;&amp;quot;unsupportedMessageTypesData&amp;quot;)<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(enabled&nbsp;=&nbsp;false,&nbsp;dataProvider&nbsp;=&nbsp;&amp;quot;unsupportedMessageTypesData&amp;quot;)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;unsupportedMessageTypes(String&nbsp;dataName,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthModuleParameters&nbsp;sessionModuleParams,&nbsp;List&amp;lt;AuthModuleParameters&amp;gt;&nbsp;authModuleParametersList,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;expectedResponseStatus,&nbsp;boolean&nbsp;expectResourceToBeCalled,&nbsp;Map&amp;lt;String,&nbsp;Matcher&amp;lt;?&amp;gt;&amp;gt;&nbsp;expectedBody,<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwaIWAModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/IWAModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.iwa;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiiwamodulesrcmainjavaorgforgerockjaspimodulesiwawdssoWDSSOjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-iwa-module/src/main/java/org/forgerock/jaspi/modules/iwa/wdsso/WDSSO.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-32,7&nbsp;+32,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.iwa.wdsso;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.login.Configuration;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrcmainjavaorgforgerockjaspimodulessessionjwtJwtSessionModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/main/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-17,7&nbsp;+17,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.jwt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_SESSION_ID_KEY;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.caf.http.Cookie.*;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-45,7&nbsp;+45,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Set;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.UUID;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.caf.http.Cookie;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.builders.JwtBuilderFactory;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.exceptions.JweDecryptionException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-228,7&nbsp;+228,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;also&nbsp;include&nbsp;ATTRIBUTE_AUTHCID!<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=&nbsp;getContextMap(messageInfo);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;claimsSetContext&nbsp;=&nbsp;jwt.getClaimsSet().getClaim(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;claimsSetContext&nbsp;=&nbsp;jwt.getClaimsSet().getClaim(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(claimsSetContext&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.putAll(claimsSetContext);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-287,7&nbsp;+287,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(jwt&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if&nbsp;all&nbsp;goes&nbsp;well!<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;claimsSetContext&nbsp;=&nbsp;jwt.getClaimsSet().getClaim(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;claimsSetContext&nbsp;=&nbsp;jwt.getClaimsSet().getClaim(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(claimsSetContext&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(String&nbsp;key&nbsp;:&nbsp;claimsSetContext.keySet())&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-321,11&nbsp;+321,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;context&nbsp;map&nbsp;internal&nbsp;to&nbsp;the&nbsp;messageInfo's&nbsp;map.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getContextMap(MessageInfo&nbsp;messageInfo)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;internalMap&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;internalMap&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().get(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(internalMap&nbsp;==&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;internalMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;internalMap);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;internalMap);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;internalMap;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-440,14&nbsp;+440,14&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfo.getMap();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object&nbsp;principal&nbsp;=&nbsp;request.getAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object&nbsp;principal&nbsp;=&nbsp;request.getAttribute(AuthenticationFramework.ATTRIBUTE_AUTH_PRINCIPAL);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jwtParameters.put(&amp;quot;prn&amp;quot;,&nbsp;principal);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map.containsKey(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jwtParameters.put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;getContextMap(messageInfo));<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map.containsKey(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jwtParameters.put(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;getContextMap(messageInfo));<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map.containsKey(SKIP_SESSION_PARAMETER_NAME)&nbsp;&amp;amp;&amp;amp;&nbsp;((Boolean)&nbsp;map.get(SKIP_SESSION_PARAMETER_NAME)))&nbsp;{<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspijwtsessionmodulesrctestjavaorgforgerockjaspimodulessessionjwtJwtSessionModuleTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-jwt-session-module/src/test/java/org/forgerock/jaspi/modules/session/jwt/JwtSessionModuleTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-44,7&nbsp;+44,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.HashMap;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.builders.EncryptedJwtBuilder;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.builders.JweHeaderBuilder;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.jose.builders.JwtBuilderFactory;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-439,7&nbsp;+439,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getResponseMessage()).willReturn(response);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(map);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.put(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(request.getCookies()).willReturn(cookies);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(cookie1.getName()).willReturn(&amp;quot;COOKIE1&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-455,7&nbsp;+455,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.getClaim(&amp;quot;prn&amp;quot;,&nbsp;String.class)).willReturn(&amp;quot;PRINCIPAL&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;newContext&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newContext.put(&amp;quot;KEY&amp;quot;,&nbsp;&amp;quot;VALUE&amp;quot;);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.getClaim(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class)).willReturn(newContext);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.getClaim(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class)).willReturn(newContext);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.get(&amp;quot;sessionId&amp;quot;)).willReturn(json(&amp;quot;SESSION_ID&amp;quot;));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-519,7&nbsp;+519,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getResponseMessage()).willReturn(response);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(map);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.put(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(request.getCookies()).willReturn(cookies);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(cookie1.getName()).willReturn(&amp;quot;COOKIE1&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-535,7&nbsp;+535,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.getClaim(&amp;quot;prn&amp;quot;,&nbsp;String.class)).willReturn(&amp;quot;PRINCIPAL&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;newContext&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newContext.put(&amp;quot;KEY&amp;quot;,&nbsp;&amp;quot;VALUE&amp;quot;);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.getClaim(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class)).willReturn(newContext);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.getClaim(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;Map.class)).willReturn(newContext);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(claimsSet.get(&amp;quot;sessionId&amp;quot;)).willReturn(json(&amp;quot;SESSION_ID&amp;quot;));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamOpenAMSessionModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/OpenAMSessionModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.openam;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.Callback;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenamsessionmodulesrcmainjavaorgforgerockjaspimodulessessionopenamRestletRestClientjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openam-session-module/src/main/java/org/forgerock/jaspi/modules/session/openam/RestletRestClient.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.session.openam;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidOpenIdConnectModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/OpenIdConnectModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.Subject;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;javax.security.auth.callback.Callback;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversJWKOpenIdResolverImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/JWKOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.URL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.Key;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversPublicKeyOpenIdResolverImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/PublicKeyOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.PublicKey;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversSharedSecretOpenIdResolverImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/SharedSecretOpenIdResolverImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.nio.charset.Charset;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversWellKnownOpenIdConfigurationFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/WellKnownOpenIdConfigurationFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.io.IOException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.MalformedURLException;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceConfiguratorImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceConfiguratorImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.MalformedURLException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.URL;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspimodulesforgerockjaspiopenidconnectmodulesrcmainjavaorgforgerockjaspimodulesopenidresolversserviceOpenIdResolverServiceImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-modules/forgerock-jaspi-openid-connect-module/src/main/java/org/forgerock/jaspi/modules/openid/resolvers/service/OpenIdResolverServiceImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,7&nbsp;+16,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.jaspi.modules.openid.resolvers.service;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.LOG;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.net.URL;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.security.PublicKey;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimepomxml&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/pom.xml&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/pom.xml&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/pom.xml&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-34,51&nbsp;+34,37&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.apache.felix&amp;lt;/groupId&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;maven-bundle-plugin&amp;lt;/artifactId&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;extensions&amp;gt;true&amp;lt;/extensions&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;configuration&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;instructions&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;DynamicImport-Package&amp;gt;*&amp;lt;/DynamicImport-Package&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/instructions&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/configuration&amp;gt;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/plugin&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/plugins&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/build&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependencies&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;com.fasterxml.jackson.core&amp;lt;/groupId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;jackson-databind&amp;lt;/artifactId&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.slf4j&amp;lt;/groupId&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;slf4j-api&amp;lt;/artifactId&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.forgerock.commons&amp;lt;/groupId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;forgerock-auth-filter-common&amp;lt;/artifactId&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.glassfish&amp;lt;/groupId&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;javax.security.auth.message&amp;lt;/artifactId&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.forgerock.http&amp;lt;/groupId&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;chf-http-core&amp;lt;/artifactId&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;!--&nbsp;TODO&nbsp;remove&nbsp;--&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;&nbsp;&amp;lt;!--&nbsp;Required&nbsp;for&nbsp;deprecated&nbsp;Logging&nbsp;framework&nbsp;in&nbsp;JaspiRuntime#LOG&nbsp;--&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.forgerock.commons&amp;lt;/groupId&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;json-resource&amp;lt;/artifactId&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;forgerock-auth-filter-common&amp;lt;/artifactId&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;javax.servlet&amp;lt;/groupId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;servlet-api&amp;lt;/artifactId&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;&nbsp;&amp;lt;!--&nbsp;Required&nbsp;for&nbsp;JsonValue&nbsp;and&nbsp;ResourceException&nbsp;--&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.forgerock.commons&amp;lt;/groupId&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;json-resource&amp;lt;/artifactId&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.glassfish&amp;lt;/groupId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;javax.security.auth.message&amp;lt;/artifactId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.slf4j&amp;lt;/groupId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;slf4j-api&amp;lt;/artifactId&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dependency&amp;gt;&nbsp;&amp;lt;!--&nbsp;Required&nbsp;for&nbsp;MediaType&nbsp;in&nbsp;FailureResponseHandler&nbsp;--&amp;gt;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;groupId&amp;gt;org.forgerock.commons.guava&amp;lt;/groupId&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;artifactId&amp;gt;forgerock-guava-net&amp;lt;/artifactId&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/dependency&amp;gt;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAsyncServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthContext.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-111,4&nbsp;+111,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;javax.security.auth.message.MessageInfo,&nbsp;Subject)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject);<br>
&lt;/span&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;short&nbsp;but&nbsp;useful&nbsp;description&nbsp;of&nbsp;this&nbsp;authentication&nbsp;context.&nbsp;Description&nbsp;should&nbsp;include<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;at&nbsp;least&nbsp;the&nbsp;IDs&nbsp;of&nbsp;the&nbsp;module&nbsp;this&nbsp;context&nbsp;manages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;toString();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAsyncServerAuthModulejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthModule.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AsyncServerAuthModule.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-52,7&nbsp;+52,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;getModuleId();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&amp;gt;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Initialize&nbsp;this&nbsp;module&nbsp;with&nbsp;request&nbsp;and&nbsp;response&nbsp;message&nbsp;policies&nbsp;to&nbsp;enforce,&nbsp;a<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Initialize&nbsp;this&nbsp;module&nbsp;with&nbsp;request&nbsp;and&nbsp;response&nbsp;message&nbsp;policies&nbsp;to&nbsp;enforce,&nbsp;a<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;CallbackHandler},&nbsp;and&nbsp;any&nbsp;module&nbsp;specific&nbsp;configuration&nbsp;properties.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;request&nbsp;policy&nbsp;and&nbsp;the&nbsp;response&nbsp;policy&nbsp;must&nbsp;not&nbsp;both&nbsp;be&nbsp;null.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-146,4&nbsp;+146,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;javax.security.auth.message.MessageInfo,&nbsp;Subject)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject);<br>
&lt;/span&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;short&nbsp;but&nbsp;useful&nbsp;description&nbsp;of&nbsp;this&nbsp;authentication&nbsp;context.&nbsp;Description&nbsp;should&nbsp;include<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;at&nbsp;least&nbsp;the&nbsp;ID&nbsp;of&nbsp;this&nbsp;module&nbsp;and&nbsp;optionally&nbsp;configuration&nbsp;details.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;toString();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthContextWithStatejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthContextWithState.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthContextWithState.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthContextWithState.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,42&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.api;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext}&nbsp;implementations&nbsp;should<br>
+&nbsp;*&nbsp;implement&nbsp;this&nbsp;interface&nbsp;when&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;has&nbsp;its&nbsp;own&nbsp;implementation&nbsp;of<br>
+&nbsp;*&nbsp;a&nbsp;{@link&nbsp;AuthenticationState}&nbsp;that&nbsp;it&nbsp;will&nbsp;be&nbsp;using&nbsp;to&nbsp;store&nbsp;and&nbsp;maintain&nbsp;state&nbsp;for&nbsp;a&nbsp;single<br>
+&nbsp;*&nbsp;request.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;{@link&nbsp;MessageContext}&nbsp;will&nbsp;use&nbsp;the&nbsp;{@link&nbsp;#createAuthenticationState()}&nbsp;method&nbsp;on&nbsp;this<br>
+&nbsp;*&nbsp;interface&nbsp;to&nbsp;create&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuthenticationState}&nbsp;for&nbsp;each&nbsp;request&nbsp;message.<br>
+&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+public&nbsp;interface&nbsp;AuthContextWithState&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Creates&nbsp;an&nbsp;instance&nbsp;of&nbsp;a&nbsp;specific&nbsp;type&nbsp;of&nbsp;{@code&nbsp;AuthenticationState}.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;Must&amp;lt;/strong&amp;gt;&nbsp;return&nbsp;a&nbsp;new&nbsp;{@code&nbsp;AuthenticationState}&nbsp;instance&nbsp;for&nbsp;each<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;invocation.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;new&nbsp;{@code&nbsp;AuthenticationState}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;createAuthenticationState();<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthenticationExceptionjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationException.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationException.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationException.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-21,7&nbsp;+21,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;generic&nbsp;authentication&nbsp;exception&nbsp;which&nbsp;accepts&nbsp;a&nbsp;detail&nbsp;message&nbsp;and/or&nbsp;the&nbsp;cause.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;class&nbsp;AuthenticationException&nbsp;extends&nbsp;AuthException&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthenticationStatejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationState.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationState.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationState.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,121&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.api;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.json;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.object;<br>
+<br>
+import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
+import&nbsp;org.forgerock.json.fluent.JsonValueException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Maintains&nbsp;state&nbsp;information&nbsp;and&nbsp;provides&nbsp;to&nbsp;retrieve&nbsp;values&nbsp;in&nbsp;a&nbsp;type&nbsp;safe&nbsp;manner.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;State&nbsp;values&nbsp;are&nbsp;represented&nbsp;with&nbsp;standard&nbsp;Java&nbsp;objects:&nbsp;{@link&nbsp;String},&nbsp;{@link&nbsp;Number},<br>
+&nbsp;*&nbsp;{@link&nbsp;Boolean},&nbsp;{@link&nbsp;Map},&nbsp;{@link&nbsp;List},&nbsp;{@link&nbsp;Set}&nbsp;and&nbsp;{@code&nbsp;null}.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;AuthenticationState&nbsp;{&nbsp;//TODO&nbsp;add&nbsp;all&nbsp;appropriate&nbsp;methods&nbsp;and/or&nbsp;replace&nbsp;with&nbsp;JsonValue&nbsp;or&nbsp;generic&nbsp;version<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;JsonValue&nbsp;state;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;AuthenticationState}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationState()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this(json(object()));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthenticationState(JsonValue&nbsp;state)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.state&nbsp;=&nbsp;state;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Adds&nbsp;the&nbsp;specified&nbsp;value.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;adding&nbsp;to&nbsp;a&nbsp;list&nbsp;value,&nbsp;the&nbsp;specified&nbsp;key&nbsp;must&nbsp;be&nbsp;parseable&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;base-10<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;integer&nbsp;and&nbsp;be&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;the&nbsp;list&nbsp;size.&nbsp;Adding&nbsp;a&nbsp;value&nbsp;to&nbsp;a&nbsp;list&nbsp;shifts&nbsp;any<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;existing&nbsp;elements&nbsp;at&nbsp;or&nbsp;above&nbsp;the&nbsp;specified&nbsp;index&nbsp;to&nbsp;the&nbsp;right&nbsp;by&nbsp;one.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;key&nbsp;The&nbsp;{@code&nbsp;Map}&nbsp;key&nbsp;or&nbsp;{@code&nbsp;List}&nbsp;index&nbsp;to&nbsp;add.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;object&nbsp;The&nbsp;Java&nbsp;object&nbsp;to&nbsp;add.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;{@code&nbsp;AuthenticationState}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthenticationStateException&nbsp;If&nbsp;not&nbsp;a&nbsp;{@code&nbsp;Map}&nbsp;or&nbsp;the&nbsp;{@code&nbsp;Map}&nbsp;key&nbsp;already<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exists.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationState&nbsp;add(String&nbsp;key,&nbsp;Object&nbsp;object)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.add(key,&nbsp;object);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(JsonValueException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationStateException(e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;this&nbsp;{@code&nbsp;AuthenticationState}&nbsp;contains&nbsp;the&nbsp;specified&nbsp;item.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;key&nbsp;The&nbsp;{@code&nbsp;Map}&nbsp;key&nbsp;or&nbsp;{@code&nbsp;List}&nbsp;index&nbsp;of&nbsp;the&nbsp;item&nbsp;to&nbsp;seek.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;this&nbsp;{@code&nbsp;AuthenticationState}&nbsp;contains&nbsp;the&nbsp;specified&nbsp;member.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;NullPointerException&nbsp;If&nbsp;{@code&nbsp;key}&nbsp;is&nbsp;{@code&nbsp;null}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;boolean&nbsp;isDefined(String&nbsp;key)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;state.isDefined(key);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;specified&nbsp;item&nbsp;value.&nbsp;If&nbsp;no&nbsp;such&nbsp;member&nbsp;value&nbsp;exists,&nbsp;then&nbsp;a<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;AuthenticationState}&nbsp;containing&nbsp;{@code&nbsp;null}&nbsp;is&nbsp;returned.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;key&nbsp;The&nbsp;{@code&nbsp;Map}&nbsp;key&nbsp;or&nbsp;{@code&nbsp;List}&nbsp;index&nbsp;identifying&nbsp;the&nbsp;item&nbsp;to&nbsp;return.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;a&nbsp;{@code&nbsp;AuthenticationState}&nbsp;containing&nbsp;the&nbsp;value&nbsp;or&nbsp;{@code&nbsp;null}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationState&nbsp;get(String&nbsp;key)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuthenticationState(state.get(key));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;{@code&nbsp;AuthenticationState}&nbsp;as&nbsp;a&nbsp;{@link&nbsp;Boolean}&nbsp;object.&nbsp;If&nbsp;the&nbsp;value&nbsp;is<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;null},&nbsp;this&nbsp;method&nbsp;returns&nbsp;{@code&nbsp;null}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;boolean&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthenticationStateException&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;a&nbsp;boolean&nbsp;type.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Boolean&nbsp;asBoolean()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;state.asBoolean();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(JsonValueException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationStateException(e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;{@code&nbsp;AuthenticationState}&nbsp;as&nbsp;an&nbsp;{@link&nbsp;Integer}&nbsp;object.&nbsp;This&nbsp;may&nbsp;involve<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;rounding&nbsp;or&nbsp;truncation.&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;{@code&nbsp;null},&nbsp;this&nbsp;method&nbsp;returns&nbsp;{@code&nbsp;null}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;integer&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthenticationStateException&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;a&nbsp;number.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Integer&nbsp;asInteger()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;state.asInteger();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(JsonValueException&nbsp;e)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationStateException(e);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiAuthenticationStateExceptionjavafromrev3228forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;copfile&quot;&gt;&lt;h4&gt;Copied:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationStateException.java&nbsp;(from&nbsp;rev&nbsp;3228,&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java)&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationStateException.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/AuthenticationStateException.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,39&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.api;<br>
+<br>
+import&nbsp;org.forgerock.json.fluent.JsonValueException;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;An&nbsp;exception&nbsp;that&nbsp;is&nbsp;thrown&nbsp;during<br>
+&nbsp;*&nbsp;{@link&nbsp;org.forgerock.caf.authentication.api.AuthenticationState}&nbsp;operations.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+public&nbsp;class&nbsp;AuthenticationStateException&nbsp;extends&nbsp;RuntimeException&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;long&nbsp;serialVersionUID&nbsp;=&nbsp;-8084970886710807796L;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;{@code&nbsp;AuthenticationStateException}&nbsp;with&nbsp;the&nbsp;specified&nbsp;cause.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;cause&nbsp;The&nbsp;cause.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationStateException(JsonValueException&nbsp;cause)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(cause);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiMessageContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContext.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,10&nbsp;+16,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authentication.api;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.framework.AuditTrail;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.Context;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;authentication&nbsp;framework&nbsp;uses&nbsp;this&nbsp;{@code&nbsp;Context}&nbsp;to&nbsp;pass&nbsp;messages&nbsp;and&nbsp;message<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;authentication&nbsp;framework&nbsp;uses&nbsp;this&nbsp;{@code&nbsp;MessageContext}&nbsp;to&nbsp;pass&nbsp;messages&nbsp;and&nbsp;message<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;processing&nbsp;state&nbsp;to&nbsp;authentication&nbsp;contexts&nbsp;for&nbsp;processing&nbsp;by&nbsp;authentication&nbsp;modules.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;class&nbsp;encapsulates&nbsp;a&nbsp;request&nbsp;and&nbsp;response&nbsp;message&nbsp;objects&nbsp;for&nbsp;a&nbsp;message&nbsp;exchange.&nbsp;This<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-32,6&nbsp;+33,20&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;interface&nbsp;MessageContext&nbsp;extends&nbsp;Context,&nbsp;MessageContextInfo&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;//Methods&nbsp;like&nbsp;setAuthContextState(...)&nbsp;and&nbsp;getAuthContextState(...)&nbsp;will&nbsp;end&nbsp;up&nbsp;here<br>
-&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;which&nbsp;do&nbsp;not&nbsp;want&nbsp;to&nbsp;be&nbsp;exposed&nbsp;to&nbsp;auth&nbsp;modules<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;{@link&nbsp;AuditTrail}&nbsp;instance&nbsp;for&nbsp;this&nbsp;message&nbsp;exchange.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;{@code&nbsp;AuditTrail}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;getAuditTrail();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;{@link&nbsp;AuthenticationState}&nbsp;instance&nbsp;that&nbsp;maintains&nbsp;any&nbsp;stateful&nbsp;information&nbsp;for<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;provided&nbsp;{@link&nbsp;AsyncServerAuthContext}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authContext&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;for&nbsp;which&nbsp;the&nbsp;state&nbsp;applies.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;&amp;lt;T&amp;gt;&nbsp;The&nbsp;type&nbsp;of&nbsp;state&nbsp;class.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;{@code&nbsp;AuthenticationState}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;T&nbsp;extends&nbsp;AuthenticationState&amp;gt;&nbsp;T&nbsp;getState(AsyncServerAuthContext&nbsp;authContext);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapiMessageContextInfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContextInfo.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContextInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/MessageContextInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-18,6&nbsp;+18,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.Context;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.protocol.Request;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.http.protocol.Response;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-33,7&nbsp;+34,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;interface&nbsp;MessageContextInfo&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+public&nbsp;interface&nbsp;MessageContextInfo&nbsp;extends&nbsp;Context&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;request&nbsp;object&nbsp;from&nbsp;this&nbsp;{@code&nbsp;MessageContextInfo}.<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationapipackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/package-info.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/api/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-18,4&nbsp;+18,4&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;the&nbsp;core&nbsp;interfaces&nbsp;and&nbsp;classes&nbsp;to&nbsp;provide&nbsp;an&nbsp;asynchronous&nbsp;and&nbsp;improved<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;JASPI-like&nbsp;message&nbsp;authentication&nbsp;API.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-package&nbsp;org.forgerock.caf.authentication.api;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;ins&gt;+package&nbsp;org.forgerock.caf.authentication.api;<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAggregateAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AggregateAuthContext.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AggregateAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AggregateAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,193&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.isSendFailure;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.isSuccess;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.util.List;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthContextWithState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+import&nbsp;org.forgerock.util.promise.AsyncFunction;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.forgerock.util.promise.SuccessHandler;<br>
+import&nbsp;org.slf4j.Logger;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Aggregates&nbsp;two&nbsp;{@link&nbsp;AsyncServerAuthContext}s&nbsp;together,&nbsp;if&nbsp;the&nbsp;first&nbsp;auth&nbsp;context&nbsp;fails&nbsp;to<br>
+&nbsp;*&nbsp;authenticate&nbsp;the&nbsp;request&nbsp;message&nbsp;the&nbsp;second&nbsp;is&nbsp;called.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;intended&nbsp;usage&nbsp;of&nbsp;this&nbsp;class&nbsp;for&nbsp;the&nbsp;first&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;perform<br>
+&nbsp;*&nbsp;session&nbsp;related&nbsp;validation&nbsp;on&nbsp;the&nbsp;request&nbsp;message&nbsp;and&nbsp;only&nbsp;if&nbsp;that&nbsp;fails&nbsp;then&nbsp;to&nbsp;attempt&nbsp;to&nbsp;use<br>
+&nbsp;*&nbsp;the&nbsp;second&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;authentication&nbsp;the&nbsp;request&nbsp;message.&amp;lt;/&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Similarly&nbsp;the&nbsp;second&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;only&nbsp;secures&nbsp;the&nbsp;response&nbsp;if&nbsp;it<br>
+&nbsp;*&nbsp;authenticated&nbsp;the&nbsp;request&nbsp;message&nbsp;and&nbsp;the&nbsp;first&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;always&nbsp;secures<br>
+&nbsp;*&nbsp;the&nbsp;response&nbsp;so&nbsp;it&nbsp;can&nbsp;add&nbsp;any&nbsp;related&nbsp;session&nbsp;information.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Both&nbsp;{@code&nbsp;AsyncServerAuthContext}s&nbsp;always&nbsp;get&nbsp;the&nbsp;opportunity&nbsp;clean&nbsp;the&nbsp;client&nbsp;subject.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+final&nbsp;class&nbsp;AggregateAuthContext&nbsp;implements&nbsp;AsyncServerAuthContext,&nbsp;AuthContextWithState&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AsyncServerAuthContext&nbsp;sessionModuleContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AsyncServerAuthContext&nbsp;authModuleContext;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;AggregateAuthContext}&nbsp;with&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthContexts}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@link&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionModuleContext&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;session&nbsp;{@code&nbsp;AsyncServerAuthContext}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModuleContext&nbsp;The&nbsp;authenticating&nbsp;{@code&nbsp;AsyncServerAuthContext}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;AggregateAuthContext(Logger&nbsp;logger,&nbsp;AsyncServerAuthContext&nbsp;sessionModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authModuleContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(logger,&nbsp;sessionModuleContext,&nbsp;authModuleContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.sessionModuleContext&nbsp;=&nbsp;sessionModuleContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModuleContext&nbsp;=&nbsp;authModuleContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Calls&nbsp;the&nbsp;session&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;request&nbsp;message&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;if&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}&nbsp;is&nbsp;returned&nbsp;the&nbsp;authentication<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;is&nbsp;called&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;request&nbsp;message.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AggregateAuthContextState&nbsp;state&nbsp;=&nbsp;context.getState(this);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionModuleContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModuleContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Record&nbsp;the&nbsp;AuthModules&nbsp;AuthStatus&nbsp;to&nbsp;decided&nbsp;later&nbsp;whether&nbsp;to&nbsp;call<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;secureResponse&nbsp;on&nbsp;the&nbsp;AuthModule.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.setIsAuthenticatedByAuthContext(true);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;authentication&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;originally&nbsp;authenticated&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;incoming&nbsp;request&nbsp;message&nbsp;then&nbsp;it&nbsp;is&nbsp;first&nbsp;called&nbsp;to&nbsp;secure&nbsp;the&nbsp;outgoing&nbsp;response.&nbsp;The<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;session&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;is&nbsp;always&nbsp;called,&nbsp;regardless&nbsp;of&nbsp;if&nbsp;it&nbsp;authenticated<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;incoming&nbsp;request&nbsp;message,&nbsp;so&nbsp;that&nbsp;is&nbsp;can&nbsp;add&nbsp;any&nbsp;session&nbsp;related&nbsp;information&nbsp;to&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(final&nbsp;MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AggregateAuthContextState&nbsp;state&nbsp;=&nbsp;context.getState(this);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(state.isAuthenticatedByAuthContext())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise&nbsp;=&nbsp;authModuleContext.secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;promise.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionModuleContext.secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;both&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthContext}s&nbsp;in&nbsp;parallel&nbsp;to&nbsp;clean&nbsp;the&nbsp;client&nbsp;subject&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;only&nbsp;return&nbsp;a&nbsp;successful&nbsp;promise&nbsp;if&nbsp;both&nbsp;complete&nbsp;successfully&nbsp;otherwise&nbsp;returns&nbsp;the&nbsp;first<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exception&nbsp;in&nbsp;a&nbsp;failed&nbsp;promise.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.when(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionModuleContext.cleanSubject(context,&nbsp;clientSubject),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleContext.cleanSubject(context,&nbsp;clientSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).thenAsync(new&nbsp;AsyncFunction&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;Void,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(List&amp;lt;Void&amp;gt;&nbsp;value)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AggregateAuthContextState&nbsp;createAuthenticationState()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AggregateAuthContextState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;AggregateAuthContextState&nbsp;extends&nbsp;AuthenticationState&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;IS_AUTHENTICATED_BY_AUTH_CONTEXT&nbsp;=&nbsp;&amp;quot;isAuthenticatedByAuthContext&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;setIsAuthenticatedByAuthContext(boolean&nbsp;isAuthenticatedByAuthContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add(IS_AUTHENTICATED_BY_AUTH_CONTEXT,&nbsp;isAuthenticatedByAuthContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;boolean&nbsp;isAuthenticatedByAuthContext()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isDefined(IS_AUTHENTICATED_BY_AUTH_CONTEXT))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;get(IS_AUTHENTICATED_BY_AUTH_CONTEXT).asBoolean();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;Session&nbsp;Authentication&nbsp;Module:&nbsp;&amp;quot;&nbsp;+&nbsp;sessionModuleContext.toString()&nbsp;+&nbsp;&amp;quot;,&nbsp;Authentication&nbsp;Modules:&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModuleContext.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuditTrailjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuditTrail.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-23,10&nbsp;+23,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Map;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.UUID;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.fluent.JsonValue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;*&nbsp;&amp;lt;p&amp;gt;Is&nbsp;responsible&nbsp;for&nbsp;tracking&nbsp;the&nbsp;auditing&nbsp;of&nbsp;an&nbsp;authentication&nbsp;attempt&nbsp;including&nbsp;auditing&nbsp;each&nbsp;of&nbsp;the&nbsp;modules&nbsp;that<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Responsible&nbsp;for&nbsp;tracking&nbsp;the&nbsp;auditing&nbsp;of&nbsp;an&nbsp;authentication&nbsp;attempt&nbsp;including&nbsp;auditing&nbsp;each&nbsp;of&nbsp;the&nbsp;modules&nbsp;that<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;are&nbsp;executed&nbsp;and&nbsp;the&nbsp;overall&nbsp;result&nbsp;of&nbsp;the&nbsp;authentication.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;audit&nbsp;record&nbsp;will&nbsp;include&nbsp;a&nbsp;unique&nbsp;request&nbsp;id,&nbsp;the&nbsp;principal&nbsp;(if&nbsp;authentication&nbsp;was&nbsp;successful)&nbsp;and&nbsp;a&nbsp;session<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-50,7&nbsp;+51,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;principal&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;has&nbsp;identified&nbsp;that&nbsp;will&nbsp;be&nbsp;set&nbsp;in&nbsp;the&nbsp;audit<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;log&nbsp;entry.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_PRINCIPAL_KEY&nbsp;=&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;AUDIT_PRINCIPAL_KEY&nbsp;=&nbsp;AuthenticationFramework.ATTRIBUTE_AUTH_PRINCIPAL;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo&nbsp;map&nbsp;key&nbsp;for&nbsp;setting&nbsp;the&nbsp;session&nbsp;id&nbsp;for&nbsp;the&nbsp;authentication&nbsp;request.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-85,7&nbsp;+86,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;api&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditApi}.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuditTrail(AuditApi&nbsp;api,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail(AuditApi&nbsp;api,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.api&nbsp;=&nbsp;api;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(CONTEXT_KEY,&nbsp;contextMap);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-98,9&nbsp;+99,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditSuccess(String&nbsp;moduleId,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;info)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries.add(json(object(<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(MODULE_ID_KEY,&nbsp;moduleId),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(RESULT_KEY,&nbsp;SUCCESSFUL_RESULT),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(INFO_KEY,&nbsp;info))<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(MODULE_ID_KEY,&nbsp;moduleId),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(RESULT_KEY,&nbsp;SUCCESSFUL_RESULT),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;field(INFO_KEY,&nbsp;info))<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).asMap());<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-136,25&nbsp;+137,35&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#AUDIT_PRINCIPAL_KEY}&nbsp;key&nbsp;and&nbsp;will&nbsp;created&nbsp;an&nbsp;ordered&nbsp;list&nbsp;of&nbsp;all&nbsp;non-null&nbsp;principal&nbsp;values.&amp;lt;/p&amp;gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;completeAuditAsFailure()&nbsp;{<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;completeAuditAsFailure(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Completes&nbsp;the&nbsp;entire&nbsp;audit&nbsp;record&nbsp;as&nbsp;a&nbsp;failure.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;No&nbsp;auth&nbsp;module&nbsp;successfully&nbsp;completed&nbsp;so&nbsp;will&nbsp;check&nbsp;each&nbsp;auth&nbsp;module&nbsp;entry's&nbsp;audit&nbsp;info&nbsp;map&nbsp;for&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#AUDIT_PRINCIPAL_KEY}&nbsp;key&nbsp;and&nbsp;will&nbsp;created&nbsp;an&nbsp;ordered&nbsp;list&nbsp;of&nbsp;all&nbsp;non-null&nbsp;principal&nbsp;values.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;error&nbsp;The&nbsp;cause&nbsp;of&nbsp;the&nbsp;failure.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;completeAuditAsFailure(AuthenticationException&nbsp;error)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;principals&nbsp;=&nbsp;array();<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;entry&nbsp;:&nbsp;entries)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;entry.get(INFO_KEY);<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditInfo&nbsp;==&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;auditInfo.get(AUDIT_PRINCIPAL_KEY);<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principals.add(principal);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(RESULT_KEY,&nbsp;&amp;quot;FAILED&amp;quot;).put(PRINCIPAL_KEY,&nbsp;principals);<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(error&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditMessage.put(&amp;quot;cause&amp;quot;,&nbsp;error.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-190,6&nbsp;+201,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;failure&nbsp;reasons&nbsp;as&nbsp;{@code&nbsp;Map}s&nbsp;of&nbsp;{@code&nbsp;String}&nbsp;to&nbsp;{@code&nbsp;Object}s.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;getFailureReasons()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasons&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;();<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthContextsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthContexts.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthContexts.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthContexts.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,365&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.security.Principal;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+import&nbsp;org.forgerock.util.promise.AsyncFunction;<br>
+import&nbsp;org.forgerock.util.promise.FailureHandler;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.forgerock.util.promise.SuccessHandler;<br>
+import&nbsp;org.slf4j.Logger;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Utility&nbsp;class&nbsp;for&nbsp;applying&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;method&nbsp;calls&nbsp;on&nbsp;a<br>
+&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;add&nbsp;logging,&nbsp;auditing&nbsp;and&nbsp;validation&nbsp;support.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withValidation(AsyncServerAuthContext)}&nbsp;wraps&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthModule}(s)<br>
+&nbsp;*&nbsp;and&nbsp;apply&nbsp;functions&nbsp;to&nbsp;validate&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;{@code&nbsp;validateRequest}&nbsp;and<br>
+&nbsp;*&nbsp;{@code&nbsp;secureResponse}&nbsp;method&nbsp;calls.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Note:&nbsp;wrapping&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;changes&nbsp;the&nbsp;processing&nbsp;flow&nbsp;as&nbsp;it&nbsp;will&nbsp;throw<br>
+&nbsp;*&nbsp;an&nbsp;{@link&nbsp;AuthenticationException}&nbsp;if&nbsp;the&nbsp;method&nbsp;call&nbsp;returns&nbsp;an&nbsp;invalid&nbsp;{@link&nbsp;AuthStatus}.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withAuditing(AsyncServerAuthContext)}&nbsp;wraps&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthModule}(s)<br>
+&nbsp;*&nbsp;and&nbsp;applies&nbsp;a&nbsp;function&nbsp;to&nbsp;audit&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;{@code&nbsp;validateRequest}&nbsp;method&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withLogging(Logger,&nbsp;AsyncServerAuthContext)}&nbsp;wraps&nbsp;the<br>
+&nbsp;*&nbsp;{@code&nbsp;AsyncServerAuthModule}(s)&nbsp;and&nbsp;apply&nbsp;functions&nbsp;to&nbsp;log&nbsp;the&nbsp;result&nbsp;of&nbsp;each&nbsp;method&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;As&nbsp;{@code&nbsp;withValidation}&nbsp;changes&nbsp;the&nbsp;processing&nbsp;flow,&nbsp;it&nbsp;must&nbsp;be&nbsp;applied&nbsp;after&nbsp;the&nbsp;other<br>
+&nbsp;*&nbsp;methods,&nbsp;i.e.<br>
+&nbsp;*&nbsp;&amp;lt;pre&amp;gt;&amp;lt;code&amp;gt;<br>
+&nbsp;*&nbsp;withValidation(withAuditing(withLogging(logger,&nbsp;authContext)));<br>
+&nbsp;*&nbsp;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;<br>
+&nbsp;*&nbsp;or<br>
+&nbsp;*&nbsp;&amp;lt;pre&amp;gt;&amp;lt;code&amp;gt;<br>
+&nbsp;*&nbsp;withValidation(withSessionAuditing(withLogging(logger,&nbsp;authContext)));<br>
+&nbsp;*&nbsp;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;<br>
+&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+final&nbsp;class&nbsp;AuthContexts&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthContexts()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Private&nbsp;constructor<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;function&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;both&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext#validateRequest(MessageContext,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext#secureResponse(MessageContext,&nbsp;Subject)}&nbsp;method&nbsp;calls,&nbsp;for<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AsyncServerAuthContext},&nbsp;which&nbsp;validates&nbsp;that&nbsp;the&nbsp;returned<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AuthStatus}&nbsp;is&nbsp;valid&nbsp;for&nbsp;the&nbsp;method&nbsp;being&nbsp;called.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;wrapped&nbsp;auth&nbsp;context&nbsp;returns&nbsp;an&nbsp;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;from&nbsp;either<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;validateRequest}&nbsp;or&nbsp;{@code&nbsp;secureResponse}&nbsp;then&nbsp;a&nbsp;{@link&nbsp;AuthenticationException}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;returned&nbsp;in&nbsp;a&nbsp;failed&nbsp;{@code&nbsp;Promise}.&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;from&nbsp;{@code&nbsp;validateRequest}&nbsp;are:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@link&nbsp;AuthStatus#FAILURE}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@code&nbsp;null}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;from&nbsp;{@code&nbsp;secureResponse}&nbsp;are:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@link&nbsp;AuthStatus#SUCCESS}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@link&nbsp;AuthStatus#FAILURE}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@code&nbsp;null}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authContext&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;with&nbsp;validation&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthContext&nbsp;withValidation(AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;ValidatingAuthContext(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext#validateRequest(MessageContext,&nbsp;Subject,&nbsp;Subject)}&nbsp;method<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;call,&nbsp;for&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AsyncServerAuthContext},&nbsp;which&nbsp;audits&nbsp;the&nbsp;outcome&nbsp;of&nbsp;the&nbsp;call.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Audits:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;successful&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;({@link&nbsp;AuthStatus#SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS})&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;failure&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;({@link&nbsp;AuthStatus#SEND_FAILURE})&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;({@link&nbsp;AuthStatus#FAILURE},&nbsp;{@code&nbsp;null})&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;any&nbsp;{@code&nbsp;AuthenticationException}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authContext&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;with&nbsp;auditing&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthContext&nbsp;withAuditing(AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuditingAuthContext(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;each&nbsp;method&nbsp;call,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;for&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AsyncServerAuthContext},&nbsp;which&nbsp;logs&nbsp;the&nbsp;outcome&nbsp;of&nbsp;the&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext#validateRequest(MessageContext,&nbsp;Subject,&nbsp;Subject)}&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;valid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Any&nbsp;{@code&nbsp;AuthenticationException}&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext#secureResponse(MessageContext,&nbsp;Subject)}&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;valid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Any&nbsp;{@code&nbsp;AuthenticationException}&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthContext#cleanSubject(MessageContext,&nbsp;Subject)}&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;successfully&nbsp;cleaning&nbsp;client&nbsp;subject&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;failed&nbsp;cleaning&nbsp;of&nbsp;client&nbsp;subject&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@code&nbsp;Logger}&nbsp;instance&nbsp;to&nbsp;log&nbsp;to.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authContext&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;with&nbsp;logging&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthContext&nbsp;withLogging(Logger&nbsp;logger,&nbsp;AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(logger,&nbsp;authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;LoggingAuthContext(logger,&nbsp;authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;ValidatingAuthContext&nbsp;extends&nbsp;WrappedAuthContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ValidatingAuthContext(AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isFailure(authStatus)&nbsp;||&nbsp;isNull(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;validateRequest:&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.secureResponse(context,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus)&nbsp;||&nbsp;isFailure(authStatus)&nbsp;||&nbsp;isNull(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;secureResponse:&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;AuditingAuthContext&nbsp;extends&nbsp;WrappedAuthContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditingAuthContext(AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;context.getAuditTrail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isFailure(authStatus)&nbsp;||&nbsp;isNull(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isSendContinue(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;context.getAuditTrail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure(error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;getPrincipal(Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;principal.getName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;LoggingAuthContext&nbsp;extends&nbsp;WrappedAuthContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;LoggingAuthContext(Logger&nbsp;logger,&nbsp;AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request,&nbsp;with&nbsp;response&nbsp;message&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Failed&nbsp;to&nbsp;validate&nbsp;request,&nbsp;included&nbsp;response&nbsp;message.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendContinue(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;validating&nbsp;request.&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(error.getMessage(),&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.secureResponse(context,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Successfully&nbsp;secured&nbsp;response.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Failed&nbsp;to&nbsp;secured&nbsp;response,&nbsp;included&nbsp;response&nbsp;message&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendContinue(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;securing&nbsp;response.&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(error.getMessage(),&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.cleanSubject(context,&nbsp;clientSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(error.getMessage(),&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;abstract&nbsp;class&nbsp;WrappedAuthContext&nbsp;implements&nbsp;AsyncServerAuthContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AsyncServerAuthContext&nbsp;authContext;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;WrappedAuthContext(AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authContext&nbsp;=&nbsp;authContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthModulesjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthModules.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthModules.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthModules.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,603&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.*;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessagePolicy;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.Collections;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.util.promise.AsyncFunction;<br>
+import&nbsp;org.forgerock.util.promise.FailureHandler;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.forgerock.util.promise.SuccessHandler;<br>
+import&nbsp;org.slf4j.Logger;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Utility&nbsp;class&nbsp;for&nbsp;applying&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;method&nbsp;calls&nbsp;on&nbsp;a<br>
+&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule}&nbsp;to&nbsp;add&nbsp;logging,&nbsp;auditing&nbsp;and&nbsp;validation&nbsp;support.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withValidation(AsyncServerAuthModule)}&nbsp;and&nbsp;{@link&nbsp;#withValidation(List)}&nbsp;wrap&nbsp;the<br>
+&nbsp;*&nbsp;{@code&nbsp;AsyncServerAuthModule}(s)&nbsp;and&nbsp;apply&nbsp;functions&nbsp;to&nbsp;validate&nbsp;the&nbsp;result&nbsp;of&nbsp;the<br>
+&nbsp;*&nbsp;{@code&nbsp;validateRequest}&nbsp;and&nbsp;{@code&nbsp;secureResponse}&nbsp;method&nbsp;calls.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Note:&nbsp;wrapping&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;changes&nbsp;the&nbsp;processing&nbsp;flow&nbsp;as&nbsp;it&nbsp;will&nbsp;throw<br>
+&nbsp;*&nbsp;an&nbsp;{@link&nbsp;AuthenticationException}&nbsp;if&nbsp;the&nbsp;method&nbsp;call&nbsp;returns&nbsp;an&nbsp;invalid&nbsp;{@link&nbsp;AuthStatus}.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withAuditing(AsyncServerAuthModule)}&nbsp;and&nbsp;{@link&nbsp;#withAuditing(List)}&nbsp;wrap&nbsp;the<br>
+&nbsp;*&nbsp;{@code&nbsp;AsyncServerAuthModule}(s)&nbsp;and&nbsp;applies&nbsp;a&nbsp;function&nbsp;to&nbsp;audit&nbsp;the&nbsp;result&nbsp;of&nbsp;the<br>
+&nbsp;*&nbsp;{@code&nbsp;validateRequest}&nbsp;method&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withSessionAuditing(AsyncServerAuthModule)}&nbsp;wrap&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthModule}<br>
+&nbsp;*&nbsp;and&nbsp;applies&nbsp;the&nbsp;same&nbsp;function&nbsp;as&nbsp;{@link&nbsp;#withAuditing(AsyncServerAuthModule)}&nbsp;and&nbsp;in&nbsp;addition<br>
+&nbsp;*&nbsp;audits&nbsp;the&nbsp;session&nbsp;id&nbsp;(if&nbsp;set)&nbsp;from&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthModule}.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;{@link&nbsp;#withLogging(Logger,&nbsp;AsyncServerAuthModule)}&nbsp;and&nbsp;{@link&nbsp;#withLogging(Logger,&nbsp;List)}<br>
+&nbsp;*&nbsp;wrap&nbsp;the&nbsp;{@code&nbsp;AsyncServerAuthModule}(s)&nbsp;and&nbsp;apply&nbsp;functions&nbsp;to&nbsp;log&nbsp;the&nbsp;result&nbsp;of&nbsp;each&nbsp;method<br>
+&nbsp;*&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;As&nbsp;{@code&nbsp;withValidation}&nbsp;changes&nbsp;the&nbsp;processing&nbsp;flow,&nbsp;it&nbsp;must&nbsp;be&nbsp;applied&nbsp;after&nbsp;the&nbsp;other<br>
+&nbsp;*&nbsp;methods,&nbsp;i.e.<br>
+&nbsp;*&nbsp;&amp;lt;pre&amp;gt;&amp;lt;code&amp;gt;<br>
+&nbsp;*&nbsp;withValidation(withAuditing(withLogging(logger,&nbsp;authModule)));<br>
+&nbsp;*&nbsp;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;<br>
+&nbsp;*&nbsp;or<br>
+&nbsp;*&nbsp;&amp;lt;pre&amp;gt;&amp;lt;code&amp;gt;<br>
+&nbsp;*&nbsp;withValidation(withSessionAuditing(withLogging(logger,&nbsp;authModule)));<br>
+&nbsp;*&nbsp;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;<br>
+&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+final&nbsp;class&nbsp;AuthModules&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthModules()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Private&nbsp;constructor<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;function&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;both&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;method&nbsp;calls,&nbsp;for<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AsyncServerAuthModule},&nbsp;which&nbsp;validates&nbsp;that&nbsp;the&nbsp;returned<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AuthStatus}&nbsp;is&nbsp;valid&nbsp;for&nbsp;the&nbsp;method&nbsp;being&nbsp;called.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;wrapped&nbsp;auth&nbsp;module&nbsp;returns&nbsp;an&nbsp;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;from&nbsp;either<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;validateRequest}&nbsp;or&nbsp;{@code&nbsp;secureResponse}&nbsp;then&nbsp;a&nbsp;{@link&nbsp;AuthenticationException}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;returned&nbsp;in&nbsp;a&nbsp;failed&nbsp;{@code&nbsp;Promise}.&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;from&nbsp;{@code&nbsp;validateRequest}&nbsp;are:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@link&nbsp;AuthStatus#FAILURE}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@code&nbsp;null}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;from&nbsp;{@code&nbsp;secureResponse}&nbsp;are:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@link&nbsp;AuthStatus#SUCCESS}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@link&nbsp;AuthStatus#FAILURE}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;{@code&nbsp;null}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;with&nbsp;validation&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthModule&nbsp;withValidation(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;ValidatingAuthModule(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;function&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;both&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;method&nbsp;calls,&nbsp;for<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;given&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s,&nbsp;which&nbsp;validates&nbsp;that&nbsp;the&nbsp;returned<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AuthStatus}&nbsp;is&nbsp;valid&nbsp;for&nbsp;the&nbsp;method&nbsp;being&nbsp;called.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}s&nbsp;with&nbsp;validation<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;{@link&nbsp;#withValidation(AsyncServerAuthModule)}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;withValidation(List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;modules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;AsyncServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AsyncServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules.add(withValidation(authModule));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;modules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;method<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;call,&nbsp;for&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AsyncServerAuthModule},&nbsp;which&nbsp;audits&nbsp;the&nbsp;outcome&nbsp;of&nbsp;the&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Audits:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;successful&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;({@link&nbsp;AuthStatus#SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS})&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;failure&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;({@link&nbsp;AuthStatus#SEND_FAILURE})&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;({@link&nbsp;AuthStatus#FAILURE},&nbsp;{@code&nbsp;null})&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;any&nbsp;{@code&nbsp;AuthenticationException}&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;with&nbsp;auditing&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthModule&nbsp;withAuditing(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuditingAuthModule(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;method<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;call,&nbsp;for&nbsp;the&nbsp;given&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s,&nbsp;which&nbsp;audits&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;outcome&nbsp;of&nbsp;each&nbsp;the&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}s&nbsp;with&nbsp;auditing<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;{@link&nbsp;#withAuditing(AsyncServerAuthModule)}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;withAuditing(List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;modules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;AsyncServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AsyncServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules.add(withAuditing(authModule));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;modules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;both&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;method<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;calls,&nbsp;for&nbsp;the&nbsp;given&nbsp;&amp;quot;session&amp;quot;&nbsp;{@code&nbsp;AsyncServerAuthModule},&nbsp;which&nbsp;audits&nbsp;the&nbsp;outcome&nbsp;of<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Applies&nbsp;the&nbsp;same&nbsp;function&nbsp;as&nbsp;the&nbsp;{@link&nbsp;#withAuditing(AsyncServerAuthModule)}&nbsp;method&nbsp;with<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;addition&nbsp;of&nbsp;settings&nbsp;the&nbsp;session&nbsp;id&nbsp;of&nbsp;the&nbsp;request&nbsp;from&nbsp;the&nbsp;request&nbsp;context&nbsp;map.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;with&nbsp;auditing,&nbsp;including&nbsp;session<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auditing,&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;{@link&nbsp;#withAuditing(AsyncServerAuthModule)}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthModule&nbsp;withSessionAuditing(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;SessionAuditingAuthModule(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;each&nbsp;method&nbsp;call,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;for&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AsyncServerAuthModule},&nbsp;which&nbsp;logs&nbsp;the&nbsp;outcome&nbsp;of&nbsp;the&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#initialize(MessagePolicy,&nbsp;MessagePolicy,&nbsp;CallbackHandler,&nbsp;Map)}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;successful&nbsp;initialization&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;failed&nbsp;initialization&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;valid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Any&nbsp;{@code&nbsp;AuthenticationException}&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#secureResponse(MessageContextInfo,&nbsp;Subject)}&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;valid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;invalid&nbsp;{@code&nbsp;AuthStatus}&nbsp;values&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Any&nbsp;{@code&nbsp;AuthenticationException}&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule#cleanSubject(MessageContextInfo,&nbsp;Subject)}&nbsp;logs:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;successfully&nbsp;cleaning&nbsp;client&nbsp;subject&nbsp;at&nbsp;&amp;lt;strong&amp;gt;debug&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;failed&nbsp;cleaning&nbsp;of&nbsp;client&nbsp;subject&nbsp;at&nbsp;&amp;lt;strong&amp;gt;error&amp;lt;/strong&amp;gt;&nbsp;level&amp;lt;/li&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@code&nbsp;Logger}&nbsp;instance&nbsp;to&nbsp;log&nbsp;to.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;with&nbsp;logging&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;AsyncServerAuthModule&nbsp;withLogging(Logger&nbsp;logger,&nbsp;AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;LoggingAuthModule(logger,&nbsp;authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Attaches&nbsp;a&nbsp;success&nbsp;and&nbsp;failure&nbsp;functions&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;each&nbsp;method&nbsp;call,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;for&nbsp;the&nbsp;given&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s,&nbsp;which&nbsp;logs&nbsp;the&nbsp;outcome&nbsp;of&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;each&nbsp;call.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@code&nbsp;Logger}&nbsp;instance&nbsp;to&nbsp;log&nbsp;to.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s&nbsp;to&nbsp;be&nbsp;be&nbsp;wrapped.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}s&nbsp;with&nbsp;logging<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;functions&nbsp;attached.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;{@link&nbsp;#withLogging(Logger,&nbsp;AsyncServerAuthModule)}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;withLogging(Logger&nbsp;logger,&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;modules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;AsyncServerAuthModule&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AsyncServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules.add(withLogging(logger,&nbsp;authModule));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;modules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;ValidatingAuthModule&nbsp;extends&nbsp;WrappedAuthModule&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ValidatingAuthModule(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isNull(authStatus)&nbsp;||&nbsp;isFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.secureResponse(messageInfo,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus)&nbsp;||&nbsp;isFailure(authStatus)&nbsp;||&nbsp;isNull(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;secureResponse,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;@Checkstyle:off<br>
+&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Checkstyle&nbsp;for&nbsp;some&nbsp;reason&nbsp;is&nbsp;enforcing&nbsp;that&nbsp;this&nbsp;class&nbsp;must&nbsp;be&nbsp;final,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;which&nbsp;cannot&nbsp;be&nbsp;the&nbsp;case&nbsp;as&nbsp;SessionAuditingAuthModule&nbsp;inherits&nbsp;from&nbsp;it!<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;class&nbsp;AuditingAuthModule&nbsp;extends&nbsp;WrappedAuthModule&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;@Checkstyle:on<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditingAuthModule(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getRequestContextMap().get(AUDIT_TRAIL_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;getMap(messageInfo.getRequestContextMap(),&nbsp;AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;getModuleId();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAlways(new&nbsp;Runnable()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;run()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;messageInfo.getRequestContextMap()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.get(AuditTrail.AUDIT_PRINCIPAL_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!principal.isEmpty())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo.put(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;principal);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus)&nbsp;||&nbsp;isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=&nbsp;removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason&nbsp;=&nbsp;Collections.emptyMap();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isFailure(authStatus)&nbsp;||&nbsp;isNull(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=&nbsp;removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason.put(&amp;quot;exception&amp;quot;,&nbsp;error.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason&nbsp;=&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;exception&amp;quot;,&nbsp;error.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;SessionAuditingAuthModule&nbsp;extends&nbsp;AuditingAuthModule&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;SessionAuditingAuthModule(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAlways(new&nbsp;Runnable()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;run()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditSessionId(messageInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.secureResponse(messageInfo,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAlways(new&nbsp;Runnable()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;run()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditSessionId(messageInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;auditSessionId(MessageContextInfo&nbsp;messageInfo)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getRequestContextMap().get(AUDIT_TRAIL_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getRequestContextMap().remove(AUDIT_INFO_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getRequestContextMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getRequestContextMap().remove(AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;LoggingAuthModule&nbsp;extends&nbsp;WrappedAuthModule&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;LoggingAuthModule(Logger&nbsp;logger,&nbsp;AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(final&nbsp;MessagePolicy&nbsp;requestPolicy,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;MessagePolicy&nbsp;responsePolicy,&nbsp;CallbackHandler&nbsp;handler,&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;options)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;Void&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(Void&nbsp;result)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logger.isDebugEnabled())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;was&nbsp;successfully&nbsp;initialized.&nbsp;\nrequest&nbsp;MessagePolicy:&nbsp;{},&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;\nresponse&nbsp;MessagePolicy:&nbsp;{},&nbsp;\noptions:&nbsp;{}&amp;quot;,&nbsp;getModuleId(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestPolicy,&nbsp;responsePolicy,&nbsp;options);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logger.isErrorEnabled())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(&amp;quot;{}&nbsp;failed&nbsp;to&nbsp;initialize.&nbsp;\nrequest&nbsp;MessagePolicy:&nbsp;{},&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;\nresponse&nbsp;MessagePolicy:&nbsp;{},&nbsp;\noptions:&nbsp;{}&amp;quot;,&nbsp;getModuleId(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestPolicy,&nbsp;responsePolicy,&nbsp;options,&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;getModuleId();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logger.isDebugEnabled())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;has&nbsp;a&nbsp;response&nbsp;to&nbsp;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendContinue(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;{}&nbsp;has&nbsp;returned&nbsp;an&nbsp;invalid&nbsp;AuthStatus&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(message,&nbsp;moduleId,&nbsp;asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(&amp;quot;{}&nbsp;has&nbsp;thrown&nbsp;an&nbsp;error&nbsp;whilst&nbsp;attempting&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleId,&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;getModuleId();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.secureResponse(messageInfo,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSendSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logger.isDebugEnabled())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;secured&nbsp;the&nbsp;response&nbsp;and&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;has&nbsp;a&nbsp;response&nbsp;to&nbsp;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;secure&nbsp;the&nbsp;response&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSendContinue(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logger.isDebugEnabled())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;securing&nbsp;the&nbsp;response&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;moduleId);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;{}&nbsp;has&nbsp;returned&nbsp;an&nbsp;invalid&nbsp;AuthStatus&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(message,&nbsp;moduleId,&nbsp;asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(&amp;quot;{}&nbsp;has&nbsp;thrown&nbsp;an&nbsp;error&nbsp;whilst&nbsp;attempting&nbsp;to&nbsp;secure&nbsp;the&nbsp;response&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleId,&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;super.cleanSubject(messageInfo,&nbsp;clientSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;Void&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(Void&nbsp;result)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;{}&nbsp;successfully&nbsp;cleaned&nbsp;client&nbsp;subject&amp;quot;,&nbsp;getModuleId());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onFailure(new&nbsp;FailureHandler&amp;lt;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleError(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.error(&amp;quot;{}&nbsp;failed&nbsp;clean&nbsp;client&nbsp;subject&amp;quot;,&nbsp;getModuleId(),&nbsp;error);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;abstract&nbsp;class&nbsp;WrappedAuthModule&nbsp;implements&nbsp;AsyncServerAuthModule&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AsyncServerAuthModule&nbsp;authModule;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;WrappedAuthModule(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModule&nbsp;=&nbsp;authModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getModuleId()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.getModuleId();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initialize(MessagePolicy&nbsp;requestPolicy,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;responsePolicy,&nbsp;CallbackHandler&nbsp;handler,&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;options)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;getSupportedMessageTypes()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.getSupportedMessageTypes();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.cleanSubject(messageInfo,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;containingMap,&nbsp;String&nbsp;key)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;containingMap.get(key);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containingMap.put(key,&nbsp;map);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;map;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;removeMap(MessageContextInfo&nbsp;context,&nbsp;String&nbsp;mapKey)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;context.getRequestContextMap().remove(mapKey);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthStatusUtilsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthStatusUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-61,7&nbsp;+61,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SUCCESS}.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SUCCESS.equals(authStatus);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-71,7&nbsp;+71,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS}.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSendSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isSendSuccess(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_SUCCESS.equals(authStatus);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-81,7&nbsp;+81,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_CONTINUE}.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;boolean&nbsp;isSendContinue(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isSendContinue(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_CONTINUE.equals(authStatus);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-91,7&nbsp;+91,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isSendFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isSendFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;SEND_FAILURE.equals(authStatus);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-101,7&nbsp;+101,18&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@link&nbsp;AuthStatus#FAILURE}.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;boolean&nbsp;isFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isFailure(AuthStatus&nbsp;authStatus)&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FAILURE.equals(authStatus);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@code&nbsp;null}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;value.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@code&nbsp;true}&nbsp;if&nbsp;the&nbsp;given&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;is&nbsp;{@code&nbsp;null}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isNull(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus&nbsp;==&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthenticationFilterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFilter.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,415&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFramework.REQUIRED_MESSAGE_TYPES_SUPPORT;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiAdapters.adapt;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
+import&nbsp;javax.security.auth.message.MessagePolicy;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.http.Context;<br>
+import&nbsp;org.forgerock.http.Filter;<br>
+import&nbsp;org.forgerock.http.Handler;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.http.protocol.ResponseException;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.PromiseImpl;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;A&nbsp;HTTP&nbsp;{@link&nbsp;Filter}&nbsp;that&nbsp;will&nbsp;protect&nbsp;all&nbsp;downstream&nbsp;filters&nbsp;or&nbsp;handlers.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;filter&nbsp;instance&nbsp;is&nbsp;created&nbsp;by&nbsp;creating&nbsp;a&nbsp;builder&nbsp;instance,&nbsp;({@link&nbsp;#builder()}),&nbsp;and<br>
+&nbsp;*&nbsp;providing&nbsp;the&nbsp;modules&nbsp;and&nbsp;configuration,&nbsp;for&nbsp;the&nbsp;particular&nbsp;authentication&nbsp;framework&nbsp;instance,<br>
+&nbsp;*&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;authenticate&nbsp;incoming&nbsp;requests&nbsp;and&nbsp;outgoing&nbsp;responses.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;authentication&nbsp;framework&nbsp;can&nbsp;be&nbsp;configured&nbsp;with&nbsp;a&nbsp;single&nbsp;session&nbsp;authentication&nbsp;module,<br>
+&nbsp;*&nbsp;which&nbsp;will&nbsp;authenticate&nbsp;requests&nbsp;based&nbsp;on&nbsp;some&nbsp;session&nbsp;identifier,&nbsp;and&nbsp;an&nbsp;ordered&nbsp;list&nbsp;of<br>
+&nbsp;*&nbsp;authentication&nbsp;modules,&nbsp;that&nbsp;are&nbsp;executed&nbsp;in&nbsp;order&nbsp;on&nbsp;a&nbsp;first&nbsp;succeeds&nbsp;wins&nbsp;basis.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;authentication&nbsp;framework&nbsp;must&nbsp;be&nbsp;configured&nbsp;with&nbsp;a&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;AuditApi}<br>
+&nbsp;*&nbsp;instance,&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;audit&nbsp;authentication&nbsp;outcomes.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+public&nbsp;final&nbsp;class&nbsp;AuthenticationFilter&nbsp;implements&nbsp;Filter&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuthenticationFramework&nbsp;runtime;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;JaspiRuntime}&nbsp;instance&nbsp;that&nbsp;will&nbsp;use&nbsp;the&nbsp;configured&nbsp;{@code&nbsp;authContext}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;authenticate&nbsp;incoming&nbsp;request&nbsp;and&nbsp;secure&nbsp;outgoing&nbsp;response&nbsp;messages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;AuditApi}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseHandler&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;FailureResponseHandler}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authContext&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;AsyncServerAuthContext}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;service&nbsp;{@link&nbsp;Subject}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;initializationPromise&nbsp;A&nbsp;{@link&nbsp;Promise}&nbsp;which&nbsp;will&nbsp;be&nbsp;completed&nbsp;once&nbsp;the&nbsp;configured<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth&nbsp;modules&nbsp;have&nbsp;been&nbsp;initialised.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilter(Logger&nbsp;logger,&nbsp;AuditApi&nbsp;auditApi,&nbsp;Subject&nbsp;serviceSubject,&nbsp;FailureResponseHandler&nbsp;responseHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext,&nbsp;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.runtime&nbsp;=&nbsp;new&nbsp;AuthenticationFramework(logger,&nbsp;auditApi,&nbsp;responseHandler,&nbsp;authContext,&nbsp;serviceSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initializationPromise);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Authenticates&nbsp;incoming&nbsp;request&nbsp;messages&nbsp;and&nbsp;if&nbsp;successful&nbsp;calls&nbsp;the&nbsp;downstream&nbsp;filter&nbsp;or<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;handler&nbsp;and&nbsp;then&nbsp;secures&nbsp;the&nbsp;returned&nbsp;response.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;The&nbsp;request&nbsp;context.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;next&nbsp;The&nbsp;downstream&nbsp;filter&nbsp;or&nbsp;handler&nbsp;in&nbsp;the&nbsp;chain&nbsp;that&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;if&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;was&nbsp;successfully&nbsp;authenticated.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;Promise}&nbsp;representing&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;filter(Context&nbsp;context,&nbsp;Request&nbsp;request,&nbsp;Handler&nbsp;next)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;runtime.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;a&nbsp;new&nbsp;{@code&nbsp;AuthenticationFilterBuilder}&nbsp;instance&nbsp;which&nbsp;is&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;configure<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;Authentication&nbsp;Framework.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;{@code&nbsp;AuthenticationFilterBuilder}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;AuthenticationFilterBuilder&nbsp;builder()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuthenticationFilterBuilder();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Builder&nbsp;class&nbsp;that&nbsp;configures&nbsp;an&nbsp;Authentication&nbsp;Framework&nbsp;instance.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Usage:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;pre&amp;gt;&amp;lt;code&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;builder.logger(logger)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.serviceSubject(serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responseHandler(responseHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.sessionModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(sessionAuthModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(sessionAuthModuleRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(sessionAuthModuleResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(sessionAuthModuleHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(sessionAuthModuleSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authModules(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModuleOne)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleOneRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleOneResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleOneHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleOneSettings),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModuleTwo)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleTwoRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleTwoResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleTwoHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleTwoSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;class&nbsp;AuthenticationFilterBuilder&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;name&nbsp;=&nbsp;&amp;quot;AuthenticationFilter&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Logger&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;FailureResponseHandler&nbsp;responseHandler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthenticationModuleBuilder&nbsp;sessionAuthModuleBuilder&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;AuthenticationModuleBuilder&amp;gt;&nbsp;authModuleBuilders&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;ArrayList&amp;lt;AuthenticationModuleBuilder&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Sets&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;logger&nbsp;instance&nbsp;that&nbsp;the&nbsp;framework&nbsp;should&nbsp;create&nbsp;and&nbsp;use&nbsp;to&nbsp;log<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;debug&nbsp;messages.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;not&nbsp;set,&nbsp;the&nbsp;name&nbsp;defaults&nbsp;to:&nbsp;AuthenticationFilter.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;name&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;{@code&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;named(String&nbsp;name)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.name&nbsp;=&nbsp;name;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Sets&nbsp;the&nbsp;logger&nbsp;instance&nbsp;that&nbsp;the&nbsp;framework&nbsp;will&nbsp;use&nbsp;to&nbsp;log&nbsp;debug&nbsp;messages.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;not&nbsp;set,&nbsp;the&nbsp;name&nbsp;defaults&nbsp;to:&nbsp;AuthenticationFilter.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@code&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;logger(Logger&nbsp;logger)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the,&nbsp;mandatory,&nbsp;{@code&nbsp;AuditApi}&nbsp;instance&nbsp;that&nbsp;the&nbsp;framework&nbsp;will&nbsp;use&nbsp;to&nbsp;audit&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;result&nbsp;of&nbsp;processed&nbsp;requests.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;The&nbsp;{@code&nbsp;AuditApi}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;auditApi(AuditApi&nbsp;auditApi)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;service&nbsp;{@code&nbsp;Subject}&nbsp;that&nbsp;contains&nbsp;credentials,&nbsp;for&nbsp;this&nbsp;framework&nbsp;instance,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;that&nbsp;auth&nbsp;modules&nbsp;can&nbsp;use&nbsp;to&nbsp;secure&nbsp;response&nbsp;messages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;The&nbsp;service&nbsp;{@code&nbsp;Subject}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;serviceSubject(Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.serviceSubject&nbsp;=&nbsp;serviceSubject;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Adds&nbsp;an&nbsp;additional&nbsp;response&nbsp;handler&nbsp;instance&nbsp;that&nbsp;adds&nbsp;support&nbsp;for&nbsp;protecting&nbsp;resources<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;which&nbsp;return&nbsp;responses&nbsp;with&nbsp;non-JSON&nbsp;content&nbsp;types.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseHandler&nbsp;The&nbsp;{@code&nbsp;ResourceExceptionHandler}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;responseHandler(ResourceExceptionHandler&nbsp;responseHandler)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseHandler.registerExceptionHandler(responseHandler);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;session&nbsp;authentication&nbsp;module&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;request&nbsp;sessions<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;maintain&nbsp;sessions&nbsp;on&nbsp;response&nbsp;messages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModuleBuilder&nbsp;A&nbsp;{@code&nbsp;AuthenticationModuleBuilder}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;sessionModule(AuthenticationModuleBuilder&nbsp;sessionAuthModuleBuilder)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModuleBuilder&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;sessionAuthModuleBuilder.authModule&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkMessageTypeSupport(sessionAuthModuleBuilder.authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.sessionAuthModuleBuilder&nbsp;=&nbsp;sessionAuthModuleBuilder;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;authentication&nbsp;modules&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;requests&nbsp;and&nbsp;secure<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;messages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModuleBuilders&nbsp;A&nbsp;{@code&nbsp;AuthenticationModuleBuilder}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;#authModules(java.util.List)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;authModules(AuthenticationModuleBuilder...&nbsp;authModuleBuilders)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModules(Arrays.asList(authModuleBuilders));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;authentication&nbsp;modules&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;requests&nbsp;and&nbsp;secure<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;messages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModuleBuilders&nbsp;A&nbsp;{@code&nbsp;AuthenticationModuleBuilder}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;#authModules(AuthenticationModuleBuilder...)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilterBuilder&nbsp;authModules(List&amp;lt;AuthenticationModuleBuilder&amp;gt;&nbsp;authModuleBuilders)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AuthenticationModuleBuilder&nbsp;authModuleBuilder&nbsp;:&nbsp;authModuleBuilders)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkMessageTypeSupport(authModuleBuilder.authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModuleBuilders.add(authModuleBuilder);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;checkMessageTypeSupport(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifFalse(authModule.getSupportedMessageTypes().containsAll(REQUIRED_MESSAGE_TYPES_SUPPORT),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;quot;Auth&nbsp;Module,&nbsp;&amp;quot;&nbsp;+&nbsp;authModule.getModuleId()&nbsp;+&nbsp;&amp;quot;,&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;required&nbsp;message&nbsp;types:&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;REQUIRED_MESSAGE_TYPES_SUPPORT);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;JaspiRuntimeFilter}&nbsp;instance&nbsp;based&nbsp;on&nbsp;the&nbsp;configuration&nbsp;provided.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;new&nbsp;Authentication&nbsp;Framework&nbsp;filter&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IllegalStateException&nbsp;If&nbsp;the&nbsp;{@code&nbsp;AuditApi}&nbsp;instance&nbsp;has&nbsp;not&nbsp;been&nbsp;set.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationFilter&nbsp;build()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditApi&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalStateException(&amp;quot;Audit&nbsp;Api&nbsp;must&nbsp;be&nbsp;set&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logger&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger&nbsp;=&nbsp;LoggerFactory.getLogger(name);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;AsyncServerAuthModule&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&amp;gt;&nbsp;initializationPromises&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;ArrayList&amp;lt;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PromiseImpl&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;kicker&nbsp;=&nbsp;PromiseImpl.create();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initializationPromises.add(kicker);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModuleBuilder&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;sessionAuthModuleBuilder.authModule&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule&nbsp;=&nbsp;sessionAuthModuleBuilder.authModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initializationPromises.add(initializeModule(sessionAuthModuleBuilder));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AuthenticationModuleBuilder&nbsp;authModuleBuilder&nbsp;:&nbsp;authModuleBuilders)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleBuilder.authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initializationPromises.add(initializeModule(authModuleBuilder));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise&nbsp;=&nbsp;Promises.when(initializationPromises);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kicker.handleResult(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;createFilter(logger,&nbsp;auditApi,&nbsp;responseHandler,&nbsp;serviceSubject,&nbsp;sessionAuthModule,&nbsp;authModules,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initializationPromise);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;initializeModule(AuthenticationModuleBuilder&nbsp;moduleBuilder)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;moduleBuilder.authModule.initialize(moduleBuilder.requestPolicy,&nbsp;moduleBuilder.responsePolicy,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleBuilder.handler,&nbsp;moduleBuilder.settings);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilter&nbsp;createFilter(Logger&nbsp;logger,&nbsp;AuditApi&nbsp;auditApi,&nbsp;FailureResponseHandler&nbsp;responseHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject,&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuthenticationFilter(logger,&nbsp;auditApi,&nbsp;serviceSubject,&nbsp;responseHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AggregateAuthContext(logger,&nbsp;new&nbsp;SessionAuthContext(logger,&nbsp;sessionAuthModule),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;FallbackAuthContext(logger,&nbsp;authModules)),&nbsp;initializationPromise);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Builder&nbsp;class&nbsp;that&nbsp;configures&nbsp;{@link&nbsp;AsyncServerAuthModule}s&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;ServerAuthModule}s.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Usage:<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;pre&amp;gt;&amp;lt;code&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;configureModule(authModuleOne)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleOneRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleOneResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleOneHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleOneSettings);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/code&amp;gt;&amp;lt;/pre&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;class&nbsp;AuthenticationModuleBuilder&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessagePolicy&nbsp;requestPolicy;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessagePolicy&nbsp;responsePolicy;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;CallbackHandler&nbsp;handler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;settings;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;authModule;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;builder&nbsp;to&nbsp;configure&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;auth&nbsp;module&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;AuthenticationModuleBuilder&nbsp;configureModule(AsyncServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationModuleBuilder&nbsp;builder&nbsp;=&nbsp;new&nbsp;AuthenticationModuleBuilder();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.authModule&nbsp;=&nbsp;authModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;builder;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;builder&nbsp;to&nbsp;configure&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;ServerAuthModule}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;{@code&nbsp;ServerAuthModule}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;auth&nbsp;module&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;AuthenticationModuleBuilder&nbsp;configureModule(ServerAuthModule&nbsp;authModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationModuleBuilder&nbsp;builder&nbsp;=&nbsp;new&nbsp;AuthenticationModuleBuilder();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.authModule&nbsp;=&nbsp;adapt(authModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;builder;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;request&nbsp;{@code&nbsp;MessagePolicy}&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;should&nbsp;use.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;requestPolicy&nbsp;The&nbsp;request&nbsp;{@code&nbsp;MessagePolicy}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;auth&nbsp;module&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationModuleBuilder&nbsp;requestPolicy(MessagePolicy&nbsp;requestPolicy)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.requestPolicy&nbsp;=&nbsp;requestPolicy;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;response&nbsp;{@code&nbsp;MessagePolicy}&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;should&nbsp;use.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responsePolicy&nbsp;The&nbsp;response&nbsp;{@code&nbsp;MessagePolicy}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;auth&nbsp;module&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationModuleBuilder&nbsp;responsePolicy(MessagePolicy&nbsp;responsePolicy)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responsePolicy&nbsp;=&nbsp;responsePolicy;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;{@code&nbsp;CallbackHandler}&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;should&nbsp;use.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;handler&nbsp;The&nbsp;{@code&nbsp;CallbackHandler}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;auth&nbsp;module&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationModuleBuilder&nbsp;callbackHandler(CallbackHandler&nbsp;handler)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handler&nbsp;=&nbsp;handler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;settings&nbsp;that&nbsp;contain&nbsp;configuration&nbsp;information&nbsp;that&nbsp;the&nbsp;auth&nbsp;module&nbsp;will&nbsp;use<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;configure&nbsp;itself.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;settings&nbsp;The&nbsp;auth&nbsp;module&nbsp;settings.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;This&nbsp;auth&nbsp;module&nbsp;builder&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationModuleBuilder&nbsp;withSettings(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;settings)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.settings&nbsp;=&nbsp;settings;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkAuthenticationFrameworkjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFramework.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFramework.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/AuthenticationFramework.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,305&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_TRAIL_KEY;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthContexts.*;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.isSendFailure;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.isSuccess;<br>
+import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.security.Principal;<br>
+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.HashSet;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.http.Context;<br>
+import&nbsp;org.forgerock.http.Handler;<br>
+import&nbsp;org.forgerock.http.HttpContext;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.http.protocol.ResponseException;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+import&nbsp;org.forgerock.util.promise.AsyncFunction;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.slf4j.LoggerFactory;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;An&nbsp;authentication&nbsp;framework&nbsp;for&nbsp;protecting&nbsp;all&nbsp;types&nbsp;of&nbsp;resources.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;authentication&nbsp;framework&nbsp;can&nbsp;be&nbsp;configured&nbsp;with&nbsp;a&nbsp;single&nbsp;session&nbsp;authentication&nbsp;module,<br>
+&nbsp;*&nbsp;which&nbsp;will&nbsp;authenticate&nbsp;requests&nbsp;based&nbsp;on&nbsp;some&nbsp;session&nbsp;identifier,&nbsp;and&nbsp;an&nbsp;ordered&nbsp;list&nbsp;of<br>
+&nbsp;*&nbsp;authentication&nbsp;modules,&nbsp;that&nbsp;are&nbsp;executed&nbsp;in&nbsp;order&nbsp;on&nbsp;a&nbsp;first&nbsp;succeeds&nbsp;wins&nbsp;basis.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;The&nbsp;authentication&nbsp;framework&nbsp;must&nbsp;be&nbsp;configured&nbsp;with&nbsp;a&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;AuditApi}<br>
+&nbsp;*&nbsp;instance,&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;audit&nbsp;authentication&nbsp;outcomes.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+public&nbsp;final&nbsp;class&nbsp;AuthenticationFramework&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Runtime&nbsp;slf4j&nbsp;debug&nbsp;logger.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;Logger&nbsp;LOG&nbsp;=&nbsp;LoggerFactory.getLogger(AuthenticationFramework.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Indicates&nbsp;that&nbsp;the&nbsp;request&nbsp;could&nbsp;not&nbsp;be&nbsp;authenticated&nbsp;either&nbsp;because&nbsp;no&nbsp;credentials&nbsp;were<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;provided&nbsp;or&nbsp;the&nbsp;credentials&nbsp;provided&nbsp;did&nbsp;not&nbsp;pass&nbsp;authentication.&nbsp;Equivalent&nbsp;to&nbsp;HTTP<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;status:&nbsp;401&nbsp;Unauthorized.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;int&nbsp;UNAUTHORIZED_HTTP_ERROR_CODE&nbsp;=&nbsp;401;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;exception&nbsp;message&nbsp;for&nbsp;a&nbsp;401&nbsp;ResourceException.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;UNAUTHORIZED_ERROR_MESSAGE&nbsp;=&nbsp;&amp;quot;Access&nbsp;Denied&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;principal&nbsp;name&nbsp;of&nbsp;the&nbsp;user/client<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;making&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;set.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_PRINCIPAL&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.principal&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;any&nbsp;additional&nbsp;authentication&nbsp;context<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;information&nbsp;will&nbsp;be&nbsp;set.&nbsp;It&nbsp;MUST&nbsp;contain&nbsp;a&nbsp;{@code&nbsp;Map}&nbsp;if&nbsp;present.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_CONTEXT&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.context&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;unique&nbsp;id&nbsp;of&nbsp;the&nbsp;request&nbsp;will&nbsp;be<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;set.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_REQUEST_ID&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.request.id&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;REQUIRED_MESSAGE_TYPES_SUPPORT&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;(Arrays.asList(Request.class,&nbsp;Response.class));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuditApi&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;FailureResponseHandler&nbsp;responseHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AsyncServerAuthContext&nbsp;authContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Subject&nbsp;serviceSubject;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;JaspiRuntime}&nbsp;instance&nbsp;that&nbsp;will&nbsp;use&nbsp;the&nbsp;configured&nbsp;{@code&nbsp;authContext}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;authenticate&nbsp;incoming&nbsp;request&nbsp;and&nbsp;secure&nbsp;outgoing&nbsp;response&nbsp;messages.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;AuditApi}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;responseHandler&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;FailureResponseHandler}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authContext&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;{@link&nbsp;AsyncServerAuthContext}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;The&nbsp;non-{@code&nbsp;null}&nbsp;service&nbsp;{@link&nbsp;Subject}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;initializationPromise&nbsp;A&nbsp;{@link&nbsp;Promise}&nbsp;which&nbsp;will&nbsp;be&nbsp;completed&nbsp;once&nbsp;the&nbsp;configured<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth&nbsp;modules&nbsp;have&nbsp;been&nbsp;initialised.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework(Logger&nbsp;logger,&nbsp;AuditApi&nbsp;auditApi,&nbsp;FailureResponseHandler&nbsp;responseHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext,&nbsp;Subject&nbsp;serviceSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(logger,&nbsp;auditApi,&nbsp;responseHandler,&nbsp;authContext,&nbsp;serviceSubject,&nbsp;initializationPromise);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseHandler&nbsp;=&nbsp;responseHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authContext&nbsp;=&nbsp;withValidation(withAuditing(withLogging(logger,&nbsp;authContext)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.serviceSubject&nbsp;=&nbsp;serviceSubject;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.initializationPromise&nbsp;=&nbsp;initializationPromise;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Authenticates&nbsp;incoming&nbsp;request&nbsp;messages&nbsp;and&nbsp;if&nbsp;successful&nbsp;calls&nbsp;the&nbsp;downstream&nbsp;filter&nbsp;or<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;handler&nbsp;and&nbsp;then&nbsp;secures&nbsp;the&nbsp;returned&nbsp;response.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;The&nbsp;request&nbsp;context.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;request.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;next&nbsp;The&nbsp;downstream&nbsp;filter&nbsp;or&nbsp;handler&nbsp;in&nbsp;the&nbsp;chain&nbsp;that&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;if&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;was&nbsp;successfully&nbsp;authenticated.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;{@code&nbsp;Promise}&nbsp;representing&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;client.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;processMessage(Context&nbsp;context,&nbsp;Request&nbsp;request,&nbsp;final&nbsp;Handler&nbsp;next)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;new&nbsp;AuditTrail(auditApi,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;MessageContextImpl&nbsp;messageContext&nbsp;=&nbsp;new&nbsp;MessageContextImpl(context,&nbsp;request,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;these&nbsp;need&nbsp;to&nbsp;be&nbsp;gone...<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageContext.getRequestContextMap().put(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageContext.getRequestContextMap().put(AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;initializationPromise<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(onInitializationSuccess(messageContext,&nbsp;clientSubject,&nbsp;next),&nbsp;onFailure(messageContext));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncFunction&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;Response,&nbsp;ResponseException&amp;gt;&nbsp;onInitializationSuccess(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;MessageContext&nbsp;context,&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Handler&nbsp;next)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AsyncFunction&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;Response,&nbsp;ResponseException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;apply(List&amp;lt;Void&amp;gt;&nbsp;voids)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;validateRequest(context,&nbsp;clientSubject,&nbsp;next)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAlways(new&nbsp;Runnable()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;run()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Handler&nbsp;next)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(processResult(context,&nbsp;clientSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(onValidateRequestSuccess(context,&nbsp;next),&nbsp;onFailure(context));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;processResult(final&nbsp;MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.getResponse().setStatusAndReason(401);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Authentication&nbsp;has&nbsp;failed.&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(UNAUTHORIZED_HTTP_ERROR_CODE,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNAUTHORIZED_ERROR_MESSAGE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;AuthenticationException(jre));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principalName&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principalName&nbsp;=&nbsp;principal.getName();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getMap(context.getRequestContextMap(),&nbsp;AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Setting&nbsp;principal&nbsp;name,&nbsp;{},&nbsp;and&nbsp;{}&nbsp;context&nbsp;values&nbsp;on&nbsp;to&nbsp;the&nbsp;request.&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principalName,&nbsp;contextMap.size());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestAttributes&nbsp;=&nbsp;context.asContext(HttpContext.class).getAttributes();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestAttributes.put(AuthenticationFramework.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;principalName);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestAttributes.put(AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;Response,&nbsp;ResponseException&amp;gt;&nbsp;onValidateRequestSuccess(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;MessageContext&nbsp;context,&nbsp;final&nbsp;Handler&nbsp;next)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;Response,&nbsp;ResponseException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;context.getAuditTrail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.asContext(HttpContext.class).getAttributes()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.put(AuthenticationFramework.ATTRIBUTE_REQUEST_ID,&nbsp;auditTrail.getRequestId());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;grantAccess(context,&nbsp;next);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(context.getResponse());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;grantAccess(final&nbsp;MessageContext&nbsp;context,&nbsp;Handler&nbsp;next)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;next.handle(context,&nbsp;context.getRequest())<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;Response,&nbsp;Response,&nbsp;ResponseException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;apply(Response&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.setResponse(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;secureResponse(context);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;new&nbsp;AsyncFunction&amp;lt;ResponseException,&nbsp;Response,&nbsp;ResponseException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;apply(ResponseException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.setResponse(error.getResponse());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;secureResponse(context);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;secureResponse(final&nbsp;MessageContext&nbsp;context)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(onSecureResponseSuccess(context),&nbsp;onFailure(context));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;Response,&nbsp;ResponseException&amp;gt;&nbsp;onSecureResponseSuccess(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;MessageContext&nbsp;context)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;Response,&nbsp;ResponseException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.getResponse().setStatusAndReason(500);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(context.getResponse());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncFunction&amp;lt;AuthenticationException,&nbsp;Response,&nbsp;ResponseException&amp;gt;&nbsp;onFailure(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;MessageContext&nbsp;context)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AsyncFunction&amp;lt;AuthenticationException,&nbsp;Response,&nbsp;ResponseException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;apply(AuthenticationException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(error.getCause()&nbsp;instanceof&nbsp;ResourceException)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;(ResourceException)&nbsp;error.getCause();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.INTERNAL_ERROR,&nbsp;error.getMessage());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;context.getAuditTrail();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;auditTrail.getFailureReasons();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReasonList&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!failureReasonList.isEmpty())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;failureReasons&amp;quot;,&nbsp;failureReasonList))));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;responseHandler.handle(jre,&nbsp;context);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(new&nbsp;ResponseException(context.getResponse(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error.getMessage(),&nbsp;error));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;containingMap,&nbsp;String&nbsp;key)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;containingMap.get(key);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containingMap.put(key,&nbsp;map);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;map;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;AuthContext:&nbsp;&amp;quot;&nbsp;+&nbsp;authContext.toString()&nbsp;+&nbsp;&amp;quot;,&nbsp;Response&nbsp;Handlers:&nbsp;&amp;quot;&nbsp;+&nbsp;responseHandler.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextFactoryjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextFactory.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,36&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2014-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;A&nbsp;factory&nbsp;which&nbsp;is&nbsp;responsible&nbsp;for&nbsp;creating&nbsp;{@code&nbsp;ServerAuthContext}s&nbsp;for&nbsp;authenticating&nbsp;requests.<br>
-&nbsp;*/<br>
-public&nbsp;interface&nbsp;ContextFactory&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Returns&nbsp;the&nbsp;context&nbsp;which&nbsp;should&nbsp;be&nbsp;used&nbsp;to&nbsp;authenticate&nbsp;requests.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;method&nbsp;is&nbsp;called&nbsp;for&nbsp;each&nbsp;request.&nbsp;This&nbsp;means&nbsp;that&nbsp;the&nbsp;{@code&nbsp;ServerAuthContext}&nbsp;instance&nbsp;can&nbsp;be<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;changed/updated&nbsp;with&nbsp;new&nbsp;ServerAuthModules&nbsp;and&nbsp;any&nbsp;changes&nbsp;will&nbsp;be&nbsp;picked&nbsp;up&nbsp;by&nbsp;the&nbsp;runtime&nbsp;for&nbsp;subsequent<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;requests.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;context&nbsp;which&nbsp;should&nbsp;be&nbsp;used&nbsp;for&nbsp;authenticating&nbsp;requests.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;getContext();<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkContextHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ContextHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,157&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.security.Principal;<br>
-import&nbsp;java.util.Arrays;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;A&nbsp;handler&nbsp;for&nbsp;ServerAuthContext,&nbsp;which&nbsp;exposes&nbsp;helper&nbsp;methods&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;at&nbsp;the&nbsp;varying&nbsp;end&nbsp;states<br>
-&nbsp;*&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;processing.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;ContextHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constant&nbsp;for&nbsp;the&nbsp;list&nbsp;of&nbsp;auth&nbsp;module&nbsp;failure&nbsp;reasons.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;FAILURE_REASONS&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ContextHandler(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Validates&nbsp;that&nbsp;each&nbsp;given&nbsp;ServerAuthModule&nbsp;conforms&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile&nbsp;by&nbsp;calling&nbsp;each<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;modules&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;and&nbsp;ensuring&nbsp;it&nbsp;contains&nbsp;both&nbsp;the&nbsp;HttpServletRequest&nbsp;and<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;HttpServletResponse&nbsp;classes.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;List&nbsp;of&nbsp;ServerAuthModules&nbsp;to&nbsp;check.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;ServerAuthModules&nbsp;does&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModuleConformToHttpServletProfile(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkAuthModuleSupportsHttpServletProfile(authModule);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Validates&nbsp;that&nbsp;the&nbsp;given&nbsp;ServerAuthModule&nbsp;conforms&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile&nbsp;by&nbsp;calling&nbsp;the&nbsp;module's<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;and&nbsp;ensuring&nbsp;it&nbsp;contains&nbsp;both&nbsp;the&nbsp;HttpServletRequest&nbsp;and&nbsp;HttpServletResponse<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;classes.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;ServerAuthModule&nbsp;to&nbsp;check.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;the&nbsp;ServerAuthModule&nbsp;does&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;checkAuthModuleSupportsHttpServletProfile(final&nbsp;ServerAuthModule&nbsp;authModule)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModule&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Class&amp;gt;&nbsp;supportedTypes&nbsp;=&nbsp;Arrays.asList(authModule.getSupportedMessageTypes());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(supportedTypes.contains(HttpServletRequest.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;amp;&amp;amp;&nbsp;supportedTypes.contains(HttpServletResponse.class)))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;ServerAuthModule&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;HttpServlet&nbsp;profile,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModule.getClass().getName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;ServerAuthModule&nbsp;does&nbsp;not&nbsp;support&nbsp;the&nbsp;HttpServlet&nbsp;profile,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authModule.getClass().getName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;completion&nbsp;of&nbsp;an&nbsp;authentication&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Checks&nbsp;if&nbsp;the&nbsp;authentication&nbsp;resulted&nbsp;in&nbsp;a&nbsp;valid&nbsp;AuthStatus&nbsp;and&nbsp;if&nbsp;not&nbsp;will&nbsp;write&nbsp;a&nbsp;401&nbsp;Unauthorized&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;the&nbsp;HttpServletResponse&nbsp;stored&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;object.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Otherwise&nbsp;will&nbsp;set&nbsp;the&nbsp;authentication&nbsp;attributes,&nbsp;principal&nbsp;name&nbsp;and&nbsp;authentication&nbsp;context&nbsp;map,&nbsp;in&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;object.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;Client&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;AuthStatus&nbsp;of&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;problem&nbsp;writing&nbsp;to&nbsp;the&nbsp;response.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleCompletion(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;authStatus)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Authentication&nbsp;has&nbsp;failed.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(UNAUTHORIZED_HTTP_ERROR_CODE,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNAUTHORIZED_ERROR_MESSAGE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(jre);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setAuthenticationRequestAttributes(messageInfo,&nbsp;clientSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Sets&nbsp;the&nbsp;authentication&nbsp;id&nbsp;and&nbsp;context&nbsp;map&nbsp;into&nbsp;the&nbsp;HttpServletRequest,&nbsp;as&nbsp;attributes,&nbsp;for&nbsp;use&nbsp;by&nbsp;other<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;filters&nbsp;and&nbsp;resources.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Will&nbsp;take&nbsp;the&nbsp;first&nbsp;Principal&nbsp;it&nbsp;finds&nbsp;in&nbsp;the&nbsp;client&nbsp;Subject&nbsp;and&nbsp;add&nbsp;the&nbsp;Principal's&nbsp;name&nbsp;to&nbsp;the&nbsp;authentication<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;context.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;object.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;Client&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;setAuthenticationRequestAttributes(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principalName&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principalName&nbsp;=&nbsp;principal.getName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;context&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Setting&nbsp;principal&nbsp;name,&nbsp;{},&nbsp;and&nbsp;{}&nbsp;context&nbsp;values&nbsp;on&nbsp;to&nbsp;the&nbsp;request.&amp;quot;,&nbsp;principalName,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.size());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;principalName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;context);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FailureResponseHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,10&nbsp;+16,6&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authentication.framework;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.math.BigDecimal;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.ArrayList;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Arrays;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-30,17&nbsp;+26,18&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.regex.Matcher;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.regex.Pattern;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;com.fasterxml.jackson.databind.ObjectMapper;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.header.ContentTypeHeader;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.ResourceException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;A&nbsp;handler&nbsp;class&nbsp;for&nbsp;rendering&nbsp;failures&nbsp;in&nbsp;the&nbsp;most&nbsp;acceptable&nbsp;supported&nbsp;content&nbsp;type.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-public&nbsp;class&nbsp;FailureResponseHandler&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+class&nbsp;FailureResponseHandler&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;ObjectMapper&nbsp;OBJECT_MAPPER&nbsp;=&nbsp;new&nbsp;ObjectMapper();<br>
-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;Pattern&nbsp;ACCEPT_HEADER&nbsp;=&nbsp;Pattern.compile(&amp;quot;(?:(?:[^\&amp;quot;,]*|(?:.*[^\\\\]\&amp;quot;.*[^\\\\]\&amp;quot;.*)))(&nbsp;*,&nbsp;*)&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;MediaType&nbsp;WILDCARD&nbsp;=&nbsp;MediaType.parse(&amp;quot;*/*&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;QUALITY_PARAMETER&nbsp;=&nbsp;&amp;quot;q&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-64,7&nbsp;+61,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;ResourceExceptionHandler&amp;gt;&nbsp;handlers&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ResourceExceptionHandler&amp;gt;();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;JsonResourceExceptionHandler&nbsp;defaultHandler;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FailureResponseHandler()&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler()&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultHandler&nbsp;=&nbsp;new&nbsp;JsonResourceExceptionHandler();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handlers.add(defaultHandler);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-74,16&nbsp;+71,15&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;handler&nbsp;is&nbsp;selected.&nbsp;If&nbsp;no&nbsp;specific&nbsp;handler&nbsp;is&nbsp;found,&nbsp;or&nbsp;if&nbsp;the&nbsp;highest&nbsp;quality&nbsp;accepted&nbsp;content&nbsp;type&nbsp;is<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;\*\/\*},&nbsp;then&nbsp;the&nbsp;{@code&nbsp;JsonResourceExceptionHandler}&nbsp;is&nbsp;used.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;jre<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handle(ResourceException&nbsp;jre,&nbsp;MessageInfo&nbsp;messageInfo)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;messageInfo.getRequestMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;handle(ResourceException&nbsp;jre,&nbsp;MessageContext&nbsp;context)&nbsp;&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;context.getRequest();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;response&nbsp;=&nbsp;context.getResponse();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(jre.getCode());<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatusAndReason(jre.getCode());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;acceptHeader&nbsp;=&nbsp;request.getHeader(&amp;quot;Accept&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;acceptHeader&nbsp;=&nbsp;request.getHeaders().getFirst(&amp;quot;Accept&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(acceptHeader&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SortedSet&amp;lt;MediaType&amp;gt;&nbsp;acceptedTypes&nbsp;=&nbsp;new&nbsp;TreeSet&amp;lt;MediaType&amp;gt;(ACCEPT_QUALITY_COMPARATOR);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matcher&nbsp;m&nbsp;=&nbsp;ACCEPT_HEADER.matcher(acceptHeader);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-114,22&nbsp;+110,17&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Register&nbsp;a&nbsp;class&nbsp;to&nbsp;handle&nbsp;{@code&nbsp;ResourceException}s.<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;handlerClass&nbsp;The&nbsp;implementation&nbsp;class.<br>
&lt;/del&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;handler&nbsp;The&nbsp;{@code&nbsp;ResourceExceptionHandler}.<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;registerExceptionHandler(Class&amp;lt;?&nbsp;extends&nbsp;ResourceExceptionHandler&amp;gt;&nbsp;handlerClass)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handlers.add(handlerClass.newInstance());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(InstantiationException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalArgumentException(&amp;quot;Cannot&nbsp;instantiate&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClass.getName(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IllegalAccessException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;IllegalArgumentException(&amp;quot;Cannot&nbsp;access&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClass.getName(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;registerExceptionHandler(ResourceExceptionHandler&nbsp;handler)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handlers.add(handler);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;default&nbsp;implementation&nbsp;of&nbsp;{@code&nbsp;ResourceExceptionHandler}&nbsp;that&nbsp;renders&nbsp;the&nbsp;exception&nbsp;to&nbsp;JSON.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;class&nbsp;JsonResourceExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;class&nbsp;JsonResourceExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;List&amp;lt;MediaType&amp;gt;&nbsp;MEDIA_TYPES&nbsp;=&nbsp;Arrays.asList(<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MediaType.JSON_UTF_8,<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-139,10&nbsp;+130,19&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MEDIA_TYPES;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;jre,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setContentType(&amp;quot;application/json&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setCharacterEncoding(&amp;quot;UTF-8&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_MAPPER.writeValue(response.getWriter(),&nbsp;jre.includeCauseInJsonValue().toJsonValue().asMap());<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;jre,&nbsp;Response&nbsp;response)&nbsp;&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.getHeaders().putSingle(ContentTypeHeader.valueOf(&amp;quot;application/json;&nbsp;charset=UTF-8&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setEntity(jre.includeCauseInJsonValue().toJsonValue().asMap());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MEDIA_TYPES.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;ins&gt;+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;Registered&nbsp;Handlers:&nbsp;&amp;quot;&nbsp;+&nbsp;handlers.toString()&nbsp;+&nbsp;&amp;quot;,&nbsp;Default&nbsp;Handler:&nbsp;&amp;quot;&nbsp;+&nbsp;defaultHandler.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFallbackAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackAuthContext.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,235&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthModules.*;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.util.ArrayList;<br>
+import&nbsp;java.util.List;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthContextWithState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+import&nbsp;org.forgerock.util.promise.AsyncFunction;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.PromiseImpl;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.forgerock.util.promise.SuccessHandler;<br>
+import&nbsp;org.slf4j.Logger;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;An&nbsp;{@link&nbsp;AsyncServerAuthContext}&nbsp;which&nbsp;manages&nbsp;a&nbsp;{@code&nbsp;List}&nbsp;of<br>
+&nbsp;*&nbsp;{@link&nbsp;AsyncServerAuthModule}s&nbsp;that&nbsp;are&nbsp;in&nbsp;a&nbsp;desired&nbsp;order&nbsp;of&nbsp;preference&nbsp;for&nbsp;authenticating<br>
+&nbsp;*&nbsp;incoming&nbsp;request&nbsp;messages.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Order&nbsp;matters&nbsp;as&nbsp;one&nbsp;and&nbsp;only&nbsp;one&nbsp;auth&nbsp;module&nbsp;can&nbsp;successfully&nbsp;authenticate&nbsp;the&nbsp;request<br>
+&nbsp;*&nbsp;message.&nbsp;Each&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;is&nbsp;called&nbsp;in&nbsp;order&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;request<br>
+&nbsp;*&nbsp;message&nbsp;and&nbsp;processing&nbsp;stops&nbsp;after&nbsp;the&nbsp;first&nbsp;auth&nbsp;module&nbsp;that&nbsp;successfully&nbsp;authenticates&nbsp;the<br>
+&nbsp;*&nbsp;request&nbsp;message,&nbsp;or&nbsp;returns&nbsp;a&nbsp;failed&nbsp;promise&nbsp;with&nbsp;an&nbsp;{@link&nbsp;AuthenticationException}.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;&amp;lt;p&amp;gt;Order&nbsp;does&nbsp;not&nbsp;matter&nbsp;when&nbsp;securing&nbsp;the&nbsp;as&nbsp;only&nbsp;the&nbsp;auth&nbsp;module&nbsp;that&nbsp;successfully<br>
+&nbsp;*&nbsp;authenticated&nbsp;the&nbsp;incoming&nbsp;request&nbsp;message&nbsp;will&nbsp;get&nbsp;the&nbsp;opportunity&nbsp;to&nbsp;secure&nbsp;the&nbsp;response<br>
+&nbsp;*&nbsp;message.&amp;lt;/p&amp;gt;<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+public&nbsp;final&nbsp;class&nbsp;FallbackAuthContext&nbsp;implements&nbsp;AsyncServerAuthContext,&nbsp;AuthContextWithState&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;FallbackAuthContext}&nbsp;managing&nbsp;the&nbsp;provided<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;AsyncServerAuthModule}s.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@link&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;{@code&nbsp;List}&nbsp;of&nbsp;{@code&nbsp;AsyncServerAuthModule}s.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FallbackAuthContext(Logger&nbsp;logger,&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(logger,&nbsp;authModules);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModules&nbsp;=&nbsp;withValidation(withAuditing(withLogging(logger,&nbsp;authModules)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Authenticates&nbsp;the&nbsp;incoming&nbsp;request&nbsp;message&nbsp;by&nbsp;calling&nbsp;each&nbsp;{@code&nbsp;AsyncServerAuthModule}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;in&nbsp;order&nbsp;until&nbsp;an&nbsp;auth&nbsp;module&nbsp;returns&nbsp;an&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;other&nbsp;than<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;SEND_FAILURE},&nbsp;or&nbsp;returns&nbsp;an&nbsp;{@code&nbsp;AuthenticationException}&nbsp;or&nbsp;the&nbsp;end&nbsp;of&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;module&nbsp;list&nbsp;is&nbsp;reached.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;module&nbsp;list&nbsp;is&nbsp;reached&nbsp;then&nbsp;an&nbsp;{@code&nbsp;AuthStatus}&nbsp;value&nbsp;of<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;SEND_FAILURE}&nbsp;is&nbsp;returned.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FallbackAuthContextState&nbsp;state&nbsp;=&nbsp;context.getState(this);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;FallbackChain(logger,&nbsp;authModules,&nbsp;0,&nbsp;state).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;FallbackChain&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;int&nbsp;position;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;FallbackAuthContextState&nbsp;state;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackChain(Logger&nbsp;logger,&nbsp;List&amp;lt;AsyncServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;int&nbsp;position,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FallbackAuthContextState&nbsp;state)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModules&nbsp;=&nbsp;authModules;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.position&nbsp;=&nbsp;position;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.state&nbsp;=&nbsp;state;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(final&nbsp;MessageContextInfo&nbsp;messageInfo,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(position&nbsp;&amp;lt;&nbsp;authModules.size())&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;authModules.get(position);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.onSuccess(new&nbsp;SuccessHandler&amp;lt;AuthStatus&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSuccess(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Save&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;authenticating&nbsp;module&nbsp;so&nbsp;that&nbsp;it&nbsp;can<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;retrieved&nbsp;when&nbsp;securing&nbsp;the&nbsp;response<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.trace(&amp;quot;Adding&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;to&nbsp;private&nbsp;context&nbsp;map,&nbsp;{}&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModule.getClass().getSimpleName());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.setAuthenticatedAuthModuleIndex(position);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;AuthStatus,&nbsp;AuthStatus,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isSendFailure(authStatus))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;next().validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackChain&nbsp;next()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;FallbackChain(logger,&nbsp;authModules,&nbsp;position&nbsp;+&nbsp;1,&nbsp;state);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Secures&nbsp;the&nbsp;response&nbsp;message&nbsp;using&nbsp;the&nbsp;same&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;that<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authenticated&nbsp;the&nbsp;incoming&nbsp;request&nbsp;message.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;no&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;authenticated&nbsp;the&nbsp;incoming&nbsp;request&nbsp;message,&nbsp;then&nbsp;this<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;method&nbsp;should&nbsp;not&nbsp;have&nbsp;been&nbsp;called&nbsp;and&nbsp;a&nbsp;failed&nbsp;promise&nbsp;will&nbsp;be&nbsp;return&nbsp;with&nbsp;an<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@code&nbsp;AuthenticationException}.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContext&nbsp;context,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FallbackAuthContextState&nbsp;state&nbsp;=&nbsp;context.getState(this);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(state.getAuthenticatedAuthModuleIndex()&nbsp;&amp;lt;&nbsp;0)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;No&nbsp;auth&nbsp;module&nbsp;authenticated&nbsp;the&nbsp;incoming&nbsp;request&nbsp;message.&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;Cannot&nbsp;secure&nbsp;response&nbsp;message.&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;authModules.get(state.getAuthenticatedAuthModuleIndex());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(&amp;quot;Using&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;from&nbsp;private&nbsp;context&nbsp;map,&nbsp;{},&nbsp;to&nbsp;secure&nbsp;the&nbsp;response&amp;quot;,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModule.getModuleId());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule.secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;each&nbsp;{@code&nbsp;AsyncServerAuthContext}&nbsp;in&nbsp;parallel&nbsp;to&nbsp;clean&nbsp;the&nbsp;client&nbsp;subject&nbsp;and<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;only&nbsp;return&nbsp;a&nbsp;successful&nbsp;promise&nbsp;if&nbsp;all&nbsp;complete&nbsp;successfully&nbsp;otherwise&nbsp;returns&nbsp;the&nbsp;first<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exception&nbsp;in&nbsp;a&nbsp;failed&nbsp;promise.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&amp;gt;&nbsp;promises&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PromiseImpl&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;kicker&nbsp;=&nbsp;PromiseImpl.create();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promises.add(kicker);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(AsyncServerAuthModule&nbsp;serverAuthModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promises.add(serverAuthModule.cleanSubject(context,&nbsp;clientSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;when&nbsp;=&nbsp;Promises.when(promises)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAsync(new&nbsp;AsyncFunction&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;Void,&nbsp;AuthenticationException&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;apply(List&amp;lt;Void&amp;gt;&nbsp;voids)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kicker.handleResult(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;when;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FallbackAuthContextState&nbsp;createAuthenticationState()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;FallbackAuthContextState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;FallbackAuthContextState&nbsp;extends&nbsp;AuthenticationState&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;AUTHENTICATION_AUTH_MODULE_INDEX&nbsp;=&nbsp;&amp;quot;authenticatedAuthModuleIndex&amp;quot;;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;setAuthenticatedAuthModuleIndex(int&nbsp;authenticatedAuthModuleIndex)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add(AUTHENTICATION_AUTH_MODULE_INDEX,&nbsp;authenticatedAuthModuleIndex);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;int&nbsp;getAuthenticatedAuthModuleIndex()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isDefined(AUTHENTICATION_AUTH_MODULE_INDEX))&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;get(AUTHENTICATION_AUTH_MODULE_INDEX).asInteger();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModules.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,203&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.*;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.asString;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.Collections;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Encapsulates&nbsp;ServerAuthModules&nbsp;that&nbsp;are&nbsp;used&nbsp;to&nbsp;validate&nbsp;service&nbsp;requests&nbsp;received&nbsp;from&nbsp;clients,&nbsp;and&nbsp;to&nbsp;secure&nbsp;any<br>
-&nbsp;*&nbsp;response&nbsp;returned&nbsp;for&nbsp;those&nbsp;requests.<br>
-&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;*&nbsp;This&nbsp;FallbackServerAuthContext&nbsp;can&nbsp;be&nbsp;configured&nbsp;to&nbsp;use&nbsp;a&nbsp;single&nbsp;Session&nbsp;ServerAuthModule,&nbsp;to&nbsp;provide&nbsp;session<br>
-&nbsp;*&nbsp;capabilities&nbsp;(i.e.&nbsp;on&nbsp;secureResponse&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;which&nbsp;is&nbsp;validated&nbsp;on&nbsp;subsequent&nbsp;request&nbsp;to&nbsp;skip&nbsp;re-authenticating<br>
-&nbsp;*&nbsp;for&nbsp;each&nbsp;request),&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;ServerAuthModule&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;in&nbsp;order&nbsp;until&nbsp;one&nbsp;returns&nbsp;a&nbsp;non-failure<br>
-&nbsp;*&nbsp;AuthStatus,&nbsp;or&nbsp;the&nbsp;list&nbsp;is&nbsp;exhausted.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;FallbackServerAuthContext&nbsp;extends&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;String&nbsp;AUTHENTICATING_AUTH_MODULE_KEY&nbsp;=&nbsp;&amp;quot;authenticatingAuthModule&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;FallbackServerAuthContext&nbsp;instance.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;The&nbsp;configured&nbsp;Session&nbsp;AuthModule.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configure&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;do&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;FallbackServerAuthContext(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule,&nbsp;final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,&nbsp;authModules);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;logic&nbsp;used&nbsp;to&nbsp;determine&nbsp;which&nbsp;of&nbsp;the&nbsp;list&nbsp;of&nbsp;ServerAuthModules&nbsp;are&nbsp;called&nbsp;is&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;Modules&nbsp;are&nbsp;called&nbsp;in&nbsp;insertion&nbsp;order&nbsp;in&nbsp;the&nbsp;list.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SUCCESS&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_SUCCESS&nbsp;the&nbsp;module&nbsp;has&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;and&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_CONTINUE&nbsp;the&nbsp;context&nbsp;will&nbsp;return&nbsp;the&nbsp;AuthStatus&nbsp;without&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;subsequent&nbsp;modules.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;module&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;the&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client&nbsp;and<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;context&nbsp;will&nbsp;call&nbsp;the&nbsp;next&nbsp;subsequent&nbsp;module.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;modules&nbsp;in&nbsp;the&nbsp;configured&nbsp;list&nbsp;the&nbsp;last&nbsp;AuthStatus&nbsp;is&nbsp;returned&nbsp;and&nbsp;processing<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stops..&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;index&nbsp;=&nbsp;0;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;authModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;&amp;quot;AuthModule-&amp;quot;&nbsp;+&nbsp;authModule.getClass().getSimpleName()&nbsp;+&nbsp;&amp;quot;-&amp;quot;&nbsp;+&nbsp;index++;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;doValidateRequest(authModule,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject,&nbsp;moduleId,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Record&nbsp;the&nbsp;AuthModules&nbsp;AuthStatus&nbsp;to&nbsp;decided&nbsp;later&nbsp;whether&nbsp;to&nbsp;call&nbsp;secureResponse&nbsp;on&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;AuthModule.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authenticatingAuthModule&nbsp;=&nbsp;authModule;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;put&nbsp;authStatus&nbsp;and&nbsp;authenticatingAuthModule&nbsp;in&nbsp;MessageInfo&nbsp;so&nbsp;can&nbsp;accessed&nbsp;by&nbsp;secureResponse&nbsp;in&nbsp;a<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;stateless&nbsp;way<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Adding&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;to&nbsp;private&nbsp;context&nbsp;map,&nbsp;{}&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authenticatingAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authContextMap&nbsp;=&nbsp;getMessageInfoUtils().getMap(messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIVATE_CONTEXT_MAP_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContextMap.put(AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authenticatingAuthModule);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;emptyMap(),&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;--&nbsp;In&nbsp;our&nbsp;implementation&nbsp;we&nbsp;will&nbsp;let&nbsp;subsequent&nbsp;modules&nbsp;try&nbsp;before&nbsp;sending&nbsp;the&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticated&nbsp;the&nbsp;client,&nbsp;passing&nbsp;to&nbsp;Auth&nbsp;Modules&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,&nbsp;authModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;In&nbsp;this&nbsp;implementation&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;we&nbsp;are&nbsp;allowing&nbsp;a&nbsp;single&nbsp;&amp;quot;session&amp;quot;&nbsp;auth&nbsp;module&nbsp;to<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;run&nbsp;and&nbsp;possible&nbsp;succeed&nbsp;and&nbsp;if&nbsp;so&nbsp;will&nbsp;stop&nbsp;processing,&nbsp;otherwise&nbsp;we&nbsp;allow&nbsp;a&nbsp;list&nbsp;of&nbsp;&amp;quot;normal&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;modules&nbsp;to&nbsp;try&nbsp;and&nbsp;authenticate&nbsp;the&nbsp;request.&nbsp;Hence&nbsp;why&nbsp;here&nbsp;a&nbsp;SEND_FAILURE&nbsp;will&nbsp;carry&nbsp;on<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;processing,&nbsp;where&nbsp;as&nbsp;SEND_CONTINUE&nbsp;and&nbsp;SEND_SUCCESS&nbsp;will&nbsp;cause&nbsp;processing&nbsp;to&nbsp;end.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;SEND_CONTINUE&nbsp;implies&nbsp;that&nbsp;there&nbsp;is&nbsp;to&nbsp;be&nbsp;more&nbsp;communication&nbsp;between&nbsp;server&nbsp;and&nbsp;client&nbsp;before<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;authentication&nbsp;can&nbsp;be&nbsp;deemed&nbsp;successful&nbsp;or&nbsp;failed.&nbsp;So&nbsp;processing&nbsp;needs&nbsp;to&nbsp;stop&nbsp;and&nbsp;a&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Only&nbsp;the&nbsp;ServerAuthModule&nbsp;which&nbsp;returned&nbsp;AuthStatus.SUCCESS&nbsp;for&nbsp;its&nbsp;#validateRequest&nbsp;method&nbsp;will&nbsp;have&nbsp;its<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;secureResponse&nbsp;method&nbsp;call&nbsp;and&nbsp;if&nbsp;no&nbsp;ServerAuthModule&nbsp;successfully&nbsp;validated&nbsp;the&nbsp;request&nbsp;then&nbsp;this&nbsp;method<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;return&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authContextMap&nbsp;=&nbsp;getMessageInfoUtils().getMap(messageInfo,&nbsp;PRIVATE_CONTEXT_MAP_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;authenticatingAuthModule&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServerAuthModule)&nbsp;authContextMap.remove(AUTHENTICATING_AUTH_MODULE_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;authenticationAuthModule&nbsp;has&nbsp;been&nbsp;set,&nbsp;ie&nbsp;a&nbsp;normal&nbsp;ServerAuthModule&nbsp;successfully&nbsp;validated&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authenticatingAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.trace(&amp;quot;Using&nbsp;authenticating&nbsp;auth&nbsp;module&nbsp;from&nbsp;private&nbsp;context&nbsp;map,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;authenticatingAuthModule.getClass().getSimpleName()&nbsp;+&nbsp;&amp;quot;,&nbsp;to&nbsp;secure&nbsp;the&nbsp;response&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authenticatingAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletCallbackHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletCallbackHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-70,10&nbsp;+70,10&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principal&nbsp;=&nbsp;callerPrincipalCallback.getPrincipal();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;principal.getName());<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;principal.getName());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.getPrincipals().add(principal);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(name&nbsp;!=&nbsp;null)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;name);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;name);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject.getPrincipals().add(new&nbsp;Principal()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getName()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-82,7&nbsp;+82,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Both&nbsp;name&nbsp;and&nbsp;principal&nbsp;are&nbsp;null&nbsp;so&nbsp;not&nbsp;adding&nbsp;either.<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Not&nbsp;adding&nbsp;principal&nbsp;as&nbsp;no&nbsp;name&nbsp;or&nbsp;principal&nbsp;set&nbsp;on&nbsp;callback&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.trace(&amp;quot;Not&nbsp;adding&nbsp;principal&nbsp;as&nbsp;no&nbsp;name&nbsp;or&nbsp;principal&nbsp;set&nbsp;on&nbsp;callback&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(GroupPrincipalCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-98,7&nbsp;+98,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&amp;lt;Principal&amp;gt;&nbsp;principals&nbsp;=&nbsp;subject.getPrincipals();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(final&nbsp;String&nbsp;group&nbsp;:&nbsp;groups)&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;group);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.trace(&amp;quot;Adding&nbsp;principal,&nbsp;{},&nbsp;to&nbsp;Subject&amp;quot;,&nbsp;group);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principals.add(new&nbsp;Principal()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;getName()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-110,23&nbsp;+110,23&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(PasswordValidationCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;JSR-196&nbsp;Spec&nbsp;states&nbsp;this&nbsp;MUST&nbsp;be&nbsp;implemented&nbsp;but&nbsp;as&nbsp;this&nbsp;is&nbsp;not&nbsp;actually&nbsp;a&nbsp;&amp;quot;real&amp;quot;&nbsp;container<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;we&nbsp;don't&nbsp;need&nbsp;to&nbsp;do&nbsp;this&nbsp;here.<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;PasswordValidationCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.error(&amp;quot;PasswordValidationCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(CertStoreCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;CertStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.error(&amp;quot;CertStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(PrivateKeyCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;PrivateKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.error(&amp;quot;PrivateKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SecretKeyCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;SecretKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.error(&amp;quot;SecretKeyCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(TrustStoreCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;TrustStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFramework.LOG.error(&amp;quot;TrustStoreCallback&nbsp;not&nbsp;supported&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UnsupportedCallbackException(callback);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(HttpCallback.class.isAssignableFrom(callback.getClass()))&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//SHOULD&nbsp;implement<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfo.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,112&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletRequestWrapper;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Provides&nbsp;an&nbsp;implementation&nbsp;of&nbsp;a&nbsp;MessageInfo&nbsp;for&nbsp;the&nbsp;HttpServlet&nbsp;profile.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;HttpServletMessageInfo&nbsp;implements&nbsp;MessageInfo&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletRequestWrapper&nbsp;request;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpServletResponseWrapper&nbsp;response;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;properties;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;HttpServletMessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HtwtpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletMessageInfo(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this(request,&nbsp;response,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;HttpServletMessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;properties&nbsp;A&nbsp;Map&nbsp;of&nbsp;properties.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletMessageInfo(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;properties)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setRequestMessage(request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResponseMessage(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.properties&nbsp;=&nbsp;properties;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;request&nbsp;message&nbsp;object&nbsp;from&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;request&nbsp;message,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;request&nbsp;message&nbsp;is&nbsp;set&nbsp;within&nbsp;the&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletRequest&nbsp;getRequestMessage()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;request;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;response&nbsp;message&nbsp;object&nbsp;from&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;response&nbsp;message,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;response&nbsp;message&nbsp;is&nbsp;set&nbsp;within&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletResponse&nbsp;getResponseMessage()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;response;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;request&nbsp;message&nbsp;object&nbsp;in&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;request&nbsp;message.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setRequestMessage(final&nbsp;Object&nbsp;request)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.request&nbsp;=&nbsp;new&nbsp;HttpServletRequestWrapper((HttpServletRequest)&nbsp;request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;the&nbsp;response&nbsp;message&nbsp;object&nbsp;in&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;An&nbsp;object&nbsp;representing&nbsp;the&nbsp;response&nbsp;message.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setResponseMessage(final&nbsp;Object&nbsp;response)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.response&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper((HttpServletResponse)&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;(a&nbsp;reference&nbsp;to)&nbsp;the&nbsp;Map&nbsp;object&nbsp;of&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;Map&nbsp;object&nbsp;of&nbsp;this&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;properties;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiAdaptersjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiAdapters.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiAdapters.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiAdapters.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-234,5&nbsp;+234,4&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;messageContextInfo.getRequestContextMap();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapper.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,72&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Response&nbsp;Wrapper&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;response&nbsp;before&nbsp;the&nbsp;JASPI&nbsp;filter&nbsp;has&nbsp;run<br>
-&nbsp;*&nbsp;secureResponse.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiHttpServletResponseWrapper&nbsp;extends&nbsp;HttpServletResponseWrapper&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;PrintWriter&nbsp;writer;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ServletOutputStream&nbsp;out;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiHttpServletResponseWrapper.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;underlying&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiHttpServletResponseWrapper(final&nbsp;HttpServletResponse&nbsp;response)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Lazily&nbsp;initialises&nbsp;the&nbsp;wrapped&nbsp;underlying&nbsp;response&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ServletOutputStream&nbsp;getOutputStream()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(out&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out&nbsp;=&nbsp;new&nbsp;JaspiServletOutputStream(getResponse().getOutputStream());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;out;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Lasily&nbsp;initialises&nbsp;the&nbsp;wrapped&nbsp;underlying&nbsp;response&nbsp;writer.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;PrintWriter&nbsp;getWriter()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(writer&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer&nbsp;=&nbsp;new&nbsp;JaspiPrintWriter(getResponse().getWriter());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;writer;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiPrintWriter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,37&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Wrapper&nbsp;around&nbsp;a&nbsp;HttpServletResponse's&nbsp;writer&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;writer&nbsp;before&nbsp;the&nbsp;JASPI<br>
-&nbsp;*&nbsp;filter&nbsp;has&nbsp;run&nbsp;secureResponse.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiPrintWriter&nbsp;extends&nbsp;PrintWriter&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiPrintWriter.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;printWriter&nbsp;The&nbsp;underlying&nbsp;PrintWriter.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiPrintWriter(final&nbsp;PrintWriter&nbsp;printWriter)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(printWriter);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimejava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntime.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,209&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.AUDIT_TRAIL_KEY;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.isSendContinue;<br>
-import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.ServletRequest;<br>
-import&nbsp;javax.servlet.ServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.slf4j.Logger;<br>
-import&nbsp;org.slf4j.LoggerFactory;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;class&nbsp;is&nbsp;the&nbsp;entry&nbsp;point&nbsp;for&nbsp;the&nbsp;JASPI&nbsp;runtime.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;Provides&nbsp;a&nbsp;single&nbsp;method&nbsp;#processMessage&nbsp;that&nbsp;takes&nbsp;a&nbsp;HttpServletRequest,&nbsp;HttpServletResponse&nbsp;and&nbsp;the&nbsp;FilterChain<br>
-&nbsp;*&nbsp;and&nbsp;will&nbsp;run&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;request&nbsp;is&nbsp;allowed&nbsp;to&nbsp;be&nbsp;passed&nbsp;down<br>
-&nbsp;*&nbsp;the&nbsp;filter&nbsp;chain.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;&amp;lt;strong&amp;gt;Note:&amp;lt;/strong&amp;gt;&nbsp;if&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;is&nbsp;not&nbsp;configured&nbsp;properly&nbsp;with&nbsp;a&nbsp;non-null&nbsp;ServerAuthContext<br>
-&nbsp;*&nbsp;each&nbsp;request&nbsp;will&nbsp;be&nbsp;passed&nbsp;straight&nbsp;to&nbsp;the&nbsp;filter&nbsp;chain&nbsp;with&nbsp;no&nbsp;further&nbsp;processing.&nbsp;So&nbsp;it&nbsp;is&nbsp;VERY&nbsp;important<br>
-&nbsp;*&nbsp;to&nbsp;ensure&nbsp;the&nbsp;runtime&nbsp;is&nbsp;configured&nbsp;correctly.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiRuntime&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Runtime&nbsp;slf4j&nbsp;debug&nbsp;logger.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;Logger&nbsp;LOG&nbsp;=&nbsp;LoggerFactory.getLogger(JaspiRuntime.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Indicates&nbsp;that&nbsp;the&nbsp;request&nbsp;could&nbsp;not&nbsp;be&nbsp;authenticated&nbsp;either&nbsp;because&nbsp;no&nbsp;credentials&nbsp;were&nbsp;provided&nbsp;or<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;credentials&nbsp;provided&nbsp;did&nbsp;not&nbsp;pass&nbsp;authentication.&nbsp;Equivalent&nbsp;to&nbsp;HTTP&nbsp;status:&nbsp;401&nbsp;Unauthorized.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;int&nbsp;UNAUTHORIZED_HTTP_ERROR_CODE&nbsp;=&nbsp;401;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;exception&nbsp;message&nbsp;for&nbsp;a&nbsp;401&nbsp;ResourceException.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;UNAUTHORIZED_ERROR_MESSAGE&nbsp;=&nbsp;&amp;quot;Access&nbsp;Denied&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;application/json&nbsp;HTTP&nbsp;Media&nbsp;Type.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;JSON_HTTP_MEDIA_TYPE&nbsp;=&nbsp;&amp;quot;application/json&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;principal&nbsp;name&nbsp;of&nbsp;the&nbsp;user/client&nbsp;making&nbsp;the&nbsp;request<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;set.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_PRINCIPAL&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.principal&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;any&nbsp;additional&nbsp;authentication&nbsp;context&nbsp;information<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;will&nbsp;be&nbsp;set.&nbsp;It&nbsp;MUST&nbsp;contain&nbsp;a&nbsp;{@code&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;if&nbsp;present.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_AUTH_CONTEXT&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.context&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;Request&nbsp;attribute&nbsp;where&nbsp;the&nbsp;unique&nbsp;id&nbsp;of&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;set.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;ATTRIBUTE_REQUEST_ID&nbsp;=&nbsp;&amp;quot;org.forgerock.authentication.request.id&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ContextFactory&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;RuntimeResultHandler&nbsp;resultHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AuditApi&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;FailureResponseHandler&nbsp;failureResponseHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;a&nbsp;new&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiRuntime.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextFactory&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;ContextFactory}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;resultHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;RuntimeResultHandler}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditApi}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;failureResponseHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;FailureResponseHandler}.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntime(ContextFactory&nbsp;contextFactory,&nbsp;RuntimeResultHandler&nbsp;resultHandler,&nbsp;AuditApi&nbsp;auditApi,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.resultHandler&nbsp;=&nbsp;resultHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.failureResponseHandler&nbsp;=&nbsp;failureResponseHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Processes&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Guaranteed&nbsp;to&nbsp;call&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;validateRequest&nbsp;method&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;request&nbsp;is<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;allowed&nbsp;through&nbsp;and&nbsp;if&nbsp;validation&nbsp;was&nbsp;successful,&nbsp;to&nbsp;call&nbsp;secureResponse&nbsp;after&nbsp;the&nbsp;service&nbsp;call&nbsp;has&nbsp;completed.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Any&nbsp;authentication&nbsp;exceptions&nbsp;that&nbsp;occur&nbsp;during&nbsp;this&nbsp;process&nbsp;will&nbsp;be&nbsp;caught&nbsp;and&nbsp;converted&nbsp;into&nbsp;a&nbsp;Json&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;that&nbsp;matches&nbsp;a&nbsp;HTTP&nbsp;500&nbsp;status&nbsp;code.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;no&nbsp;ServerAuthContext&nbsp;is&nbsp;configured&nbsp;for&nbsp;the&nbsp;HttpServlet&nbsp;layer&nbsp;and&nbsp;the&nbsp;requests&nbsp;application&nbsp;context,&nbsp;then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;request&nbsp;will&nbsp;be&nbsp;allowed&nbsp;through.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;filterChain&nbsp;The&nbsp;filter&nbsp;chain.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error&nbsp;processing&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;processMessage(final&nbsp;HttpServletRequest&nbsp;request,&nbsp;final&nbsp;HttpServletResponse&nbsp;response,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;FilterChain&nbsp;filterChain)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Must&nbsp;create&nbsp;new&nbsp;client&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Can&nbsp;be&nbsp;null&nbsp;if&nbsp;no&nbsp;details&nbsp;required&nbsp;for&nbsp;service&nbsp;subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;new&nbsp;AuditTrail(auditApi,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().put(AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;requestAuthStatus&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;contextFactory.getContext();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Could&nbsp;be&nbsp;null&nbsp;if&nbsp;no&nbsp;modules&nbsp;found<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(serverAuthContext&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;No&nbsp;ServerAuthContext&nbsp;configured!&nbsp;Jaspi&nbsp;Runtime&nbsp;not&nbsp;configured&nbsp;properly!&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&amp;quot;Proceeding&nbsp;with&nbsp;filter&nbsp;chain&nbsp;call.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter(request,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;This&nbsp;is&nbsp;where&nbsp;the&nbsp;modules&nbsp;are&nbsp;called<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestAuthStatus&nbsp;=&nbsp;serverAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!resultHandler.handleValidateRequestResult(requestAuthStatus,&nbsp;messageInfo,&nbsp;auditTrail,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject,&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage()))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;e;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(JaspiRuntime.ATTRIBUTE_REQUEST_ID,&nbsp;auditTrail.getRequestId());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter((ServletRequest)&nbsp;messageInfo.getRequestMessage(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServletResponse)&nbsp;messageInfo.getResponseMessage());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;responseAuthStatus&nbsp;=&nbsp;serverAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(responseAuthStatus,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(HttpServletResponse)&nbsp;messageInfo.getResponseMessage());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Give&nbsp;the&nbsp;AuthModule&nbsp;a&nbsp;chance&nbsp;to&nbsp;clear&nbsp;out&nbsp;any&nbsp;authentication&nbsp;data&nbsp;from&nbsp;the&nbsp;subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverAuthContext.cleanSubject(messageInfo,&nbsp;clientSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(e.getCause()&nbsp;instanceof&nbsp;ResourceException)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(e.getMessage(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;(ResourceException)&nbsp;e.getCause();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(e.getMessage(),&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.INTERNAL_ERROR,&nbsp;e.getMessage());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Map&amp;lt;String,&nbsp;Object&amp;gt;&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;auditTrail.getFailureReasons();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReasonList&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!failureReasonList.isEmpty())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;failureReasons&amp;quot;,&nbsp;failureReasonList))));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler.handle(jre,&nbsp;messageInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IOException&nbsp;ioe)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(e.getMessage(),&nbsp;ioe);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(ioe.getMessage(),&nbsp;ioe);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isSendContinue(requestAuthStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.audit();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilter.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,194&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
-<br>
-import&nbsp;javax.servlet.Filter;<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.FilterConfig;<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.ServletRequest;<br>
-import&nbsp;javax.servlet.ServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.lang.reflect.Method;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;This&nbsp;Servlet&nbsp;Filter&nbsp;class&nbsp;provides&nbsp;a&nbsp;method&nbsp;of&nbsp;integrating&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;into&nbsp;a&nbsp;Servlet&nbsp;Container,&nbsp;such&nbsp;that<br>
-&nbsp;*&nbsp;requests&nbsp;made&nbsp;to&nbsp;the&nbsp;url&nbsp;this&nbsp;filter&nbsp;is&nbsp;registered&nbsp;at&nbsp;will&nbsp;cause&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;to&nbsp;validate&nbsp;and&nbsp;secure&nbsp;the<br>
-&nbsp;*&nbsp;request&nbsp;and&nbsp;response&nbsp;using&nbsp;it&nbsp;configured&nbsp;{@code&nbsp;ServerAuthModule}s.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;&amp;lt;p&amp;gt;To&nbsp;configure&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;the&nbsp;Servlet&nbsp;Filter&nbsp;registration&nbsp;must&nbsp;contain&nbsp;the&nbsp;configuration&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;{@link&nbsp;ContextFactory}&nbsp;and&nbsp;the&nbsp;{@link&nbsp;AuditApi}.&amp;lt;/p&amp;gt;<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiRuntimeFilter&nbsp;implements&nbsp;Filter&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_CLASS&nbsp;=&nbsp;&amp;quot;context-factory-class&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD&nbsp;=&nbsp;&amp;quot;context-factory-method&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD_DEFAULT&nbsp;=&nbsp;&amp;quot;getContextFactory&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Filter&nbsp;config&nbsp;can&nbsp;register&nbsp;different&nbsp;{@code&nbsp;ResourceException}&nbsp;handlers.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;org.forgerock.caf.authentication.framework.ResourceExceptionHandler<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_EXCEPTION_HANDLERS&nbsp;=&nbsp;&amp;quot;resource-exception-handlers&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_CLASS&nbsp;=&nbsp;&amp;quot;audit-api-factory-class&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_METHOD&nbsp;=&nbsp;&amp;quot;audit-api-factory-method&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;INIT_PARAM_AUDIT_API_METHOD_DEFAULT&nbsp;=&nbsp;&amp;quot;getAuditApi&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextFactory&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiRuntime&nbsp;runtime;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Default&nbsp;constructor&nbsp;called&nbsp;during&nbsp;normal&nbsp;Filter&nbsp;initialization.&nbsp;Implementations&nbsp;MUST&nbsp;override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#getContextFactory(FilterConfig)}&nbsp;and&nbsp;{@link&nbsp;#getAuditApi(FilterConfig)}&nbsp;in&nbsp;order&nbsp;for&nbsp;the&nbsp;HTTP&nbsp;Servlet&nbsp;to<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;function.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntimeFilter()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Creates&nbsp;a&nbsp;new&nbsp;Jaspi&nbsp;HTTP&nbsp;Filter&nbsp;with&nbsp;the&nbsp;provided&nbsp;context&nbsp;factory&nbsp;and&nbsp;audit&nbsp;api.&nbsp;This&nbsp;constructor&nbsp;is&nbsp;provided<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;as&nbsp;a&nbsp;convenience&nbsp;for&nbsp;cases&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;Filter&nbsp;is&nbsp;instantiated&nbsp;programmatically.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;HTTP&nbsp;Filter&nbsp;is&nbsp;created&nbsp;using&nbsp;this&nbsp;constructor&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;need&nbsp;to&nbsp;override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;{@link&nbsp;#getContextFactory(FilterConfig)}&nbsp;or&nbsp;{@link&nbsp;#getAuditApi(FilterConfig)}.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextFactory&nbsp;The&nbsp;context&nbsp;factory.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditApi&nbsp;The&nbsp;audit&nbsp;api.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiRuntimeFilter(ContextFactory&nbsp;contextFactory,&nbsp;AuditApi&nbsp;auditApi)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextFactory&nbsp;=&nbsp;contextFactory;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditApi&nbsp;=&nbsp;auditApi;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Initialises&nbsp;the&nbsp;filter&nbsp;with&nbsp;the&nbsp;provided&nbsp;filter&nbsp;configuration.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;config&nbsp;The&nbsp;filter&nbsp;config.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;either&nbsp;the&nbsp;{@code&nbsp;ContextFactory}&nbsp;or&nbsp;{@code&nbsp;AuditApi}&nbsp;instance&nbsp;could&nbsp;not&nbsp;be&nbsp;created.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;init(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(contextFactory&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextFactory&nbsp;=&nbsp;getContextFactory(config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(auditApi&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;getAuditApi(config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;exceptionHandlers&nbsp;=&nbsp;config.getInitParameter(JaspiRuntimeFilter.INIT_PARAM_EXCEPTION_HANDLERS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(exceptionHandlers&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(String&nbsp;handlerClassName&nbsp;:&nbsp;exceptionHandlers.split(&amp;quot;,&amp;quot;))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&amp;lt;?&nbsp;extends&nbsp;ResourceExceptionHandler&amp;gt;&nbsp;handlerClass&nbsp;=&nbsp;Class.forName(handlerClassName.trim())<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.asSubclass(ResourceExceptionHandler.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler.registerExceptionHandler(handlerClass);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(ClassNotFoundException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&amp;quot;Class&nbsp;is&nbsp;not&nbsp;available:&nbsp;&amp;quot;&nbsp;+&nbsp;handlerClassName,&nbsp;e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.runtime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;new&nbsp;RuntimeResultHandler(),&nbsp;auditApi,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;On&nbsp;receipt&nbsp;of&nbsp;a&nbsp;request&nbsp;the&nbsp;Jaspi&nbsp;runtime&nbsp;is&nbsp;invoked&nbsp;to&nbsp;validate&nbsp;the&nbsp;request&nbsp;and&nbsp;secure&nbsp;the&nbsp;response,&nbsp;(providing<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;validation&nbsp;was&nbsp;successful).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;ServletRequest.&nbsp;MUST&nbsp;be&nbsp;of&nbsp;type&nbsp;HttpServletRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;ServletResponse.&nbsp;MUST&nbsp;be&nbsp;of&nbsp;type&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;chain&nbsp;The&nbsp;filter&nbsp;chain.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;ServletException&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;exception&nbsp;thrown&nbsp;from&nbsp;the&nbsp;Jaspi&nbsp;runtime.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;doFilter(ServletRequest&nbsp;request,&nbsp;ServletResponse&nbsp;response,&nbsp;FilterChain&nbsp;chain)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(request&nbsp;instanceof&nbsp;HttpServletRequest&nbsp;&amp;amp;&amp;amp;&nbsp;response&nbsp;instanceof&nbsp;HttpServletResponse))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Non&nbsp;HTTP&nbsp;request&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.processMessage((HttpServletRequest)&nbsp;request,&nbsp;(HttpServletResponse)&nbsp;response,&nbsp;chain);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextFactory&nbsp;getContextFactory(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(config&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;for&nbsp;configured&nbsp;connection&nbsp;factory&nbsp;class&nbsp;first.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;className&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_CONTEXT_FACTORY_CLASS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(className&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Class&amp;lt;?&amp;gt;&nbsp;cls&nbsp;=&nbsp;Class.forName(className);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;tmp&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_CONTEXT_FACTORY_METHOD);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;methodName&nbsp;=&nbsp;tmp&nbsp;!=&nbsp;null&nbsp;?&nbsp;tmp&nbsp;:&nbsp;INIT_PARAM_CONTEXT_FACTORY_METHOD_DEFAULT;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ContextFactory)&nbsp;factoryMethod.invoke(null,&nbsp;config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;IllegalArgumentException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;no-arg&nbsp;method.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(ContextFactory)&nbsp;factoryMethod.invoke(null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;Exception&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIXME:&nbsp;i18n<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Unable&nbsp;to&nbsp;initialize&nbsp;ContextFactory&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;getAuditApi(FilterConfig&nbsp;config)&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(config&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;for&nbsp;configured&nbsp;connection&nbsp;factory&nbsp;class&nbsp;first.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;className&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_AUDIT_API_CLASS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(className&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Class&amp;lt;?&amp;gt;&nbsp;cls&nbsp;=&nbsp;Class.forName(className);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;tmp&nbsp;=&nbsp;config.getInitParameter(INIT_PARAM_AUDIT_API_METHOD);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;methodName&nbsp;=&nbsp;tmp&nbsp;!=&nbsp;null&nbsp;?&nbsp;tmp&nbsp;:&nbsp;INIT_PARAM_AUDIT_API_METHOD_DEFAULT;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AuditApi)&nbsp;factoryMethod.invoke(null,&nbsp;config);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;IllegalArgumentException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;no-arg&nbsp;method.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Method&nbsp;factoryMethod&nbsp;=&nbsp;cls.getDeclaredMethod(methodName);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(AuditApi)&nbsp;factoryMethod.invoke(null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(final&nbsp;Exception&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(e);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIXME:&nbsp;i18n<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ServletException(&amp;quot;Unable&nbsp;to&nbsp;initialize&nbsp;AuditApi&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;destroy()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;what&nbsp;if&nbsp;context&nbsp;is&nbsp;still&nbsp;processing&nbsp;something?...<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,442&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuditTrail.*;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.asString;<br>
-import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.JaspiRuntime.LOG;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.Collections;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Encapsulates&nbsp;ServerAuthModules&nbsp;that&nbsp;are&nbsp;used&nbsp;to&nbsp;validate&nbsp;service&nbsp;requests&nbsp;received&nbsp;from&nbsp;clients,&nbsp;and&nbsp;to&nbsp;secure&nbsp;any<br>
-&nbsp;*&nbsp;response&nbsp;returned&nbsp;for&nbsp;those&nbsp;requests.<br>
-&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;*&nbsp;This&nbsp;abstract&nbsp;implementation&nbsp;of&nbsp;the&nbsp;ServerAuthContext&nbsp;interface&nbsp;allows&nbsp;a&nbsp;single&nbsp;Session&nbsp;ServerAuthModule,&nbsp;to<br>
-&nbsp;*&nbsp;provide&nbsp;session&nbsp;capabilities&nbsp;(i.e.&nbsp;on&nbsp;secureResponse,&nbsp;adds&nbsp;a&nbsp;cookie&nbsp;which&nbsp;is&nbsp;validate&nbsp;on&nbsp;each&nbsp;subsequent&nbsp;request&nbsp;to<br>
-&nbsp;*&nbsp;skip&nbsp;re-authenticating&nbsp;each&nbsp;request),&nbsp;and&nbsp;then&nbsp;defers&nbsp;to&nbsp;the&nbsp;concrete&nbsp;implementation&nbsp;to&nbsp;co-ordinate&nbsp;calling<br>
-&nbsp;*&nbsp;any&nbsp;other&nbsp;ServerAuthModules.<br>
-&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;*&nbsp;This&nbsp;class&nbsp;or&nbsp;concrete&nbsp;implementations&nbsp;of&nbsp;it&nbsp;MUST&nbsp;not&nbsp;store&nbsp;any&nbsp;request&nbsp;specific&nbsp;state&nbsp;in&nbsp;it.&nbsp;This&nbsp;is&nbsp;because<br>
-&nbsp;*&nbsp;many&nbsp;different&nbsp;requests&nbsp;will&nbsp;use&nbsp;this&nbsp;class,&nbsp;possibly&nbsp;concurrently.&nbsp;If&nbsp;the&nbsp;request-specific&nbsp;state&nbsp;needs&nbsp;to&nbsp;be<br>
-&nbsp;*&nbsp;maintained&nbsp;then&nbsp;use&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;provided.&nbsp;This&nbsp;is&nbsp;created&nbsp;and&nbsp;used&nbsp;only&nbsp;by&nbsp;this&nbsp;specific&nbsp;request&nbsp;-&nbsp;it&nbsp;will<br>
-&nbsp;*&nbsp;be&nbsp;available&nbsp;for&nbsp;the&nbsp;entire&nbsp;time&nbsp;the&nbsp;request&nbsp;is&nbsp;being&nbsp;processed..<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@param&nbsp;&amp;lt;T&amp;gt;&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;ServerAuthModule&nbsp;configured&nbsp;in&nbsp;the&nbsp;runtime.<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;abstract&nbsp;class&nbsp;JaspiServerAuthContext&amp;lt;T&nbsp;extends&nbsp;ServerAuthModule&amp;gt;&nbsp;implements&nbsp;ServerAuthContext&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Key&nbsp;to&nbsp;the&nbsp;private&nbsp;context&nbsp;map,&nbsp;shared&nbsp;between&nbsp;ServerAuthContext&nbsp;implementations.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;static&nbsp;final&nbsp;String&nbsp;PRIVATE_CONTEXT_MAP_KEY&nbsp;=&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiServerAuthContext.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Each&nbsp;configured&nbsp;ServerAuthModule&nbsp;has&nbsp;its&nbsp;#getSupportedMessageTypes()&nbsp;method&nbsp;called&nbsp;to&nbsp;ensure&nbsp;that&nbsp;each&nbsp;module<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;does&nbsp;support&nbsp;and&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfoUtils&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;contextHandler&nbsp;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;ContextHandler.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;A&nbsp;Session&nbsp;AuthModule.&nbsp;Can&nbsp;be&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;A&nbsp;List&nbsp;of&nbsp;ServerAuthModules.&nbsp;MUST&nbsp;not&nbsp;be&nbsp;&amp;lt;code&amp;gt;null&amp;lt;/code&amp;gt;.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;any&nbsp;of&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;do&nbsp;not&nbsp;conform&nbsp;to&nbsp;the&nbsp;Jaspi&nbsp;HttpServlet&nbsp;Profile.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiServerAuthContext(final&nbsp;MessageInfoUtils&nbsp;messageInfoUtils,&nbsp;final&nbsp;ContextHandler&nbsp;contextHandler,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ServerAuthModule&nbsp;sessionAuthModule,&nbsp;final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;allAuthModules;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;(authModules);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAuthModules.add(0,&nbsp;sessionAuthModule);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(allAuthModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.messageInfoUtils&nbsp;=&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.contextHandler&nbsp;=&nbsp;contextHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.sessionAuthModule&nbsp;=&nbsp;sessionAuthModule;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.authModules&nbsp;=&nbsp;authModules;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Returns&nbsp;the&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;MessageInfoUtils.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;MessageInfoUtils&nbsp;getMessageInfoUtils()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Authenticate&nbsp;a&nbsp;received&nbsp;service&nbsp;request&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;logic&nbsp;used&nbsp;to&nbsp;determine&nbsp;whether&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;called&nbsp;is&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;a&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;configured,&nbsp;it&nbsp;is&nbsp;called&nbsp;first.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;configured&nbsp;and&nbsp;returns&nbsp;AuthStatus.SUCCESS,&nbsp;AuthStatus.SEND_SUCCESS&nbsp;or<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus.SEND_CONTINUE&nbsp;processing&nbsp;stops&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;returned.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;it&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;then&nbsp;the&nbsp;list<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;ServerAuthModules&nbsp;are&nbsp;called.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ol&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE,&nbsp;then&nbsp;the&nbsp;concrete&nbsp;sub-types<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#validateRequest(List,&nbsp;MessageInfo,&nbsp;Subject,&nbsp;Subject)&nbsp;will&nbsp;be&nbsp;called&nbsp;for&nbsp;the&nbsp;ServerAuthModules<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;#validateRequest(MessageInfo,&nbsp;Subject,&nbsp;Subject)&nbsp;to&nbsp;be&nbsp;called.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;configured&nbsp;AuditLogger&nbsp;will&nbsp;be&nbsp;called&nbsp;to&nbsp;audit&nbsp;the&nbsp;request&nbsp;&amp;lt;strong&amp;gt;if&amp;lt;/strong&amp;gt;&nbsp;the&nbsp;Session&nbsp;AuthModule<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;returns&nbsp;AuthStatus.SEND_FAILURE&nbsp;as&nbsp;if&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;passes&nbsp;the&nbsp;Jaspi&nbsp;Runtime<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;takes&nbsp;this&nbsp;as&nbsp;an&nbsp;existing&nbsp;session&nbsp;continuing.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;request&nbsp;message&nbsp;was&nbsp;successfully&nbsp;validated.&nbsp;The&nbsp;validated&nbsp;request<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getRequestMessage&nbsp;on&nbsp;messageInfo.&amp;lt;li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;to&nbsp;indicate&nbsp;that&nbsp;validation/processing&nbsp;of&nbsp;the&nbsp;request&nbsp;message&nbsp;successfully&nbsp;produced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;secured&nbsp;application&nbsp;response&nbsp;message&nbsp;(in&nbsp;messageInfo).&nbsp;The&nbsp;secured&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;is&nbsp;incomplete,&nbsp;and&nbsp;that&nbsp;a&nbsp;preliminary&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;was&nbsp;returned&nbsp;as&nbsp;the&nbsp;response&nbsp;message&nbsp;in&nbsp;messageInfo.&nbsp;When&nbsp;this&nbsp;status&nbsp;value&nbsp;is&nbsp;returned&nbsp;to&nbsp;challenge&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;application&nbsp;request&nbsp;message,&nbsp;the&nbsp;challenged&nbsp;request&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;request&nbsp;returned&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;challenge.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;failed&nbsp;and&nbsp;that&nbsp;an&nbsp;appropriate&nbsp;failure&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;validate&nbsp;session&nbsp;module<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;moduleId&nbsp;=&nbsp;&amp;quot;Session-&amp;quot;&nbsp;+&nbsp;sessionAuthModule.getClass().getSimpleName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;doValidateRequest(sessionAuthModule,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject,&nbsp;moduleId,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;successfully&nbsp;authenticated&nbsp;the&nbsp;client&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditSuccess(moduleId,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;may&nbsp;have&nbsp;completely/partially/not&nbsp;authenticated&nbsp;the&nbsp;client&nbsp;and&nbsp;has&nbsp;a&nbsp;response&nbsp;to&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;return&nbsp;to&nbsp;the&nbsp;client&amp;quot;,&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;emptyMap(),&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticate&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;--&nbsp;In&nbsp;our&nbsp;implementation&nbsp;we&nbsp;will&nbsp;let&nbsp;subsequent&nbsp;modules&nbsp;try&nbsp;before&nbsp;sending&nbsp;the&nbsp;failure.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;failed&nbsp;to&nbsp;authenticated&nbsp;the&nbsp;client,&nbsp;passing&nbsp;to&nbsp;Auth&nbsp;Modules&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(AuthStatus.SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;module&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;{}&nbsp;has&nbsp;not&nbsp;completed&nbsp;authenticating&nbsp;the&nbsp;client&amp;quot;,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.getClass().getSimpleName());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;&nbsp;+&nbsp;asString(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;message&amp;quot;,&nbsp;message),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(message);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.getMap().remove(AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().remove(AUDIT_SESSION_ID_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;exceptionAuthStatus&nbsp;=&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Setting&nbsp;authStatus&nbsp;to&nbsp;null&nbsp;so&nbsp;auditing&nbsp;does&nbsp;not&nbsp;happen.&nbsp;As&nbsp;this&nbsp;exception&nbsp;is&nbsp;a&nbsp;configuration&nbsp;issue.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;,&nbsp;asString(exceptionAuthStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(exceptionAuthStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Performs&nbsp;the&nbsp;actual&nbsp;{@code&nbsp;#validateRequest}&nbsp;call&nbsp;on&nbsp;the&nbsp;auth&nbsp;module&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;principal&nbsp;set&nbsp;by&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;auth&nbsp;module&nbsp;is&nbsp;set&nbsp;in&nbsp;the&nbsp;audit&nbsp;trail&nbsp;and&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;an&nbsp;exception&nbsp;that&nbsp;the&nbsp;failure&nbsp;reason&nbsp;is&nbsp;captured.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModule&nbsp;The&nbsp;auth&nbsp;module&nbsp;to&nbsp;call&nbsp;{@code&nbsp;#validateRequest}&nbsp;on.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;moduleId&nbsp;The&nbsp;module&nbsp;identifier.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;audit&nbsp;trail.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;{@code&nbsp;AuthStatus}&nbsp;from&nbsp;the&nbsp;{@code&nbsp;#validateRequest}&nbsp;call.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;the&nbsp;{@code&nbsp;#validateRequest}&nbsp;call&nbsp;fails.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;doValidateRequest(ServerAuthModule&nbsp;authModule,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject,&nbsp;String&nbsp;moduleId,&nbsp;AuditTrail&nbsp;auditTrail)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;principal&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().get(AUDIT_PRINCIPAL_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;!principal.isEmpty())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;auditInfo&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;AUDIT_INFO_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditInfo.put(AUDIT_PRINCIPAL_KEY,&nbsp;principal);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&amp;quot;Auditing&nbsp;authentication&nbsp;result&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.removeMap(messageInfo,&nbsp;AUDIT_FAILURE_REASON_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(failureReason&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason.put(&amp;quot;exception&amp;quot;,&nbsp;e.getMessage());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureReason&nbsp;=&nbsp;Collections.&amp;lt;String,&nbsp;Object&amp;gt;singletonMap(&amp;quot;exception&amp;quot;,&nbsp;e.getMessage());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.auditFailure(moduleId,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;e;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Co-ordinates&nbsp;calling&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;#validateRequest&nbsp;method,&nbsp;when&nbsp;either&nbsp;the&nbsp;Session<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthModule&nbsp;is&nbsp;not&nbsp;configured&nbsp;or&nbsp;has&nbsp;returned&nbsp;AuthStatus.SEND_FAILURE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SUCCESS,&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configured&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;service&nbsp;request.&nbsp;It&nbsp;is&nbsp;used&nbsp;to&nbsp;store&nbsp;Principals<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;credentials&nbsp;validated&nbsp;in&nbsp;the&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;request&nbsp;message&nbsp;was&nbsp;successfully&nbsp;validated.&nbsp;The&nbsp;validated&nbsp;request<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getRequestMessage&nbsp;on&nbsp;messageInfo.&amp;lt;li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;to&nbsp;indicate&nbsp;that&nbsp;validation/processing&nbsp;of&nbsp;the&nbsp;request&nbsp;message&nbsp;successfully&nbsp;produced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;secured&nbsp;application&nbsp;response&nbsp;message&nbsp;(in&nbsp;messageInfo).&nbsp;The&nbsp;secured&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;is&nbsp;incomplete,&nbsp;and&nbsp;that&nbsp;a&nbsp;preliminary&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;was&nbsp;returned&nbsp;as&nbsp;the&nbsp;response&nbsp;message&nbsp;in&nbsp;messageInfo.&nbsp;When&nbsp;this&nbsp;status&nbsp;value&nbsp;is&nbsp;returned&nbsp;to&nbsp;challenge&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;application&nbsp;request&nbsp;message,&nbsp;the&nbsp;challenged&nbsp;request&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;request&nbsp;returned&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;challenge.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;message&nbsp;validation&nbsp;failed&nbsp;and&nbsp;that&nbsp;an&nbsp;appropriate&nbsp;failure&nbsp;response<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;abstract&nbsp;AuthStatus&nbsp;validateRequest(final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;clientSubject,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Secures&nbsp;a&nbsp;service&nbsp;response&nbsp;before&nbsp;sending&nbsp;it&nbsp;to&nbsp;the&nbsp;client&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;configured<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Firstly&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;#secureResponse(List,&nbsp;MessageInfo,&nbsp;Subject)&nbsp;will&nbsp;be&nbsp;called&nbsp;for&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;ServerAuthModules&nbsp;#secureResponse(MessageInfo,&nbsp;Subject)&nbsp;to&nbsp;be&nbsp;called.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;Session&nbsp;AuthModule&nbsp;is&nbsp;only&nbsp;called&nbsp;if:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;it&nbsp;is&nbsp;configured&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;li&amp;gt;the&nbsp;call&nbsp;to&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;secureResponse&nbsp;returns&nbsp;AuthStatus.SEND_SUCCESS&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Any&nbsp;other&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;the&nbsp;concrete&nbsp;sub-types&nbsp;secureResponse&nbsp;method&nbsp;will&nbsp;result&nbsp;in&nbsp;the&nbsp;end&nbsp;of<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;processing&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;to&nbsp;be&nbsp;returned.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Note:&nbsp;secureResponse&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;if&nbsp;the&nbsp;call&nbsp;to&nbsp;validateRequest&nbsp;returned&nbsp;AuthStatus.SUCCESS.&nbsp;Any&nbsp;other<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;should&nbsp;cause&nbsp;the&nbsp;runtime&nbsp;to&nbsp;finish&nbsp;processing&nbsp;the&nbsp;request&nbsp;and&nbsp;return&nbsp;a&nbsp;response&nbsp;to&nbsp;the&nbsp;client.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;was&nbsp;successfully&nbsp;secured.&nbsp;The&nbsp;secured<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;message&nbsp;may&nbsp;be&nbsp;obtained&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;(within&nbsp;messageInfo)&nbsp;was&nbsp;replaced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;with&nbsp;a&nbsp;security&nbsp;message&nbsp;that&nbsp;should&nbsp;elicit&nbsp;a&nbsp;security-specific&nbsp;response&nbsp;(in&nbsp;the&nbsp;form&nbsp;of&nbsp;a&nbsp;request)&nbsp;from&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peer.&nbsp;This&nbsp;status&nbsp;value&nbsp;serves&nbsp;to&nbsp;inform&nbsp;the&nbsp;calling&nbsp;runtime&nbsp;that&nbsp;(to&nbsp;successfully&nbsp;complete&nbsp;the&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exchange)&nbsp;it&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;capable&nbsp;of&nbsp;continuing&nbsp;the&nbsp;message&nbsp;dialog&nbsp;by&nbsp;processing&nbsp;at&nbsp;least&nbsp;one&nbsp;additional<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;exchange&nbsp;(after&nbsp;having&nbsp;sent&nbsp;the&nbsp;response&nbsp;message&nbsp;returned&nbsp;in&nbsp;messageInfo).&nbsp;When&nbsp;this&nbsp;status<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;is&nbsp;returned,&nbsp;the&nbsp;application&nbsp;response&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can&nbsp;be<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;elicited&nbsp;response.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;a&nbsp;failure&nbsp;occurred&nbsp;while&nbsp;securing&nbsp;the&nbsp;response&nbsp;message&nbsp;and&nbsp;that&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;appropriate&nbsp;failure&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;(AuditTrail)&nbsp;messageInfo.getMap().get(AUDIT_TRAIL_KEY);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(AuthStatus.SUCCESS.equals(authStatus)&nbsp;||&nbsp;AuthStatus.FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.error(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;{}&amp;quot;,&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthenticationException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;returned&nbsp;from&nbsp;validateRequest,&nbsp;&amp;quot;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;SessionModule&nbsp;is&nbsp;configured&nbsp;and&nbsp;either&nbsp;the&nbsp;AuthModule&nbsp;secureResponse&nbsp;has&nbsp;been&nbsp;called&nbsp;and&nbsp;returned<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus.SUCCESS&nbsp;or&nbsp;the&nbsp;AuthModule&nbsp;secureResponse&nbsp;has&nbsp;not&nbsp;been&nbsp;called&nbsp;and&nbsp;hence&nbsp;the&nbsp;authStatus&nbsp;is&nbsp;null.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;(authStatus&nbsp;==&nbsp;null&nbsp;||&nbsp;AuthStatus.SEND_SUCCESS.equals(authStatus)))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authStatus&nbsp;=&nbsp;sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;sessionId&nbsp;=&nbsp;(String)&nbsp;messageInfo.getMap().remove(AUDIT_SESSION_ID_KEY);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.setSessionId(sessionId);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;As&nbsp;this&nbsp;method&nbsp;can&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;validateRequest&nbsp;returns&nbsp;a&nbsp;AuthStatus.SUCCESS,&nbsp;which&nbsp;means&nbsp;either&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;SessionModule&nbsp;is&nbsp;configured&nbsp;or&nbsp;the&nbsp;authenticatingAuthModule&nbsp;will&nbsp;be&nbsp;set,&nbsp;so&nbsp;authStatus&nbsp;cannot&nbsp;be&nbsp;null&nbsp;and<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;MUST&nbsp;be&nbsp;set&nbsp;to&nbsp;a&nbsp;valid&nbsp;AuthStatus&nbsp;value&nbsp;for&nbsp;secureResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Co-ordinates&nbsp;calling&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;#secureResponse&nbsp;method,&nbsp;before&nbsp;the&nbsp;Session&nbsp;AuthModule&nbsp;is<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;called&nbsp;(if&nbsp;it&nbsp;is&nbsp;configured).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Any&nbsp;other&nbsp;AuthStatus&nbsp;that&nbsp;AuthStatus.SEND_SUCCESS&nbsp;returned&nbsp;from&nbsp;the&nbsp;configured&nbsp;ServerAuthModules&nbsp;secureResponse<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;method&nbsp;will&nbsp;result&nbsp;in&nbsp;the&nbsp;end&nbsp;of&nbsp;processing&nbsp;and&nbsp;the&nbsp;AuthStatus&nbsp;to&nbsp;be&nbsp;returned.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Possible&nbsp;AuthStatus&nbsp;return&nbsp;values:&nbsp;SEND_SUCCESS,&nbsp;SEND_FAILURE,&nbsp;SEND_CONTINUE.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authModules&nbsp;The&nbsp;list&nbsp;of&nbsp;configured&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;A&nbsp;Subject&nbsp;that&nbsp;represents&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request,&nbsp;or&nbsp;null.&nbsp;It&nbsp;may&nbsp;be&nbsp;used&nbsp;as<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;source&nbsp;of&nbsp;Principals&nbsp;or&nbsp;credentials&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;the&nbsp;request.&nbsp;If&nbsp;the&nbsp;Subject<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;null,&nbsp;the&nbsp;method&nbsp;implementation&nbsp;may&nbsp;add&nbsp;additional&nbsp;Principals&nbsp;or&nbsp;credentials<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pertaining&nbsp;to&nbsp;the&nbsp;recipient&nbsp;of&nbsp;the&nbsp;service&nbsp;request)&nbsp;to&nbsp;the&nbsp;Subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;An&nbsp;AuthStatus&nbsp;object&nbsp;representing&nbsp;the&nbsp;completion&nbsp;status&nbsp;of&nbsp;the&nbsp;processing&nbsp;performed&nbsp;by&nbsp;the&nbsp;method.&nbsp;The<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthStatus&nbsp;values&nbsp;that&nbsp;may&nbsp;be&nbsp;returned&nbsp;by&nbsp;this&nbsp;method&nbsp;are&nbsp;defined&nbsp;as&nbsp;follows:<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_SUCCESS&nbsp;when&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;was&nbsp;successfully&nbsp;secured.&nbsp;The&nbsp;secured<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;response&nbsp;message&nbsp;may&nbsp;be&nbsp;obtained&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_CONTINUE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;application&nbsp;response&nbsp;message&nbsp;(within&nbsp;messageInfo)&nbsp;was&nbsp;replaced<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;with&nbsp;a&nbsp;security&nbsp;message&nbsp;that&nbsp;should&nbsp;elicit&nbsp;a&nbsp;security-specific&nbsp;response&nbsp;(in&nbsp;the&nbsp;form&nbsp;of&nbsp;a&nbsp;request)&nbsp;from&nbsp;the<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peer.&nbsp;This&nbsp;status&nbsp;value&nbsp;serves&nbsp;to&nbsp;inform&nbsp;the&nbsp;calling&nbsp;runtime&nbsp;that&nbsp;(to&nbsp;successfully&nbsp;complete&nbsp;the&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;exchange)&nbsp;it&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;capable&nbsp;of&nbsp;continuing&nbsp;the&nbsp;message&nbsp;dialog&nbsp;by&nbsp;processing&nbsp;at&nbsp;least&nbsp;one&nbsp;additional<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;request/response&nbsp;exchange&nbsp;(after&nbsp;having&nbsp;sent&nbsp;the&nbsp;response&nbsp;message&nbsp;returned&nbsp;in&nbsp;messageInfo).&nbsp;When&nbsp;this&nbsp;status<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;is&nbsp;returned,&nbsp;the&nbsp;application&nbsp;response&nbsp;must&nbsp;be&nbsp;saved&nbsp;by&nbsp;the&nbsp;authentication&nbsp;module&nbsp;such&nbsp;that&nbsp;it&nbsp;can&nbsp;be<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;recovered&nbsp;when&nbsp;the&nbsp;module's&nbsp;validateRequest&nbsp;message&nbsp;is&nbsp;called&nbsp;to&nbsp;process&nbsp;the&nbsp;elicited&nbsp;response.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;li&amp;gt;AuthStatus.SEND_FAILURE&nbsp;to&nbsp;indicate&nbsp;that&nbsp;a&nbsp;failure&nbsp;occurred&nbsp;while&nbsp;securing&nbsp;the&nbsp;response&nbsp;message&nbsp;and&nbsp;that&nbsp;an<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;appropriate&nbsp;failure&nbsp;response&nbsp;message&nbsp;is&nbsp;available&nbsp;by&nbsp;calling&nbsp;getResponseMessage&nbsp;on&nbsp;messageInfo.&amp;lt;/li&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;/ul&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;When&nbsp;the&nbsp;message&nbsp;processing&nbsp;failed&nbsp;without&nbsp;establishing&nbsp;a&nbsp;failure&nbsp;response&nbsp;message<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(in&nbsp;messageInfo).<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;abstract&nbsp;AuthStatus&nbsp;secureResponse(final&nbsp;List&amp;lt;T&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;MessageInfo&nbsp;messageInfo,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Remove&nbsp;method&nbsp;specific&nbsp;principals&nbsp;and&nbsp;credentials&nbsp;from&nbsp;the&nbsp;subject&nbsp;by&nbsp;delegating&nbsp;calls&nbsp;to&nbsp;the&nbsp;Session<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;AuthModule&nbsp;and&nbsp;the&nbsp;List&nbsp;of&nbsp;ServerAuthModules.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;subject&nbsp;The&nbsp;Subject&nbsp;instance&nbsp;from&nbsp;which&nbsp;the&nbsp;Principals&nbsp;and&nbsp;credentials&nbsp;are&nbsp;to&nbsp;be&nbsp;removed.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;AuthException&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;Subject&nbsp;processing.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;final&nbsp;void&nbsp;cleanSubject(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;Subject&nbsp;subject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule.cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authModules&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ServerAuthModule&nbsp;serverAuthModule&nbsp;:&nbsp;authModules)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverAuthModule.cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStream.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,87&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;Copyrighted&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Wrapper&nbsp;around&nbsp;a&nbsp;HttpServletResponse's&nbsp;output&nbsp;stream&nbsp;to&nbsp;prevent&nbsp;subsequent&nbsp;Servlets&nbsp;closing&nbsp;the&nbsp;stream&nbsp;before&nbsp;the<br>
-&nbsp;*&nbsp;JASPI&nbsp;filter&nbsp;has&nbsp;run&nbsp;secureResponse.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.0.3<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;JaspiServletOutputStream&nbsp;extends&nbsp;ServletOutputStream&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;ServletOutputStream&nbsp;servletOutputStream;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Constructs&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;JaspiServletOutputStream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;servletOutputStream&nbsp;The&nbsp;underlying&nbsp;ServletOutputStream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;JaspiServletOutputStream(final&nbsp;ServletOutputStream&nbsp;servletOutputStream)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.servletOutputStream&nbsp;=&nbsp;servletOutputStream;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(int)&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;i&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(final&nbsp;int&nbsp;i)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(i);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(byte[])&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;b&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(byte[]&nbsp;b)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;write(byte[],&nbsp;int,&nbsp;int)&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;b&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;off&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;len&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(byte[]&nbsp;b,&nbsp;int&nbsp;off,&nbsp;int&nbsp;len)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b,&nbsp;off,&nbsp;len);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Calls&nbsp;close()&nbsp;on&nbsp;the&nbsp;underlying&nbsp;output&nbsp;stream.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;IOException&nbsp;{@inheritDoc}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;close()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.close();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkMessageContextImpljava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageContextImpl.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageContextImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageContextImpl.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,110&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthContextWithState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.http.Context;<br>
+import&nbsp;org.forgerock.http.ServerContext;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;An&nbsp;implementation&nbsp;of&nbsp;{@link&nbsp;MessageContext}&nbsp;that&nbsp;holds&nbsp;contextual&nbsp;information&nbsp;and&nbsp;state&nbsp;for&nbsp;a<br>
+&nbsp;*&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;message&nbsp;exchange.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@see&nbsp;MessageContext<br>
+&nbsp;*&nbsp;@see&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+final&nbsp;class&nbsp;MessageContextImpl&nbsp;extends&nbsp;ServerContext&nbsp;implements&nbsp;MessageContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Request&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Response&nbsp;response;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditTrail&nbsp;auditTrail;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Map&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthContext&amp;gt;,&nbsp;AuthenticationState&amp;gt;&nbsp;authContextState&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;HashMap&amp;lt;Class&amp;lt;?&nbsp;extends&nbsp;AsyncServerAuthContext&amp;gt;,&nbsp;AuthenticationState&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;message&nbsp;context&nbsp;that&nbsp;holds&nbsp;both&nbsp;the&nbsp;request&nbsp;and&nbsp;response&nbsp;messages&nbsp;and&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;global&nbsp;context&nbsp;{@code&nbsp;Map}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;parent&nbsp;The&nbsp;parent&nbsp;context.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;request&nbsp;The&nbsp;request&nbsp;message.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;{@code&nbsp;AuditTrail}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;MessageContextImpl(Context&nbsp;parent,&nbsp;Request&nbsp;request,&nbsp;AuditTrail&nbsp;auditTrail)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(parent,&nbsp;&amp;quot;jaspi&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(request,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.request&nbsp;=&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.response&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(200);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.auditTrail&nbsp;=&nbsp;auditTrail;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Request&nbsp;getRequest()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setRequest(Request&nbsp;request)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.request&nbsp;=&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Response&nbsp;getResponse()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;response;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setResponse(Response&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.response&nbsp;=&nbsp;response;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getRequestContextMap()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;requestContextMap;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuditTrail&nbsp;getAuditTrail()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;auditTrail;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;&amp;lt;T&nbsp;extends&nbsp;AuthenticationState&amp;gt;&nbsp;T&nbsp;getState(AsyncServerAuthContext&nbsp;authContext)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;state&nbsp;=&nbsp;authContextState.get(authContext.getClass());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(state&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(authContext&nbsp;instanceof&nbsp;AuthContextWithState)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;((AuthContextWithState)&nbsp;authContext).createAuthenticationState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;new&nbsp;AuthenticationState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContextState.put(authContext.getClass(),&nbsp;state);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(T)&nbsp;state;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/MessageInfoUtils.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,89&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Provides&nbsp;methods&nbsp;that&nbsp;allow&nbsp;working&nbsp;with&nbsp;MessageInfo&nbsp;maps&nbsp;to&nbsp;be&nbsp;simplified.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;MessageInfoUtils&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Removes&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;of&nbsp;the&nbsp;MessageInfo,&nbsp;then&nbsp;{@code&nbsp;null}&nbsp;will&nbsp;be&nbsp;returned.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;remove&nbsp;the&nbsp;map&nbsp;from.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;or&nbsp;{@code&nbsp;null}&nbsp;if&nbsp;it&nbsp;does&nbsp;not&nbsp;exist.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;removeMap(MessageInfo&nbsp;messageInfo,&nbsp;String&nbsp;mapKey)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;messageInfo.getMap().remove(mapKey);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;of&nbsp;the&nbsp;MessageInfo,&nbsp;the&nbsp;a&nbsp;new&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;will<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;created&nbsp;an&nbsp;inserted&nbsp;into&nbsp;it,&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;get&nbsp;the&nbsp;map&nbsp;from.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;MessageInfo&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;String&nbsp;mapKey)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;getMap(messageInfo.getMap(),&nbsp;mapKey);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Gets&nbsp;the&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key&nbsp;from&nbsp;the&nbsp;given&nbsp;containing&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;map&nbsp;does&nbsp;not&nbsp;exist,&nbsp;a&nbsp;new&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;will&nbsp;be&nbsp;created&nbsp;and&nbsp;inserted&nbsp;into&nbsp;the&nbsp;given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;containing&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;containingMap&nbsp;The&nbsp;map&nbsp;that&nbsp;will&nbsp;contain&nbsp;the&nbsp;map&nbsp;at&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;mapKey&nbsp;The&nbsp;key&nbsp;for&nbsp;the&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;The&nbsp;map&nbsp;that&nbsp;is&nbsp;contained&nbsp;in&nbsp;the&nbsp;given&nbsp;map&nbsp;with&nbsp;the&nbsp;given&nbsp;key.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;getMap(final&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;containingMap,&nbsp;final&nbsp;String&nbsp;mapKey)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;containingMap.get(mapKey);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(map&nbsp;==&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;containingMap.put(mapKey,&nbsp;map);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;map;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Adds&nbsp;a&nbsp;new&nbsp;empty&nbsp;{@code&nbsp;&amp;lt;String,&nbsp;Object&amp;gt;}&nbsp;map&nbsp;in&nbsp;the&nbsp;root&nbsp;map&nbsp;in&nbsp;the&nbsp;MessageInfo.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;The&nbsp;MessageInfo&nbsp;to&nbsp;add&nbsp;the&nbsp;map&nbsp;to.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;key&nbsp;The&nbsp;key&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;new&nbsp;map.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;addMap(final&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;final&nbsp;String&nbsp;key)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getMap(messageInfo,&nbsp;key);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkResourceExceptionHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/ResourceExceptionHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,11&nbsp;+16,10&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authentication.framework;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Collection;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.protocol.Response;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.ResourceException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-29,17&nbsp;+28,24&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;interface&nbsp;ResourceExceptionHandler&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Which&nbsp;media&nbsp;types&nbsp;can&nbsp;this&nbsp;handler&nbsp;handle<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Which&nbsp;media&nbsp;types&nbsp;can&nbsp;this&nbsp;handler&nbsp;handle.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;A&nbsp;list&nbsp;of&nbsp;media&nbsp;types.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;MediaType&amp;gt;&nbsp;handles();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;the&nbsp;details&nbsp;of&nbsp;the&nbsp;exception&nbsp;out,&nbsp;and&nbsp;set&nbsp;the&nbsp;content&nbsp;type&nbsp;of&nbsp;the&nbsp;response.<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;exception&nbsp;The&nbsp;exception&nbsp;to&nbsp;be&nbsp;written.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;response&nbsp;to&nbsp;write&nbsp;the&nbsp;details&nbsp;to.<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;java.io.IOException&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;writing&nbsp;failure.<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;Response&nbsp;response);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;short&nbsp;but&nbsp;useful&nbsp;description&nbsp;of&nbsp;this&nbsp;response&nbsp;handler.&nbsp;Description&nbsp;should&nbsp;include&nbsp;the<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;media&nbsp;type&nbsp;this&nbsp;response&nbsp;handler&nbsp;handles.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;toString();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;}<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/RuntimeResultHandler.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,116&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;javax.security.auth.message.AuthStatus.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.security.Principal;<br>
-<br>
-/**<br>
-&nbsp;*&nbsp;Handler&nbsp;which&nbsp;handles&nbsp;the&nbsp;result&nbsp;of&nbsp;calls&nbsp;to&nbsp;a&nbsp;ServerAuthContexts&nbsp;validateRequest&nbsp;and&nbsp;secureResponse&nbsp;methods.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;@since&nbsp;1.3.0<br>
-&nbsp;*/<br>
-public&nbsp;class&nbsp;RuntimeResultHandler&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Handles&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;ServerAuthContext&nbsp;validateRequest&nbsp;method.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Only&nbsp;an&nbsp;AuthStatus&nbsp;of&nbsp;SUCCESS&nbsp;will&nbsp;return&nbsp;true&nbsp;and&nbsp;an&nbsp;AuthStatus&nbsp;of&nbsp;SEND_FAILURE&nbsp;will&nbsp;set&nbsp;the&nbsp;response&nbsp;status<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;401.&amp;lt;/p&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;returned&nbsp;AuthStatus&nbsp;from&nbsp;the&nbsp;validateRequest&nbsp;method&nbsp;call.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;messageInfo&nbsp;A&nbsp;contextual&nbsp;object&nbsp;that&nbsp;encapsulates&nbsp;the&nbsp;client&nbsp;request&nbsp;and&nbsp;server&nbsp;response&nbsp;objects.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;auditTrail&nbsp;The&nbsp;instance&nbsp;of&nbsp;the&nbsp;{@code&nbsp;AuditTrail}&nbsp;for&nbsp;this&nbsp;authentication&nbsp;request.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;The&nbsp;client's&nbsp;subject.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;&amp;lt;code&amp;gt;true&amp;lt;/code&amp;gt;&nbsp;if&nbsp;the&nbsp;processing&nbsp;of&nbsp;the&nbsp;request&nbsp;should&nbsp;proceed,&nbsp;&amp;lt;code&amp;gt;false&amp;lt;/code&amp;gt;&nbsp;otherwise.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;If&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;not&nbsp;valid&nbsp;for&nbsp;a&nbsp;call&nbsp;to&nbsp;validateRequest.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;boolean&nbsp;handleValidateRequestResult(AuthStatus&nbsp;authStatus,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;AuditTrail&nbsp;auditTrail,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsSuccessful(getPrincipal(clientSubject));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Successfully&nbsp;validated&nbsp;request,&nbsp;with&nbsp;response&nbsp;message&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Failed&nbsp;to&nbsp;validate&nbsp;request,&nbsp;included&nbsp;response&nbsp;message.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(401);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;validating&nbsp;request.&nbsp;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail.completeAuditAsFailure();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;AuthStatusUtils.asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;validateRequest:&nbsp;&amp;quot;&nbsp;+&nbsp;AuthStatusUtils.asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;getPrincipal(Subject&nbsp;clientSubject)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Principal&nbsp;principal&nbsp;:&nbsp;clientSubject.getPrincipals())&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(principal.getName()&nbsp;!=&nbsp;null)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;principal.getName();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Handles&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;ServerAuthContext&nbsp;secureResponse&nbsp;method.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;br/&amp;gt;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;An&nbsp;AuthStatus&nbsp;of&nbsp;SEND_CONTINUE&nbsp;will&nbsp;set&nbsp;the&nbsp;response&nbsp;status&nbsp;to&nbsp;100.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;authStatus&nbsp;The&nbsp;returned&nbsp;AuthStatus&nbsp;from&nbsp;the&nbsp;secureResponse&nbsp;method&nbsp;call.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;response&nbsp;The&nbsp;HttpServletResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;javax.security.auth.message.AuthException&nbsp;If&nbsp;the&nbsp;AuthStatus&nbsp;is&nbsp;not&nbsp;valid&nbsp;for&nbsp;a&nbsp;call&nbsp;to&nbsp;secureResponse.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleSecureResponseResult(final&nbsp;AuthStatus&nbsp;authStatus,&nbsp;final&nbsp;HttpServletResponse&nbsp;response)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SEND_SUCCESS.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;here&nbsp;just&nbsp;carry&nbsp;on<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Successfully&nbsp;secured&nbsp;response.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_FAILURE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Failed&nbsp;to&nbsp;secured&nbsp;response,&nbsp;included&nbsp;response&nbsp;message&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setStatus(500);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(SEND_CONTINUE.equals(authStatus))&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;HttpServletResponse&nbsp;to&nbsp;client&nbsp;and&nbsp;exit.<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.debug(&amp;quot;Has&nbsp;not&nbsp;finished&nbsp;securing&nbsp;response.&nbsp;Requires&nbsp;more&nbsp;information&nbsp;from&nbsp;client.&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime.LOG.error(&amp;quot;Invalid&nbsp;AuthStatus,&nbsp;{}&amp;quot;,&nbsp;AuthStatusUtils.asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AuthException(&amp;quot;Invalid&nbsp;AuthStatus&nbsp;from&nbsp;secureResponse:&nbsp;&amp;quot;&nbsp;+&nbsp;AuthStatusUtils.asString(authStatus));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkSessionAuthContextjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/SessionAuthContext.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/SessionAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/SessionAuthContext.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,125&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthModules.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.util.Reject;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.slf4j.Logger;<br>
+<br>
+/**<br>
+&nbsp;*&nbsp;An&nbsp;{@link&nbsp;AsyncServerAuthContext}&nbsp;which&nbsp;manages&nbsp;a&nbsp;session&nbsp;{@link&nbsp;AsyncServerAuthModule}&nbsp;that<br>
+&nbsp;*&nbsp;performs&nbsp;session&nbsp;related&nbsp;validation&nbsp;on&nbsp;the&nbsp;request&nbsp;message&nbsp;and&nbsp;secures&nbsp;the&nbsp;response&nbsp;message&nbsp;with<br>
+&nbsp;*&nbsp;session&nbsp;related&nbsp;information.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;@since&nbsp;2.0.0<br>
+&nbsp;*/<br>
+final&nbsp;class&nbsp;SessionAuthContext&nbsp;implements&nbsp;AsyncServerAuthContext&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Logger&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Creates&nbsp;a&nbsp;new&nbsp;{@code&nbsp;SessionAuthContext}&nbsp;managing&nbsp;the&nbsp;provided&nbsp;{@code&nbsp;AsyncServerAuthModule}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;logger&nbsp;The&nbsp;{@link&nbsp;Logger}&nbsp;instance.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;sessionAuthModule&nbsp;The&nbsp;session&nbsp;{@code&nbsp;AsyncServerAuthModule}.<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;SessionAuthContext(Logger&nbsp;logger,&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reject.ifNull(logger);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.logger&nbsp;=&nbsp;logger;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.sessionAuthModule&nbsp;=&nbsp;withValidation(withSessionAuditing(withLogging(logger,&nbsp;sessionAuthModule)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Calls&nbsp;{@link&nbsp;AsyncServerAuthModule#validateRequest(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo,&nbsp;Subject,&nbsp;Subject)}&nbsp;directly.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;configured&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;is&nbsp;{@code&nbsp;null}&nbsp;return&nbsp;a&nbsp;successful<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;promise&nbsp;with&nbsp;the&nbsp;value&nbsp;{@link&nbsp;AuthStatus#SEND_FAILURE}.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionAuthModule.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Calls&nbsp;{@link&nbsp;AsyncServerAuthModule#secureResponse(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo,&nbsp;Subject)}&nbsp;directly.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;configured&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;is&nbsp;{@code&nbsp;null}&nbsp;return&nbsp;a&nbsp;successful<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;promise&nbsp;with&nbsp;the&nbsp;value&nbsp;{@link&nbsp;AuthStatus#SEND_SUCCESS}.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;serviceSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContext&nbsp;context,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionAuthModule.secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;/**<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;Calls&nbsp;{@link&nbsp;AsyncServerAuthModule#cleanSubject(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo,&nbsp;Subject)}&nbsp;directly.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&amp;lt;p&amp;gt;If&nbsp;the&nbsp;configured&nbsp;{@code&nbsp;AsyncServerAuthModule}&nbsp;is&nbsp;{@code&nbsp;null}&nbsp;return&nbsp;a&nbsp;successful<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;promise&nbsp;with&nbsp;the&nbsp;value&nbsp;{@code&nbsp;null}.&amp;lt;/p&amp;gt;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;context&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;clientSubject&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;{@inheritDoc}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Promises.newSuccessfulPromise(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionAuthModule.cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;toString()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sessionAuthModule&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;N/A&amp;quot;;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionAuthModule.toString();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrcmainjavaorgforgerockcafauthenticationframeworkpackageinfojava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/package-info.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/main/java/org/forgerock/caf/authentication/framework/package-info.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-18,4&nbsp;+18,4&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;This&nbsp;package&nbsp;defines&nbsp;the&nbsp;authentication&nbsp;framework&nbsp;classes&nbsp;for&nbsp;the&nbsp;authentication&nbsp;of&nbsp;messages<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*&nbsp;via&nbsp;authentication&nbsp;contexts&nbsp;and&nbsp;modules.<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;*/<br>
&lt;/span&gt;&lt;del&gt;-package&nbsp;org.forgerock.caf.authentication.framework;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;ins&gt;+package&nbsp;org.forgerock.caf.authentication.framework;<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationapiAuthenticationExceptionTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/api/AuthenticationExceptionTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/api/AuthenticationExceptionTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/api/AuthenticationExceptionTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-26,7&nbsp;+26,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;class&nbsp;AuthenticationExceptionTest&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiAuthExceptionWithMessage()&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateAuthenticationExceptionWithMessage()&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-39,7&nbsp;+39,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiAuthExceptionWithThrowable()&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateAuthenticationExceptionWithThrowable()&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exception&nbsp;cause&nbsp;=&nbsp;new&nbsp;Exception(&amp;quot;MESSAGE&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-53,7&nbsp;+53,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiAuthExceptionWithMessageAndCause()&nbsp;{<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateAuthenticationExceptionWithMessageAndCause()&nbsp;{<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exception&nbsp;cause&nbsp;=&nbsp;new&nbsp;Exception(&amp;quot;CAUSE_MESSAGE&amp;quot;);<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAggregateAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AggregateAuthContextTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AggregateAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AggregateAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,282&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.util.test.assertj.AssertJPromiseAssert.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.mockito.invocation.InvocationOnMock;<br>
+import&nbsp;org.mockito.stubbing.Answer;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.AfterMethod;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AggregateAuthContextTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AggregateAuthContext&nbsp;authContext;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthContext&nbsp;sessionModuleContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthContext&nbsp;authModuleContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthenticationState&nbsp;state;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setup()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionModuleContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;new&nbsp;AggregateAuthContext(logger,&nbsp;sessionModuleContext,&nbsp;authModuleContext);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@AfterMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;tearDown()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;mockAuthContext(AsyncServerAuthContext&nbsp;authContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authContext,&nbsp;validateRequestResult,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;mockAuthContext(AsyncServerAuthContext&nbsp;authContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponseResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authContext,&nbsp;validateRequestResult,&nbsp;secureResponseResult,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;mockAuthContext(AsyncServerAuthContext&nbsp;authContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponseResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubjectResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject())).willReturn(validateRequestResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(secureResponseResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(cleanSubjectResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageContext&nbsp;mockMessageContext()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when(context.getState(Matchers.&amp;lt;AsyncServerAuthContext&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAnswer(new&nbsp;Answer&amp;lt;AuthenticationState&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationState&nbsp;answer(InvocationOnMock&nbsp;invocationOnMock)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(state&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;authContext.createAuthenticationState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;state;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;context;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;successfulSessionValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSuccessfulSessionValidateRequestResultsData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;successfulSessionValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSessionAuthContextReturnsSuccessfulResultTheAuthModuleContextShouldNotBeCalled(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext,&nbsp;never()).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;authModuleValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getAuthModuleValidateRequestResultsData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;authModuleValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSessionAuthContextReturnsSendFailureTheAuthModuleContextShouldBeCalled(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenAuthModuleContextDidNotAuthenticateTheRequestSecureResponseShouldOnlyCallSessionAuthContext()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext,&nbsp;never()).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenAuthModuleContextAuthenticatesTheRequestSecureResponseShouldCallBothAuthContexts()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenAuthModuleContextDoesNotReturnSendSuccessFromSecureSubjectSessionAuthContextShouldNotBeCalled()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authModuleContext,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_CONTINUE));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_CONTINUE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext,&nbsp;never()).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubjectShouldCallAllAuthContexts()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,&nbsp;null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authModuleContext,&nbsp;null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubjectShouldReportExceptionFromAuthContexts()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(sessionModuleContext,&nbsp;null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newFailedPromise(new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(authModuleContext,&nbsp;null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionModuleContext).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleContext).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthContextsTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthContextsTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthContextsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthContextsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,448&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.asString;<br>
+import&nbsp;static&nbsp;org.forgerock.util.test.assertj.AssertJPromiseAssert.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.contains;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.eq;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.verifyZeroInteractions;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+<br>
+import&nbsp;java.security.Principal;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AuthContextsTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validValidateRequestResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidValidateRequestResultValidatingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validValidateRequestResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthContextShouldValidateValidValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withValidation(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidValidateRequestResultValidatingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthContextShouldValidateInvalidValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withValidation(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageStartingWith(&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(&amp;quot;validateRequest&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validSecureResponseResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidSecureResponseResultValidatingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validSecureResponseResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthContextShouldValidateValidSecureResponseResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.secureResponse(context,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withValidation(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidSecureResponseResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidSecureResponseResultValidatingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidSecureResponseResultValidatingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthContextShouldValidateInvalidSecureResponseResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.secureResponse(context,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withValidation(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageStartingWith(&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(&amp;quot;secureResponse&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;successfulValidateRequestResultAuditingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSuccessfulValidateRequestResultAuditingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;successfulValidateRequestResultAuditingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthContextShouldAuditSuccessfulValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principalOne&nbsp;=&nbsp;mock(Principal.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principalTwo&nbsp;=&nbsp;mock(Principal.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(context.getAuditTrail()).willReturn(auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().add(principalOne);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().add(principalTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(principalTwo.getName()).willReturn(&amp;quot;PRINCIPAL_NAME&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withAuditing(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).completeAuditAsSuccessful(&amp;quot;PRINCIPAL_NAME&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;failedAndInvalidValidateRequestResultAuditingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getFailedAndInvalidValidateRequestResultAuditingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;failedAndInvalidValidateRequestResultAuditingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthContextShouldAuditFailedAndInvalidValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(context.getAuditTrail()).willReturn(auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withAuditing(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).completeAuditAsFailure();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthContextShouldAuditValidateRequestAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(context.getAuditTrail()).willReturn(auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withAuditing(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).completeAuditAsFailure(exception);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthContextShouldAuditNullPrincipalWhenPrincipalNotSetOnClientSubject()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(context.getAuditTrail()).willReturn(auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withAuditing(authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).completeAuditAsSuccessful(null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).audit();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validateRequestResultLoggingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidateRequestResultLoggingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;&amp;quot;Success&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;&amp;quot;Success&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;&amp;quot;not&nbsp;finished&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;&amp;quot;Failed&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validateRequestResultLoggingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthContextShouldLogValidateRequestResult(AuthStatus&nbsp;authStatus,&nbsp;String&nbsp;expectedMessage,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isError)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withLogging(logger,&nbsp;authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isError)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(expectedMessage),&nbsp;eq(asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).debug(contains(expectedMessage));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthContextShouldLogValidateRequestAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withLogging(logger,&nbsp;authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(&amp;quot;ERROR&amp;quot;,&nbsp;exception);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;secureResponseResultLoggingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSecureResponseResultLoggingContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;&amp;quot;Success&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;&amp;quot;not&nbsp;finished&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;&amp;quot;Failed&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;secureResponseResultLoggingContext&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthContextShouldLogSecureResponseResult(AuthStatus&nbsp;authStatus,&nbsp;String&nbsp;expectedMessage,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isError)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.secureResponse(context,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withLogging(logger,&nbsp;authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isError)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(expectedMessage),&nbsp;eq(asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).debug(contains(expectedMessage));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthContextShouldLogSecureResponseAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.secureResponse(context,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withLogging(logger,&nbsp;authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(&amp;quot;ERROR&amp;quot;,&nbsp;exception);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthContextShouldLogCleanSubject()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.cleanSubject(context,&nbsp;clientSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withLogging(logger,&nbsp;authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(logger);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthContextShouldLogCleanSubjectAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.cleanSubject(context,&nbsp;clientSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthContexts.withLogging(logger,&nbsp;authContext)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(&amp;quot;ERROR&amp;quot;,&nbsp;exception);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthModulesTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthModulesTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthModulesTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthModulesTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,805&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthStatusUtils.asString;<br>
+import&nbsp;static&nbsp;org.forgerock.util.test.assertj.AssertJPromiseAssert.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.anyMapOf;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.anyObject;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.anyString;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.contains;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.eq;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;javax.security.auth.message.MessagePolicy;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.assertj.core.api.Assertions;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.mockito.ArgumentCaptor;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AuthModulesTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validValidateRequestResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidValidateRequestResultValidatingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validValidateRequestResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthModuleShouldValidateValidValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withValidation(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidValidateRequestResultValidatingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthModuleShouldValidateInvalidValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withValidation(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageStartingWith(&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(&amp;quot;validateRequest&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validSecureResponseResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidSecureResponseResultValidatingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validSecureResponseResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthModuleShouldValidateValidSecureResponseResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withValidation(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidSecureResponseResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidSecureResponseResultValidatingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidSecureResponseResultValidatingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validatingAuthModuleShouldValidateInvalidSecureResponseResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withValidation(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException()<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageStartingWith(&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(&amp;quot;secureResponse&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.hasMessageContaining(asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditPrincipalInAuditModuleInfo()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;PRINCIPAL_NAME&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(moduleAuditInfo).containsEntry(AuditTrail.AUDIT_PRINCIPAL_KEY,&nbsp;&amp;quot;PRINCIPAL_NAME&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;successfulValidateRequestResultAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSuccessfulValidateRequestResultModuleContextData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;successfulValidateRequestResultAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditSuccessfulValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditSuccess(&amp;quot;MODULE_ID&amp;quot;,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditFailedValidateRequestResultWithFailureReason()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus.SEND_FAILURE));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_FAILURE_REASON_KEY,&nbsp;failureReason);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(&amp;quot;MODULE_ID&amp;quot;,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings({&nbsp;&amp;quot;unchecked&amp;quot;,&nbsp;&amp;quot;rawtypes&amp;quot;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditFailedValidateRequestResultWithoutFailureReason()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus.SEND_FAILURE));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Map&amp;gt;&nbsp;reasonCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Map.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;reasonCaptor.capture(),&nbsp;eq(moduleAuditInfo));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(reasonCaptor.getValue()).isEmpty();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResultAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidValidateRequestResultAuditingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings({&nbsp;&amp;quot;unchecked&amp;quot;,&nbsp;&amp;quot;rawtypes&amp;quot;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResultAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditInvalidValidateRequestResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Map&amp;gt;&nbsp;reasonCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Map.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;reasonCaptor.capture(),&nbsp;eq(moduleAuditInfo));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;reasonMessage&nbsp;=&nbsp;(String)&nbsp;reasonCaptor.getValue().get(&amp;quot;message&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(reasonMessage)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.startsWith(&amp;quot;Invalid&nbsp;AuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.contains(&amp;quot;validateRequest&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.contains(asString(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditValidateRequestAuthenticationExceptionWithFailureReason()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;failureReason&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_FAILURE_REASON_KEY,&nbsp;failureReason);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(&amp;quot;MODULE_ID&amp;quot;,&nbsp;failureReason,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(failureReason).containsEntry(&amp;quot;exception&amp;quot;,&nbsp;&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings({&nbsp;&amp;quot;unchecked&amp;quot;,&nbsp;&amp;quot;rawtypes&amp;quot;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;auditingAuthModuleShouldAuditValidateRequestAuthenticationExceptionWithoutFailureReason()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Map&amp;gt;&nbsp;reasonCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Map.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;reasonCaptor.capture(),&nbsp;eq(moduleAuditInfo));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(reasonCaptor.getValue()).containsEntry(&amp;quot;exception&amp;quot;,&nbsp;&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validateRequestResultSessionAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidateRequestResultSessionAuditingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;true,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;true,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;false,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;true,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;true,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;true,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validateRequestResultSessionAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;sessionAuditingAuthModuleShouldAuditValidateRequestResult(AuthStatus&nbsp;authStatus,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;shouldBeAudited,&nbsp;boolean&nbsp;isSuccessful)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_FAILURE_REASON_KEY,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withSessionAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(shouldBeAudited&nbsp;&amp;amp;&amp;amp;&nbsp;isSuccessful)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditSuccess(&amp;quot;MODULE_ID&amp;quot;,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(shouldBeAudited)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),&nbsp;eq(moduleAuditInfo));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).setSessionId(&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(requestContextMap)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_INFO_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_FAILURE_REASON_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;sessionAuditingAuthModuleShouldAuditValidateRequestAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;moduleAuditInfo&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;moduleAuditInfo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_FAILURE_REASON_KEY,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;SESSION_ID&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withSessionAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),&nbsp;eq(moduleAuditInfo));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).setSessionId(&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(requestContextMap)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_INFO_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_FAILURE_REASON_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;secureResponseResultSessionAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSecureResponseResultSessionAuditingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;secureResponseResultSessionAuditingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;sessionAuditingAuthModuleShouldAuditSecureResponseResult(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_FAILURE_REASON_KEY,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;SESSION_ID&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withSessionAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).setSessionId(&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(requestContextMap)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_INFO_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_FAILURE_REASON_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;sessionAuditingAuthModuleShouldAuditSecureResponseAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_INFO_KEY,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_FAILURE_REASON_KEY,&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_SESSION_ID_KEY,&nbsp;&amp;quot;SESSION_ID&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withSessionAuditing(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).setSessionId(&amp;quot;SESSION_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(requestContextMap)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_INFO_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_FAILURE_REASON_KEY)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.doesNotContainKey(AuditTrail.AUDIT_SESSION_ID_KEY);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;initializeResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInitializeResultLoggingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;initializeResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogInitializeResult(boolean&nbsp;logLevelEnabled)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;requestPolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;responsePolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;handler&nbsp;=&nbsp;mock(CallbackHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;options&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(logger.isDebugEnabled()).willReturn(logLevelEnabled);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logLevelEnabled)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).debug(anyString(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger,&nbsp;never()).debug(anyString(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;initializeResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogInitializeAuthenticationException(boolean&nbsp;logLevelEnabled)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;requestPolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;responsePolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;handler&nbsp;=&nbsp;mock(CallbackHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;options&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(logger.isErrorEnabled()).willReturn(logLevelEnabled);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(logLevelEnabled)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(anyString(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;eq(exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger,&nbsp;never()).error(anyString(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject(),&nbsp;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validateRequestResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidateRequestResultLoggingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;&amp;quot;success&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;&amp;quot;may&nbsp;have&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;&amp;quot;has&nbsp;not&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;&amp;quot;failed&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;&amp;quot;invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;&amp;quot;invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validateRequestResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogValidateRequestResult(AuthStatus&nbsp;authStatus,&nbsp;String&nbsp;expectedMessage,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isError)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(logger.isDebugEnabled()).willReturn(true);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isError)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(expectedMessage),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;eq(asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).debug(contains(expectedMessage),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogValidateRequestAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(&amp;quot;thrown&nbsp;an&nbsp;error&amp;quot;),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;eq(exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;secureResponseResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSecureResponseResultLoggingModuleData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;&amp;quot;may&nbsp;have&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;&amp;quot;has&nbsp;not&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;&amp;quot;failed&amp;quot;,&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;&amp;quot;invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;&amp;quot;invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;&amp;quot;invalid&nbsp;AuthStatus&amp;quot;,&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;secureResponseResultLoggingModule&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogSecureResponseResult(AuthStatus&nbsp;authStatus,&nbsp;String&nbsp;expectedMessage,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isError)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(logger.isDebugEnabled()).willReturn(true);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isError)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(expectedMessage),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;eq(asString(authStatus)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).debug(contains(expectedMessage),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogSecureResponseAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessage(&amp;quot;ERROR&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(&amp;quot;thrown&nbsp;an&nbsp;error&amp;quot;),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;eq(exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogCleanSubjectResult()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.cleanSubject(messageInfo,&nbsp;clientSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.cleanSubject(messageInfo,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).debug(contains(&amp;quot;success&amp;quot;),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;loggingAuthModuleShouldLogCleanSubjectAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContextInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageContextInfo.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationException&nbsp;exception&nbsp;=&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getModuleId()).willReturn(&amp;quot;MODULE_ID&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.cleanSubject(messageInfo,&nbsp;clientSubject))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newFailedPromise(exception));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;AuthModules.withLogging(logger,&nbsp;authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.cleanSubject(messageInfo,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(logger).error(contains(&amp;quot;failed&amp;quot;),&nbsp;eq(&amp;quot;MODULE_ID&amp;quot;),&nbsp;eq(exception));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthStatusUtilsTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthStatusUtilsTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthStatusUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthStatusUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,84&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AuthStatusUtilsTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;authStatusString&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Object[][]&nbsp;getAuthStatusStringData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;&amp;quot;SUCCESS&amp;quot;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;&amp;quot;SEND_SUCCESS&amp;quot;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;&amp;quot;SEND_CONTINUE&amp;quot;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;&amp;quot;SEND_FAILURE&amp;quot;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;&amp;quot;FAILURE&amp;quot;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;&amp;quot;null&amp;quot;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;authStatusString&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;asStringShouldConvertAuthStatusToString(AuthStatus&nbsp;authStatus,&nbsp;String&nbsp;expectedString)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;s&nbsp;=&nbsp;AuthStatusUtils.asString(authStatus);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(s).isEqualTo(expectedString);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;isAuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Object[][]&nbsp;getIsAuthStatusData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;AuthStatus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;isSuccess&nbsp;|&nbsp;isSendSuccess&nbsp;|&nbsp;isSendContinue&nbsp;|&nbsp;isSendFailure&nbsp;|&nbsp;isFailure&nbsp;|&nbsp;isNull<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS,&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;true},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;isAuthStatus&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;isAuthStatusShouldCompareAuthStatus(AuthStatus&nbsp;authStatus,&nbsp;boolean&nbsp;expectedIsSuccess,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;expectedIsSendSuccess,&nbsp;boolean&nbsp;expectedIsSendContinue,&nbsp;boolean&nbsp;expectedIsSendFailure,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;expectedIsFailure,&nbsp;boolean&nbsp;expectedIsNull)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isSuccess&nbsp;=&nbsp;AuthStatusUtils.isSuccess(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isSendSuccess&nbsp;=&nbsp;AuthStatusUtils.isSendSuccess(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isSendContinue&nbsp;=&nbsp;AuthStatusUtils.isSendContinue(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isSendFailure&nbsp;=&nbsp;AuthStatusUtils.isSendFailure(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isFailure&nbsp;=&nbsp;AuthStatusUtils.isFailure(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;isNull&nbsp;=&nbsp;AuthStatusUtils.isNull(authStatus);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(isSuccess).isEqualTo(expectedIsSuccess);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(isSendSuccess).isEqualTo(expectedIsSendSuccess);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(isSendContinue).isEqualTo(expectedIsSendContinue);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(isSendFailure).isEqualTo(expectedIsSendFailure);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(isFailure).isEqualTo(expectedIsFailure);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(isNull).isEqualTo(expectedIsNull);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthenticationFilterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFilterTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,244&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.failBecauseExceptionWasNotThrown;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFilter.AuthenticationFilterBuilder;<br>
+import&nbsp;static&nbsp;org.forgerock.caf.authentication.framework.AuthenticationFilter.AuthenticationModuleBuilder.configureModule;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.eq;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.callback.CallbackHandler;<br>
+import&nbsp;javax.security.auth.message.MessagePolicy;<br>
+import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
+import&nbsp;java.util.Collection;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.HashSet;<br>
+import&nbsp;java.util.List;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.mockito.ArgumentCaptor;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AuthenticationFilterTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(expectedExceptions&nbsp;=&nbsp;IllegalStateException.class)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;attemptingToBuildFilterWithNoAuditApiShouldThrowIllegalStateException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilterBuilder&nbsp;builder&nbsp;=&nbsp;spy(AuthenticationFilter.builder());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.build();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failBecauseExceptionWasNotThrown(IllegalStateException.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings({&nbsp;&amp;quot;unchecked&amp;quot;,&nbsp;&amp;quot;rawtypes&amp;quot;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldBuildFilterWithAuditApiAndDefaultLogger()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilterBuilder&nbsp;builder&nbsp;=&nbsp;spy(AuthenticationFilter.builder());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Logger&amp;gt;&nbsp;loggerCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;FailureResponseHandler&amp;gt;&nbsp;responseHandlerCaptor&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor.forClass(FailureResponseHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Subject&amp;gt;&nbsp;serviceSubjectCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Subject.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;List&amp;gt;&nbsp;authModulesCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(List.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(builder).createFilter(loggerCaptor.capture(),&nbsp;eq(auditApi),&nbsp;responseHandlerCaptor.capture(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubjectCaptor.capture(),&nbsp;eq(sessionAuthModule),&nbsp;authModulesCaptor.capture(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(loggerCaptor.getValue()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(responseHandlerCaptor.getValue()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(serviceSubjectCaptor.getValue()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(authModulesCaptor.getValue()).isEmpty();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldBuildFilterWithNamedLogger()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilterBuilder&nbsp;builder&nbsp;=&nbsp;spy(AuthenticationFilter.builder());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.named(&amp;quot;NAMED_LOGGER&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Logger&amp;gt;&nbsp;loggerCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Logger.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(builder).createFilter(loggerCaptor.capture(),&nbsp;eq(auditApi),&nbsp;Matchers.&amp;lt;FailureResponseHandler&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),&nbsp;eq(sessionAuthModule),&nbsp;Matchers.&amp;lt;List&amp;lt;AsyncServerAuthModule&amp;gt;&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(loggerCaptor.getValue()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings({&nbsp;&amp;quot;unchecked&amp;quot;,&nbsp;&amp;quot;rawtypes&amp;quot;&nbsp;})<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldBuildFullyConfiguredFilter()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceExceptionHandler&nbsp;responseHandler&nbsp;=&nbsp;mock(ResourceExceptionHandler.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mockAuthModule();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;sessionAuthModuleRequestPolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;sessionAuthModuleResponsePolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;sessionAuthModuleHandler&nbsp;=&nbsp;mock(CallbackHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;sessionAuthModuleSettings&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mockAuthModule();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;authModuleOneRequestPolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;authModuleOneResponsePolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;authModuleOneHandler&nbsp;=&nbsp;mock(CallbackHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authModuleOneSettings&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mockAuthModule();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;authModuleTwoRequestPolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;authModuleTwoResponsePolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;authModuleTwoHandler&nbsp;=&nbsp;mock(CallbackHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authModuleTwoSettings&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilterBuilder&nbsp;builder&nbsp;=&nbsp;spy(AuthenticationFilter.builder());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.logger(logger)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.serviceSubject(serviceSubject)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responseHandler(responseHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.sessionModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(sessionAuthModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(sessionAuthModuleRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(sessionAuthModuleResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(sessionAuthModuleHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(sessionAuthModuleSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authModules(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModuleOne)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleOneRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleOneResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleOneHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleOneSettings),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModuleTwo)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleTwoRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleTwoResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleTwoHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleTwoSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;Logger&amp;gt;&nbsp;loggerCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;FailureResponseHandler&amp;gt;&nbsp;responseHandlerCaptor&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor.forClass(FailureResponseHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;List&amp;gt;&nbsp;authModulesCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(List.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(builder).createFilter(loggerCaptor.capture(),&nbsp;eq(auditApi),&nbsp;responseHandlerCaptor.capture(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject),&nbsp;eq(sessionAuthModule),&nbsp;authModulesCaptor.capture(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(loggerCaptor.getValue()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(responseHandlerCaptor.getValue()).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(authModulesCaptor.getValue()).hasSize(2).contains(authModuleOne,&nbsp;authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).initialize(sessionAuthModuleRequestPolicy,&nbsp;sessionAuthModuleResponsePolicy,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModuleHandler,&nbsp;sessionAuthModuleSettings);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).initialize(authModuleOneRequestPolicy,&nbsp;authModuleOneResponsePolicy,&nbsp;authModuleOneHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleOneSettings);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).initialize(authModuleTwoRequestPolicy,&nbsp;authModuleTwoResponsePolicy,&nbsp;authModuleTwoHandler,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleTwoSettings);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldBuildFilterWithAdaptedServerAuthContext()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;authModuleRequestPolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessagePolicy&nbsp;authModuleResponsePolicy&nbsp;=&nbsp;mock(MessagePolicy.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallbackHandler&nbsp;authModuleHandler&nbsp;=&nbsp;mock(CallbackHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;authModuleSettings&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{Request.class,&nbsp;Response.class});<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationFilterBuilder&nbsp;builder&nbsp;=&nbsp;spy(AuthenticationFilter.builder());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.auditApi(auditApi)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authModules(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configureModule(authModule)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.requestPolicy(authModuleRequestPolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.responsePolicy(authModuleResponsePolicy)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.callbackHandler(authModuleHandler)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withSettings(authModuleSettings))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(builder).createFilter(Matchers.&amp;lt;Logger&amp;gt;anyObject(),&nbsp;eq(auditApi),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;FailureResponseHandler&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;AsyncServerAuthModule&amp;gt;anyObject(),&nbsp;anyListOf(AsyncServerAuthModule.class),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModule).initialize(authModuleRequestPolicy,&nbsp;authModuleResponsePolicy,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleHandler,&nbsp;authModuleSettings);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;mockAuthModule()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Collection&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;&nbsp;supportedMessageTypes&nbsp;=&nbsp;new&nbsp;HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Request.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supportedMessageTypes.add(Response.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(supportedMessageTypes);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.initialize(Matchers.&amp;lt;MessagePolicy&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;MessagePolicy&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;CallbackHandler&amp;gt;anyObject(),&nbsp;anyMapOf(String.class,&nbsp;Object.class)))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkAuthenticationFrameworkTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFrameworkTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFrameworkTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/AuthenticationFrameworkTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,419&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.util.test.assertj.AssertJPromiseAssert.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Matchers.eq;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.util.Collections;<br>
+import&nbsp;java.util.List;<br>
+<br>
+import&nbsp;org.assertj.core.api.Assertions;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.http.Context;<br>
+import&nbsp;org.forgerock.http.Handler;<br>
+import&nbsp;org.forgerock.http.HttpContext;<br>
+import&nbsp;org.forgerock.http.RootContext;<br>
+import&nbsp;org.forgerock.http.Session;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.http.protocol.ResponseException;<br>
+import&nbsp;org.forgerock.json.resource.ResourceException;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;AuthenticationFrameworkTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthenticationFramework&nbsp;runtime;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FailureResponseHandler&nbsp;responseHandler;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthContext&nbsp;authContext;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Subject&nbsp;serviceSubject;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Response&nbsp;successfulResponse&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(200);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Response&nbsp;unauthenticatedResponse&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(401);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Response&nbsp;failedResponse&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(400);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;Response&nbsp;serverErrorResponse&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(500);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setup()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;responseHandler&nbsp;=&nbsp;mock(FailureResponseHandler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.newSuccessfulPromise(Collections.&amp;lt;Void&amp;gt;emptyList());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime&nbsp;=&nbsp;createRuntime(initializationPromise);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthenticationFramework&nbsp;createRuntime(Promise&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;&nbsp;initializationPromise)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;AuthenticationFramework(logger,&nbsp;auditApi,&nbsp;responseHandler,&nbsp;authContext,&nbsp;serviceSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initializationPromise);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;HttpContext&nbsp;mockContext()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Session&nbsp;session&nbsp;=&nbsp;mock(Session.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;HttpContext(new&nbsp;RootContext(),&nbsp;session);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Handler&nbsp;mockHandler(Request&nbsp;request,&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mock(Handler.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(next.handle(Matchers.&amp;lt;Context&amp;gt;anyObject(),&nbsp;eq(request))).willReturn(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;next;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;mockAuthContext(Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(validateRequestResult,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;mockAuthContext(Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponseResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(validateRequestResult,&nbsp;secureResponseResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;mockAuthContext(Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponseResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubjectResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject))).willReturn(validateRequestResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject)))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(secureResponseResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authContext.cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(cleanSubjectResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenInitializationFailsExceptionShouldBeWrittenToResponse()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime&nbsp;=&nbsp;createRuntime(Promises.&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(responseHandler).handle(Matchers.&amp;lt;ResourceException&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;MessageContext&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenInitializationFailsWithResourceExceptionItShouldBeWrittenToResponse()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;resourceException&nbsp;=&nbsp;mock(ResourceException.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime&nbsp;=&nbsp;createRuntime(Promises.&amp;lt;List&amp;lt;Void&amp;gt;,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;,&nbsp;resourceException)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(responseHandler).handle(eq(resourceException),&nbsp;Matchers.&amp;lt;MessageContext&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenMessageProcessingSucceedsResourceResponseShouldBeReturned()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpContext&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(successfulResponse);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(context.getAttributes()).containsKey(AuthenticationFramework.ATTRIBUTE_REQUEST_ID);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(context.getAttributes())<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.containsKeys(AuthenticationFramework.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;AuthenticationFramework.ATTRIBUTE_AUTH_CONTEXT);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenValidateRequestReturnSendFailureShouldReturnAccessDeniedResponse()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.getOrThrowUninterruptibly();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.failBecauseExceptionWasNotThrown(ResourceException.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(ResponseException&nbsp;error)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(error.getResponse().getStatus()).isEqualTo(unauthenticatedResponse.getStatus());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;validateRequestResponse&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getValidateRequestResponseData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;validateRequestResponse&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenMessageProcessingStopsAfterValidatingRequestResponseShouldBeReturned(AuthStatus&nbsp;authStatus)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(promise.getOrThrowUninterruptibly().getStatus()).isEqualTo(200);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidValidateRequestResultsData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenValidateRequestReturnsInvalidResultExceptionShouldBeWrittenToResponse(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(responseHandler).handle(Matchers.&amp;lt;ResourceException&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;MessageContext&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenValidateRequestReturnsAuthenticationExceptionItShouldBeWrittenToResponse()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(responseHandler).handle(Matchers.&amp;lt;ResourceException&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;MessageContext&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext,&nbsp;never()).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;secureResponseResponse&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getSecureResponseResponseData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE,&nbsp;serverErrorResponse},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE,&nbsp;successfulResponse},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;secureResponseResponse&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenMessageProcessingStopsAfterSecureResponseTheResponseShouldBeReturned(AuthStatus&nbsp;authStatus,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;expectedResponse)&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(promise.getOrThrowUninterruptibly().getStatus()).isEqualTo(expectedResponse.getStatus());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;invalidSecureResponseResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getInvalidSecureResponseResultsData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{null},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;invalidSecureResponseResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSecureResponseReturnsInvalidResultExceptionShouldBeWrittenToResponse(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(responseHandler).handle(Matchers.&amp;lt;ResourceException&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;MessageContext&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSecureResponseReturnsAuthenticationExceptionItShouldBeWrittenToResponse()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newSuccessfulPromise(successfulResponse));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(responseHandler).handle(Matchers.&amp;lt;ResourceException&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;MessageContext&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenResourceReturnsResponseExceptionItShouldBeSecuredAndReturned()&nbsp;throws&nbsp;Exception&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;context&nbsp;=&nbsp;mockContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;next&nbsp;=&nbsp;mockHandler(request,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Response,&nbsp;ResponseException&amp;gt;newFailedPromise(new&nbsp;ResponseException(failedResponse)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthContext(Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Response,&nbsp;ResponseException&amp;gt;&nbsp;promise&nbsp;=&nbsp;runtime.processMessage(context,&nbsp;request,&nbsp;next);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assertions.assertThat(promise.getOrThrowUninterruptibly().getStatus()).isEqualTo(failedResponse.getStatus());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).validateRequest(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).secureResponse(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;eq(serviceSubject));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authContext).cleanSubject(Matchers.&amp;lt;MessageContext&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkContextHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/ContextHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,220&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.security.Principal;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;ContextHandlerTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextHandler&nbsp;contextHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler&nbsp;=&nbsp;new&nbsp;ContextHandler(messageInfoUtils);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModulesWhenAuthModulesNull()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenDoesNotSupportEither()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[0]);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenOnlySupportsHttpServletRequest()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{HttpServletRequest.class});<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateServerAuthModulesShouldThrowJaspiAuthExceptionWhenOnlySupportsHttpServletResponse()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes()).willReturn(new&nbsp;Class[]{HttpServletResponse.class});<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;rawtypes&amp;quot;)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.getSupportedMessageTypes())<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(new&nbsp;Class[]{HttpServletRequest.class,&nbsp;HttpServletResponse.class});<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateServerAuthModulesWhenAuthModuleListContainsNullAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.validateServerAuthModuleConformToHttpServletProfile(authModules);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNull()&nbsp;throws&nbsp;AuthException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail(&amp;quot;Expect&nbsp;exception&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(AuthException&nbsp;e)&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(e.getCause()&nbsp;instanceof&nbsp;ResourceException);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((ResourceException)&nbsp;e.getCause()).getCode(),&nbsp;401);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNotNullAndPrincipalNameNotSet()&nbsp;throws&nbsp;AuthException,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT)).willReturn(contextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(messageInfo,&nbsp;never()).setRequestMessage(anyObject());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleCompletionWhenAuthStatusIsNotNull()&nbsp;throws&nbsp;AuthException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal&nbsp;principalOne&nbsp;=&nbsp;mock(Principal.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getRequestMessage()).willReturn(request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT)).willReturn(contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientSubject.getPrincipals().add(principalOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(principalOne.getName()).willReturn(&amp;quot;PRN_ONE&amp;quot;);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler.handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;authStatus);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_PRINCIPAL,&nbsp;&amp;quot;PRN_ONE&amp;quot;);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(request).setAttribute(JaspiRuntime.ATTRIBUTE_AUTH_CONTEXT,&nbsp;contextMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFailureResponseHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FailureResponseHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-16,19&nbsp;+16,21&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;package&nbsp;org.forgerock.caf.authentication.framework;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.entry;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;static&nbsp;org.forgerock.json.fluent.JsonValue.*;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
&lt;/del&gt;&lt;ins&gt;+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.PrintWriter;<br>
-import&nbsp;java.io.StringWriter;<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.Arrays;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;java.util.List;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;java.util.Map;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.guava.common.net.MediaType;<br>
&lt;/span&gt;&lt;ins&gt;+import&nbsp;org.forgerock.http.header.ContentTypeHeader;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.forgerock.json.resource.ResourceException;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.BeforeMethod;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;import&nbsp;org.testng.annotations.DataProvider;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-37,7&nbsp;+39,7&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;public&nbsp;class&nbsp;FailureResponseHandlerTest&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_XML&nbsp;=&nbsp;&amp;quot;application/xml&amp;quot;;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_JSON&nbsp;=&nbsp;&amp;quot;application/json&amp;quot;;<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;APPLICATION_JSON&nbsp;=&nbsp;&amp;quot;application/json;&nbsp;charset=UTF-8&amp;quot;;<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TEXT_XML&nbsp;=&nbsp;&amp;quot;text/xml&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TEXT_PLAIN&nbsp;=&nbsp;&amp;quot;text/plain&amp;quot;;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-48,12&nbsp;+50,11&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.handler&nbsp;=&nbsp;new&nbsp;FailureResponseHandler();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;@SuppressWarnings(&amp;quot;unchecked&amp;quot;)<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;jsonHandlerShouldRenderException()&nbsp;throws&nbsp;Exception&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StringWriter();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(new&nbsp;PrintWriter(sw)).when(response).getWriter();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;response&nbsp;=&nbsp;new&nbsp;Response();<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.BAD_REQUEST,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;))));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-61,28&nbsp;+62,29&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;FailureResponseHandler.JsonResourceExceptionHandler().write(jre,&nbsp;response);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;responseText&nbsp;=&nbsp;sw.toString();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;400&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;BAD_REQUEST&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;DETAIL_KEY&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(responseText.contains(&amp;quot;DETAIL_VALUE&amp;quot;));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setContentType(&amp;quot;application/json&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;responseBody&nbsp;=&nbsp;(Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;response.getEntity().getJson();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(response.getHeaders().getFirst(ContentTypeHeader.NAME)).isEqualTo(&amp;quot;application/json;&nbsp;charset=UTF-8&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(responseBody).containsKey(&amp;quot;detail&amp;quot;).contains(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;code&amp;quot;,&nbsp;400),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;reason&amp;quot;,&nbsp;&amp;quot;Bad&nbsp;Request&amp;quot;),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry(&amp;quot;message&amp;quot;,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat((Map&amp;lt;String,&nbsp;Object&amp;gt;)&nbsp;responseBody.get(&amp;quot;detail&amp;quot;)).containsEntry(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;content-types&amp;quot;)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;Object[][]&nbsp;contentTypes()&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]&nbsp;{<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;APPLICATION_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/svg+xml&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_PLAIN,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.8,&nbsp;application/xml&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.9,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=1.0&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;null,&nbsp;APPLICATION_JSON&nbsp;}<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;APPLICATION_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/svg+xml&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_XML,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;TEXT_PLAIN,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.8,&nbsp;application/xml&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;application/json;&nbsp;q=0.9,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=0.8&amp;quot;,&nbsp;APPLICATION_JSON&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&amp;quot;*/*;&nbsp;q=1.0,&nbsp;application/json;&nbsp;q=0.6,&nbsp;application/xml;&nbsp;q=1.0&amp;quot;,&nbsp;APPLICATION_XML&nbsp;},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;null,&nbsp;APPLICATION_JSON&nbsp;}<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-90,24&nbsp;+92,24&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldUseExceptionHandlerIfAvailable(String&nbsp;accept,&nbsp;String&nbsp;expected)&nbsp;throws&nbsp;Exception&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StringWriter();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(new&nbsp;PrintWriter(sw)).when(response).getWriter();<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;response&nbsp;=&nbsp;new&nbsp;Response();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;messageContext&nbsp;=&nbsp;mock(MessageContext.class);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doReturn(accept).when(request).getHeader(&amp;quot;Accept&amp;quot;);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.getHeaders().putSingle(&amp;quot;Accept&amp;quot;,&nbsp;accept);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageContext.getRequest()).willReturn(request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageContext.getResponse()).willReturn(response);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.registerExceptionHandler(TestExceptionHandler.class);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.registerExceptionHandler(new&nbsp;TestExceptionHandler());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResourceException&nbsp;jre&nbsp;=&nbsp;ResourceException.getException(ResourceException.BAD_REQUEST,&nbsp;&amp;quot;BAD_REQUEST&amp;quot;);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jre.setDetail(json(object(field(&amp;quot;DETAIL_KEY&amp;quot;,&nbsp;&amp;quot;DETAIL_VALUE&amp;quot;))));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.handle(jre,&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response));<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handler.handle(jre,&nbsp;messageContext);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(400);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setContentType(expected);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(response.getHeaders().getFirst(ContentTypeHeader.NAME)).isEqualTo(expected);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;final&nbsp;class&nbsp;TestExceptionHandler&nbsp;implements&nbsp;ResourceExceptionHandler&nbsp;{<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-116,10&nbsp;+118,9&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Arrays.asList(MediaType.parse(APPLICATION_XML),&nbsp;MediaType.parse(TEXT_XML));<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;HttpServletResponse&nbsp;response)&nbsp;throws&nbsp;IOException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setContentType(APPLICATION_XML);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.getWriter().write(&amp;quot;Hello&nbsp;&amp;quot;+exception.getCode());<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;write(ResourceException&nbsp;exception,&nbsp;Response&nbsp;response)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.getHeaders().putSingle(ContentTypeHeader.valueOf(APPLICATION_XML));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setEntity(&amp;quot;Hello&nbsp;&amp;quot;&nbsp;+&nbsp;exception.getCode());<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;del&gt;-<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&lt;/span&gt;&lt;del&gt;-}<br>
&lt;/del&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;\&nbsp;No&nbsp;newline&nbsp;at&nbsp;end&nbsp;of&nbsp;file<br>
&lt;/span&gt;&lt;ins&gt;+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFallbackAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackAuthContextTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,281&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.util.test.assertj.AssertJPromiseAssert.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.util.Arrays;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.mockito.invocation.InvocationOnMock;<br>
+import&nbsp;org.mockito.stubbing.Answer;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.AfterMethod;<br>
+import&nbsp;org.testng.annotations.DataProvider;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;FallbackAuthContextTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackAuthContext&nbsp;authContext;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuthenticationState&nbsp;state;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@AfterMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;tearDown()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackAuthContext&nbsp;createFallbackAuthContext(AsyncServerAuthModule...&nbsp;authModules)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;FallbackAuthContext(logger,&nbsp;Arrays.asList(authModules));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;mockAuthModule(Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mockAuthModule(validateRequestResult,&nbsp;null,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;mockAuthModule(Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponseResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;mockAuthModule(validateRequestResult,&nbsp;secureResponseResult,&nbsp;null);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;mockAuthModule(Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequestResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponseResult,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubjectResult)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.validateRequest(Matchers.&amp;lt;MessageContextInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject())).willReturn(validateRequestResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(Matchers.&amp;lt;MessageContextInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(secureResponseResult);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.cleanSubject(Matchers.&amp;lt;MessageContextInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(cleanSubjectResult);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;authModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageContext&nbsp;mockMessageContext()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(context.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when(context.getState(Matchers.&amp;lt;AsyncServerAuthContext&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.thenAnswer(new&nbsp;Answer&amp;lt;AuthenticationState&amp;gt;()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationState&nbsp;answer(InvocationOnMock&nbsp;invocationOnMock)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(state&nbsp;==&nbsp;null)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;=&nbsp;authContext.createAuthenticationState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;state;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;context;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenNoAuthModulesConfiguredValidateRequestShouldReturnSendFailure()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;authModuleOneValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getAuthModuleOneValidateRequestResultsData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;authModuleOneValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldCallFirstAuthModule(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mockAuthModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mockAuthModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newFailedPromise(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext(authModuleOne,&nbsp;authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo,&nbsp;never()).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@DataProvider(name&nbsp;=&nbsp;&amp;quot;authModuleTwoValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object[][]&nbsp;getAuthModuleTwoValidateRequestResultsData()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;Object[][]{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_SUCCESS},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_CONTINUE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AuthStatus.SEND_FAILURE},<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test(dataProvider&nbsp;=&nbsp;&amp;quot;authModuleTwoValidateRequestResults&amp;quot;)<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenFirstAuthModuleReturnsSendFailureValidateRequestShouldCallNextAuthModule(AuthStatus&nbsp;authStatus)&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mockAuthModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mockAuthModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(authStatus));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext(authModuleOne,&nbsp;authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(authStatus);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenNoAuthModuleAuthenticatedTheRequestSecureResponseShouldThrowAuthenticationException()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().hasMessageStartingWith(&amp;quot;No&nbsp;auth&nbsp;module&nbsp;authenticated&nbsp;the&nbsp;incoming&nbsp;&amp;quot;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&amp;quot;request&nbsp;message&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenAuthModuleAuthenticatedRequestSecureResponseShouldCallAuthenticatingAuthModule()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mockAuthModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mockAuthModule(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_FAILURE)),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubjectShouldCallAllAuthModules()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mockAuthModule(null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mockAuthModule(null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext(authModuleOne,&nbsp;authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubjectShouldReportExceptionFromAuthModules()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mockAuthModule(null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newFailedPromise(new&nbsp;AuthenticationException(&amp;quot;ERROR&amp;quot;)));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mockAuthModule(null,&nbsp;null,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createFallbackAuthContext(authModuleOne,&nbsp;authModuleTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkFallbackServerAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/FallbackServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,389&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;FallbackServerAuthContextTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;FallbackServerAuthContext&nbsp;fallbackServerAuthContext;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextHandler&nbsp;contextHandler&nbsp;=&nbsp;mock(ContextHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext&nbsp;=&nbsp;new&nbsp;FallbackServerAuthContext(messageInfoUtils,&nbsp;contextHandler,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSuccessWhenFirstAuthModuleValidateRequestReturnsSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsKey(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsValue(authModuleOne));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendSuccessWhenFirstAuthModuleValidateRequestReturnsSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendContinueWhenFirstAuthModuleValidateRequestReturnsSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSuccessWhenAuthModulesValidateRequestReturnSendFailureSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleTwo.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsKey(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(privateContextMap.containsValue(authModuleTwo));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldReturnSendFailureWhenSingleAuthModuleValidateRequestReturnsSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModuleOne.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowAuthExceptionWhenAuthModuleValidateRequestThrowsAuthException()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;Object&amp;gt;&nbsp;failureReasonList&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.failure.reasons&amp;quot;,&nbsp;failureReasonList);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(authModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldReturnSendFailureWithNoAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.validateRequest(authModules,&nbsp;messageInfo,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnNullWhenNoAuthModuleValidateRequestSuccessfullyAuthenticated()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNull(authStatus);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendSuccessWhenAuthModuleReturnsSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendContinueWhenAuthModuleReturnsSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldReturnSendFailureWhenAuthModuleReturnsSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(authModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(privateContextMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowAuthExceptionWhenAuthModuleSecureResponseThrowsAuthException()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;privateContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(authModule).secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateContextMap.put(FallbackServerAuthContext.AUTHENTICATING_AUTH_MODULE_KEY,&nbsp;authModule);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;&amp;quot;_serverAuthContextMap&amp;quot;)).willReturn(privateContextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallbackServerAuthContext.secureResponse(authModules,&nbsp;messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkHttpServletMessageInfoTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/HttpServletMessageInfoTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,130&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;HttpServletMessageInfoTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetRequestMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;returnedRequest&nbsp;=&nbsp;messageInfo.getRequestMessage();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedRequest);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedRequest,&nbsp;request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetResponseMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;returnedResponse&nbsp;=&nbsp;messageInfo.getResponseMessage();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedResponse);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedResponse,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMapWithNoMapGivenInConstructor()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;returnedMap&nbsp;=&nbsp;messageInfo.getMap();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(returnedMap.size(),&nbsp;0);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSetRequestMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request2&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.setRequestMessage(request2);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;returnedRequest&nbsp;=&nbsp;messageInfo.getRequestMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedRequest);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedRequest,&nbsp;request2);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSetResponseMessage()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response2&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfo.setResponseMessage(response2);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;returnedResponse&nbsp;=&nbsp;messageInfo.getResponseMessage();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(returnedResponse);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotEquals(returnedResponse,&nbsp;response2);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMapWithMapGivenInConstructor()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletMessageInfo&nbsp;messageInfo&nbsp;=&nbsp;new&nbsp;HttpServletMessageInfo(request,&nbsp;response,&nbsp;map);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;returnedMap&nbsp;=&nbsp;messageInfo.getMap();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(returnedMap,&nbsp;map);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiAdaptersTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;modfile&quot;&gt;&lt;h4&gt;Modified:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiAdaptersTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiAdaptersTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiAdaptersTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-60,8&nbsp;+60,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;asyncAuthContext&nbsp;=&nbsp;JaspiAdapters.adapt(authContext);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthContext.validateRequest(messageContext,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthContext.validateRequest(messageContext,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SUCCESS);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-81,8&nbsp;+81,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;asyncAuthContext&nbsp;=&nbsp;JaspiAdapters.adapt(authContext);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthContext.validateRequest(messageContext,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthContext.validateRequest(messageContext,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().isInstanceOf(AuthenticationException.class);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-101,8&nbsp;+101,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;asyncAuthContext&nbsp;=&nbsp;JaspiAdapters.adapt(authContext);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthContext.secureResponse(messageContext,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthContext.secureResponse(messageContext,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-121,8&nbsp;+121,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;asyncAuthContext&nbsp;=&nbsp;JaspiAdapters.adapt(authContext);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthContext.secureResponse(messageContext,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthContext.secureResponse(messageContext,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().isInstanceOf(AuthenticationException.class);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-190,8&nbsp;+190,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isNull();<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-212,8&nbsp;+212,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthModule.initialize(requestPolicy,&nbsp;responsePolicy,&nbsp;handler,&nbsp;options);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().isInstanceOf(AuthenticationException.class);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-249,8&nbsp;+249,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SUCCESS);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-270,8&nbsp;+270,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().isInstanceOf(AuthenticationException.class);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-290,8&nbsp;+290,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-310,8&nbsp;+310,8&nbsp;@@<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;asyncAuthModule&nbsp;=&nbsp;JaspiAdapters.adapt(authModule);<br>
&lt;/span&gt;&lt;del&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;asyncAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
&lt;/del&gt;&lt;ins&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asyncAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
&lt;/ins&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;cx&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).failedWithException().isInstanceOf(AuthenticationException.class);<br>
&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiHttpServletResponseWrapperTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiHttpServletResponseWrapperTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,62&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertTrue;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiHttpServletResponseWrapperTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetOutputStream()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiHttpServletResponseWrapper&nbsp;responseWrapper&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper(response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletOutputStream&nbsp;outputStream&nbsp;=&nbsp;responseWrapper.getOutputStream();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(JaspiServletOutputStream.class.isAssignableFrom(outputStream.getClass()));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetWriter()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiHttpServletResponseWrapper&nbsp;responseWrapper&nbsp;=&nbsp;new&nbsp;JaspiHttpServletResponseWrapper(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;printWriter&nbsp;=&nbsp;mock(PrintWriter.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(response.getWriter()).willReturn(printWriter);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;writer&nbsp;=&nbsp;responseWrapper.getWriter();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(JaspiPrintWriter.class.isAssignableFrom(writer.getClass()));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiPrintWriterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiPrintWriterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,40&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiPrintWriterTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiPrintWriter()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;printWriter&nbsp;=&nbsp;mock(PrintWriter.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiPrintWriter&nbsp;jaspiPrintWriter&nbsp;=&nbsp;new&nbsp;JaspiPrintWriter(printWriter);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiPrintWriter);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeFilterTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeFilterTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,103&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-import&nbsp;static&nbsp;org.testng.Assert.fail;<br>
-<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.FilterConfig;<br>
-import&nbsp;javax.servlet.ServletException;<br>
-import&nbsp;javax.servlet.ServletRequest;<br>
-import&nbsp;javax.servlet.ServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiRuntimeFilterTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiRuntimeFilter&nbsp;jaspiRuntimeFilter;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;throws&nbsp;ServletException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditApi&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter&nbsp;=&nbsp;new&nbsp;JaspiRuntimeFilter(contextFactory,&nbsp;auditApi);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterConfig&nbsp;filterConfig&nbsp;=&nbsp;mock(FilterConfig.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.init(filterConfig);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiRuntimeFilterWithDefaultConstructor()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntimeFilter&nbsp;runtimeFilter&nbsp;=&nbsp;new&nbsp;JaspiRuntimeFilter();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(runtimeFilter);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;ServletException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowServletExceptionWhenNotHttpServletRequest()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletRequest&nbsp;request&nbsp;=&nbsp;mock(ServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.doFilter(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;ServletException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowServletExceptionWhenNotHttpServletResponse()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletResponse&nbsp;response&nbsp;=&nbsp;mock(ServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.doFilter(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldDestroyFilter()&nbsp;throws&nbsp;ServletException,&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntimeFilter.destroy();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiRuntimeTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiRuntimeTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,161&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-*&nbsp;License.<br>
-*<br>
-*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-*<br>
-*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-*<br>
-*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.config.ServerAuthContext;<br>
-import&nbsp;javax.servlet.FilterChain;<br>
-import&nbsp;javax.servlet.http.HttpServletRequest;<br>
-import&nbsp;javax.servlet.http.HttpServletRequestWrapper;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;javax.servlet.http.HttpServletResponseWrapper;<br>
-<br>
-import&nbsp;org.forgerock.json.resource.ResourceException;<br>
-import&nbsp;org.mockito.ArgumentCaptor;<br>
-import&nbsp;org.mockito.Matchers;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiRuntimeTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;RuntimeResultHandler&nbsp;runtimeResultHandler;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditApi&nbsp;auditApi;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtimeResultHandler&nbsp;=&nbsp;mock(RuntimeResultHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditApi&nbsp;=&nbsp;mock(AuditApi.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessageAndPassStraightToChainWhenServerAuthContextNotConfigured()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain).doFilter(request,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(runtimeResultHandler);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessageAndNotCallChainIfValidateRequestIsNotSUCCESS()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(runtimeResultHandler.handleValidateRequestResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;AuditTrail&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject())).willReturn(false);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain,&nbsp;never()).doFilter(request,&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(runtimeResultHandler,&nbsp;never()).handleSecureResponseResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldProcessMessage()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(runtimeResultHandler.handleValidateRequestResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;AuditTrail&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject())).willReturn(true);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;HttpServletRequest&amp;gt;&nbsp;requestCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;HttpServletResponse&amp;gt;&nbsp;responseCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(filterChain).doFilter(requestCaptor.capture(),&nbsp;responseCaptor.capture());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(runtimeResultHandler).handleSecureResponseResult(Matchers.&amp;lt;AuthStatus&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;HttpServletResponse&amp;gt;anyObject());<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(serverAuthContext).cleanSubject(Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((HttpServletRequestWrapper)&nbsp;requestCaptor.getValue()).getRequest(),&nbsp;request);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(((HttpServletResponseWrapper)&nbsp;responseCaptor.getValue()).getResponse(),&nbsp;response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldConvertAuthExceptionToCrestResponseWhenDoFilterFails()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;mock(HttpServletRequest.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain&nbsp;filterChain&nbsp;=&nbsp;mock(FilterChain.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FailureResponseHandler&nbsp;failureResponseHandler&nbsp;=&nbsp;mock(FailureResponseHandler.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContextFactory&nbsp;contextFactory&nbsp;=&nbsp;mock(ContextFactory.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthContext&nbsp;serverAuthContext&nbsp;=&nbsp;mock(ServerAuthContext.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(contextFactory.getContext()).willReturn(serverAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(serverAuthContext).validateRequest(Matchers.&amp;lt;MessageInfo&amp;gt;anyObject(),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject());<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiRuntime&nbsp;jaspiRuntime&nbsp;=&nbsp;new&nbsp;JaspiRuntime(contextFactory,&nbsp;runtimeResultHandler,&nbsp;auditApi,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failureResponseHandler);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiRuntime.processMessage(request,&nbsp;response,&nbsp;filterChain);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArgumentCaptor&amp;lt;ResourceException&amp;gt;&nbsp;resourceExceptionCaptor&nbsp;=&nbsp;ArgumentCaptor.forClass(ResourceException.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(failureResponseHandler).handle(resourceExceptionCaptor.capture(),&nbsp;any(MessageInfo.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(resourceExceptionCaptor.getValue().getCode(),&nbsp;500);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServerAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServerAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,789&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.never;<br>
-import&nbsp;static&nbsp;org.mockito.Matchers.anyListOf;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.security.auth.message.module.ServerAuthModule;<br>
-import&nbsp;java.util.ArrayList;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.List;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiServerAuthContextTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ContextHandler&nbsp;contextHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;mock(MessageInfoUtils.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextHandler&nbsp;=&nbsp;mock(ContextHandler.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;createJaspiServerAuthContext(ServerAuthModule&nbsp;sessionAuthModule,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules,&nbsp;final&nbsp;AuthStatus&nbsp;validateRequestAuthStatus,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;AuthStatus&nbsp;secureResponseAuthStatus)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;(messageInfoUtils,&nbsp;contextHandler,&nbsp;sessionAuthModule,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules)&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;validateRequest(List&nbsp;authModules,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;validateRequestAuthStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;AuthStatus&nbsp;secureResponse(List&nbsp;authModules,&nbsp;MessageInfo&nbsp;messageInfo,&nbsp;Subject&nbsp;serviceSubject)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;secureResponseAuthStatus;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContextWithNoSessionAuthModuleAndEmptyListOfAuthModules()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContextWithNoSessionAuthModuleAndNullListOfAuthModules()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCreateJaspiServerAuthContext()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(jaspiServerAuthContext);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldThrowJaspiAuthExceptionWhenAuthModuleDoesNotConformToHttpServletProfile()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doThrow(AuthException.class).when(contextHandler)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.validateServerAuthModuleConformToHttpServletProfile(anyListOf(ServerAuthModule.class));<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createJaspiServerAuthContext(sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetMessageInfoUtils()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfoUtils&nbsp;actualMessageInfoUtils&nbsp;=&nbsp;jaspiServerAuthContext.getMessageInfoUtils();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(actualMessageInfoUtils,&nbsp;messageInfoUtils);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithNoAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler,&nbsp;never()).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_CONTINUE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler,&nbsp;never()).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenSessionModuleReturnsInvalidAuthStatus()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithOnlySessionModuleSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_FAILURE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;contextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfoUtils.getMap(messageInfo,&nbsp;JaspiServerAuthContext.PRIVATE_CONTEXT_MAP_KEY))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(contextMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenAuthModulesReturnNull()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldThrowJaspiAuthExceptionWhenAuthModulesReturnFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.FAILURE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Expected&nbsp;JaspiAuthException<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldNotAuditWhenAuthModulesReturnSendContinue()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_CONTINUE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_CONTINUE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSendSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldAuditWhenAuthModulesReturnSendFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SEND_FAILURE,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject))<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(auditTrail).auditFailure(startsWith(&amp;quot;Session-ServerAuthModule&amp;quot;),&nbsp;anyMapOf(String.class,&nbsp;Object.class),<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyMapOf(String.class,&nbsp;Object.class));<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldValidateRequestWithNoSessionModuleAndWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;AuthStatus.SUCCESS,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.validateRequest(messageInfo,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(contextHandler).handleCompletion(messageInfo,&nbsp;clientSubject,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(auditTrail);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldThrowJaspiAuthExceptionWhenAuthModulesReturnSuccess()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthenticationException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldThrowJaspiAuthExceptionWhenAuthModulesReturnFailure()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnSendSuccessWithNoSessionAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnNullWithSessionAuthModule()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_SUCCESS);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldSecureResponseWhenAuthModulesReturnSendSuccessAndSessionModuleReturnsSendFailure()<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;AuthStatus.SEND_SUCCESS);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(&amp;quot;org.forgerock.authentication.audit.trail&amp;quot;,&nbsp;auditTrail);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(messageInfo,&nbsp;serviceSubject)).willReturn(AuthStatus.SEND_FAILURE);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;jaspiServerAuthContext.secureResponse(messageInfo,&nbsp;serviceSubject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(authStatus,&nbsp;AuthStatus.SEND_FAILURE);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithNoSessionAuthModuleAndNullAuthModules()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithOnlySessionAuthModuleConfigured()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;null;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubjectWithOnlyAuthModulesConfigured()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;null;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldCleanSubject()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleOne&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerAuthModule&nbsp;authModuleTwo&nbsp;=&nbsp;mock(ServerAuthModule.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&amp;lt;ServerAuthModule&amp;gt;&nbsp;authModules&nbsp;=&nbsp;new&nbsp;ArrayList&amp;lt;ServerAuthModule&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleOne);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authModules.add(authModuleTwo);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JaspiServerAuthContext&amp;lt;ServerAuthModule&amp;gt;&nbsp;jaspiServerAuthContext&nbsp;=&nbsp;createJaspiServerAuthContext(<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule,&nbsp;authModules,&nbsp;null,&nbsp;null);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//-----------------<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;subject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jaspiServerAuthContext.cleanSubject(messageInfo,&nbsp;subject);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleOne).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(authModuleTwo).cleanSubject(messageInfo,&nbsp;subject);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkJaspiServletOutputStreamTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/JaspiServletOutputStreamTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,91&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.verify;<br>
-<br>
-import&nbsp;javax.servlet.ServletOutputStream;<br>
-import&nbsp;java.io.IOException;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;JaspiServletOutputStreamTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;JaspiServletOutputStream&nbsp;servletOutputStream;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;ServletOutputStream&nbsp;outputStream;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outputStream&nbsp;=&nbsp;mock(ServletOutputStream.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream&nbsp;=&nbsp;new&nbsp;JaspiServletOutputStream(outputStream);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWrite()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(1);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWriteByte()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;b&nbsp;=&nbsp;new&nbsp;byte[0];<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(b);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldWriteByteWithLength()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;b&nbsp;=&nbsp;new&nbsp;byte[0];<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.write(b,&nbsp;0,&nbsp;1);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).write(b,&nbsp;0,&nbsp;1);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldClose()&nbsp;throws&nbsp;IOException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletOutputStream.close();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(outputStream).close();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkMessageContextImplTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageContextImplTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageContextImplTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageContextImplTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,213&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.assertj.core.api.Assertions.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthContextWithState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationState;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.http.Context;<br>
+import&nbsp;org.forgerock.http.protocol.Request;<br>
+import&nbsp;org.forgerock.http.protocol.Response;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;MessageContextImplTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageContext&nbsp;context;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Request&nbsp;request;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AuditTrail&nbsp;auditTrail;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setup()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context&nbsp;parent&nbsp;=&nbsp;mock(Context.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context&nbsp;=&nbsp;new&nbsp;MessageContextImpl(parent,&nbsp;request,&nbsp;auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getRequestShouldReturnInitialRequest()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;context.getRequest();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(request).isEqualTo(this.request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setRequestShouldReplaceInitialRequest()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Request&nbsp;request&nbsp;=&nbsp;new&nbsp;Request();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.setRequest(request);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(context.getRequest()).isEqualTo(request);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getResponseShouldReturnSuccessfulResponse()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;response&nbsp;=&nbsp;context.getResponse();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(response.getStatus()).isEqualTo(200);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(response.getReason()).isEqualTo(&amp;quot;OK&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setResponseShouldReplaceInitialResponse()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response&nbsp;response&nbsp;=&nbsp;new&nbsp;Response().setStatusAndReason(401);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.setResponse(response);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(context.getResponse()).isEqualTo(response);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(response.getStatus()).isEqualTo(401);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(response.getReason()).isEqualTo(&amp;quot;Unauthorized&amp;quot;);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getRequestContextMapShouldReturnEmptyMap()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;context.getRequestContextMap();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(requestContextMap).isEmpty();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getAuditTrailShouldReturnInitialAuditTrail()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;context.getAuditTrail();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(auditTrail).isEqualTo(this.auditTrail);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getStateShouldReturnNewAuthenticationStateWhenFirstCalledByAuthContext()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;state&nbsp;=&nbsp;context.getState(authContext);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(state).isNotNull();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getStateShouldReturnSameAuthenticationStateWhenSubsequentlyCalledBySameAuthContext()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;stateOne&nbsp;=&nbsp;context.getState(authContext);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;stateTwo&nbsp;=&nbsp;context.getState(authContext);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(stateOne).isEqualTo(stateTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getStateShouldReturnDifferentAuthenticationStateWhenCalledByDifferentAuthContext()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContextOne&nbsp;=&nbsp;mock(AsyncServerAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContextTwo&nbsp;=&nbsp;mock(TestAuthContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;stateOne&nbsp;=&nbsp;context.getState(authContextOne);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;stateTwo&nbsp;=&nbsp;context.getState(authContextTwo);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(stateOne).isNotEqualTo(stateTwo);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;getStateShouldReturnSpecificAuthenticationStateSubTypeWhenCalledByAuthContextWithState()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthContext&nbsp;authContext&nbsp;=&nbsp;new&nbsp;TestAuthContext();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthenticationState&nbsp;state&nbsp;=&nbsp;context.getState(authContext);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(state).isNotNull().isInstanceOf(TestAuthenticationState.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;class&nbsp;TestAuthContext&nbsp;implements&nbsp;AsyncServerAuthContext,&nbsp;AuthContextWithState&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;validateRequest(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject,&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;secureResponse(MessageContext&nbsp;context,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;cleanSubject(MessageContext&nbsp;context,&nbsp;Subject&nbsp;clientSubject)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthenticationState&nbsp;createAuthenticationState()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;TestAuthenticationState();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;class&nbsp;TestAuthenticationState&nbsp;extends&nbsp;AuthenticationState&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkMessageInfoUtilsTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/MessageInfoUtilsTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,92&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.mock;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertEquals;<br>
-import&nbsp;static&nbsp;org.testng.Assert.assertNotNull;<br>
-<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;java.util.HashMap;<br>
-import&nbsp;java.util.Map;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;MessageInfoUtilsTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageInfoUtils&nbsp;messageInfoUtils;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils&nbsp;=&nbsp;new&nbsp;MessageInfoUtils();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetNewMap()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;mapKey);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertNotNull(map);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldGetExistingMap()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;expectedMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoMap.put(mapKey,&nbsp;expectedMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;map&nbsp;=&nbsp;messageInfoUtils.getMap(messageInfo,&nbsp;mapKey);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertEquals(map,&nbsp;expectedMap);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;should()&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mapKey&nbsp;=&nbsp;&amp;quot;MAP_KEY&amp;quot;;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;messageInfoMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(messageInfo.getMap()).willReturn(messageInfoMap);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageInfoUtils.addMap(messageInfo,&nbsp;mapKey);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkRuntimeResultHandlerTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;delfile&quot;&gt;&lt;h4&gt;Deleted:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&nbsp;(3260&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:01:25&nbsp;UTC&nbsp;(rev&nbsp;3260)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/RuntimeResultHandlerTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-1,212&nbsp;+0,0&nbsp;@@<br>
&lt;/span&gt;&lt;del&gt;-/*<br>
-&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
-&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
-&nbsp;*&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
-&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
-&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
-&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
-&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
-&nbsp;*<br>
-&nbsp;*&nbsp;Copyright&nbsp;2013-2015&nbsp;ForgeRock&nbsp;AS.<br>
-&nbsp;*/<br>
-<br>
-package&nbsp;org.forgerock.caf.authentication.framework;<br>
-<br>
-import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
-import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
-import&nbsp;static&nbsp;org.testng.Assert.*;<br>
-<br>
-import&nbsp;javax.security.auth.Subject;<br>
-import&nbsp;javax.security.auth.message.AuthException;<br>
-import&nbsp;javax.security.auth.message.AuthStatus;<br>
-import&nbsp;javax.security.auth.message.MessageInfo;<br>
-import&nbsp;javax.servlet.http.HttpServletResponse;<br>
-import&nbsp;java.io.PrintWriter;<br>
-<br>
-import&nbsp;org.testng.annotations.BeforeMethod;<br>
-import&nbsp;org.testng.annotations.Test;<br>
-<br>
-public&nbsp;class&nbsp;RuntimeResultHandlerTest&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;RuntimeResultHandler&nbsp;resultHandler;<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setUp()&nbsp;{<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler&nbsp;=&nbsp;new&nbsp;RuntimeResultHandler();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertTrue(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendFailureAuthStatus()&nbsp;throws&nbsp;Exception&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintWriter&nbsp;writer&nbsp;=&nbsp;mock(PrintWriter.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(response.getWriter()).willReturn(writer);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(401);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleValidateRequestWithSendContinueAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_CONTINUE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;result&nbsp;=&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertFalse(result);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response,&nbsp;never()).setStatus(100);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;handleValidateRequestShouldThrowAuthExceptionWithFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyZeroInteractions(response);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response).setStatus(500);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSendContinueAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SEND_CONTINUE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(response,&nbsp;never()).setStatus(100);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithSuccessAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.SUCCESS;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleSecureResponseResult(authStatus,&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;@Test&nbsp;(expectedExceptions&nbsp;=&nbsp;AuthException.class)<br>
-&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;shouldHandleSecureResponseWithFailureAuthStatus()&nbsp;throws&nbsp;AuthException&nbsp;{<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthStatus&nbsp;authStatus&nbsp;=&nbsp;AuthStatus.FAILURE;<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageInfo&nbsp;messageInfo&nbsp;=&nbsp;mock(MessageInfo.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse&nbsp;response&nbsp;=&nbsp;mock(HttpServletResponse.class);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultHandler.handleValidateRequestResult(authStatus,&nbsp;messageInfo,&nbsp;auditTrail,&nbsp;clientSubject,<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response);<br>
-<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail();<br>
-&nbsp;&nbsp;&nbsp;&nbsp;}<br>
-}<br>
&lt;/del&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;<br>
&lt;a&nbsp;id=&quot;forgerockauthfilterstrunkforgerockauthnfilterforgerockjaspiruntimesrctestjavaorgforgerockcafauthenticationframeworkSessionAuthContextTestjava&quot;&gt;&lt;/a&gt;<br>
&lt;div&nbsp;class=&quot;addfile&quot;&gt;&lt;h4&gt;Added:&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/SessionAuthContextTest.java&nbsp;(0&nbsp;=&gt;&nbsp;3261)&lt;/h4&gt;<br>
&lt;pre&nbsp;class=&quot;diff&quot;&gt;&lt;span&gt;<br>
&lt;span&nbsp;class=&quot;info&quot;&gt;---&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/SessionAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rev&nbsp;0)<br>
+++&nbsp;forgerock-auth-filters/trunk/forgerock-authn-filter/forgerock-jaspi-runtime/src/test/java/org/forgerock/caf/authentication/framework/SessionAuthContextTest.java&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp2015-05-01&nbsp;07:29:16&nbsp;UTC&nbsp;(rev&nbsp;3261)<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;lines&quot;&gt;@@&nbsp;-0,0&nbsp;+1,184&nbsp;@@<br>
&lt;/span&gt;&lt;ins&gt;+/*<br>
+&nbsp;*&nbsp;The&nbsp;contents&nbsp;of&nbsp;this&nbsp;file&nbsp;are&nbsp;subject&nbsp;to&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;Common&nbsp;Development&nbsp;and<br>
+&nbsp;*&nbsp;Distribution&nbsp;License&nbsp;(the&nbsp;License).&nbsp;You&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the<br>
+&nbsp;*&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the<br>
+&nbsp;*&nbsp;specific&nbsp;language&nbsp;governing&nbsp;permission&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;When&nbsp;distributing&nbsp;Covered&nbsp;Software,&nbsp;include&nbsp;this&nbsp;CDDL&nbsp;Header&nbsp;Notice&nbsp;in&nbsp;each&nbsp;file&nbsp;and&nbsp;include<br>
+&nbsp;*&nbsp;the&nbsp;License&nbsp;file&nbsp;at&nbsp;legal/CDDLv1.0.txt.&nbsp;If&nbsp;applicable,&nbsp;add&nbsp;the&nbsp;following&nbsp;below&nbsp;the&nbsp;CDDL<br>
+&nbsp;*&nbsp;Header,&nbsp;with&nbsp;the&nbsp;fields&nbsp;enclosed&nbsp;by&nbsp;brackets&nbsp;[]&nbsp;replaced&nbsp;by&nbsp;your&nbsp;own&nbsp;identifying<br>
+&nbsp;*&nbsp;information:&nbsp;&amp;quot;Portions&nbsp;copyright&nbsp;[year]&nbsp;[name&nbsp;of&nbsp;copyright&nbsp;owner]&amp;quot;.<br>
+&nbsp;*<br>
+&nbsp;*&nbsp;Copyright&nbsp;2015&nbsp;ForgeRock&nbsp;AS.<br>
+&nbsp;*/<br>
+<br>
+package&nbsp;org.forgerock.caf.authentication.framework;<br>
+<br>
+import&nbsp;static&nbsp;org.forgerock.util.test.assertj.AssertJPromiseAssert.assertThat;<br>
+import&nbsp;static&nbsp;org.mockito.BDDMockito.given;<br>
+import&nbsp;static&nbsp;org.mockito.Mockito.*;<br>
+<br>
+import&nbsp;javax.security.auth.Subject;<br>
+import&nbsp;javax.security.auth.message.AuthStatus;<br>
+import&nbsp;java.util.HashMap;<br>
+import&nbsp;java.util.Map;<br>
+<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AsyncServerAuthModule;<br>
+import&nbsp;org.forgerock.caf.authentication.api.AuthenticationException;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContext;<br>
+import&nbsp;org.forgerock.caf.authentication.api.MessageContextInfo;<br>
+import&nbsp;org.forgerock.util.promise.Promise;<br>
+import&nbsp;org.forgerock.util.promise.Promises;<br>
+import&nbsp;org.mockito.Matchers;<br>
+import&nbsp;org.slf4j.Logger;<br>
+import&nbsp;org.testng.annotations.BeforeMethod;<br>
+import&nbsp;org.testng.annotations.Test;<br>
+<br>
+public&nbsp;class&nbsp;SessionAuthContextTest&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthContext&nbsp;authContext;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule;<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@BeforeMethod<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;setup()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionAuthModule&nbsp;=&nbsp;mockSessionAuthModule();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createSessionAuthContext(sessionAuthModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthContext&nbsp;createSessionAuthContext(AsyncServerAuthModule&nbsp;sessionAuthModule)&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger&nbsp;logger&nbsp;=&nbsp;mock(Logger.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;SessionAuthContext(logger,&nbsp;sessionAuthModule);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;AsyncServerAuthModule&nbsp;mockSessionAuthModule()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncServerAuthModule&nbsp;sessionAuthModule&nbsp;=&nbsp;mock(AsyncServerAuthModule.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.validateRequest(Matchers.&amp;lt;MessageContextInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject(),<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SUCCESS));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.secureResponse(Matchers.&amp;lt;MessageContextInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promises.&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(AuthStatus.SEND_SUCCESS));<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(sessionAuthModule.cleanSubject(Matchers.&amp;lt;MessageContextInfo&amp;gt;anyObject(),&nbsp;Matchers.&amp;lt;Subject&amp;gt;anyObject()))<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.willReturn(Promises.&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;newSuccessfulPromise(null));<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sessionAuthModule;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;MessageContext&nbsp;mockMessageContext()&nbsp;{<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mock(MessageContext.class);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&amp;lt;String,&nbsp;Object&amp;gt;&nbsp;requestContextMap&nbsp;=&nbsp;new&nbsp;HashMap&amp;lt;String,&nbsp;Object&amp;gt;();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&nbsp;auditTrail&nbsp;=&nbsp;mock(AuditTrail.class);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given(context.getRequestContextMap()).willReturn(requestContextMap);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requestContextMap.put(AuditTrail.AUDIT_TRAIL_KEY,&nbsp;auditTrail);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;context;<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;validateRequestShouldCallSessionAuthModule()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSessionAuthModuleIsNullValidateRequestShouldReturnSendFailure()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createSessionAuthContext(null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.validateRequest(context,&nbsp;clientSubject,<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_FAILURE);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule,&nbsp;never()).validateRequest(context,&nbsp;clientSubject,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;secureResponseShouldCallSessionAuthModule()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSessionAuthModuleIsNullSecureResponseShouldReturnSendSuccess()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;serviceSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createSessionAuthContext(null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;AuthStatus,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.secureResponse(context,&nbsp;serviceSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded().withObject().isEqualTo(AuthStatus.SEND_SUCCESS);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule,&nbsp;never()).secureResponse(context,&nbsp;serviceSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;cleanSubjectShouldCallSessionAuthModule()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;@Test<br>
+&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;whenSessionAuthModuleIsNullCleanSubjectShouldReturnNull()&nbsp;{<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Given<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageContext&nbsp;context&nbsp;=&nbsp;mockMessageContext();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subject&nbsp;clientSubject&nbsp;=&nbsp;new&nbsp;Subject();<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authContext&nbsp;=&nbsp;createSessionAuthContext(null);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Promise&amp;lt;Void,&nbsp;AuthenticationException&amp;gt;&nbsp;promise&nbsp;=&nbsp;authContext.cleanSubject(context,&nbsp;clientSubject);<br>
+<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Then<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assertThat(promise).succeeded();<br>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify(sessionAuthModule,&nbsp;never()).cleanSubject(context,&nbsp;clientSubject);<br>
+&nbsp;&nbsp;&nbsp;&nbsp;}<br>
+}<br>
&lt;/ins&gt;&lt;/span&gt;&lt;/pre&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;footer&quot;&gt;Copyright&nbsp;(c)&nbsp;by&nbsp;ForgeRock.&nbsp;All&nbsp;rights&nbsp;reserved.&lt;/div&gt;<br>
<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
